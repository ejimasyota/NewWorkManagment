<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ログイン | 作品管理システム</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="Front/Css/Common.css" />
  </head>
  <body>
    <div class="LoginContainer">
      <div class="LoginCard">
        <div class="LoginIcon">
          <i class="fas fa-book-open"></i>
        </div>
        <h1 class="LoginTitle">作品管理システム</h1>
        <p class="LoginSubtitle">アカウントにログインしてください</p>

        <form class="LoginForm" id="LoginForm" onsubmit="return false;">
          <div class="FormGroup">
            <input
              type="text"
              class="InputForm"
              id="UserId"
              placeholder="ユーザーID（12桁）"
              maxlength="12"
              autocomplete="username"
            />
          </div>

          <div class="FormGroup">
            <input
              type="password"
              class="InputForm"
              id="Password"
              placeholder="パスワード（12桁）"
              maxlength="12"
              autocomplete="current-password"
            />
          </div>

          <div class="LoginButtonGroup">
            <button
              type="submit"
              class="ButtonClass PrimaryButton ButtonFull"
              id="LoginButton"
            >
              <i class="fas fa-sign-in-alt"></i> ログイン
            </button>
            <button
              type="button"
              class="ButtonClass SecondaryButton ButtonFull"
              id="RegisterButton"
            >
              <i class="fas fa-user-plus"></i> 会員登録
            </button>
          </div>
        </form>
      </div>
    </div>

    <script src="Front/Js/Common.js"></script>
    <script src="Front/Js/Dialog.js"></script>
    <script>
      /**
       * 画面ロード時
       */
      document.addEventListener('DOMContentLoaded', function () {
        // 1 .ログイン画面の初期化処理呼び出し
        InitializeLoginPage()
      })

      /**
       * ログイン画面の初期化
       */
      function InitializeLoginPage() {
        /* ==========================================================
         * ログインボタンのクリックイベント定義
         * ========================================================== */
        document
          .getElementById('LoginButton')
          .addEventListener('click', HandleLogin)

        /* ==========================================================
         * 会員登録ボタンのクリックイベント定義
         * ========================================================== */
        document
          .getElementById('RegisterButton')
          .addEventListener('click', function () {
            window.location.href = 'Front/Html/Registration.html'
          })

        /* ==========================================================
         * Enterキーのクリックイベント定義
         * ========================================================== */
        document
          .getElementById('LoginForm')
          .addEventListener('keypress', function (Event) {
            /* ---------------------------------------------
             *  1. Enterキー押下時の処理
             * --------------------------------------------- */
            if (Event.key === 'Enter') {
              // 1. ログイン処理呼び出し
              HandleLogin()
            }
          })
      }

      /**
       * ログイン処理
       */
      async function HandleLogin() {
        /* ==========================================================
         * 定義
         * ========================================================== */
        // 1. ユーザーID
        const UserId = document.getElementById('UserId').value.trim()
        // 2. パスワード
        const Password = document.getElementById('Password').value.trim()

        /* ==========================================================
         * 入力値チェック
         * ========================================================== */
        /* ---------------------------------------------
         *  1. ユーザーID入力チェック
         * --------------------------------------------- */
        if (!IsRequired(UserId)) {
          // 1. エラーダイアログ表示
          await ShowErrorDialog('ユーザーIDを入力してください')
          // 2. フォーカス設定
          document.getElementById('UserId').focus()
          // 3. 処理終了
          return
        }

        /* ---------------------------------------------
         *  2. パスワード入力チェック
         * --------------------------------------------- */
        if (!IsRequired(Password)) {
          // 1. エラーダイアログ表示
          await ShowErrorDialog('パスワードを入力してください')
          // 2. フォーカス設定
          document.getElementById('Password').focus()
          // 3. 処理終了
          return
        }

        /* ---------------------------------------------
         *  3. ユーザーID桁数チェック
         * --------------------------------------------- */
        if (!CheckLength(UserId, 12)) {
          // 1. エラーダイアログ表示
          await ShowErrorDialog('ユーザーIDは12桁で入力してください')
          // 2. フォーカス設定
          document.getElementById('UserId').focus()
          // 3. 処理終了
          return
        }
        /* ---------------------------------------------
         *  4. パスワード桁数チェック
         * --------------------------------------------- */
        if (!CheckLength(Password, 12)) {
          // 1. エラーダイアログ表示
          await ShowErrorDialog('パスワードは12桁で入力してください')
          // 2. フォーカス設定
          document.getElementById('Password').focus()
          // 3. 処理終了
          return
        }

        /* ---------------------------------------------
         *  5. ユーザーID形式チェック
         * --------------------------------------------- */
        if (!ValidateUserId(UserId)) {
          // 1. エラーダイアログ表示
          await ShowErrorDialog(
            'ユーザーIDには大文字・記号・数値を含めてください',
          )
          // 2. フォーカス設定
          document.getElementById('UserId').focus()
          // 3. 処理終了
          return
        }

        /* ---------------------------------------------
         *  6. ユーザーIDとパスワードの同一チェック
         * --------------------------------------------- */
        if (UserId === Password) {
          // 1. エラーダイアログ表示
          await ShowErrorDialog(
            'パスワードはユーザーIDと異なる値を設定してください',
          )
          // 2. フォーカス設定
          document.getElementById('Password').focus()
          // 3. 処理終了
          return
        }

        /* ==========================================================
         * API呼び出し
         * ========================================================== */
        try {
          /* ---------------------------------------------
           *  1. 事前処理
           * --------------------------------------------- */
          // 1. スピナー表示
          ShowSpinner()

          /* ---------------------------------------------
           *  2. ユーザーID入力チェック
           * --------------------------------------------- */
          const Response = await CallApi('/Login.php', 'POST', {
            // 1. ユーザーID
            UserId: UserId,
            // 2. パスワード
            Password: Password,
          })

          /* ---------------------------------------------
           *  3. ログイン成功
           * --------------------------------------------- */
          if (Response.Success) {
            /* 1. 事前処理 */
            // 1. ユーザーIDをセッションに保持
            sessionStorage.setItem('UserId', UserId)
            // 2. 遷移前パス取得
            const LastPath = sessionStorage.getItem('LastPath')

            /* 2. 管理者によるログインであった場合 */
            if (Response.Data.IsAdmin) {
              // 1. 管理者状態をセッションに保持
              sessionStorage.setItem('AuthFlg', 'true')
            }

            /* 3. セッションに遷移前パスが存在する場合(セッションタイムアウトによるログアウト時) */
            if (LastPath && LastPath !== '/index.html') {
              // 1. セッションの遷移前パスを削除
              sessionStorage.removeItem('LastPath')
              // 2. 遷移前パスへリダイレクト
              window.location.href = LastPath
            } else {
              /* 4. セッションに遷移前パスが存在しない場合 */
              // 1. メイン画面へリダイレクト
              window.location.href = 'Front/Html/Main.html'
            }
          } else {
            /* ---------------------------------------------
             *  4. ログイン失敗
             * --------------------------------------------- */
            // 1. エラーダイアログ表示
            await ShowErrorDialog(Response.Message || 'ログインに失敗しました')
          }
        } catch (Error) {
          /* ==========================================================
           * 例外処理
           * ========================================================== */
          // 1. エラーダイアログ表示
          await ShowErrorDialog(
            Error.message || 'ログイン処理中にエラーが発生しました',
          )
          // 2. デバッグログ出力
          console.error(Error)
        }
      }
    </script>
  </body>
</html>

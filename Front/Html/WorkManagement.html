<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>作品管理 | 作品管理システム</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="../Css/Common.css" />
    <style>
      /**
     * 作品管理画面固有スタイル
     */
      .WorkTitle {
        font-size: 18px;
        color: #2c3e50;
        margin-bottom: 20px;
        padding: 10px 15px;
        background-color: #ecf0f1;
        border-radius: 6px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .WorkTitle i {
        color: #3498db;
      }

      .SidebarSubMenu {
        padding-left: 20px;
        font-size: 13px;
      }

      .SidebarSubMenu .SidebarItem {
        padding: 10px 15px;
      }

      .SidebarDivider {
        height: 1px;
        background-color: #34495e;
        margin: 10px 15px;
      }

      .FormRow {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
        flex-wrap: wrap;
      }

      .FormRow .FormGroup {
        flex: 1;
        min-width: 200px;
        margin-bottom: 0;
      }

      .FormLabel {
        display: block;
        font-size: 12px;
        color: #666;
        margin-bottom: 5px;
      }

      /* 相関図スタイル */
      .RelationContainer {
        display: flex;
        gap: 20px;
        height: calc(100vh - 200px);
        min-height: 500px;
      }

      .RelationSidebar {
        width: 200px;
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        overflow-y: auto;
      }

      .RelationSidebarTitle {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 10px;
        color: #2c3e50;
      }

      .CharacterListItem {
        padding: 8px 12px;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-bottom: 8px;
        cursor: grab;
        font-size: 12px;
        transition: all 0.2s ease;
      }

      .CharacterListItem:hover {
        background: #e3f2fd;
        border-color: #3498db;
      }

      .CharacterListItem.dragging {
        opacity: 0.5;
      }

      .RelationCanvas {
        flex: 1;
        background: #fff;
        border: 2px solid #ddd;
        border-radius: 8px;
        position: relative;
        overflow: hidden;
      }

      .RelationCanvasSvg {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
      }

      .RelationCanvasSvg line,
      .RelationCanvasSvg path {
        pointer-events: stroke;
        cursor: pointer;
      }

      .RelationObject {
        position: absolute;
        background: #fff;
        border: 2px solid #3498db;
        border-radius: 8px;
        padding: 10px;
        cursor: move;
        min-width: 80px;
        text-align: center;
        font-size: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        z-index: 10;
      }

      .RelationObject.selected {
        border-color: #e74c3c;
        box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.2);
      }

      .RelationObject img {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        object-fit: cover;
        margin-bottom: 5px;
      }

      .RelationGroupBox {
        position: absolute;
        border: 2px dashed #9b59b6;
        border-radius: 12px;
        padding: 10px;
        background: rgba(155, 89, 182, 0.05);
        z-index: 1;
      }

      .RelationGroupLabel {
        position: absolute;
        top: -12px;
        left: 10px;
        background: #9b59b6;
        color: #fff;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 11px;
      }

      .TrashZone {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 60px;
        height: 60px;
        background: #f8f9fa;
        border: 2px dashed #e74c3c;
        border-radius: 8px;
        display: flex;
        justify-content: center;
        align-items: center;
        color: #e74c3c;
        font-size: 24px;
        transition: all 0.2s ease;
        z-index: 100;
      }

      .TrashZone.active {
        background: #fee;
        border-style: solid;
        transform: scale(1.1);
      }

      /* ストーリー・プロット用スタイル */
      .StoryList {
        margin-top: 20px;
      }

      .StoryItem {
        display: flex;
        align-items: flex-start;
        padding: 15px;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        margin-bottom: 10px;
        cursor: grab;
        transition: all 0.2s ease;
      }

      .StoryItem:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .StoryItem.dragging {
        opacity: 0.5;
        transform: rotate(2deg);
      }

      .StoryItem.drag-over {
        border-color: #3498db;
        background: #e3f2fd;
      }

      .StoryNumber {
        width: 30px;
        height: 30px;
        background: #3498db;
        color: #fff;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: 600;
        font-size: 12px;
        margin-right: 15px;
        flex-shrink: 0;
      }

      .StoryContent {
        flex: 1;
      }

      .StoryNarrator {
        font-size: 12px;
        color: #666;
        margin-bottom: 5px;
      }

      .StoryText {
        font-size: 14px;
        line-height: 1.6;
      }

      .PlotBadge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        margin-right: 10px;
      }

      .PlotBadge.ki {
        background: #e3f2fd;
        color: #1976d2;
      }

      .PlotBadge.sho {
        background: #e8f5e9;
        color: #388e3c;
      }

      .PlotBadge.ten {
        background: #fff3e0;
        color: #f57c00;
      }

      .PlotBadge.ketsu {
        background: #fce4ec;
        color: #c2185b;
      }

      /* 関係性タイプ選択 */
      .RelationTypeSelector {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 15px;
      }

      .RelationTypeOption {
        padding: 8px 16px;
        border: 2px solid #ddd;
        border-radius: 20px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s ease;
      }

      .RelationTypeOption:hover {
        border-color: #3498db;
      }

      .RelationTypeOption.selected {
        border-color: currentColor;
        background: currentColor;
        color: #fff;
      }

      /* カレンダーUI */
      .CalendarContainer {
        margin-top: 20px;
      }

      .CalendarHeader {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding: 10px;
        background-color: #3498db;
        border-radius: 8px;
        color: #fff;
      }

      .CalendarHeader h3 {
        margin: 0;
        font-size: 18px;
      }

      .CalendarNavButton {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: #fff;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 16px;
        transition: background 0.2s;
      }

      .CalendarNavButton:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .CalendarGrid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 2px;
        background-color: #ddd;
        border-radius: 8px;
        overflow: hidden;
      }

      .CalendarDayHeader {
        background-color: #34495e;
        color: #fff;
        text-align: center;
        padding: 10px 5px;
        font-size: 12px;
        font-weight: bold;
      }

      .CalendarDayHeader.Sunday {
        color: #ff6b6b;
      }
      .CalendarDayHeader.Saturday {
        color: #74b9ff;
      }

      .CalendarDay {
        background-color: #fff;
        min-height: 80px;
        padding: 5px;
        cursor: pointer;
        transition: background 0.2s;
        position: relative;
      }

      .CalendarDay:hover {
        background-color: #ecf0f1;
      }

      .CalendarDay.OtherMonth {
        background-color: #f8f9fa;
        color: #aaa;
      }

      .CalendarDay.Today {
        background-color: #fff9c4;
      }

      .CalendarDayNumber {
        font-size: 12px;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .CalendarDay.Sunday .CalendarDayNumber {
        color: #e74c3c;
      }
      .CalendarDay.Saturday .CalendarDayNumber {
        color: #3498db;
      }

      .CalendarEvent {
        font-size: 10px;
        padding: 2px 4px;
        margin-bottom: 2px;
        border-radius: 3px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        cursor: pointer;
        color: #fff;
        background-color: #3498db;
      }

      .CalendarEvent:hover {
        opacity: 0.8;
      }

      .CalendarMoreEvents {
        font-size: 10px;
        color: #666;
        text-align: center;
        margin-top: 2px;
      }

      /* スケジュール詳細モーダル */
      .ScheduleModal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }

      .ScheduleModalContent {
        background: #fff;
        padding: 25px;
        border-radius: 12px;
        width: 90%;
        max-width: 450px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      }

      .ScheduleModalHeader {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .ScheduleModalHeader h3 {
        margin: 0;
        font-size: 18px;
        color: #2c3e50;
      }

      .ScheduleModalClose {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #999;
      }

      .ScheduleModalClose:hover {
        color: #333;
      }

      .ScheduleColorPicker {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-bottom: 15px;
      }

      .ColorOption {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        cursor: pointer;
        border: 3px solid transparent;
        transition: transform 0.2s, border-color 0.2s;
      }

      .ColorOption:hover {
        transform: scale(1.1);
      }

      .ColorOption.Selected {
        border-color: #2c3e50;
      }

      @media screen and (max-width: 768px) {
        .CalendarDay {
          min-height: 60px;
          padding: 3px;
        }
        .CalendarDayNumber {
          font-size: 10px;
        }
        .CalendarEvent {
          font-size: 8px;
          padding: 1px 2px;
        }
      }

      /* 年表ビジュアル表示スタイル */
      .TimelineVisual {
        position: relative;
        padding: 20px 0;
        max-width: 900px;
        margin: 0 auto;
      }

      .TimelineVisual::before {
        content: '';
        position: absolute;
        left: 50%;
        top: 0;
        bottom: 0;
        width: 4px;
        background: linear-gradient(180deg, #3498db 0%, #9b59b6 100%);
        transform: translateX(-50%);
        border-radius: 2px;
      }

      .TimelineItem {
        position: relative;
        width: 50%;
        padding: 10px 30px;
        box-sizing: border-box;
      }

      .TimelineItem::before {
        content: '';
        position: absolute;
        top: 20px;
        width: 16px;
        height: 16px;
        background: #fff;
        border: 4px solid #3498db;
        border-radius: 50%;
        z-index: 1;
      }

      .TimelineLeft {
        left: 0;
        padding-right: 40px;
        text-align: right;
      }

      .TimelineLeft::before {
        right: -8px;
      }

      .TimelineRight {
        left: 50%;
        padding-left: 40px;
        text-align: left;
      }

      .TimelineRight::before {
        left: -8px;
      }

      .TimelineContent {
        background: #fff;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        border-left: 4px solid #3498db;
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .TimelineContent:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
      }

      .TimelineRight .TimelineContent {
        border-left: none;
        border-right: 4px solid #9b59b6;
      }

      .TimelineDate {
        font-size: 12px;
        font-weight: 600;
        color: #3498db;
        margin-bottom: 5px;
      }

      .TimelineRight .TimelineDate {
        color: #9b59b6;
      }

      .TimelineTitle {
        font-size: 16px;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 8px;
      }

      .TimelineDesc {
        font-size: 13px;
        color: #666;
        line-height: 1.5;
        white-space: pre-wrap;
        word-break: break-word;
      }

      /* レスポンシブ対応 */
      @media screen and (max-width: 768px) {
        .TimelineVisual::before {
          left: 20px;
        }

        .TimelineItem {
          width: 100%;
          padding-left: 50px;
          padding-right: 15px;
          text-align: left;
        }

        .TimelineLeft,
        .TimelineRight {
          left: 0;
        }

        .TimelineLeft::before,
        .TimelineRight::before {
          left: 12px;
          right: auto;
        }

        .TimelineContent,
        .TimelineRight .TimelineContent {
          border-left: 4px solid #3498db;
          border-right: none;
        }

        .TimelineRight .TimelineDate {
          color: #3498db;
        }
      }

      /* 階級組織図表示スタイル */
      .ClassChart {
        padding: 20px;
        display: flex;
        flex-wrap: wrap;
        gap: 30px;
        justify-content: center;
      }

      .ClassChartGroup {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        min-width: 280px;
        max-width: 400px;
        flex: 1;
      }

      .ClassChartGroupTitle {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        color: #fff;
        padding: 12px 20px;
        font-size: 16px;
        font-weight: 600;
        border-radius: 12px 12px 0 0;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .ClassChartGroupTitle i {
        font-size: 18px;
      }

      .ClassChartHierarchy {
        padding: 15px;
        position: relative;
      }

      .ClassChartHierarchy::before {
        content: '';
        position: absolute;
        left: 30px;
        top: 15px;
        bottom: 15px;
        width: 3px;
        background: linear-gradient(180deg, #3498db 0%, #9b59b6 50%, #e74c3c 100%);
        border-radius: 2px;
      }

      .ClassChartItem {
        position: relative;
        padding: 8px 0 8px 55px;
      }

      .ClassChartItem::before {
        content: '';
        position: absolute;
        left: 24px;
        top: 50%;
        transform: translateY(-50%);
        width: 14px;
        height: 14px;
        background: #fff;
        border: 3px solid #3498db;
        border-radius: 50%;
        z-index: 1;
      }

      .ClassChartNode {
        background: #f8f9fa;
        padding: 12px 15px;
        border-radius: 8px;
        border-left: 4px solid #3498db;
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .ClassChartNode:hover {
        transform: translateX(5px);
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
      }

      .ClassChartRank {
        font-size: 11px;
        font-weight: 600;
        color: #3498db;
        margin-bottom: 3px;
      }

      .ClassChartName {
        font-size: 15px;
        font-weight: 600;
        color: #2c3e50;
      }

      .ClassChartDesc {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
        line-height: 1.4;
      }

      /* レスポンシブ対応 */
      @media screen and (max-width: 768px) {
        .ClassChart {
          flex-direction: column;
          padding: 10px;
        }

        .ClassChartGroup {
          max-width: 100%;
          min-width: auto;
        }
      }
    </style>
  </head>
  <body>
    <!-- メニュートグルボタン（モバイル用） -->
    <button class="MenuToggle" id="MenuToggle">
      <i class="fas fa-bars"></i>
    </button>

    <!-- サイドバーオーバーレイ（モバイル用） -->
    <div class="SidebarOverlay" id="SidebarOverlay"></div>

    <div class="PageContainer">
      <!-- サイドバー -->
      <nav class="Sidebar" id="Sidebar">
        <div class="SidebarHeader">
          <h1><i class="fas fa-book-open"></i> 作品管理</h1>
        </div>
        <div class="SidebarMenu">
          <!-- メイン機能 -->
          <button class="SidebarItem" id="MenuBackToMain">
            <i class="fas fa-arrow-left"></i> メインへ戻る
          </button>

          <div class="SidebarDivider"></div>

          <!-- 作品設定 -->
          <button class="SidebarItem Active" id="MenuWorkInfo">
            <i class="fas fa-info-circle"></i> 作品共通情報
          </button>
          <button class="SidebarItem" id="MenuCharacter">
            <i class="fas fa-user"></i> キャラ設定
          </button>
          <button class="SidebarItem" id="MenuOrganization">
            <i class="fas fa-building"></i> 組織設定
          </button>
          <button class="SidebarItem" id="MenuTeam">
            <i class="fas fa-users"></i> チーム設定
          </button>
          <button class="SidebarItem" id="MenuRace">
            <i class="fas fa-dna"></i> 種族設定
          </button>
          <button class="SidebarItem" id="MenuClass">
            <i class="fas fa-medal"></i> 階級設定
          </button>

          <div class="SidebarDivider"></div>

          <!-- 世界観設定 -->
          <button class="SidebarItem" id="MenuCalendar">
            <i class="fas fa-calendar-alt"></i> 元号設定
          </button>
          <button class="SidebarItem" id="MenuTimeline">
            <i class="fas fa-stream"></i> 年表設定
          </button>
          <button class="SidebarItem" id="MenuStage">
            <i class="fas fa-map-marked-alt"></i> 舞台設定
          </button>
          <button class="SidebarItem" id="MenuBuilding">
            <i class="fas fa-landmark"></i> 建物設定
          </button>

          <div class="SidebarDivider"></div>

          <!-- 能力・装備 -->
          <button class="SidebarItem" id="MenuPower">
            <i class="fas fa-bolt"></i> 能力設定
          </button>
          <button class="SidebarItem" id="MenuWeapon">
            <i class="fas fa-shield-alt"></i> 武器設定
          </button>
          <button class="SidebarItem" id="MenuMove">
            <i class="fas fa-fire"></i> 技設定
          </button>

          <div class="SidebarDivider"></div>

          <!-- ストーリー・その他 -->
          <button class="SidebarItem" id="MenuSerif">
            <i class="fas fa-comment"></i> セリフ設定
          </button>
          <button class="SidebarItem" id="MenuRelation">
            <i class="fas fa-project-diagram"></i> 相関図作成
          </button>
          <button class="SidebarItem" id="MenuStory">
            <i class="fas fa-book"></i> ストーリー作成
          </button>
          <button class="SidebarItem" id="MenuPlot">
            <i class="fas fa-sitemap"></i> プロット作成
          </button>
          <button class="SidebarItem" id="MenuClue">
            <i class="fas fa-puzzle-piece"></i> 伏線メモ
          </button>

          <div class="SidebarDivider"></div>

          <!-- 管理 -->
          <button class="SidebarItem" id="MenuReview">
            <i class="fas fa-star"></i> 作品レビュー
          </button>
          <button class="SidebarItem" id="MenuMemo">
            <i class="fas fa-sticky-note"></i> 作品作成用メモ
          </button>
          <button class="SidebarItem" id="MenuSchedule">
            <i class="fas fa-tasks"></i> スケジュール
          </button>
          <button class="SidebarItem" id="MenuParticipants">
            <i class="fas fa-user-friends"></i> 参加者一覧
          </button>
          <button class="SidebarItem" id="MenuHistory">
            <i class="fas fa-history"></i> 更新履歴
          </button>
        </div>
        <div class="SidebarFooter">
          <button class="SidebarItem" id="MenuLogout">
            <i class="fas fa-sign-out-alt"></i> ログアウト
          </button>
        </div>
      </nav>

      <!-- メインコンテンツ -->
      <main class="MainContentWrapper">
        <div class="ContentArea" id="ContentArea">
          <!-- 動的にコンテンツが挿入される -->
        </div>
      </main>
    </div>

    <script src="../Js/Common.js"></script>
    <script src="../Js/Dialog.js"></script>
    <script>
      /* ==========================================================================
      * 定数
      * ========================================================================== */
      // 1. ページネーション用の1ページあたり件数
      const PAGE_SIZE = 15

      /* ==========================================================================
      * グローバル定義
      * ========================================================================== */
      /* ---------------------------------------------
       *  1. 画面情報
       * --------------------------------------------- */
      // 1. 作品情報
      let WorkInfo = null

      /* ---------------------------------------------
       *  2. 制御FLG
       * --------------------------------------------- */
      // 1. 作成者FLG
      let IsCreator = false
      // 2. 管理者FLG
      let IsAdmin = false
      // 3. アシスタントFLG
      let IsAssistant = false

      /* ---------------------------------------------
       *  3. 画面制御
       * --------------------------------------------- */
      // 1. ページ初期ページ
      let CurrentPage = 1

      /* ---------------------------------------------
       *  4. 一覧
       * --------------------------------------------- */
      // 1. 年表一覧
      let TimelineList = []
      // 2. スケジュール一覧
      let ScheduleList = []
      // 3. レビュー一覧
      let ReviewList = []
      // 4. キャラクター一覧
      let CharacterList = []

      /* ---------------------------------------------
       *  5. 選択行ID
       * --------------------------------------------- */
      // 1. 年表選択行ID
      let SelectedTimelineId = null
      // 2. スケジュール選択行ID
      let SelectedScheduleId = null
      // 3. レビュー選択行ID
      let SelectedReviewId = null
      // 4. キャラクター選択行ID
      let SelectedCharacterId = null

      /* ---------------------------------------------
       *  6. キャラ設定画面プルダウン
       * --------------------------------------------- */
      // 1. 組織プルダウン
      let CharacterOrganizationList = []
      // 2. チームプルダウン
      let CharacterTeamList = []
      // 3. 種族プルダウン
      let CharacterRaceList = []
      // 4. 階級プルダウン
      let CharacterClassList = []

      /**
       * 画面ロード時処理
       */
      document.addEventListener('DOMContentLoaded', function () {
        // 1. 初期化処理を呼び出し
        InitializeWorkManagementPage()
      })

      /**
       * 作品管理画面の初期化処理
       */
      async function InitializeWorkManagementPage() {
        /* ==========================================================================
        * 定義
        * ========================================================================== */
        // 1. セッションからユーザーIDを取得
        const UserId = sessionStorage.getItem('UserId')
        // 2. セッションから作品IDを取得
        const WorkId = sessionStorage.getItem('WorkId')

        /* ==========================================================================
        * チェック
        * ========================================================================== */
        /* ---------------------------------------------
        *  1. ユーザーIDまたは作品IDが存在しない場合
        * --------------------------------------------- */
        if (!UserId || !WorkId) {
          // 1. ログイン画面へ遷移
          window.location.href = '/index.html'
          // 2. 処理終了
          return
        }

        /* ==========================================================================
        * 管理者状態を設定
        * ========================================================================== */
        IsAdmin = sessionStorage.getItem('AuthFlg') === 'true'

        /* ==========================================================================
        * イベント定義
        * ========================================================================== */
        /* ---------------------------------------------
        *  1. メニューボタン押下時イベント定義
        * --------------------------------------------- */
        SetupMenuEvents()

        /* ---------------------------------------------
        *  2. モバイル版メニューボタン押下時イベント定義
        * --------------------------------------------- */
        SetupMobileMenu()

        /* ==========================================================================
        * セッション状態監視処理開始
        * ========================================================================== */
        StartSessionMonitor()

        /* ==========================================================================
        * 作品情報取得処理
        * ========================================================================== */
        await LoadWorkInfo()

        /* ==========================================================================
        * 利用者区分判定処理
        * ========================================================================== */
        await CheckUserPermission()

        /* ==========================================================================
        * 作品共通情報表示処理
        * ========================================================================== */
        ShowWorkCommonInfo()
      }

      /**
       * 作品情報を読み込み
       */
      async function LoadWorkInfo() {
        /* ==========================================================================
        * API通信
        * ========================================================================== */
        try {
          /* ---------------------------------------------
          *  1. 定義
          * --------------------------------------------- */
          // 1. スピナー表示
          ShowSpinner()
          // 2. 作品ID取得
          const WorkId = sessionStorage.getItem('WorkId')

          /* ---------------------------------------------
          *  2. API呼び出し
          * --------------------------------------------- */
          const Response = await CallApi(
            `/GetWorkInfo.php?WorkId=${encodeURIComponent(WorkId)}`,
            'GET',
          )

          /* ---------------------------------------------
          *  3. スピナー削除
          * --------------------------------------------- */
          HideSpinner()

          /* ---------------------------------------------
          *  4. 通信成功
          * --------------------------------------------- */
          if (Response.Success) {
            // 1. 作品情報を保持
            WorkInfo = Response.Data
          } else {
            /* ---------------------------------------------
            *  5. 通信失敗
            * --------------------------------------------- */
            // 1. エラーダイアログ表示
            await ShowErrorDialog(
              Response.Message || '作品情報の取得に失敗しました',
            )
            // 2. メイン画面へリダイレクト
            window.location.href = 'Main.html'
          }
        } catch (Error) {
          /* ==========================================================================
          * 例外処理
          * ========================================================================== */
          // 1. スピナー削除
          HideSpinner()
          // 2. エラーダイアログを表示
          await ShowErrorDialog('作品情報の取得中にエラーが発生しました')
          // 3. メイン画面へリダイレクト
          window.location.href = 'Main.html'
          // 4. デバッグログ
          console.error(Error)
        }
      }

      /**
       * 利用者区分チェック
       */
      async function CheckUserPermission() {
        /* ==========================================================================
        * API通信
        * ========================================================================== */
        try {
          /* ---------------------------------------------
          *  1. 定義
          * --------------------------------------------- */
          // 1. ユーザーID
          const UserId = sessionStorage.getItem('UserId')
          // 2. 作品ID
          const WorkId = sessionStorage.getItem('WorkId')

          /* ---------------------------------------------
          *  2. API呼び出し
          * --------------------------------------------- */
          const Response = await CallApi(
            `/GetUserPermission.php?WorkId=${encodeURIComponent(
              WorkId,
            )}&UserId=${encodeURIComponent(UserId)}`,
            'GET',
          )

          /* ---------------------------------------------
          *  3. 通信成功
          * --------------------------------------------- */
          if (Response.Success) {
            // 1. 作成区分を設定
            IsCreator = Response.Data.IsCreator
            // 2. アシスタント区分を設定
            IsAssistant = !Response.Data.IsCreator
          }
        } catch (Error) {
          /* ==========================================================================
          * 例外処理
          * ========================================================================== */
          // 1. デバッグログ
          console.error(Error)
        }
      }

      /**
       * 編集権限があるかチェック
       * 作成者または管理者であるかを判定する
       * @returns {boolean} 編集権限があるかどうか
       */
      function CanEdit() {
        // 1. 作成者であるか管理者であるかを返す
        return IsCreator || IsAdmin
      }

      /**
       * レビュー編集権限があるかチェック
       * アシスタントまたは管理者
       * @returns {boolean} レビュー編集権限があるかどうか
       */
      function CanEditReview() {
        // 1. アシスタントであるか管理者であるかを返す
        return IsAssistant || IsAdmin
      }

      /**
       * メニューイベントの設定
       */
      function SetupMenuEvents() {
        /* ---------------------------------------------
         *  1. メニューボタン押下時
         * --------------------------------------------- */
        document
          .getElementById('MenuBackToMain')
          .addEventListener('click', function () {
            // 1. メニュー画面へ遷移
            window.location.href = 'Main.html'
          })

        /* ---------------------------------------------
         *  2. 作品共通情報ボタン押下時
         * --------------------------------------------- */
        document
          .getElementById('MenuWorkInfo')
          .addEventListener('click', function () {
            // 1. 押下されたセクションをアクティブにする
            SetActiveMenu(this)
            // 2. 作品共通情報を表示
            ShowWorkCommonInfo()
            // 3. スクロール位置設定
            ScrollToTop()
          })

        /* ---------------------------------------------
         *  3. キャラ設定ボタン押下時
         * --------------------------------------------- */
        document
          .getElementById('MenuCharacter')
          .addEventListener('click', function () {
            // 1. 押下されたセクションをアクティブにする
            SetActiveMenu(this)
            // 2. キャラ設定画面を表示
            ShowCharacterSetting()
            // 3. スクロール位置設定
            ScrollToTop()
          })

        /* ---------------------------------------------
         *  4. 組織設定ボタン押下時
         * --------------------------------------------- */
        document
          .getElementById('MenuOrganization')
          .addEventListener('click', function () {
            // 1. 押下されたセクションをアクティブにする
            SetActiveMenu(this)
            // 2. 組織設定画面を表示
            ShowOrganizationSetting()
            // 3. スクロール位置設定
            ScrollToTop()
          })

        /* ---------------------------------------------
         *  5. チーム設定ボタン押下時
         * --------------------------------------------- */
        document
          .getElementById('MenuTeam')
          .addEventListener('click', function () {
            // 1. 押下されたセクションをアクティブにする
            SetActiveMenu(this)
            // 2. チーム設定画面を表示
            ShowTeamSetting()
            // 3. スクロール位置設定
            ScrollToTop()
          })

        /* ---------------------------------------------
         *  6. 種族設定ボタン押下時
         * --------------------------------------------- */
        document
          .getElementById('MenuRace')
          .addEventListener('click', function () {
            // 1. 押下されたセクションをアクティブにする
            SetActiveMenu(this)
            // 2. 種族設定画面を表示
            ShowRaceSetting()
            // 3. スクロール位置設定
            ScrollToTop()
          })

        /* ---------------------------------------------
         *  7. 階級設定ボタン押下時
         * --------------------------------------------- */
        document
          .getElementById('MenuClass')
          .addEventListener('click', function () {
            // 1. 押下されたセクションをアクティブにする
            SetActiveMenu(this)
            // 2. 階級設定画面を表示
            ShowClassSetting()
            // 3. スクロール位置設定
            ScrollToTop()
          })

        /* ---------------------------------------------
         *  8. 元号設定ボタン押下時
         * --------------------------------------------- */
        document
          .getElementById('MenuCalendar')
          .addEventListener('click', function () {
            // 1. 押下されたセクションをアクティブにする
            SetActiveMenu(this)
            // 2. 元号設定画面を表示
            ShowCalendarSetting()
            // 3. スクロール位置設定
            ScrollToTop()
          })

        /* ---------------------------------------------
         *  9. 年表設定ボタン押下時
         * --------------------------------------------- */
        document
          .getElementById('MenuTimeline')
          .addEventListener('click', function () {
            // 1. 押下されたセクションをアクティブにする
            SetActiveMenu(this)
            // 2. 年表設定画面を表示
            ShowTimelineSetting()
            // 3. スクロール位置設定
            ScrollToTop()
          })

        /* ---------------------------------------------
         *  10.舞台設定ボタン押下時
         * --------------------------------------------- */
        document
          .getElementById('MenuStage')
          .addEventListener('click', function () {
            // 1. 押下されたセクションをアクティブにする
            SetActiveMenu(this)
            // 2. 舞台設定画面を表示
            ShowStageSetting()
            // 3. スクロール位置設定
            ScrollToTop()
          })

        /* ---------------------------------------------
         *  11.建物設定ボタン押下時
         * --------------------------------------------- */
        document
          .getElementById('MenuBuilding')
          .addEventListener('click', function () {
            // 1. 押下されたセクションをアクティブにする
            SetActiveMenu(this)
            // 2. 建物設定画面を表示
            ShowBuildingSetting()
            // 3. スクロール位置設定
            ScrollToTop()
          })

        /* ---------------------------------------------
         *  12.能力設定ボタン押下時
         * --------------------------------------------- */
        document
          .getElementById('MenuPower')
          .addEventListener('click', function () {
            // 1. 押下されたセクションをアクティブにする
            SetActiveMenu(this)
            // 2. 能力設定画面を表示
            ShowPowerSetting()
            // 3. スクロール位置設定
            ScrollToTop()
          })

        /* ---------------------------------------------
         *  13.武器設定ボタン押下時
         * --------------------------------------------- */
        document
          .getElementById('MenuWeapon')
          .addEventListener('click', function () {
            // 1. 押下されたセクションをアクティブにする
            SetActiveMenu(this)
            // 2. 武器設定画面を表示
            ShowWeaponSetting()
            // 3. スクロール位置設定
            ScrollToTop()
          })

        /* ---------------------------------------------
         *  14.技設定ボタン押下時
         * --------------------------------------------- */
        document
          .getElementById('MenuMove')
          .addEventListener('click', function () {
            // 1. 押下されたセクションをアクティブにする
            SetActiveMenu(this)
            // 2, 技設定画面を表示
            ShowMoveSetting()
            // 3. スクロール位置設定
            ScrollToTop()
          })

        /* ---------------------------------------------
         *  15.セリフ設定ボタン押下時
         * --------------------------------------------- */
        document
          .getElementById('MenuSerif')
          .addEventListener('click', function () {
            // 1. 押下されたセクションをアクティブにする
            SetActiveMenu(this)
            // 2. セリフ設定画面を表示
            ShowSerifSetting()
            // 3. スクロール位置設定
            ScrollToTop()
          })
        
        /* ---------------------------------------------
         *  16.相関図設定ボタン押下時
         * --------------------------------------------- */
        document
          .getElementById('MenuRelation')
          .addEventListener('click', function () {
            // 1. 押下されたセクションをアクティブにする
            SetActiveMenu(this)
            // 2. 相関図設定画面を表示
            ShowRelationDiagram()
            // 3. スクロール位置設定
            ScrollToTop()
          })

        /* ---------------------------------------------
         *  17.ストーリー設定ボタン押下時
         * --------------------------------------------- */
        document
          .getElementById('MenuStory')
          .addEventListener('click', function () {
            // 1. 押下されたセクションをアクティブにする
            SetActiveMenu(this)
            // 2. ストーリー設定画面を表示
            ShowStoryCreation()
            // 3. スクロール位置設定
            ScrollToTop()
          })

        /* ---------------------------------------------
         *  18.プロット設定ボタン押下時
         * --------------------------------------------- */
        document
          .getElementById('MenuPlot')
          .addEventListener('click', function () {
            // 1. 押下されたセクションをアクティブにする
            SetActiveMenu(this)
            // 2. プロット設定画面を表示
            ShowPlotCreation()
            // 3. スクロール位置設定
            ScrollToTop()
          })

        /* ---------------------------------------------
         *  19.伏線メモボタン押下時
         * --------------------------------------------- */
        document
          .getElementById('MenuClue')
          .addEventListener('click', function () {
            // 1. 押下されたセクションをアクティブにする
            SetActiveMenu(this)
            // 2. 伏線メモ画面を表示
            ShowClueMemo()
            // 3. スクロール位置設定
            ScrollToTop()
          })

        /* ---------------------------------------------
         *  20.作品レビューボタン押下時
         * --------------------------------------------- */
        document
          .getElementById('MenuReview')
          .addEventListener('click', function () {
            // 1. 押下されたセクションをアクティブにする
            SetActiveMenu(this)
            // 2. 作品レビュー画面を表示
            ShowWorkReview()
            // 3. スクロール位置設定
            ScrollToTop()
          })

        /* ---------------------------------------------
         *  21.作品作成用メモボタン押下時
         * --------------------------------------------- */
        document
          .getElementById('MenuMemo')
          .addEventListener('click', function () {
            // 1. 押下されたセクションをアクティブにする
            SetActiveMenu(this)
            // 2. 作品作成用メモ画面を表示
            ShowWorkMemo()
            // 3. スクロール位置設定
            ScrollToTop()
          })

        /* ---------------------------------------------
         *  22.スケジュールボタン押下時
         * --------------------------------------------- */
        document
          .getElementById('MenuSchedule')
          .addEventListener('click', function () {
            // 1. 押下されたセクションをアクティブにする
            SetActiveMenu(this)
            // 2. スケジュール画面を表示
            ShowSchedule()
            // 3. スクロール位置設定
            ScrollToTop()
          })

        /* ---------------------------------------------
         *  21.参加者一覧ボタン押下時
         * --------------------------------------------- */
        document
          .getElementById('MenuParticipants')
          .addEventListener('click', function () {
            // 1. 押下されたセクションをアクティブにする
            SetActiveMenu(this)
            // 2. 参加者一覧画面を表示
            ShowParticipants()
            // 3. スクロール位置設定
            ScrollToTop()
          })

        /* ---------------------------------------------
         *  21.更新履歴ボタン押下時
         * --------------------------------------------- */
        document
          .getElementById('MenuHistory')
          .addEventListener('click', function () {
            // 1. 押下されたセクションをアクティブにする
            SetActiveMenu(this)
            // 2. 更新履歴画面を表示
            ShowUpdateHistory()
            // 3. スクロール位置設定
            ScrollToTop()
          })

        /* ---------------------------------------------
         *  22.ログアウトボタン押下時
         * --------------------------------------------- */
        document
          .getElementById('MenuLogout')
          .addEventListener('click', SystemLogout)
      }

      /**
       * 画面を先頭へスクロール
       */
      function ScrollToTop() {
        window.scrollTo({
          top: 0,
          left: 0,
          behavior: 'smooth', 
        })
      }

      /**
       * モバイルメニューの設定
       */
      function SetupMobileMenu() {
        /* ==========================================================================
         * 定義
         * ========================================================================== */
        // 1. メニュートグル要素
        const Toggle = document.getElementById('MenuToggle')
        // 2. サイドバー要素
        const Sidebar = document.getElementById('Sidebar')
        // 3. サイドバーオーバーレイ要素
        const Overlay = document.getElementById('SidebarOverlay')

        /* ==========================================================================
         * メニュートグルクリックイベント定義
         * ========================================================================== */
        Toggle.addEventListener('click', function () {
          // 1. サイドバーを表示
          Sidebar.classList.toggle('Open')
          // 2. サイドバーオーバーレイを表示
          Overlay.classList.toggle('Open')
        })

        /* ==========================================================================
         * サイドバーオーバーレイクリックイベント定義
         * ========================================================================== */
        Overlay.addEventListener('click', function () {
          // 1. サイドバーを表示
          Sidebar.classList.remove('Open')
          // 2. サイドバーオーバーレイを表示
          Overlay.classList.remove('Open')
        })
      }

      /**
       * アクティブメニューの設定
       * @param {HTMLElement} Element アクティブにする要素
       */
      function SetActiveMenu(Element) {
        /* ==========================================================================
         * すべてのセクションのアクティブを解除
         * ========================================================================== */
        document.querySelectorAll('.SidebarItem').forEach((Item) => {
          // 1. アクティブクラスを除去
          Item.classList.remove('Active')
        })
        /* ==========================================================================
         * 押下されたセクションにアクティブクラスを設定
         * ========================================================================== */
        Element.classList.add('Active')

        /* ==========================================================================
         * 表示クラスを除去
         * ========================================================================== */
        // 1. サイドバーの表示クラスを除去
        document.getElementById('Sidebar').classList.remove('Open')
        // 2. サイドバーオーバーレイの表示クラスを除去
        document.getElementById('SidebarOverlay').classList.remove('Open')
      }

      /**
       * ログアウト処理
       */
      async function SystemLogout() {
        /* ---------------------------------------------
         *  1. 確認ダイアログを表示
         * --------------------------------------------- */
        const Confirmed = await ShowConfirmDialog('ログアウトしますか？')

        /* ---------------------------------------------
         *  1. [はい]ボタンを押下した場合
         * --------------------------------------------- */
        if (Confirmed) {
          // 1. セッションをクリア
          sessionStorage.clear()
          // 2. ログイン画面へ遷移
          window.location.href = '/index.html'
        }
      }

      /**
       * コンテンツヘッダーを生成
       * @param   {string}  Title タイトル
       * @param   {string}  Icon  アイコン
       * @returns {string}  HTML文字列
       */
      function CreateContentHeader(Title, Icon) {
        /* ---------------------------------------------
         *  1. 定義
         * --------------------------------------------- */
        // 1. ヘッダータイトルを設定
        const WorkTitle = WorkInfo ? WorkInfo.WorkTitle : ''
        
        /* ---------------------------------------------
         *  2. 戻り値を定義
         * --------------------------------------------- */
        return `
            <div class="WorkTitle">
              <i class="fas fa-book"></i>
              <span>${TruncateText(WorkTitle, 30)}</span>
            </div>
            <div class="ContentHeader">
              <h2 class="ContentTitle"><i class="fas fa-${Icon}"></i> ${Title}</h2>
            </div>
          `
      }

      /* ======================================================================================================================
      * ■ 作品共通情報
      * -----------------------------------------------------------------------------------------------------------------------
      * ・作品の作品名やジャンルを編集する
      * ======================================================================================================================= */
      /**
       * 作品共通情報画面を表示
       */
      function ShowWorkCommonInfo() {
        /* ==========================================================================
         * 定義
         * ========================================================================== */
        // 1. コンテンツエリア要素取得
        const ContentArea = document.getElementById('ContentArea')
        // 2. 編集可能であるかを判定
        const CanEditFlg = CanEdit()

        /* ==========================================================================
         * DOM組み立て
         * ========================================================================== */
        ContentArea.innerHTML = `
            ${CreateContentHeader('作品共通情報', 'info-circle')}
            <div class="FormGroup">
              <input type="text" class="InputForm" id="WorkTitle" placeholder="作品名" value="${
                WorkInfo?.WorkTitle || ''
              }" ${!CanEditFlg ? 'disabled' : ''}>
            </div>
            <div class="FormGroup">
              <select class="SelectForm" id="Genre" ${
                !CanEditFlg ? 'disabled' : ''
              }>
                ${PullDownList('Genre')}
              </select>
            </div>
            ${
              CanEditFlg
                ? `
            <div class="ButtonGroup">
              <button class="ButtonClass SaveButton" id="SaveWorkInfoButton">
                <i class="fas fa-save"></i> 保存
              </button>
            </div>
            `
                : ''
            }
          `
        /* ==========================================================================
         * 作品情報取得
         * ========================================================================== */
        if (WorkInfo) {
          // 1. ジャンルを設定
          document.getElementById('Genre').value = WorkInfo.Genre
        }

        /* ==========================================================================
         * 編集権限の状態を確認
         * ========================================================================== */
        if (CanEditFlg) {
          // 1. 保存ボタンのクリックイベントを定義
          document
            .getElementById('SaveWorkInfoButton')
            .addEventListener('click', SaveWorkInfo)
        }
      }

      /**
       * 作品情報を保存
       */
      async function SaveWorkInfo() {
        /* ==========================================================================
         * 定義
         * ========================================================================== */
        // 1. 作品名取得
        const WorkTitle = document.getElementById('WorkTitle').value.trim()
        // 2. ジャンルを取得
        const Genre = document.getElementById('Genre').value

        /* ==========================================================================
         * バリデーションチェック
         * ========================================================================== */
        /* ---------------------------------------------
         *  1. 作品名の入力バリデーションチェック
         * --------------------------------------------- */
        if (!WorkTitle) {
          // 1. エラーダイアログを表示
          await ShowErrorDialog('作品名を入力してください')
          // 2. 処理終了
          return
        }

        /* ==========================================================================
         * API通信
         * ========================================================================== */
        try {
         /* ---------------------------------------------
          *  1. 定義
          * --------------------------------------------- */
          // 1. スピナー表示
          ShowSpinner()
          // 2. ユーザーID取得
          const UserId = sessionStorage.getItem('UserId')
          // 3. 作品ID取得
          const WorkId = sessionStorage.getItem('WorkId')

         /* ---------------------------------------------
          *  2. API呼び出し
          * --------------------------------------------- */
          const Response = await CallApi('/UpdateWorkInfo.php', 'POST', {
            // 1. 作品ID
            WorkId: WorkId,
            // 2. 作品名
            WorkTitle: WorkTitle,
            // 3. ジャンル
            Genre: parseInt(Genre),
            // 4. ユーザーID
            UserId: UserId,
          })

         /* ---------------------------------------------
          *  3. スピナー削除
          * --------------------------------------------- */
          HideSpinner()

         /* ---------------------------------------------
          *  4. 通信成功
          * --------------------------------------------- */
          if (Response.Success) {
            // 1. インフォダイアログを表示
            await ShowInfoDialog('保存完了', '作品情報を保存しました')
            // 2. 作品情報取得
            await LoadWorkInfo()
            // 3. 作品情報表示
            ShowWorkCommonInfo()
          } else {
           /* ---------------------------------------------
            *  5. 通信失敗
            * --------------------------------------------- */
            // 1. エラーダイアログを表示
            await ShowErrorDialog(Response.Message || '保存に失敗しました')
          }
        } catch (Error) {
         /* ==========================================================================
          * 例外処理
          * ========================================================================== */
          // 1. スピナー削除
          HideSpinner()
          // 2. エラーダイアログを表示
          await ShowErrorDialog('保存中にエラーが発生しました')
          // 3. デバッグログ
          console.error(Error)
        }
      }

      /* ======================================================================================================================
      * ■ キャラ設定
      * -----------------------------------------------------------------------------------------------------------------------
      * ・キャラクター情報の編集を行う
      * ======================================================================================================================= */
      /**
       * キャラ設定画面を表示
       * */
      async function ShowCharacterSetting() {
       /* ==========================================================================
        * 定義
        * ========================================================================== */
        // 1. 初期ページを設定
        CurrentPage = 1
        // 2. キャラ選択行IDを初期化
        SelectedCharacterId = null
        // 3. コンテンツエリア要素を取得
        const ContentArea = document.getElementById('ContentArea')
        // 4. 編集権限状態を取得
        const CanEditFlg = CanEdit()

       /* ==========================================================================
        * DOM組み立て
        * ========================================================================== */
        ContentArea.innerHTML = `
              ${CreateContentHeader('キャラ設定', 'user')}
              <div class="TabContainer">
                <div class="TabHeader">
                  <button class="TabButton Active" data-tab="basic">基本情報</button>
                  <button class="TabButton" data-tab="affiliation">所属情報</button>
                  <button class="TabButton" data-tab="detail">詳細情報</button>
                  <button class="TabButton" data-tab="image">画像</button>
                </div>

                <!-- 基本情報タブ -->
                <div class="TabContent Active" id="TabBasic">
                  <div class="FormRow">
                    <div class="FormGroup">
                      <input type="text" class="InputForm" id="CharaName" placeholder="キャラ名" maxlength="255" ${
                        !CanEditFlg ? 'disabled' : ''
                      }>
                    </div>
                    <div class="FormGroup">
                      <select class="SelectForm" id="CharaGender" ${
                        !CanEditFlg ? 'disabled' : ''
                      }>${PullDownList('Gender')}</select>
                    </div>
                  </div>
                  <div class="FormRow">
                    <div class="FormGroup InputWithButton">
                      <input type="text" class="InputForm" id="CharaBirthDate" placeholder="生年月日" readonly ${
                        !CanEditFlg ? 'disabled' : ''
                      }>
                      ${
                        CanEditFlg
                          ? `<button class="ButtonClass SecondaryButton ButtonSmall" id="CharaBirthDateBtn"><i class="fas fa-calendar"></i></button>`
                          : ''
                      }
                    </div>
                    <div class="FormGroup">
                      <input type="text" class="InputForm" id="CharaAge" placeholder="年齢" maxlength="50" ${
                        !CanEditFlg ? 'disabled' : ''
                      }>
                    </div>
                  </div>
                  <div class="FormRow">
                    <div class="FormGroup">
                      <input type="text" class="InputForm" id="CharaHeight" placeholder="身長" maxlength="50" ${
                        !CanEditFlg ? 'disabled' : ''
                      }>
                    </div>
                    <div class="FormGroup">
                      <input type="text" class="InputForm" id="CharaWeight" placeholder="体重" maxlength="50" ${
                        !CanEditFlg ? 'disabled' : ''
                      }>
                    </div>
                    <div class="FormGroup">
                      <input type="text" class="InputForm" id="CharaBloodType" placeholder="血液型" maxlength="10" ${
                        !CanEditFlg ? 'disabled' : ''
                      }>
                    </div>
                  </div>
                  <div class="FormRow">
                    <div class="FormGroup">
                      <input type="text" class="InputForm" id="CharaFirstPerson" placeholder="一人称" maxlength="50" ${
                        !CanEditFlg ? 'disabled' : ''
                      }>
                    </div>
                    <div class="FormGroup">
                      <input type="text" class="InputForm" id="CharaSecondPerson" placeholder="二人称" maxlength="50" ${
                        !CanEditFlg ? 'disabled' : ''
                      }>
                    </div>
                  </div>
                  <div class="FormGroup InputWithButton">
                    <input type="text" class="InputForm" id="CharaRoleInfo" placeholder="役割" disabled>
                    <button class="ButtonClass SecondaryButton ButtonSmall" id="CharaRoleInfoButton"><i class="fas fa-edit"></i></button>
                  </div>
                  <input type="hidden" id="CharaRoleInfoHidden">
                </div>

                <!-- 所属情報タブ -->
                <div class="TabContent" id="TabAffiliation">
                  <div class="FormRow">
                    <div class="FormGroup">
                      <select class="SelectForm" id="CharaRace" ${
                        !CanEditFlg ? 'disabled' : ''
                      }>
                        <option value="">種族を選択</option>
                      </select>
                    </div>
                    <div class="FormGroup">
                      <select class="SelectForm" id="CharaOrganization" ${
                        !CanEditFlg ? 'disabled' : ''
                      }>
                        <option value="">組織を選択</option>
                      </select>
                    </div>
                  </div>
                  <div class="FormRow">
                    <div class="FormGroup">
                      <select class="SelectForm" id="CharaTeam" ${
                        !CanEditFlg ? 'disabled' : ''
                      }>
                        <option value="">チームを選択</option>
                      </select>
                    </div>
                    <div class="FormGroup">
                      <select class="SelectForm" id="CharaClass" ${
                        !CanEditFlg ? 'disabled' : ''
                      }>
                        <option value="">階級を選択</option>
                      </select>
                    </div>
                  </div>
                </div>

                <!-- 詳細情報タブ -->
                <div class="TabContent" id="TabDetail">
                  <div class="FormGroup InputWithButton">
                    <input type="text" class="InputForm" id="CharaPersonality" placeholder="性格" disabled>
                    <button class="ButtonClass SecondaryButton ButtonSmall" id="CharaPersonalityButton"><i class="fas fa-edit"></i></button>
                  </div>
                  <input type="hidden" id="CharaPersonalityHidden">
                  <div class="FormGroup InputWithButton">
                    <input type="text" class="InputForm" id="CharaBiography" placeholder="生い立ち・経歴" disabled>
                    <button class="ButtonClass SecondaryButton ButtonSmall" id="CharaBiographyButton"><i class="fas fa-edit"></i></button>
                  </div>
                  <input type="hidden" id="CharaBiographyHidden">
                </div>

                <!-- 画像タブ -->
                <div class="TabContent" id="TabImage">
                  <div class="ImageBox" id="CharaImageBox">
                    <div class="ImageBoxPlaceholder">
                      <i class="fas fa-user"></i>
                      <div>クリックで画像選択</div>
                    </div>
                  </div>
                  <input type="file" id="CharaImageInput" accept="image/*" style="display:none;">
                  <input type="hidden" id="CharaImagePath">
                </div>
              </div>

              ${
                CanEditFlg
                  ? `
              <div class="ButtonGroup">
                <button class="ButtonClass ClearButton" id="CharaClearButton"><i class="fas fa-sync"></i> クリア</button>
                <button class="ButtonClass SaveButton" id="CharaSaveButton"><i class="fas fa-save"></i> 保存</button>
                <button class="ButtonClass DeleteButton Hidden" id="CharaDeleteButton"><i class="fas fa-trash"></i> 削除</button>
              </div>
              `
                  : ''
              }
              <div id="RecordCountArea" class="MarginTop20"></div>
              <div class="TableContainer" id="CharacterTableArea"></div>
              <div id="PaginationArea"></div>
            `

       /* ==========================================================================
        * 定義
        * ========================================================================== */
        // 1. タブクリックイベントを定義
        SetupCharacterTabEvents()
        // 2. キャラ設定画面で使用する各プルダウンの内容を取得
        await LoadCharacterPulldown()
        // 3. ボタンクリックイベントを定義
        CharacButtonEvent(CanEditFlg)
        // 4. キャラクター一覧を取得
        await LoadCharacterList()
      }

      /**
       * タブクリックイベントを定義
       * */
      function SetupCharacterTabEvents() {
       /* ==========================================================================
        * 各タブのクリックイベントを定義
        * ========================================================================== */
        document.querySelectorAll('.TabButton').forEach((TabButton) => {
          TabButton.addEventListener('click', function () {
           /* ---------------------------------------------
            *  1. すべてのタブボタンからアクティブ状態を削除
            * --------------------------------------------- */
            document
              .querySelectorAll('.TabButton')
              .forEach((Button) => Button.classList.remove('Active'))

           /* ---------------------------------------------
            *  2. すべてのタブコンテンツからアクティブ状態を削除
            * --------------------------------------------- */
            document
              .querySelectorAll('.TabContent')
              .forEach((Content) => Content.classList.remove('Active'))

           /* ---------------------------------------------
            *  3. 押下されたタブにアクティブクラスを付与
            * --------------------------------------------- */
            this.classList.add('Active')

           /* ---------------------------------------------
            *  4. タブIDを設定
            * --------------------------------------------- */
            const TabId = this.dataset.tab

           /* ---------------------------------------------
            *  5. タブ内容を定義
            * --------------------------------------------- */
            const TabMap = {
              // 1. 初期タブ
              basic: 'TabBasic',
              // 2. 所属情報タブ
              affiliation: 'TabAffiliation',
              // 3. 詳細タブ
              detail: 'TabDetail',
              // 4. 画像タブ
              image: 'TabImage',
            }

           /* ---------------------------------------------
            *  6. 押下されたタブにアクティブ状態を設定
            * --------------------------------------------- */
            document.getElementById(TabMap[TabId]).classList.add('Active')
          })
        })
      }

      /**
       * プルダウンの内容取得
       * */
      async function LoadCharacterPulldown() {
       /* ==========================================================================
        * API通信
        * ========================================================================== */
        try {
          /* ---------------------------------------------
           *  1. 定義
           * --------------------------------------------- */
          // 1. 作品IDを取得
          const WorkId = sessionStorage.getItem('WorkId')

          /* ---------------------------------------------
           *  2. API呼び出し
           * --------------------------------------------- */
          const [OrgResponse, TeamResponse, RaceResponse, ClassResponse] = await Promise.all([
            /* 1. 組織一覧取得 */
            CallApi(
              `/GetOrganizationList.php?WorkId=${encodeURIComponent(WorkId)}`,
              'GET',
            ),
            /* 2. チーム一覧取得 */
            CallApi(
              `/GetTeamList.php?WorkId=${encodeURIComponent(WorkId)}`,
              'GET',
            ),
            /* 3. 種族一覧取得 */
            CallApi(
              `/GetRaceList.php?WorkId=${encodeURIComponent(WorkId)}`,
              'GET',
            ),
            /* 4. 階級一覧取得 */
            CallApi(
              `/GetClassList.php?WorkId=${encodeURIComponent(WorkId)}`,
              'GET',
            ),
          ])

          /* ---------------------------------------------
           *  3. 組織一覧の内容をプルダウンに保持
           * --------------------------------------------- */
          CharacterOrganizationList = OrgResponse.Success
            ? OrgResponse.Data.OrganizationList || []
            : []

          /* ---------------------------------------------
           *  4. チーム一覧の内容をプルダウンに保持
           * --------------------------------------------- */
          CharacterTeamList = TeamResponse.Success ? TeamResponse.Data.TeamList || [] : []

          /* ---------------------------------------------
           *  5. 種族一覧の内容をプルダウンに保持
           * --------------------------------------------- */
          CharacterRaceList = RaceResponse.Success ? RaceResponse.Data.RaceList || [] : []

          /* ---------------------------------------------
           *  6. 階級一覧の内容をプルダウンに保持
           * --------------------------------------------- */
          CharacterClassList = ClassResponse.Success
            ? ClassResponse.Data.ClassList || []
            : []

          /* ---------------------------------------------
           *  7. プルダウンのDOMを作成
           * --------------------------------------------- */
          CreateCharaPulldown()
        } catch (Error) {
          /* ==========================================================================
           * 例外処理
           * ========================================================================== */
          // 1. デバッグログ
          console.error(Error)
        }
      }

      /**
       * プルダウンのDOM作成
       * */
      function CreateCharaPulldown() {
        /* ==========================================================================
         * 定義
         * ========================================================================== */
        // 1. 組織プルダウンを取得
        const OrgSelect = document.getElementById('CharaOrganization')
        // 2. チームプルダウンを取得
        const TeamSelect = document.getElementById('CharaTeam')
        // 3.  種族プルダウンを取得
        const RaceSelect = document.getElementById('CharaRace')
        // 4. 階級プルダウンを取得
        const ClassSelect = document.getElementById('CharaClass')

        /* ==========================================================================
         * プルダウンのDOM作成
         * ========================================================================== */
        /* ---------------------------------------------
         *  1. 組織プルダウンの内容のDOMを作成
         * --------------------------------------------- */
        OrgSelect.innerHTML =
          '<option value="">組織を選択</option>' +
          CharacterOrganizationList.map(
            (Option) => `<option value="${Option.OrgId}">${Option.OrgName}</option>`,
          ).join('')

        /* ---------------------------------------------
         *  2. チームプルダウンの内容のDOMを作成
         * --------------------------------------------- */
        TeamSelect.innerHTML =
          '<option value="">チームを選択</option>' +
          CharacterTeamList.map(
            (Option) => `<option value="${Option.TeamId}">${Option.TeamName}</option>`,
          ).join('')

        /* ---------------------------------------------
         *  3. 種族プルダウンの内容のDOMを作成
         * --------------------------------------------- */
        RaceSelect.innerHTML =
          '<option value="">種族を選択</option>' +
          CharacterRaceList.map(
            (Option) => `<option value="${Option.RaceId}">${Option.RaceName}</option>`,
          ).join('')

        /* ---------------------------------------------
         *  4. 階級プルダウンの内容のDOMを作成
         * --------------------------------------------- */
        ClassSelect.innerHTML =
          '<option value="">階級を選択</option>' +
          CharacterClassList.map(
            (Option) => `<option value="${Option.ClassId}">${Option.ClassName}</option>`,
          ).join('')
      }

      /**
       * キャラ設定画面のボタンのクリックイベントを定義
       * */
      function CharacButtonEvent(CanEditFlg) {
        /* ==========================================================================
         * 編集可能な権限である場合
         * ========================================================================== */
        if (CanEditFlg) {
         /* ---------------------------------------------
          *  1. 生年月日デートピッカーボタンクリックイベント定義
          * --------------------------------------------- */
          // 1. デートピッカーインスタンス作成
          const DatePickerInstance = new DatePicker()
          // 2. 生年月日デートピッカーボタンクリックイベント定義
          document
            .getElementById('CharaBirthDateBtn')
            ?.addEventListener('click', () =>
              DatePickerInstance.OpenDialog('CharaBirthDate'),
            )

         /* ---------------------------------------------
          *  2. クリアボタンクリックイベント定義
          * --------------------------------------------- */
          document
            .getElementById('CharaClearButton')
            .addEventListener('click', ClearCharacterForm)

         /* ---------------------------------------------
          *  3. 保存ボタンクリックイベント定義
          * --------------------------------------------- */
          document
            .getElementById('CharaSaveButton')
            .addEventListener('click', SaveCharacter)

         /* ---------------------------------------------
          *  4. 削除ボタンクリックイベント定義
          * --------------------------------------------- */
          document
            .getElementById('CharaDeleteButton')
            .addEventListener('click', DeleteCharacter)

         /* ---------------------------------------------
          *  5. 画像ボックスクリックイベント定義
          * --------------------------------------------- */
          document
            .getElementById('CharaImageBox')
            .addEventListener('click', async () => {
              /* 1. 定義 */
              // 1. キャラ画像ボックス要素取得
              const CharaImageBox = document.getElementById('CharaImageBox')
              // 2. 画像要素取得
              const ImgElement = CharaImageBox.querySelector('img')
              console.log("ImgElement",ImgElement)
              /* 2. 画像要素が存在しない場合 */
              if (!ImgElement) {
                // 1. ファイル選択画面を表示
                document.getElementById('CharaImageInput').click()
                // 2. 処理終了
                return
              }

              /* 3. 画像ダイアログ呼び出し */
              const ImgDelete = await ShowImageDialog(ImgElement.src, CanEdit())

              /* 4. 画像ダイアログで削除ボタンを押下した場合 */
              if (ImgDelete) {
                // 1. 画像ボックスの内容を初期化
                CharaImageBox.innerHTML = `
                    <div class="ImageBoxPlaceholder">
                      <i class="fas fa-user"></i>
                      <div>クリックで画像選択</div>
                    </div>
                  `
                // 2. 画像パスを初期化
                document.getElementById('CharaImagePath').value = ''
                // 3, ファイル選択入力フォームを初期化
                document.getElementById('CharaImageInput').value = ''
              }
            })

         /* ---------------------------------------------
          *  6. ファイル選択イベント定義
          * --------------------------------------------- */
          document
            .getElementById('CharaImageInput')
            .addEventListener('change', CharaImgChange)
        }

        /* ==========================================================================
         * 権限にかかわらず利用可能なイベント定義
         * ========================================================================== */
        /* ---------------------------------------------
         *  1. キャラ役割詳細ボタン
         * --------------------------------------------- */
         document
          .getElementById('CharaRoleInfoButton')
          .addEventListener('click', async () => {
            /* 1. 入力エリアダイアログ呼び出し */
            const Result = await ShowInputAreaDialog(
              document.getElementById('CharaRoleInfoHidden').value,
              !CanEditFlg,
            )

            /* 2. 編集可能かつ結果が存在する場合 */
            if (Result !== null && CanEditFlg) {
              // 1. 入力エリアダイアログの結果を設定
              document.getElementById('CharaRoleInfoHidden').value = Result
              // 2. 表示用入力フォームへ結果を設定
              document.getElementById('CharaRoleInfo').value = TruncateText(
                Result,
                30,
              )
            }
          })

        /* ---------------------------------------------
         *  2. キャラ性格詳細ボタン
         * --------------------------------------------- */
         document
          .getElementById('CharaPersonalityButton')
          .addEventListener('click', async () => {
            /* 1. 入力エリアダイアログ呼び出し */
            const Result = await ShowInputAreaDialog(
              document.getElementById('CharaPersonalityHidden').value,
              !CanEditFlg,
            )

            /* 2. 編集可能かつ結果が存在する場合 */
            if (Result !== null && CanEditFlg) {
              // 1. 入力エリアダイアログの結果を設定
              document.getElementById('CharaPersonalityHidden').value = Result
              // 2. 表示用入力フォームへ結果を設定
              document.getElementById('CharaPersonality').value = TruncateText(
                Result,
                30,
              )
            }
          })

        /* ---------------------------------------------
         *  3. 生い立ち・経歴詳細ボタン
         * --------------------------------------------- */
         document
          .getElementById('CharaBiographyButton')
          .addEventListener('click', async () => {
            /* 1. 入力エリアダイアログ呼び出し */
            const Result = await ShowInputAreaDialog(
              document.getElementById('CharaBiographyHidden').value,
              !CanEditFlg,
            )

            /* 2. 編集可能かつ結果が存在する場合 */
            if (Result !== null && CanEditFlg) {
              // 1. 入力エリアダイアログの結果を設定
              document.getElementById('CharaBiographyHidden').value = Result
              // 2. 表示用入力フォームへ結果を設定
              document.getElementById('CharaBiography').value = TruncateText(
                Result,
                30,
              )
            }
          })
      }

      /**
       * キャラ画像変更時処理
       **/
      function CharaImgChange(Event) {
        /* ==========================================================================
         * 定義
         * ========================================================================== */
        // 1. 選択されたファイル取得
        const File = Event.target.files[0]

        /* ==========================================================================
         * バリデーションチェック
         * ========================================================================== */
        /* ---------------------------------------------
         *  1. ファイルが存在しない場合
         * --------------------------------------------- */
        if (!File) {
          // 1. 処理終了
          return
        }

        /* ==========================================================================
         * FileReaderインスタンス作成
         * ========================================================================== */
        const Reader = new FileReader()

        /* ==========================================================================
         * ファイル読み取り処理
         * ========================================================================== */
        Reader.onload = function (Event) {
         /* ---------------------------------------------
          *  1. 定義
          * --------------------------------------------- */
          // 1. 画像ボックス要素取得
          const ImageBox = document.getElementById('CharaImageBox')
          // 2. 画像ボックスに画像を設定
          ImageBox.innerHTML = `<img src="${Event.target.result}" alt="キャラ画像">`

         /* ---------------------------------------------
          *  2. 画像ボックスクリックイベント
          * --------------------------------------------- */
          ImageBox.onclick(async () => {
            /* 1. 定義 */
            // 1. 画像ダイアログにて選択された操作の状態を保持する
            const ImgDelete = await ShowImageDialog(
              Event.target.result,
              CanEdit(),
            )

            /* 2. 削除の操作が選択された場合 */
            if (ImgDelete) {
              // 1. 画像ソースを初期化
              ImageBox.innerHTML = `<div class="ImageBoxPlaceholder"><i class="fas fa-user"></i><div>クリックで画像選択</div></div>`
              // 2. 画像パス初期化
              document.getElementById('CharaImageInput').value = ''
              // 3. 画像入力フォーム(ファイルイベント発火用)初期化
              document.getElementById('CharaImagePath').value = ''
            }
          })
        }
       /* ==========================================================================
        * ファイルを Base64 形式のデータURLとして読み込む
        * ========================================================================== */
        Reader.readAsDataURL(File)
      }

      async function LoadCharacterList() {
        try {
          const WorkId = sessionStorage.getItem('WorkId')
          const Response = await CallApi(
            `/GetCharacterList.php?WorkId=${encodeURIComponent(WorkId)}`,
            'GET',
          )
          if (Response.Success) {
            CharacterList = Response.Data || []
            RenderCharacterTable()
          } else {
            await ShowErrorDialog(
              Response.Message || 'キャラ一覧の取得に失敗しました',
            )
          }
        } catch (Error) {
          console.error(Error)
          await ShowErrorDialog('キャラ一覧の取得中にエラーが発生しました')
        }
      }

      function RenderCharacterTable() {
        const TableArea = document.getElementById('CharacterTableArea')
        const RecordCountArea = document.getElementById('RecordCountArea')
        const PaginationArea = document.getElementById('PaginationArea')
        RecordCountArea.innerHTML = ''
        RecordCountArea.appendChild(CreateRecordCount(CharacterList.length))
        const Table = document.createElement('table')
        Table.className = 'DataTable'
        const Thead = document.createElement('thead')
        Thead.innerHTML = `<tr><th>キャラ名</th><th>性別</th><th>年齢</th><th>種族</th><th>組織</th><th>登録日</th></tr>`
        Table.appendChild(Thead)
        const Tbody = document.createElement('tbody')
        const StartIndex = (CurrentPage - 1) * RECORDS_PER_PAGE
        const EndIndex = Math.min(
          StartIndex + RECORDS_PER_PAGE,
          CharacterList.length,
        )
        const PageData = CharacterList.slice(StartIndex, EndIndex)
        if (PageData.length === 0) {
          Tbody.innerHTML =
            '<tr><td colspan="6" style="text-align:center;color:#999;">データがありません</td></tr>'
        } else {
          PageData.forEach((Item, Index) => {
            const Row = document.createElement('tr')
            Row.style.cursor = 'pointer'
            Row.innerHTML = `<td title="${Item.CharaName}">${TruncateText(
              Item.CharaName,
              15,
            )}</td><td>${GetKeyInfo('Gender', Item.Gender)}</td><td>${
              Item.Age || '-'
            }</td><td>${Item.RaceName || '-'}</td><td>${
              Item.OrgName || '-'
            }</td><td>${FormatTimestamp(Item.RegistDate)}</td>`
            Row.addEventListener('dblclick', () =>
              SelectCharacter(StartIndex + Index),
            )
            Tbody.appendChild(Row)
          })
        }
        Table.appendChild(Tbody)
        TableArea.innerHTML = ''
        TableArea.appendChild(Table)
        PaginationArea.innerHTML = ''
        PaginationArea.appendChild(
          CreatePagination(CharacterList.length, CurrentPage, (Page) => {
            CurrentPage = Page
            RenderCharacterTable()
          }),
        )
      }

      function SelectCharacter(Index) {
        const Item = CharacterList[Index]
        SelectedCharacterId = Item.CharaId
        document.getElementById('CharaName').value = Item.CharaName || ''
        document.getElementById('CharaGender').value = Item.Gender || 0
        document.getElementById('CharaBirthDate').value = Item.BirthDate || ''
        document.getElementById('CharaAge').value = Item.Age || ''
        document.getElementById('CharaHeight').value = Item.Height || ''
        document.getElementById('CharaWeight').value = Item.Weight || ''
        document.getElementById('CharaBloodType').value = Item.BloodType || ''
        document.getElementById('CharaFirstPerson').value =
          Item.FirstPerson || ''
        document.getElementById('CharaSecondPerson').value =
          Item.SecondPerson || ''
        document.getElementById('CharaRoleInfo').value = TruncateText(
          Item.RoleInfo,
          30,
        )
        document.getElementById('CharaRoleInfoHidden').value =
          Item.RoleInfo || ''
        document.getElementById('CharaRace').value = Item.RaceId || ''
        document.getElementById('CharaOrganization').value = Item.OrgId || ''
        document.getElementById('CharaTeam').value = Item.TeamId || ''
        document.getElementById('CharaClass').value = Item.ClassId || ''
        document.getElementById('CharaPersonality').value = TruncateText(
          Item.Personality,
          30,
        )
        document.getElementById('CharaPersonalityHidden').value =
          Item.Personality || ''
        document.getElementById('CharaBiography').value = TruncateText(
          Item.Biography,
          30,
        )
        document.getElementById('CharaBiographyHidden').value =
          Item.Biography || ''
        if (Item.ImgPath) {
          const ImageBox = document.getElementById('CharaImageBox')
          ImageBox.innerHTML = `<img src="${Item.ImgPath}" alt="キャラ画像">`
          document.getElementById('CharaImagePath').value = Item.ImgPath
        }
        const DeleteBtn = document.getElementById('CharaDeleteButton')
        if (DeleteBtn) DeleteBtn.classList.remove('Hidden')
      }

      function ClearCharacterForm() {
        SelectedCharacterId = null
        document.getElementById('CharaName').value = ''
        document.getElementById('CharaGender').value = 0
        document.getElementById('CharaBirthDate').value = ''
        document.getElementById('CharaAge').value = ''
        document.getElementById('CharaHeight').value = ''
        document.getElementById('CharaWeight').value = ''
        document.getElementById('CharaBloodType').value = ''
        document.getElementById('CharaFirstPerson').value = ''
        document.getElementById('CharaSecondPerson').value = ''
        document.getElementById('CharaRoleInfo').value = ''
        document.getElementById('CharaRoleInfoHidden').value = ''
        document.getElementById('CharaRace').value = ''
        document.getElementById('CharaOrganization').value = ''
        document.getElementById('CharaTeam').value = ''
        document.getElementById('CharaClass').value = ''
        document.getElementById('CharaPersonality').value = ''
        document.getElementById('CharaPersonalityHidden').value = ''
        document.getElementById('CharaBiography').value = ''
        document.getElementById('CharaBiographyHidden').value = ''
        document.getElementById(
          'CharaImageBox',
        ).innerHTML = `<div class="ImageBoxPlaceholder"><i class="fas fa-user"></i><div>クリックで画像選択</div></div>`
        document.getElementById('CharaImagePath').value = ''
        document.getElementById('CharaImageInput').value = ''
        const DeleteBtn = document.getElementById('CharaDeleteButton')
        if (DeleteBtn) DeleteBtn.classList.add('Hidden')
      }

      async function SaveCharacter() {
        const CharaName = document.getElementById('CharaName').value.trim()
        if (!CharaName) {
          await ShowErrorDialog('キャラ名を入力してください')
          return
        }
        try {
          const FormData = new window.FormData()
          FormData.append('CharaId', SelectedCharacterId || '')
          FormData.append('WorkId', sessionStorage.getItem('WorkId'))
          FormData.append('CharaName', CharaName)
          FormData.append(
            'Gender',
            document.getElementById('CharaGender').value,
          )
          FormData.append(
            'BirthDate',
            document.getElementById('CharaBirthDate').value,
          )
          FormData.append('Age', document.getElementById('CharaAge').value)
          FormData.append(
            'Height',
            document.getElementById('CharaHeight').value,
          )
          FormData.append(
            'Weight',
            document.getElementById('CharaWeight').value,
          )
          FormData.append(
            'BloodType',
            document.getElementById('CharaBloodType').value,
          )
          FormData.append(
            'FirstPerson',
            document.getElementById('CharaFirstPerson').value,
          )
          FormData.append(
            'SecondPerson',
            document.getElementById('CharaSecondPerson').value,
          )
          FormData.append(
            'RoleInfo',
            document.getElementById('CharaRoleInfoHidden').value,
          )
          FormData.append('RaceId', document.getElementById('CharaRace').value)
          FormData.append(
            'OrgId',
            document.getElementById('CharaOrganization').value,
          )
          FormData.append('TeamId', document.getElementById('CharaTeam').value)
          FormData.append(
            'ClassId',
            document.getElementById('CharaClass').value,
          )
          FormData.append(
            'Personality',
            document.getElementById('CharaPersonalityHidden').value,
          )
          FormData.append(
            'Biography',
            document.getElementById('CharaBiographyHidden').value,
          )
          FormData.append('UserId', sessionStorage.getItem('UserId'))
          const ImageInput = document.getElementById('CharaImageInput')
          if (ImageInput.files[0]) FormData.append('Image', ImageInput.files[0])
          ShowSpinner()
          const Response = await fetch(`${API_BASE_URL}/SaveCharacter.php`, {
            method: 'POST',
            body: FormData,
          })
          const Result = await Response.json()
          HideSpinner()
          if (Result.Success) {
            await ShowInfoDialog('保存完了', 'キャラ情報を保存しました')
            ClearCharacterForm()
            await LoadCharacterList()
          } else {
            await ShowErrorDialog(Result.Message || '保存に失敗しました')
          }
        } catch (Error) {
          HideSpinner()
          await ShowErrorDialog('保存中にエラーが発生しました')
        }
      }

      async function DeleteCharacter() {
        if (!SelectedCharacterId) return
        if (!(await ShowConfirmDialog('このキャラを削除しますか？'))) return
        try {
          const Response = await CallApi('/DeleteCharacter.php', 'POST', {
            CharaId: SelectedCharacterId,
            UserId: sessionStorage.getItem('UserId'),
          })
          if (Response.Success) {
            await ShowInfoDialog('削除完了', 'キャラを削除しました')
            ClearCharacterForm()
            await LoadCharacterList()
          } else {
            await ShowErrorDialog(Response.Message || '削除に失敗しました')
          }
        } catch (Error) {
          await ShowErrorDialog('削除中にエラーが発生しました')
        }
      }

      /* ==========================================================================
       * 組織設定画面
       * ========================================================================== */
      /* ---------------------------------------------
       *  1. 定義
       * --------------------------------------------- */
      // 1. 組織一覧の内容を保持する
      let OrganizationList = []
      // 2. 建物一覧の内容を保持する
      let BuildListForOrg = []
      // 3. 選択中の組織IDを保持する
      let SelectedOrgId = null

      /**
       * 組織設定画面を表示
       **/
      async function ShowOrganizationSetting() {
        /* ---------------------------------------------
         *  1. 定義
         * --------------------------------------------- */
        // 1. 現座標次ページ
        CurrentPage = 1
        // 2. 選択中の組織IDを初期化
        SelectedOrgId = null
        // 3. コンテンツ表示エリア要素取得
        const ContentArea = document.getElementById('ContentArea')
        // 4. 編集権限確認
        const CanEditFlg = CanEdit()

        /* ---------------------------------------------
         *  2. DOM構築
         * --------------------------------------------- */
        ContentArea.innerHTML = `
              ${CreateContentHeader('組織設定', 'building')}
              <div class="FormRow">
                <div class="FormGroup Flex1">
                  <div class="ImageBox" id="OrgImageBox">
                    <div class="ImageBoxPlaceholder">
                      <i class="fas fa-building"></i>
                      <div>クリックで画像選択</div>
                    </div>
                  </div>
                </div>
              </div>
              <input type="file" id="OrgImageInput" accept="image/*" style="display:none;">
              <input type="hidden" id="OrgImagePath">
              <div class="FormRow">
                <div class="FormGroup Flex1">
                  <input type="text" class="InputForm" id="OrgName" placeholder="組織名" maxlength="255" ${
                    !CanEditFlg ? 'disabled' : ''
                  }>
                </div>
                <div class="FormGroup Flex1">
                  <select class="SelectForm" id="OrgBaseBuild" ${
                    !CanEditFlg ? 'disabled' : ''
                  }>
                    <option value="">拠点建物を選択</option>
                  </select>
                </div>
              </div>
              <div class="FormRow">
                <div class="FormGroup Flex1 InputWithButton">
                  <input type="text" class="InputForm" id="OrgFoundedDate" placeholder="設立日" readonly ${
                    !CanEditFlg ? 'disabled' : ''
                  }>
                  ${
                    CanEditFlg
                      ? `<button class="ButtonClass SecondaryButton ButtonSmall" id="OrgFoundedDateBtn"><i class="fas fa-calendar"></i></button>`
                      : ''
                  }
                </div>
                <div class="FormGroup Flex1">
                  <input type="text" class="InputForm" id="OrgPeopleNum" placeholder="人数" maxlength="50" ${
                    !CanEditFlg ? 'disabled' : ''
                  }>
                </div>
              </div>
              <div class="FormGroup InputWithButton">
                <input type="text" class="InputForm" id="OrgPurpose" placeholder="目的" disabled>
                <button class="ButtonClass SecondaryButton ButtonSmall" id="OrgPurposeBtn"><i class="fas fa-edit"></i></button>
              </div>
              <input type="hidden" id="OrgPurposeHidden">
              <div class="FormGroup InputWithButton">
                <input type="text" class="InputForm" id="OrgActivity" placeholder="活動内容" disabled>
                <button class="ButtonClass SecondaryButton ButtonSmall" id="OrgActivityBtn"><i class="fas fa-edit"></i></button>
              </div>
              <input type="hidden" id="OrgActivityHidden">
              ${
                CanEditFlg
                  ? `
              <div class="ButtonGroup">
                <button class="ButtonClass ClearButton" id="OrgClearButton"><i class="fas fa-sync"></i> クリア</button>
                <button class="ButtonClass SaveButton" id="OrgSaveButton"><i class="fas fa-save"></i> 保存</button>
                <button class="ButtonClass DeleteButton Hidden" id="OrgDeleteButton"><i class="fas fa-trash"></i> 削除</button>
              </div>
              `
                  : ''
              }
              <div id="RecordCountArea" class="MarginTop20"></div>
              <div class="TableContainer" id="OrgTableArea"></div>
              <div id="PaginationArea"></div>
            `

        /* ---------------------------------------------
         *  3. 編集可能な場合
         * --------------------------------------------- */
        if (CanEditFlg) {
          /* 1. 定義 */
          // 1. デートピッカーインスタンス
          const DatePickerInstance = new DatePicker()

          /* 2.イベント登録 */
          // 1. 発生時期ボタンクリックイベント
          document
            .getElementById('OrgFoundedDateBtn')
            .addEventListener('click', () =>
              DatePickerInstance.OpenDialog('OrgFoundedDate'),
            )
          // 2. 目的入力欄詳細ボタンクリックイベント
          document
            .getElementById('OrgPurposeBtn')
            .addEventListener('click', async () => {
              const Result = await ShowInputAreaDialog(
                document.getElementById('OrgPurposeHidden').value,
                !CanEditFlg,
              )
              if (Result !== null && CanEditFlg) {
                document.getElementById('OrgPurposeHidden').value = Result
                document.getElementById('OrgPurpose').value = TruncateText(
                  Result,
                  30,
                )
              }
            })
          // 3. 活動内容入力欄詳細ボタンクリックイベント
          document
            .getElementById('OrgActivityBtn')
            .addEventListener('click', async () => {
              const Result = await ShowInputAreaDialog(
                document.getElementById('OrgActivityHidden').value,
                !CanEditFlg,
              )
              if (Result !== null && CanEditFlg) {
                document.getElementById('OrgActivityHidden').value = Result
                document.getElementById('OrgActivity').value = TruncateText(
                  Result,
                  30,
                )
              }
            })
          // 4. 画像ボックスクリックイベント
          document
            .getElementById('OrgImageBox')
            .addEventListener('click', async () => {
              const OrgImageBox = document.getElementById('OrgImageBox')
              const ImgElement = OrgImageBox.querySelector('img')

              if (!ImgElement) {
                document.getElementById('OrgImageInput').click()
                return
              }

              const Deleted = await ShowImageDialog(ImgElement.src, CanEdit())

              if (Deleted) {
                OrgImageBox.innerHTML = `
                    <div class="ImageBoxPlaceholder">
                      <i class="fas fa-building"></i>
                      <div>クリックで画像選択</div>
                    </div>
                  `
                document.getElementById('OrgImagePath').value = ''
                document.getElementById('OrgImageInput').value = ''
              }
            })
          // 5. 画像入力変更イベント
          document
            .getElementById('OrgImageInput')
            .addEventListener('change', HandleOrgImageChange)
          // 6. クリアボタンクリックイベント
          document
            .getElementById('OrgClearButton')
            .addEventListener('click', ClearOrgForm)
          // 7. 保存ボタンクリックイベント
          document
            .getElementById('OrgSaveButton')
            .addEventListener('click', SaveOrganization)
          // 8. 削除ボタンクリックイベント
          document
            .getElementById('OrgDeleteButton')
            .addEventListener('click', DeleteOrganization)
        } else {
          /* ---------------------------------------------
           *  4. 編集不可能な場合
           * --------------------------------------------- */
          // 1. 目的入力欄詳細ボタンクリックイベント
          document
            .getElementById('OrgPurposeBtn')
            .addEventListener('click', async () => {
              const Result = await ShowInputAreaDialog(
                document.getElementById('OrgPurposeHidden').value,
                false,
              )
              if (Result !== null && CanEditFlg) {
                document.getElementById('OrgPurposeHidden').value = Result
                document.getElementById('OrgPurpose').value = TruncateText(
                  Result,
                  30,
                )
              }
            })
          // 2. 活動内容入力欄詳細ボタンクリックイベント
          document
            .getElementById('OrgActivityBtn')
            .addEventListener('click', async () => {
              const Result = await ShowInputAreaDialog(
                document.getElementById('OrgActivityHidden').value,
                false,
              )
              if (Result !== null && CanEditFlg) {
                document.getElementById('OrgActivityHidden').value = Result
                document.getElementById('OrgActivity').value = TruncateText(
                  Result,
                  30,
                )
              }
            })
        }
        /* ---------------------------------------------
         *  5. 一覧取得処理呼び出し
         * --------------------------------------------- */
        await LoadOrganizationList()
      }

      /**
       * 組織一覧取得処理
       * **/
      async function LoadOrganizationList() {
        try {
          /* ---------------------------------------------
           *  1. 定義
           * --------------------------------------------- */
          // 1. 作品ID取得
          const WorkId = sessionStorage.getItem('WorkId')
          // 2. API呼び出し
          const Response = await CallApi(
            `/GetOrganizationList.php?WorkId=${encodeURIComponent(
              WorkId,
            )}&UserId=${encodeURIComponent(sessionStorage.getItem('UserId'))}`,
            'GET',
          )

          /* ---------------------------------------------
           *  2. 通信成功
           * --------------------------------------------- */
          if (Response.Success) {
            // 1. 組織一覧を保持
            OrganizationList = Response.Data.OrganizationList || []
            // 2. 建物一覧を保持
            BuildListForOrg = Response.Data.BuildList || []
            // 3. 建物プルダウンの内容更新
            UpdateBuildSelect()
            // 4. 組織一覧表示
            RenderOrganizationTable()
          } else {
            /* ---------------------------------------------
             *  3. 通信失敗
             * --------------------------------------------- */
            // 1. エラーダイアログ表示
            await ShowErrorDialog(
              Response.Message || '組織一覧の取得に失敗しました',
            )
          }
        } catch (Error) {
          /* ---------------------------------------------
           *  4. 例外処理
           * --------------------------------------------- */
          // 1. エラーダイアログ
          await ShowErrorDialog('組織一覧の取得中にエラーが発生しました')
          // 2. デバッグログ
          console.error(Error)
        }
      }

      /**
       * 建物プルダウン更新処理
       **/
      function UpdateBuildSelect() {
        /* ---------------------------------------------
         *  1. 定義
         * --------------------------------------------- */
        // 1. 建物のプルダウン要素取得
        const Select = document.getElementById('OrgBaseBuild')

        /* ---------------------------------------------
         *  2. バリデーションチェック
         * --------------------------------------------- */
        /* 1. 建物のプルダウン要素が存在しない場合 */
        if (!Select) {
          // 1. 処理終了
          return
        }

        /* ---------------------------------------------
         *  3. DOM構築
         * --------------------------------------------- */
        Select.innerHTML =
          '<option value="">拠点建物を選択</option>' +
          BuildListForOrg.map(
            (Build) =>
              `<option value="${Build.BuildId}">${Build.BuildName}</option>`,
          ).join('')
      }

      /**
       * 組織一覧表示処理
       **/
      function RenderOrganizationTable() {
        /* ---------------------------------------------
         *  1. 定義
         * --------------------------------------------- */
        // 1. 件数取得
        const TotalCount = OrganizationList.length
        // 1. 件数表示エリアに件数を定義
        document.getElementById(
          'RecordCountArea',
        ).innerHTML = `<span class="RecordCount">${TotalCount} 件</span>`
        // 3. ページング表示開始ページ
        const Start = (CurrentPage - 1) * RECORDS_PER_PAGE
        // 4. ページング表示終了ページ
        const End = Math.min(Start + RECORDS_PER_PAGE, TotalCount)
        // 5. ページング表示データ
        const PageData = OrganizationList.slice(Start, End)
        // 6. テーブルヘッダー定義
        let TableHtml = `
              <table class="DataTable">
                <thead><tr><th>組織名</th><th>拠点</th><th>人数</th><th>設立日</th></tr></thead>
                <tbody>
            `
        /* ---------------------------------------------
         *  2. 件数が1件以上存在する場合
         * --------------------------------------------- */
        if (PageData.length) {
          // 1. ページング行を追加
          TableHtml += PageData.map(
            (Org) => `
                  <tr data-id="${Org.OrgId}">
                    <td>${EscapeHtml(Org.OrgName)}</td>
                    <td>${EscapeHtml(Org.BuildName || '')}</td>
                    <td>${EscapeHtml(Org.PeopleNum || '')}</td>
                    <td>${FormatDateTimeWithWeekday(Org.FoundedDate)}</td>
                  </tr>
                `,
          ).join('')
        } else {
          /* ---------------------------------------------
           *  3. 件数が0件の場合
           * --------------------------------------------- */
          // 1. データなし行を追加
          TableHtml +=
            '<tr><td colspan="4" class="NoData">データがありません</td></tr>'
        }
        /* ---------------------------------------------
         *  4. 閉じタグ作成
         * --------------------------------------------- */
        TableHtml += '</tbody></table>'

        /* ---------------------------------------------
         *  5. テーブルDOMをテーブル表示エリアに設定
         * --------------------------------------------- */
        document.getElementById('OrgTableArea').innerHTML = TableHtml

        /* ---------------------------------------------
         *  6. 行ダブルクリックイベント
         * --------------------------------------------- */
        document
          .querySelectorAll('#OrgTableArea tbody tr[data-id]')
          .forEach((Row) => {
            Row.addEventListener('dblclick', () =>
              // 1. 組織選択処理呼び出し
              SelectOrganization(Row.dataset.id),
            )
          })

        /* ---------------------------------------------
         *  7. ページネーションDOM構築
         * --------------------------------------------- */
        // 1. ページネーション表示エリア取得
        const PaginationArea = document.getElementById('PaginationArea')
        // 2. ページネーション表示エリア初期化
        PaginationArea.innerHTML = ''
        // 3. ページネーションDOMをページネーション表示エリアに設定
        PaginationArea.appendChild(
          CreatePagination(TotalCount, CurrentPage, (Page) => {
            CurrentPage = Page
            RenderOrganizationTable()
          }),
        )
      }

      /**
       * 組織選択処理
       **/
      function SelectOrganization(OrgId) {
        /* ---------------------------------------------
         *  1. 定義
         * --------------------------------------------- */
        // 1. 選択行の情報を取得
        const Item = OrganizationList.find((Org) => Org.OrgId == OrgId)

        /* ---------------------------------------------
         *  2. バリデーションチェック
         * --------------------------------------------- */
        /* 1. 選択行情報が取得できなかった場合 */
        if (!Item) {
          // 1. 処理終了
          return
        }

        /* ---------------------------------------------
         *  3. 選択行情報を入力フォームへ設定
         * --------------------------------------------- */
        // 1. 組織IDを設定
        SelectedOrgId = OrgId
        // 2. 組織名を設定
        document.getElementById('OrgName').value = Item.OrgName || ''
        // 3. 拠点建物プルダウンの値を設定
        document.getElementById('OrgBaseBuild').value = Item.BaseBuildId || ''
        // 4. 組織設立年月日
        document.getElementById('OrgFoundedDate').value = Item.FoundedDate || ''
        // 5. 人員数を設定
        document.getElementById('OrgPeopleNum').value = Item.PeopleNum || ''
        // 6. 目的を設定
        document.getElementById('OrgPurpose').value = TruncateText(
          Item.Purpose || '',
          30,
        )
        // 7. 目的をDB登録用フォームへ設定
        document.getElementById('OrgPurposeHidden').value = Item.Purpose || ''
        // 8. 活動内容を設定
        document.getElementById('OrgActivity').value = TruncateText(
          Item.Activity || '',
          30,
        )
        // 9. 活動内容をDB登録用フォームへ設定
        document.getElementById('OrgActivityHidden').value = Item.Activity || ''

        /* ---------------------------------------------
         *  4. 画像パスが存在する場合
         * --------------------------------------------- */
        if (Item.ImgPath) {
          // 1. 画像パスの画像を設定
          document.getElementById(
            'OrgImageBox',
          ).innerHTML = `<img src="${API_BASE_URL}${Item.ImgPath}" alt="組織画像">`
        }

        /* ---------------------------------------------
         *  5. 削除ボタンの状態設定
         * --------------------------------------------- */
        // 1. 削除ボタンの取得
        const DeleteBtn = document.getElementById('OrgDeleteButton')
        // 2. 削除ボタンが存在する場合は表示
        if (DeleteBtn) {
          DeleteBtn.classList.remove('Hidden')
        }
      }

      /**
       * 組織入力フォームクリア処理
       **/
      function ClearOrgForm() {
        // 1. 選択中組織ID初期化
        SelectedOrgId = null
        // 2. 組織名初期化
        document.getElementById('OrgName').value = ''
        // 3. 拠点建物初期化
        document.getElementById('OrgBaseBuild').value = ''
        // 4. 組織設立年月日初期化
        document.getElementById('OrgFoundedDate').value = ''
        // 5. 人員数初期化
        document.getElementById('OrgPeopleNum').value = ''
        // 6. 目的初期化
        document.getElementById('OrgPurpose').value = ''
        // 7. 目的(DB登録用)初期化
        document.getElementById('OrgPurposeHidden').value = ''
        // 8. 活動内容初期化
        document.getElementById('OrgActivity').value = ''
        // 9. 活動内容(DB登録用)初期化
        document.getElementById('OrgActivityHidden').value = ''
        // 10.画像ボックス初期化
        document.getElementById(
          'OrgImageBox',
        ).innerHTML = `<div class="ImageBoxPlaceholder"><i class="fas fa-builder"></i><div>クリックで画像選択</div></div>`
        // 11.画像パス初期化
        document.getElementById('OrgImagePath').value = ''
        // 12.画像入力フォーム(ファイルイベント発火用)初期化
        document.getElementById('OrgImageInput').value = ''
        // 13.削除ボタン要素取得
        const DeleteBtn = document.getElementById('OrgDeleteButton')
        // 14.削除ボタンが存在すれば非表示
        if (DeleteBtn) {
          DeleteBtn.classList.add('Hidden')
        }
      }

      /**
       * 組織保存処理
       **/
      async function SaveOrganization() {
        /* ---------------------------------------------
         *  1. 定義
         * --------------------------------------------- */
        // 1. 組織名取得
        const OrgName = document.getElementById('OrgName').value.trim()
        // 2. 組織設立年月日取得
        const FoundedDate = document
          .getElementById('OrgFoundedDate')
          .value.trim()
        // 3. 人員数
        const PeopleNum = document.getElementById('OrgPeopleNum').value.trim()
        // 4. 目的取得
        const Purpose = document.getElementById('OrgPurposeHidden').value.trim()
        // 5. 活動内容取得
        const Activity = document
          .getElementById('OrgActivityHidden')
          .value.trim()
        // 6. 拠点建物ID取得
        const BaseBuildId = document.getElementById('OrgBaseBuild').value.trim()
        // 7. 選択中の組織ID取得
        const OrgId = SelectedOrgId || ''
        // 8. 画像ファイル取得
        const ImageInput =
          document.getElementById('OrgImageInput').files[0] || null

        /* ---------------------------------------------
         *  2. バリデーションチェック
         * --------------------------------------------- */
        /* 1. 組織名が未入力の場合 */
        if (!OrgName) {
          // 1. エラーダイアログ表示
          await ShowErrorDialog('組織名を入力してください')
          // 2. 処理終了
          return
        }

        /* ---------------------------------------------
         *  3. API通信
         * --------------------------------------------- */
        try {
          /* 1. スピナー表示 */
          ShowSpinner()

          /* 2. API呼び出し */
          const Response = await CallApi('/SaveOrganization.php', 'POST', {
            // 1. 組織名
            OrgName: OrgName,
            // 2. 作品ID
            WorkId: sessionStorage.getItem('WorkId'),
            // 3. ユーザーID
            UserId: sessionStorage.getItem('UserId'),
            // 4. 組織設立年月日
            FoundedDate: FoundedDate,
            // 5. 人員数
            PeopleNum: PeopleNum,
            // 6. 目的
            Purpose: Purpose,
            // 7. 活動内容
            Activity: Activity,
            // 8. 拠点建物ID
            BaseBuildId: BaseBuildId,
            // 9. 組織ID
            OrgId: OrgId,
            // 10.選択された画像
            Image: ImageInput ? 'Attached' : '',
          })

          /* 2. スピナー削除 */
          HideSpinner()

          /* 3. 通信成功 */
          if (Response.Success) {
            // 1. 情報ダイアログ表示{
            await ShowInfoDialog('保存完了', Response.Data.Message)
            // 2. 入力フォームクリア
            ClearOrgForm()
            // 3. 組織一覧再取得
            await LoadOrganizationList()
          } else {
            /* 4. 通信失敗 */
            // 1. エラーダイアログ表示
            await ShowErrorDialog(Response.Message || '保存に失敗しました')
          }
        } catch (Error) {
          /* ---------------------------------------------
           *  4. 例外処理
           * --------------------------------------------- */
          // 1. スピナー削除
          HideSpinner()
          // 2. エラーダイアログ表示
          await ShowErrorDialog('保存中にエラーが発生しました')
          // 3. デバッグログ
          console.error(Error)
        }
      }

      /**
       * 組織一覧の削除処理
       **/
      async function DeleteOrganization() {
        /* ---------------------------------------------
         *  1. バリデーションチェック
         * --------------------------------------------- */
        /* 1. 選択された組織IDが取得できない場合 */
        if (!SelectedOrgId) {
          // 1. 処理終了
          return
        }

        /* ---------------------------------------------
         *  2. コンファームにていいえが選択された場合
         * --------------------------------------------- */
        if (!(await ShowConfirmDialog('この組織を削除しますか？'))) {
          // 1. 処理終了
          return
        }

        /* ---------------------------------------------
         *  3. API通信
         * --------------------------------------------- */
        try {
          /* 1. スピナー表示 */
          ShowSpinner()

          /* 2. API呼び出し */
          const Response = await CallApi('/DeleteOrganization.php', 'POST', {
            // 1. 組織ID
            OrgId: SelectedOrgId,
            // 2. 作品ID
            WorkId: sessionStorage.getItem('WorkId'),
            // 3. ユーザーID
            UserId: sessionStorage.getItem('UserId'),
          })

          /* 3. スピナー削除 */
          HideSpinner()

          /* 4. 通信成功 */
          if (Response.Success) {
            // 1. インフォダイアログ表示
            await ShowInfoDialog('削除完了', '組織を削除しました')
            // 2. 入力フォーム初期化
            ClearOrgForm()
            // 3. 崇徳処理再発火
            await LoadOrganizationList()
          } else {
            /* 5. 通信失敗 */
            await ShowErrorDialog(Response.Message || '削除に失敗しました')
          }
        } catch (Error) {
          /* ---------------------------------------------
           *  4. 例外処理
           * --------------------------------------------- */
          // 1. スピナー削除
          HideSpinner()
          // 2. エラーダイアログ
          await ShowErrorDialog('削除中にエラーが発生しました')
        }
      }

      /**
       * 画像変更時処理
       **/
      function HandleOrgImageChange(Event) {
        /* ---------------------------------------------
         *  1. 定義
         * --------------------------------------------- */
        // 1. 選択されたファイル取得
        const File = Event.target.files[0]

        /* ---------------------------------------------
         *  2. バリデーションチェック
         * --------------------------------------------- */
        /* 1. ファイルが存在しない場合 */
        if (!File) {
          // 1. 処理終了
          return
        }

        /* ---------------------------------------------
         *  3. ファイル読み取り用定義
         * --------------------------------------------- */
        // 1. FileReaderインスタンス作成
        const Reader = new FileReader()

        /* ---------------------------------------------
         *  4. ファイル読み取り処理
         * --------------------------------------------- */
        Reader.onload = function (Event) {
          /* 1. 定義 */
          // 1. 画像ボックス要素取得
          const ImageBox = document.getElementById('OrgImageBox')
          // 2. 画像ボックスに画像を設定
          ImageBox.innerHTML = `<img src="${Event.target.result}" alt="組織画像">`

          /* 2. 画像ボックスクリックイベント */
          ImageBox.onclick(async () => {
            /* 定義 */
            // 1. 画像ダイアログにて選択された操作の状態を保持する
            const Deleted = await ShowImageDialog(
              Event.target.result,
              CanEdit(),
            )

            /* 削除の操作が選択された場合 */
            if (Deleted) {
              // 1. 画像ソースを初期化
              ImageBox.innerHTML = `<div class="ImageBoxPlaceholder"><i class="fas fa-building"></i><div>クリックで画像選択</div></div>`
              // 2. 画像パス初期化
              document.getElementById('OrgImagePath').value = ''
              // 3. 画像入力フォーム(ファイルイベント発火用)初期化
              document.getElementById('OrgImageInput').value = ''
            }
          })
        }
        Reader.readAsDataURL(File)
      }

      /* ==========================================================================
       * チーム設定画面
       * ========================================================================== */
      let TeamList = []
      let OrgListForTeam = []
      let SelectedTeamId = null

      async function ShowTeamSetting() {
        CurrentPage = 1
        SelectedTeamId = null
        const ContentArea = document.getElementById('ContentArea')
        const CanEditFlg = CanEdit()

        ContentArea.innerHTML = `
              ${CreateContentHeader('チーム設定', 'users')}
              <div class="FormRow">
                <div class="Flex1">
                  <div class="ImageBox" id="TeamImageBox">
                    <div class="ImageBoxPlaceholder">
                      <i class="fas fa-users"></i>
                      <div>クリックで画像選択</div>
                    </div>
                  </div>
                </div>
              </div>
              <input type="file" id="TeamImageInput" accept="image/*" style="display:none;">
              <input type="hidden" id="TeamImagePath">
              <div class="FormRow">
                <div class="FormGroup Flex1">
                  <input type="text" class="InputForm" id="TeamName" placeholder="チーム名" maxlength="150" ${
                    !CanEditFlg ? 'disabled' : ''
                  }>
                </div>
                <div class="FormGroup Flex1">
                  <select class="SelectForm" id="TeamOrgId" ${
                    !CanEditFlg ? 'disabled' : ''
                  }>
                    <option value="">所属組織を選択</option>
                  </select>
                </div>
              </div>
              <div class="FormGroup InputWithButton">
                <input type="text" class="InputForm" id="TeamDescription" placeholder="説明" disabled>
                <button class="ButtonClass SecondaryButton ButtonSmall" id="TeamDescriptionBtn"><i class="fas fa-edit"></i></button>
              </div>
              <input type="hidden" id="TeamDescriptionHidden">
              ${
                CanEditFlg
                  ? `
              <div class="ButtonGroup">
                <button class="ButtonClass ClearButton" id="TeamClearButton"><i class="fas fa-sync"></i> クリア</button>
                <button class="ButtonClass SaveButton" id="TeamSaveButton"><i class="fas fa-save"></i> 保存</button>
                <button class="ButtonClass DeleteButton Hidden" id="TeamDeleteButton"><i class="fas fa-trash"></i> 削除</button>
              </div>
              `
                  : ''
              }
              <div id="RecordCountArea" class="MarginTop20"></div>
              <div class="TableContainer" id="TeamTableArea"></div>
              <div id="PaginationArea"></div>
            `

        if (CanEditFlg) {
          document
            .getElementById('TeamDescriptionBtn')
            .addEventListener('click', async () => {
              const Result = await ShowInputAreaDialog(
                document.getElementById('TeamDescriptionHidden').value,
                false,
              )
              if (Result !== null && CanEditFlg) {
                document.getElementById('TeamDescriptionHidden').value = Result
                document.getElementById('TeamDescription').value = TruncateText(
                  Result,
                  30,
                )
              }
            })

          // 4. 画像ボックスクリックイベント
          document
            .getElementById('TeamImageBox')
            .addEventListener('click', async () => {
              const TeamImageBox = document.getElementById('TeamImageBox')
              const ImgElement = TeamImageBox.querySelector('img')

              if (!ImgElement) {
                document.getElementById('TeamImageInput').click()
                return
              }

              const Deleted = await ShowImageDialog(ImgElement.src, CanEdit())

              if (Deleted) {
                TeamImageBox.innerHTML = `
                    <div class="ImageBoxPlaceholder">
                      <i class="fas fa-users"></i>
                      <div>クリックで画像選択</div>
                    </div>
                  `
                document.getElementById('TeamImagePath').value = ''
                document.getElementById('TeamImageInput').value = ''
              }
            })
          // 5. 画像入力変更イベント

          document
            .getElementById('TeamImageInput')
            .addEventListener('change', HandleTeamOrgImageChange)
          document
            .getElementById('TeamClearButton')
            .addEventListener('click', ClearTeamForm)
          document
            .getElementById('TeamSaveButton')
            .addEventListener('click', SaveTeam)
          document
            .getElementById('TeamDeleteButton')
            .addEventListener('click', DeleteTeam)
        } else {
          document
            .getElementById('TeamDescriptionBtn')
            .addEventListener('click', () =>
              ShowInputAreaDialog(
                'TeamDescription',
                'TeamDescriptionHidden',
                false,
              ),
            )
        }

        await LoadTeamList()
      }

      async function LoadTeamList() {
        try {
          const WorkId = sessionStorage.getItem('WorkId')
          const Response = await CallApi(
            `/GetTeamList.php?WorkId=${encodeURIComponent(
              WorkId,
            )}&UserId=${encodeURIComponent(sessionStorage.getItem('UserId'))}`,
            'GET',
          )
          if (Response.Success) {
            TeamList = Response.Data.TeamList || []
            OrgListForTeam = Response.Data.OrganizationList || []
            UpdateTeamOrgSelect()
            RenderTeamTable()
          } else {
            await ShowErrorDialog(
              Response.Message || 'チーム一覧の取得に失敗しました',
            )
          }
        } catch (Error) {
          console.error(Error)
          await ShowErrorDialog('チーム一覧の取得中にエラーが発生しました')
        }
      }
      /**
       * チーム画像変更時処理
       **/
      function HandleTeamOrgImageChange(Event) {
        /* ---------------------------------------------
         *  1. 定義
         * --------------------------------------------- */
        // 1. 選択されたファイル取得
        const File = Event.target.files[0]

        /* ---------------------------------------------
         *  2. バリデーションチェック
         * --------------------------------------------- */
        /* 1. ファイルが存在しない場合 */
        if (!File) {
          // 1. 処理終了
          return
        }

        /* ---------------------------------------------
         *  3. ファイル読み取り用定義
         * --------------------------------------------- */
        // 1. FileReaderインスタンス作成
        const Reader = new FileReader()

        /* ---------------------------------------------
         *  4. ファイル読み取り処理
         * --------------------------------------------- */
        Reader.onload = function (Event) {
          /* 1. 定義 */
          // 1. 画像ボックス要素取得
          const ImageBox = document.getElementById('TeamImageBox')
          // 2. 画像ボックスに画像を設定
          ImageBox.innerHTML = `<img src="${Event.target.result}" alt="チーム画像">`

          /* 2. 画像ボックスクリックイベント */
          ImageBox.onclick(async () => {
            /* 定義 */
            // 1. 画像ダイアログにて選択された操作の状態を保持する
            const Deleted = await ShowImageDialog(
              Event.target.result,
              CanEdit(),
            )

            /* 削除の操作が選択された場合 */
            if (Deleted) {
              // 1. 画像ソースを初期化
              ImageBox.innerHTML = `<div class="ImageBoxPlaceholder"><i class="fas fa-users"></i><div>クリックで画像選択</div></div>`
              // 2. 画像パス初期化
              document.getElementById('TeamImagePath').value = ''
              // 3. 画像入力フォーム(ファイルイベント発火用)初期化
              document.getElementById('TeamImageInput').value = ''
            }
          })
        }
        Reader.readAsDataURL(File)
      }

      function UpdateTeamOrgSelect() {
        const Select = document.getElementById('TeamOrgId')
        if (!Select) return
        Select.innerHTML =
          '<option value="">所属組織を選択</option>' +
          OrgListForTeam.map(
            (O) => `<option value="${O.OrgId}">${O.OrgName}</option>`,
          ).join('')
      }

      function RenderTeamTable() {
        const TotalCount = TeamList.length
        document.getElementById(
          'RecordCountArea',
        ).innerHTML = `<span class="RecordCount">${TotalCount} 件</span>`
        const Start = (CurrentPage - 1) * RECORDS_PER_PAGE
        const End = Math.min(Start + RECORDS_PER_PAGE, TotalCount)
        const PageData = TeamList.slice(Start, End)
        let TableHtml = `
              <table class="DataTable">
                <thead><tr><th>チーム名</th><th>所属組織</th><th>説明</th></tr></thead>
                <tbody>
            `
        if (PageData.length) {
          TableHtml += PageData.map(
            (T) => `
                  <tr data-id="${T.TeamId}">
                    <td>${EscapeHtml(T.TeamName)}</td>
                    <td>${EscapeHtml(T.OrgName || '')}</td>
                    <td>${EscapeHtml(
                      TruncateText(T.Description || '', 30),
                    )}</td>
                  </tr>
                `,
          ).join('')
        } else {
          TableHtml +=
            '<tr><td colspan="3" class="NoData">データがありません</td></tr>'
        }
        TableHtml += '</tbody></table>'
        document.getElementById('TeamTableArea').innerHTML = TableHtml
        document
          .querySelectorAll('#TeamTableArea tbody tr[data-id]')
          .forEach((Row) => {
            Row.addEventListener('dblclick', () => SelectTeam(Row.dataset.id))
          })
        const PaginationArea = document.getElementById('PaginationArea')
        PaginationArea.innerHTML = ''
        PaginationArea.appendChild(
          CreatePagination(TotalCount, CurrentPage, (Page) => {
            CurrentPage = Page
            RenderTeamTable()
          }),
        )
      }

      function SelectTeam(TeamId) {
        const Item = TeamList.find((T) => T.TeamId == TeamId)
        if (!Item) return
        SelectedTeamId = TeamId
        document.getElementById('TeamName').value = Item.TeamName || ''
        document.getElementById('TeamOrgId').value = Item.OrgId || ''
        document.getElementById('TeamDescription').value = TruncateText(
          Item.Description || '',
          30,
        )
        document.getElementById('TeamDescriptionHidden').value =
          Item.Description || ''
        if (Item.ImgPath) {
          document.getElementById(
            'TeamImageBox',
          ).innerHTML = `<img src="${API_BASE_URL}${Item.ImgPath}" alt="チーム画像">`
        }
        const DeleteBtn = document.getElementById('TeamDeleteButton')
        if (DeleteBtn) DeleteBtn.classList.remove('Hidden')
      }

      function ClearTeamForm() {
        SelectedTeamId = null
        document.getElementById('TeamName').value = ''
        document.getElementById('TeamOrgId').value = ''
        document.getElementById('TeamDescription').value = ''
        document.getElementById('TeamDescriptionHidden').value = ''
        document.getElementById('TeamImageBox').innerHTML =
          '<span class="ImagePlaceholder"><i class="fas fa-image"></i> 画像を選択</span>'
        document.getElementById('TeamImageInput').value = ''
        const DeleteBtn = document.getElementById('TeamDeleteButton')
        if (DeleteBtn) DeleteBtn.classList.add('Hidden')
      }

      async function SaveTeam() {
        const TeamName = document.getElementById('TeamName').value.trim()
        if (!TeamName) {
          await ShowErrorDialog('チーム名を入力してください')
          return
        }
        try {
          ShowSpinner()
          const FormData = new window.FormData()
          if (SelectedTeamId) FormData.append('TeamId', SelectedTeamId)
          FormData.append('WorkId', sessionStorage.getItem('WorkId'))
          FormData.append('TeamName', TeamName)
          FormData.append('OrgId', document.getElementById('TeamOrgId').value)
          FormData.append(
            'Description',
            document.getElementById('TeamDescriptionHidden').value,
          )
          FormData.append('UserId', sessionStorage.getItem('UserId'))
          const ImageFile = document.getElementById('TeamImageInput').files[0]
          if (ImageFile) FormData.append('Image', ImageFile)
          const Response = await fetch(`${API_BASE_URL}/SaveTeam.php`, {
            method: 'POST',
            body: FormData,
          })
          const Result = await Response.json()
          HideSpinner()
          if (Result.Success) {
            await ShowInfoDialog('保存完了', Result.Data.Message)
            ClearTeamForm()
            await LoadTeamList()
          } else {
            await ShowErrorDialog(Result.Message || '保存に失敗しました')
          }
        } catch (Error) {
          HideSpinner()
          await ShowErrorDialog('保存中にエラーが発生しました')
        }
      }

      async function DeleteTeam() {
        if (!SelectedTeamId) return
        if (!(await ShowConfirmDialog('このチームを削除しますか？'))) return
        try {
          const Response = await CallApi('/DeleteTeam.php', 'POST', {
            TeamId: SelectedTeamId,
            WorkId: sessionStorage.getItem('WorkId'),
            UserId: sessionStorage.getItem('UserId'),
          })
          if (Response.Success) {
            await ShowInfoDialog('削除完了', 'チームを削除しました')
            ClearTeamForm()
            await LoadTeamList()
          } else {
            await ShowErrorDialog(Response.Message || '削除に失敗しました')
          }
        } catch (Error) {
          await ShowErrorDialog('削除中にエラーが発生しました')
        }
      }

      /* ==========================================================================
       * 種族設定画面 (3.8 RaceInfo)
       * ========================================================================== */
      let RaceList = []
      let SelectedRaceId = null

      async function ShowRaceSetting() {
        CurrentPage = 1
        SelectedRaceId = null
        const ContentArea = document.getElementById('ContentArea')
        const CanEditFlg = CanEdit()

        ContentArea.innerHTML = `
              ${CreateContentHeader('種族設定', 'dna')}
              <div class="FormRow">
                <div class="FormGroup Flex1">
                  <input type="text" class="InputForm" id="RaceName" placeholder="種族名" maxlength="150" ${
                    !CanEditFlg ? 'disabled' : ''
                  }>
                </div>
              </div>
              <div class="FormGroup InputWithButton">
                <input type="text" class="InputForm" id="RaceDescription" placeholder="説明" disabled>
                <button class="ButtonClass SecondaryButton ButtonSmall" id="RaceDescriptionBtn"><i class="fas fa-edit"></i></button>
              </div>
              <input type="hidden" id="RaceDescriptionHidden">
              ${
                CanEditFlg
                  ? `
              <div class="ButtonGroup">
                <button class="ButtonClass ClearButton" id="RaceClearButton"><i class="fas fa-sync"></i> クリア</button>
                <button class="ButtonClass SaveButton" id="RaceSaveButton"><i class="fas fa-save"></i> 保存</button>
                <button class="ButtonClass DeleteButton Hidden" id="RaceDeleteButton"><i class="fas fa-trash"></i> 削除</button>
              </div>
              `
                  : ''
              }
              <div id="RecordCountArea" class="MarginTop20"></div>
              <div class="TableContainer" id="RaceTableArea"></div>
              <div id="PaginationArea"></div>
            `

        if (CanEditFlg) {
          document
            .getElementById('RaceDescriptionBtn')
            .addEventListener('click', async () => {
              const Result = await ShowInputAreaDialog(
                document.getElementById('RaceDescriptionHidden').value,
                false,
              )
              if (Result !== null && CanEditFlg) {
                document.getElementById('RaceDescriptionHidden').value = Result
                document.getElementById('RaceDescription').value = TruncateText(
                  Result,
                  30,
                )
              }
            })

          document
            .getElementById('RaceClearButton')
            .addEventListener('click', ClearRaceForm)
          document
            .getElementById('RaceSaveButton')
            .addEventListener('click', SaveRace)
          document
            .getElementById('RaceDeleteButton')
            .addEventListener('click', DeleteRace)
        } else {
          document
            .getElementById('RaceDescriptionBtn')
            .addEventListener('click', async () => {
              await ShowInputAreaDialog(
                document.getElementById('RaceDescriptionHidden').value,
                true,
              )
            })
        }

        await LoadRaceList()
      }

      async function LoadRaceList() {
        try {
          const WorkId = sessionStorage.getItem('WorkId')
          const Response = await CallApi(
            `/GetRaceList.php?WorkId=${encodeURIComponent(
              WorkId,
            )}&UserId=${encodeURIComponent(sessionStorage.getItem('UserId'))}`,
            'GET',
          )
          if (Response.Success) {
            RaceList = Response.Data.RaceList || []
            RenderRaceTable()
          } else {
            await ShowErrorDialog(
              Response.Message || '種族一覧の取得に失敗しました',
            )
          }
        } catch (Error) {
          console.error(Error)
          await ShowErrorDialog('種族一覧の取得中にエラーが発生しました')
        }
      }

      function RenderRaceTable() {
        const TotalCount = RaceList.length
        document.getElementById(
          'RecordCountArea',
        ).innerHTML = `<span class="RecordCount">${TotalCount} 件</span>`
        const Start = (CurrentPage - 1) * RECORDS_PER_PAGE
        const End = Math.min(Start + RECORDS_PER_PAGE, TotalCount)
        const PageData = RaceList.slice(Start, End)
        let TableHtml = `
              <table class="DataTable">
                <thead><tr><th>種族名</th><th>説明</th></tr></thead>
                <tbody>
            `
        if (PageData.length) {
          TableHtml += PageData.map(
            (R) => `
                  <tr data-id="${R.RaceId}">
                    <td>${EscapeHtml(R.RaceName)}</td>
                    <td>${EscapeHtml(
                      TruncateText(R.Description || '', 30),
                    )}</td>
                  </tr>
                `,
          ).join('')
        } else {
          TableHtml +=
            '<tr><td colspan="2" class="NoData">データがありません</td></tr>'
        }
        TableHtml += '</tbody></table>'
        document.getElementById('RaceTableArea').innerHTML = TableHtml
        document
          .querySelectorAll('#RaceTableArea tbody tr[data-id]')
          .forEach((Row) => {
            Row.addEventListener('dblclick', () => SelectRace(Row.dataset.id))
          })
        const PaginationArea = document.getElementById('PaginationArea')
        PaginationArea.innerHTML = ''
        PaginationArea.appendChild(
          CreatePagination(TotalCount, CurrentPage, (Page) => {
            CurrentPage = Page
            RenderRaceTable()
          }),
        )
      }

      function SelectRace(RaceId) {
        const Item = RaceList.find((R) => R.RaceId == RaceId)
        if (!Item) return
        SelectedRaceId = RaceId
        document.getElementById('RaceName').value = Item.RaceName || ''
        document.getElementById('RaceDescription').value = TruncateText(
          Item.Description || '',
          30,
        )
        document.getElementById('RaceDescriptionHidden').value =
          Item.Description || ''
        const DeleteBtn = document.getElementById('RaceDeleteButton')
        if (DeleteBtn) DeleteBtn.classList.remove('Hidden')
      }

      function ClearRaceForm() {
        SelectedRaceId = null
        document.getElementById('RaceName').value = ''
        document.getElementById('RaceDescription').value = ''
        document.getElementById('RaceDescriptionHidden').value = ''
        const DeleteBtn = document.getElementById('RaceDeleteButton')
        if (DeleteBtn) DeleteBtn.classList.add('Hidden')
      }

      async function SaveRace() {
        const RaceName = document.getElementById('RaceName').value.trim()
        if (!RaceName) {
          await ShowErrorDialog('種族名を入力してください')
          return
        }
        try {
          ShowSpinner()
          const RequestData = {
            WorkId: sessionStorage.getItem('WorkId'),
            RaceName: RaceName,
            Description: document.getElementById('RaceDescriptionHidden').value,
            UserId: sessionStorage.getItem('UserId'),
          }
          if (SelectedRaceId) RequestData.RaceId = SelectedRaceId

          const Response = await CallApi('/SaveRace.php', 'POST', RequestData)
          HideSpinner()
          if (Response.Success) {
            await ShowInfoDialog('保存完了', Response.Data.Message)
            ClearRaceForm()
            await LoadRaceList()
          } else {
            await ShowErrorDialog(Response.Message || '保存に失敗しました')
          }
        } catch (Error) {
          HideSpinner()
          await ShowErrorDialog('保存中にエラーが発生しました')
        }
      }

      async function DeleteRace() {
        if (!SelectedRaceId) return
        if (!(await ShowConfirmDialog('この種族を削除しますか？'))) return
        try {
          const Response = await CallApi('/DeleteRace.php', 'POST', {
            RaceId: SelectedRaceId,
            WorkId: sessionStorage.getItem('WorkId'),
            UserId: sessionStorage.getItem('UserId'),
          })
          if (Response.Success) {
            await ShowInfoDialog('削除完了', '種族を削除しました')
            ClearRaceForm()
            await LoadRaceList()
          } else {
            await ShowErrorDialog(Response.Message || '削除に失敗しました')
          }
        } catch (Error) {
          await ShowErrorDialog('削除中にエラーが発生しました')
        }
      }

      /* ==========================================================================
       * 階級設定画面 (3.6 ClassInfo)
       * ========================================================================== */
      let ClassList = []
      let OrgListForClass = []
      let SelectedClassId = null
      /** 組織図表示モード（true: 組織図表示, false: テーブル表示） */
      let IsClassChartMode = false

      async function ShowClassSetting() {
        CurrentPage = 1
        SelectedClassId = null
        IsClassChartMode = false
        const ContentArea = document.getElementById('ContentArea')
        const CanEditFlg = CanEdit()

        ContentArea.innerHTML = `
              ${CreateContentHeader('階級設定', 'medal')}
              <div class="FormRow">
                <div class="FormGroup Flex1">
                  <input type="text" class="InputForm" id="ClassName" placeholder="階級名" maxlength="150" ${
                    !CanEditFlg ? 'disabled' : ''
                  }>
                </div>
                <div class="FormGroup Flex1">
                  <select class="SelectForm" id="ClassOrgId" ${
                    !CanEditFlg ? 'disabled' : ''
                  }>
                    <option value="">組織を選択（共通階級の場合は未選択）</option>
                  </select>
                </div>
              </div>
              <div class="FormRow">
                <div class="FormGroup Flex1">
                  <input type="number" class="InputForm" id="ClassRankOrder" placeholder="序列（数字が小さいほど上位）" min="0" ${
                    !CanEditFlg ? 'disabled' : ''
                  }>
                </div>
              </div>
              <div class="FormGroup InputWithButton">
                <input type="text" class="InputForm" id="ClassDescription" placeholder="説明" disabled>
                <button class="ButtonClass SecondaryButton ButtonSmall" id="ClassDescriptionBtn"><i class="fas fa-edit"></i></button>
              </div>
              <input type="hidden" id="ClassDescriptionHidden">
              <div class="ButtonGroup">
                <button class="ButtonClass SecondaryButton" id="ClassChartBtn"><i class="fas fa-sitemap"></i> 組織図</button>
                ${
                  CanEditFlg
                    ? `
                <button class="ButtonClass ClearButton" id="ClassClearButton"><i class="fas fa-sync"></i> クリア</button>
                <button class="ButtonClass SaveButton" id="ClassSaveButton"><i class="fas fa-save"></i> 保存</button>
                <button class="ButtonClass DeleteButton Hidden" id="ClassDeleteButton"><i class="fas fa-trash"></i> 削除</button>
                `
                    : ''
                }
              </div>
              <div id="RecordCountArea" class="MarginTop20"></div>
              <div class="TableContainer" id="ClassTableArea"></div>
              <div id="ClassVisualArea" class="Hidden"></div>
              <div id="PaginationArea"></div>
            `

        if (CanEditFlg) {
          document
            .getElementById('ClassDescriptionBtn')
            .addEventListener('click', () =>
              ShowInputAreaDialog(
                'ClassDescription',
                'ClassDescriptionHidden',
                CanEditFlg,
              ),
            )
          document
            .getElementById('ClassClearButton')
            .addEventListener('click', ClearClassForm)
          document
            .getElementById('ClassSaveButton')
            .addEventListener('click', SaveClass)
          document
            .getElementById('ClassDeleteButton')
            .addEventListener('click', DeleteClass)
        } else {
          document
            .getElementById('ClassDescriptionBtn')
            .addEventListener('click', () =>
              ShowInputAreaDialog(
                'ClassDescription',
                'ClassDescriptionHidden',
                false,
              ),
            )
        }

        // 組織図ボタンイベント（編集権限に関係なく使用可能）
        document
          .getElementById('ClassChartBtn')
          .addEventListener('click', ToggleClassChartView)

        await LoadClassList()
      }

      async function LoadClassList() {
        try {
          const WorkId = sessionStorage.getItem('WorkId')
          const Response = await CallApi(
            `/GetClassList.php?WorkId=${encodeURIComponent(
              WorkId,
            )}&UserId=${encodeURIComponent(sessionStorage.getItem('UserId'))}`,
            'GET',
          )
          if (Response.Success) {
            ClassList = Response.Data.ClassList || []
            OrgListForClass = Response.Data.OrganizationList || []
            UpdateClassOrgSelect()
            RenderClassTable()
          } else {
            await ShowErrorDialog(
              Response.Message || '階級一覧の取得に失敗しました',
            )
          }
        } catch (Error) {
          console.error(Error)
          await ShowErrorDialog('階級一覧の取得中にエラーが発生しました')
        }
      }

      function UpdateClassOrgSelect() {
        const Select = document.getElementById('ClassOrgId')
        if (!Select) return
        Select.innerHTML =
          '<option value="">組織を選択（共通階級の場合は未選択）</option>' +
          OrgListForClass.map(
            (O) => `<option value="${O.OrgId}">${O.OrgName}</option>`,
          ).join('')
      }

      function RenderClassTable() {
        const TotalCount = ClassList.length
        document.getElementById(
          'RecordCountArea',
        ).innerHTML = `<span class="RecordCount">${TotalCount} 件</span>`
        const Start = (CurrentPage - 1) * RECORDS_PER_PAGE
        const End = Math.min(Start + RECORDS_PER_PAGE, TotalCount)
        const PageData = ClassList.slice(Start, End)
        let TableHtml = `
              <table class="DataTable">
                <thead><tr><th>階級名</th><th>所属組織</th><th>序列</th><th>説明</th></tr></thead>
                <tbody>
            `
        if (PageData.length) {
          TableHtml += PageData.map(
            (C) => `
                  <tr data-id="${C.ClassId}">
                    <td>${EscapeHtml(C.ClassName)}</td>
                    <td>${EscapeHtml(C.OrgName || '共通')}</td>
                    <td>${C.RankOrder !== null ? C.RankOrder : ''}</td>
                    <td>${EscapeHtml(
                      TruncateText(C.Description || '', 30),
                    )}</td>
                  </tr>
                `,
          ).join('')
        } else {
          TableHtml +=
            '<tr><td colspan="4" class="NoData">データがありません</td></tr>'
        }
        TableHtml += '</tbody></table>'
        document.getElementById('ClassTableArea').innerHTML = TableHtml
        document
          .querySelectorAll('#ClassTableArea tbody tr[data-id]')
          .forEach((Row) => {
            Row.addEventListener('dblclick', () => SelectClass(Row.dataset.id))
          })
        const PaginationArea = document.getElementById('PaginationArea')
        PaginationArea.innerHTML = ''
        PaginationArea.appendChild(
          CreatePagination(TotalCount, CurrentPage, (Page) => {
            CurrentPage = Page
            RenderClassTable()
          }),
        )
      }

      /**
       * 組織図表示の切り替え処理
       */
      function ToggleClassChartView() {
        IsClassChartMode = !IsClassChartMode
        const TableArea = document.getElementById('ClassTableArea')
        const VisualArea = document.getElementById('ClassVisualArea')
        const PaginationArea = document.getElementById('PaginationArea')
        const RecordCountArea = document.getElementById('RecordCountArea')
        const Btn = document.getElementById('ClassChartBtn')

        if (IsClassChartMode) {
          /** 組織図表示モード */
          TableArea.style.display = 'none'
          PaginationArea.style.display = 'none'
          RecordCountArea.style.display = 'none'
          VisualArea.classList.remove('Hidden')
          VisualArea.style.display = 'block'
          Btn.innerHTML = '<i class="fas fa-table"></i> 一覧表示'
          RenderClassChart()
        } else {
          /** テーブル表示モード */
          TableArea.style.display = ''
          PaginationArea.style.display = ''
          RecordCountArea.style.display = ''
          VisualArea.classList.add('Hidden')
          VisualArea.style.display = 'none'
          Btn.innerHTML = '<i class="fas fa-sitemap"></i> 組織図'
        }
      }

      /**
       * 階級組織図表示処理（序列の昇順でソート）
       */
      function RenderClassChart() {
        const VisualArea = document.getElementById('ClassVisualArea')

        if (ClassList.length === 0) {
          VisualArea.innerHTML = `
            <div style="text-align:center;padding:40px;color:#999;">
              <i class="fas fa-sitemap" style="font-size:48px;margin-bottom:15px;"></i>
              <p>階級データがありません</p>
            </div>
          `
          return
        }

        /** 組織ごとにグループ化 */
        const OrgGroups = {}
        const CommonClasses = []

        ClassList.forEach((Item) => {
          if (Item.OrgId && Item.OrgName) {
            if (!OrgGroups[Item.OrgId]) {
              OrgGroups[Item.OrgId] = {
                OrgName: Item.OrgName,
                Classes: [],
              }
            }
            OrgGroups[Item.OrgId].Classes.push(Item)
          } else {
            CommonClasses.push(Item)
          }
        })

        /** 序列でソート（昇順、nullは最後） */
        const SortByRank = (a, b) => {
          if (a.RankOrder === null && b.RankOrder === null) return 0
          if (a.RankOrder === null) return 1
          if (b.RankOrder === null) return -1
          return a.RankOrder - b.RankOrder
        }

        CommonClasses.sort(SortByRank)
        Object.values(OrgGroups).forEach((Group) => Group.Classes.sort(SortByRank))

        /** 組織図HTML生成 */
        let Html = '<div class="ClassChart">'

        /** 共通階級を表示 */
        if (CommonClasses.length > 0) {
          Html += `
            <div class="ClassChartGroup">
              <div class="ClassChartGroupTitle"><i class="fas fa-globe"></i> 共通階級</div>
              <div class="ClassChartHierarchy">
          `
          CommonClasses.forEach((Item, Index) => {
            const RankDisplay = Item.RankOrder !== null ? `[${Item.RankOrder}]` : ''
            Html += `
              <div class="ClassChartItem" style="--level: ${Index};">
                <div class="ClassChartNode">
                  <div class="ClassChartRank">${RankDisplay}</div>
                  <div class="ClassChartName">${EscapeHtml(Item.ClassName)}</div>
                  ${Item.Description ? `<div class="ClassChartDesc">${EscapeHtml(TruncateText(Item.Description, 50))}</div>` : ''}
                </div>
              </div>
            `
          })
          Html += '</div></div>'
        }

        /** 組織ごとの階級を表示 */
        Object.entries(OrgGroups).forEach(([OrgId, Group]) => {
          Html += `
            <div class="ClassChartGroup">
              <div class="ClassChartGroupTitle"><i class="fas fa-building"></i> ${EscapeHtml(Group.OrgName)}</div>
              <div class="ClassChartHierarchy">
          `
          Group.Classes.forEach((Item, Index) => {
            const RankDisplay = Item.RankOrder !== null ? `[${Item.RankOrder}]` : ''
            Html += `
              <div class="ClassChartItem" style="--level: ${Index};">
                <div class="ClassChartNode">
                  <div class="ClassChartRank">${RankDisplay}</div>
                  <div class="ClassChartName">${EscapeHtml(Item.ClassName)}</div>
                  ${Item.Description ? `<div class="ClassChartDesc">${EscapeHtml(TruncateText(Item.Description, 50))}</div>` : ''}
                </div>
              </div>
            `
          })
          Html += '</div></div>'
        })

        Html += '</div>'
        VisualArea.innerHTML = Html
      }

      function SelectClass(ClassId) {
        const Item = ClassList.find((C) => C.ClassId == ClassId)
        if (!Item) return
        SelectedClassId = ClassId
        document.getElementById('ClassName').value = Item.ClassName || ''
        document.getElementById('ClassOrgId').value = Item.OrgId || ''
        document.getElementById('ClassRankOrder').value =
          Item.RankOrder !== null ? Item.RankOrder : ''
        document.getElementById('ClassDescription').value = TruncateText(
          Item.Description || '',
          30,
        )
        document.getElementById('ClassDescriptionHidden').value =
          Item.Description || ''
        const DeleteBtn = document.getElementById('ClassDeleteButton')
        if (DeleteBtn) DeleteBtn.classList.remove('Hidden')
      }

      function ClearClassForm() {
        SelectedClassId = null
        document.getElementById('ClassName').value = ''
        document.getElementById('ClassOrgId').value = ''
        document.getElementById('ClassRankOrder').value = ''
        document.getElementById('ClassDescription').value = ''
        document.getElementById('ClassDescriptionHidden').value = ''
        const DeleteBtn = document.getElementById('ClassDeleteButton')
        if (DeleteBtn) DeleteBtn.classList.add('Hidden')
      }

      async function SaveClass() {
        const ClassName = document.getElementById('ClassName').value.trim()
        if (!ClassName) {
          await ShowErrorDialog('階級名を入力してください')
          return
        }
        try {
          const RankOrderVal = document.getElementById('ClassRankOrder').value
          const Response = await CallApi('/SaveClass.php', 'POST', {
            ClassId: SelectedClassId,
            WorkId: sessionStorage.getItem('WorkId'),
            OrgId: document.getElementById('ClassOrgId').value || null,
            ClassName: ClassName,
            RankOrder: RankOrderVal !== '' ? parseInt(RankOrderVal) : null,
            Description: document.getElementById('ClassDescriptionHidden')
              .value,
            UserId: sessionStorage.getItem('UserId'),
          })
          if (Response.Success) {
            await ShowInfoDialog('保存完了', Response.Data.Message)
            ClearClassForm()
            await LoadClassList()
          } else {
            await ShowErrorDialog(Response.Message || '保存に失敗しました')
          }
        } catch (Error) {
          await ShowErrorDialog('保存中にエラーが発生しました')
        }
      }

      async function DeleteClass() {
        if (!SelectedClassId) return
        if (!(await ShowConfirmDialog('この階級を削除しますか？'))) return
        try {
          const Response = await CallApi('/DeleteClass.php', 'POST', {
            ClassId: SelectedClassId,
            WorkId: sessionStorage.getItem('WorkId'),
            UserId: sessionStorage.getItem('UserId'),
          })
          if (Response.Success) {
            await ShowInfoDialog('削除完了', '階級を削除しました')
            ClearClassForm()
            await LoadClassList()
          } else {
            await ShowErrorDialog(Response.Message || '削除に失敗しました')
          }
        } catch (Error) {
          await ShowErrorDialog('削除中にエラーが発生しました')
        }
      }

      /* ==========================================================================
       * 元号設定画面 (3.2 CalendarInfo)
       * ========================================================================== */
      let CalendarList = []
      let SelectedCalendarId = null

      async function ShowCalendarSetting() {
        CurrentPage = 1
        SelectedCalendarId = null
        const ContentArea = document.getElementById('ContentArea')
        const CanEditFlg = CanEdit()

        ContentArea.innerHTML = `
              ${CreateContentHeader('元号設定', 'calendar-alt')}
              <div class="FormRow">
                <div class="FormGroup Flex1">
                  <input type="text" class="InputForm" id="CalendarEraName" placeholder="元号名" maxlength="100" ${
                    !CanEditFlg ? 'disabled' : ''
                  }>
                </div>
              </div>
              <div class="FormRow">
                <div class="FormGroup InputWithButton Flex1">
                  <input type="text" class="InputForm" id="CalendarStartYear" placeholder="開始年" readonly ${
                    !CanEditFlg ? 'disabled' : ''
                  }>
                  ${
                    CanEditFlg
                      ? `<button class="ButtonClass SecondaryButton ButtonSmall" id="CalendarStartYearBtn"><i class="fas fa-calendar"></i></button>`
                      : ''
                  }
                </div>
                <div class="FormGroup InputWithButton Flex1">
                  <input type="text" class="InputForm" id="CalendarEndYear" placeholder="終了年" readonly ${
                    !CanEditFlg ? 'disabled' : ''
                  }>
                  ${
                    CanEditFlg
                      ? `<button class="ButtonClass SecondaryButton ButtonSmall" id="CalendarEndYearBtn"><i class="fas fa-calendar"></i></button>`
                      : ''
                  }
                </div>
              </div>
              <div class="FormGroup InputWithButton">
                <input type="text" class="InputForm" id="CalendarDescription" placeholder="概要" disabled>
                <button class="ButtonClass SecondaryButton ButtonSmall" id="CalendarDescriptionBtn"><i class="fas fa-edit"></i></button>
              </div>
              <input type="hidden" id="CalendarDescriptionHidden">
              ${
                CanEditFlg
                  ? `
              <div class="ButtonGroup">
                <button class="ButtonClass ClearButton" id="CalendarClearButton"><i class="fas fa-sync"></i> クリア</button>
                <button class="ButtonClass SaveButton" id="CalendarSaveButton"><i class="fas fa-save"></i> 保存</button>
                <button class="ButtonClass DeleteButton Hidden" id="CalendarDeleteButton"><i class="fas fa-trash"></i> 削除</button>
              </div>
              `
                  : ''
              }
              <div id="RecordCountArea" class="MarginTop20"></div>
              <div class="TableContainer" id="CalendarTableArea"></div>
              <div id="PaginationArea"></div>
            `

        /** イベント設定 */
        if (CanEditFlg) {
          const DatePickerInstance = new DatePicker()
          document
            .getElementById('CalendarStartYearBtn')
            .addEventListener('click', () =>
              DatePickerInstance.openDialog('CalendarStartYear'),
            )
          document
            .getElementById('CalendarEndYearBtn')
            .addEventListener('click', () =>
              DatePickerInstance.openDialog('CalendarEndYear'),
            )
          document
            .getElementById('CalendarDescriptionBtn')
            .addEventListener('click', () =>
              ShowInputAreaDialog(
                'CalendarDescription',
                'CalendarDescriptionHidden',
                CanEditFlg,
              ),
            )
          document
            .getElementById('CalendarClearButton')
            .addEventListener('click', ClearCalendarForm)
          document
            .getElementById('CalendarSaveButton')
            .addEventListener('click', SaveCalendar)
          document
            .getElementById('CalendarDeleteButton')
            .addEventListener('click', DeleteCalendar)
        } else {
          document
            .getElementById('CalendarDescriptionBtn')
            .addEventListener('click', () =>
              ShowInputAreaDialog(
                'CalendarDescription',
                'CalendarDescriptionHidden',
                false,
              ),
            )
        }

        await LoadCalendarList()
      }

      async function LoadCalendarList() {
        try {
          const WorkId = sessionStorage.getItem('WorkId')
          const Response = await CallApi(
            `/GetCalendarList.php?WorkId=${encodeURIComponent(
              WorkId,
            )}&UserId=${encodeURIComponent(sessionStorage.getItem('UserId'))}`,
            'GET',
          )
          if (Response.Success) {
            CalendarList = Response.Data.CalendarList || []
            RenderCalendarTable()
          } else {
            await ShowErrorDialog(
              Response.Message || '元号一覧の取得に失敗しました',
            )
          }
        } catch (Error) {
          console.error(Error)
          await ShowErrorDialog('元号一覧の取得中にエラーが発生しました')
        }
      }

      function RenderCalendarTable() {
        const TotalCount = CalendarList.length
        document.getElementById(
          'RecordCountArea',
        ).innerHTML = `<span class="RecordCount">${TotalCount} 件</span>`
        const Start = (CurrentPage - 1) * RECORDS_PER_PAGE
        const End = Math.min(Start + RECORDS_PER_PAGE, TotalCount)
        const PageData = CalendarList.slice(Start, End)
        let TableHtml = `
              <table class="DataTable">
                <thead><tr><th>元号名</th><th>開始年</th><th>終了年</th><th>概要</th></tr></thead>
                <tbody>
            `
        if (PageData.length) {
          TableHtml += PageData.map(
            (C) => `
                  <tr data-id="${C.CaleId}">
                    <td>${EscapeHtml(C.EraName || '')}</td>
                    <td>${FormatDate(C.StartYear)}</td>
                    <td>${FormatDate(C.EndYear)}</td>
                    <td>${TruncateText(
                      EscapeHtml(C.Description || ''),
                      30,
                    )}</td>
                  </tr>
                `,
          ).join('')
        } else {
          TableHtml +=
            '<tr><td colspan="4" class="NoData">データがありません</td></tr>'
        }
        TableHtml += '</tbody></table>'
        document.getElementById('CalendarTableArea').innerHTML = TableHtml
        document
          .querySelectorAll('#CalendarTableArea tbody tr[data-id]')
          .forEach((Row) => {
            Row.addEventListener('dblclick', () =>
              SelectCalendar(Row.dataset.id),
            )
          })
        const PaginationArea = document.getElementById('PaginationArea')
        PaginationArea.innerHTML = ''
        PaginationArea.appendChild(
          CreatePagination(TotalCount, CurrentPage, (Page) => {
            CurrentPage = Page
            RenderCalendarTable()
          }),
        )
      }

      function SelectCalendar(CaleId) {
        const Item = CalendarList.find((C) => C.CaleId == CaleId)
        if (!Item) return
        SelectedCalendarId = CaleId
        document.getElementById('CalendarEraName').value = Item.EraName || ''
        document.getElementById('CalendarStartYear').value =
          Item.StartYear || ''
        document.getElementById('CalendarEndYear').value = Item.EndYear || ''
        document.getElementById('CalendarDescription').value = TruncateText(
          Item.Description || '',
          30,
        )
        document.getElementById('CalendarDescriptionHidden').value =
          Item.Description || ''
        const DeleteBtn = document.getElementById('CalendarDeleteButton')
        if (DeleteBtn) DeleteBtn.classList.remove('Hidden')
      }

      function ClearCalendarForm() {
        SelectedCalendarId = null
        document.getElementById('CalendarEraName').value = ''
        document.getElementById('CalendarStartYear').value = ''
        document.getElementById('CalendarEndYear').value = ''
        document.getElementById('CalendarDescription').value = ''
        document.getElementById('CalendarDescriptionHidden').value = ''
        const DeleteBtn = document.getElementById('CalendarDeleteButton')
        if (DeleteBtn) DeleteBtn.classList.add('Hidden')
      }

      async function SaveCalendar() {
        const EraName = document.getElementById('CalendarEraName').value.trim()
        if (!EraName) {
          await ShowErrorDialog('元号名を入力してください')
          return
        }
        try {
          const Response = await CallApi('/SaveCalendar.php', 'POST', {
            CaleId: SelectedCalendarId,
            WorkId: sessionStorage.getItem('WorkId'),
            EraName: EraName,
            StartYear: document.getElementById('CalendarStartYear').value,
            EndYear: document.getElementById('CalendarEndYear').value,
            Description: document.getElementById('CalendarDescriptionHidden')
              .value,
            UserId: sessionStorage.getItem('UserId'),
          })
          if (Response.Success) {
            await ShowInfoDialog('保存完了', '元号を保存しました')
            ClearCalendarForm()
            await LoadCalendarList()
          } else {
            await ShowErrorDialog(Response.Message || '保存に失敗しました')
          }
        } catch (Error) {
          await ShowErrorDialog('保存中にエラーが発生しました')
        }
      }

      async function DeleteCalendar() {
        if (!SelectedCalendarId) return
        if (!(await ShowConfirmDialog('この元号を削除しますか？'))) return
        try {
          const Response = await CallApi('/DeleteCalendar.php', 'POST', {
            CaleId: SelectedCalendarId,
            WorkId: sessionStorage.getItem('WorkId'),
            UserId: sessionStorage.getItem('UserId'),
          })
          if (Response.Success) {
            await ShowInfoDialog('削除完了', '元号を削除しました')
            ClearCalendarForm()
            await LoadCalendarList()
          } else {
            await ShowErrorDialog(Response.Message || '削除に失敗しました')
          }
        } catch (Error) {
          await ShowErrorDialog('削除中にエラーが発生しました')
        }
      }

      /* ==========================================================================
       * 更新履歴一覧画面 (2.3 UpdateHistory)
       * ========================================================================== */
      let UpdateHistoryList = []

      async function ShowUpdateHistory() {
        CurrentPage = 1
        const ContentArea = document.getElementById('ContentArea')

        ContentArea.innerHTML = `
              ${CreateContentHeader('更新履歴', 'history')}
              <div id="RecordCountArea" class="MarginTop20"></div>
              <div class="TableContainer" id="HistoryTableArea"></div>
              <div id="PaginationArea"></div>
            `

        await LoadUpdateHistoryList()
      }

      async function LoadUpdateHistoryList() {
        try {
          const WorkId = sessionStorage.getItem('WorkId')
          const Response = await CallApi(
            `/GetUpdateHistoryList.php?WorkId=${encodeURIComponent(
              WorkId,
            )}&UserId=${encodeURIComponent(sessionStorage.getItem('UserId'))}`,
            'GET',
          )
          if (Response.Success) {
            UpdateHistoryList = Response.Data.HistoryList || []
            RenderUpdateHistoryTable()
          } else {
            await ShowErrorDialog(
              Response.Message || '更新履歴の取得に失敗しました',
            )
          }
        } catch (Error) {
          console.error(Error)
          await ShowErrorDialog('更新履歴の取得中にエラーが発生しました')
        }
      }

      function RenderUpdateHistoryTable() {
        const TotalCount = UpdateHistoryList.length
        document.getElementById(
          'RecordCountArea',
        ).innerHTML = `<span class="RecordCount">${TotalCount} 件</span>`
        const Start = (CurrentPage - 1) * RECORDS_PER_PAGE
        const End = Math.min(Start + RECORDS_PER_PAGE, TotalCount)
        const PageData = UpdateHistoryList.slice(Start, End)
        let TableHtml = `
              <table class="DataTable">
                <thead><tr><th>更新日時</th><th>機能名</th><th>操作</th><th>更新者</th></tr></thead>
                <tbody>
            `
        if (PageData.length) {
          TableHtml += PageData.map(
            (H) => `
                  <tr>
                    <td>${FormatDateTimeWithWeekday(H.RegistDate)}</td>
                    <td>${EscapeHtml(H.FunctionName || '')}</td>
                    <td>${EscapeHtml(H.Operation || '')}</td>
                    <td>${EscapeHtml(H.RegistUser || '')}</td>
                  </tr>
                `,
          ).join('')
        } else {
          TableHtml +=
            '<tr><td colspan="4" class="NoData">データがありません</td></tr>'
        }
        TableHtml += '</tbody></table>'
        document.getElementById('HistoryTableArea').innerHTML = TableHtml
        const PaginationArea = document.getElementById('PaginationArea')
        PaginationArea.innerHTML = ''
        PaginationArea.appendChild(
          CreatePagination(TotalCount, CurrentPage, (Page) => {
            CurrentPage = Page
            RenderUpdateHistoryTable()
          }),
        )
      }

      /* ======================================================================================================================
      * ■ 年表設定
      * -----------------------------------------------------------------------------------------------------------------------
      * ・作中の年表を設定する
      * ======================================================================================================================= */

      /**
       * 年表設定画面の表示処理
       */
      async function ShowTimelineSetting() {
        /* ==========================================================================
         * 定義
         * ========================================================================== */
        // 1. 年表一覧表示ページ
        CurrentPage = 1
        // 2. 行ID
        SelectedTimelineId = null
        // 3. 年表表示モードリセット
        IsTimelineVisualMode = false
        // 3. コンテンツ表示エリア要素
        const ContentArea = document.getElementById('ContentArea')
        // 4. 編集権限FLG
        const CanEditFlg = CanEdit()

        /* ==========================================================================
         * DOM組み立て
         * ========================================================================== */
        ContentArea.innerHTML = `
            ${CreateContentHeader('年表設定', 'stream')}
            <div class="FormGroup">
              <input type="text" class="InputForm" id="TimelineTitle" placeholder="出来事タイトル" maxlength="255" ${
                !CanEditFlg ? 'disabled' : ''
              }>
            </div>
            <div class="FormGroup InputWithButton">
              <input type="text" class="InputForm" id="TimelineEventDate" placeholder="発生時期" readonly ${
                !CanEditFlg ? 'disabled' : ''
              }>
              ${
                CanEditFlg
                  ? `<button class="ButtonClass SecondaryButton ButtonSmall" id="TimelineEventDateBtn"><i class="fas fa-calendar"></i></button>`
                  : ''
              }
            </div>
            <div class="FormGroup InputWithButton">
              <input type="text" class="InputForm" id="TimelineEndDate" placeholder="終了時期（任意）" readonly ${
                !CanEditFlg ? 'disabled' : ''
              }>
              ${
                CanEditFlg
                  ? `<button class="ButtonClass SecondaryButton ButtonSmall" id="TimelineEndDateBtn"><i class="fas fa-calendar"></i></button>`
                  : ''
              }
            </div>
            <div class="FormGroup InputWithButton">
              <input type="text" class="InputForm" id="TimelineContent" placeholder="内容" disabled>
              <button class="ButtonClass SecondaryButton ButtonSmall" id="TimelineContentBtn"><i class="fas fa-edit"></i></button>
            </div>
            <input type="hidden" id="TimelineContentHidden">
            ${
              CanEditFlg
                ? `
            <div class="ButtonGroup">
              <button class="ButtonClass SecondaryButton" id="TimelineViewBtn"><i class="fas fa-stream"></i> 年表表示</button>
              <button class="ButtonClass ClearButton" id="TimelineClearButton"><i class="fas fa-sync"></i> クリア</button>
              <button class="ButtonClass SaveButton" id="TimelineSaveButton"><i class="fas fa-save"></i> 保存</button>
              <button class="ButtonClass DeleteButton Hidden" id="TimelineDeleteButton"><i class="fas fa-trash"></i> 削除</button>
            </div>
            `
                : ''
            }
            <div id="RecordCountArea" class="MarginTop10"></div>
            <div class="TableContainer" id="TimelineTableArea"></div>
            <div id="TimelineVisualArea" style="display:none;"></div>
            <div id="PaginationArea"></div>
          `

        /* ==========================================================================
         * 編集可能な権限である場合
         * ========================================================================== */
        if (CanEditFlg) {
          /* 1. 定義 */
          // 1. デートピッカーインスタンス
          const DatePickerInstance = new DatePicker()

          /* 2.イベント登録 */
          // 1. 発生時期ボタンクリックイベント
          document
            .getElementById('TimelineEventDateBtn')
            .addEventListener('click', () =>
              DatePickerInstance.OpenDialog('TimelineEventDate'),
            )
          // 2. 終了時期ボタンクリックイベント
          document
            .getElementById('TimelineEndDateBtn')
            .addEventListener('click', () =>
              DatePickerInstance.OpenDialog('TimelineEndDate'),
            )
          // 3. クリアボタンクリックイベント
          document
            .getElementById('TimelineClearButton')
            .addEventListener('click', ClearTimelineForm)
          // 4. 保存ボタンクリックイベント
          document
            .getElementById('TimelineSaveButton')
            .addEventListener('click', SaveTimeline)
          // 5. 削除ボタンクリックイベント
          document
            .getElementById('TimelineDeleteButton')
            .addEventListener('click', DeleteTimeline)
        }
        // 4. 内容ボタンクリックイベント
        document
          .getElementById('TimelineContentBtn')
          .addEventListener('click', async () => {
            const Result = await ShowInputAreaDialog(
              document.getElementById('TimelineContentHidden').value,
              !CanEditFlg,
            )
            if (Result !== null && CanEditFlg) {
              document.getElementById('TimelineContentHidden').value = Result
              document.getElementById('TimelineContent').value = TruncateText(
                Result,
                30,
              )
            }
          })

        /* ---------------------------------------------
         *  4. 年表表示ボタンイベント
         * --------------------------------------------- */
        document
          .getElementById('TimelineViewBtn')
          .addEventListener('click', ToggleTimelineView)

        /* ---------------------------------------------
         *  5. 年表一覧取得処理
         * --------------------------------------------- */
        await LoadTimelineList()
      }

      /** 年表表示モード（true: ビジュアル表示, false: テーブル表示） */
      let IsTimelineVisualMode = false

      /**
       * 年表表示の切り替え処理
       */
      function ToggleTimelineView() {
        IsTimelineVisualMode = !IsTimelineVisualMode
        const TableArea = document.getElementById('TimelineTableArea')
        const VisualArea = document.getElementById('TimelineVisualArea')
        const PaginationArea = document.getElementById('PaginationArea')
        const RecordCountArea = document.getElementById('RecordCountArea')
        const Btn = document.getElementById('TimelineViewBtn')

        if (IsTimelineVisualMode) {
          /** ビジュアル表示モード */
          TableArea.style.display = 'none'
          PaginationArea.style.display = 'none'
          RecordCountArea.style.display = 'none'
          VisualArea.style.display = 'block'
          Btn.innerHTML = '<i class="fas fa-table"></i> 一覧表示'
          RenderTimelineVisual()
        } else {
          /** テーブル表示モード */
          TableArea.style.display = ''
          PaginationArea.style.display = ''
          RecordCountArea.style.display = ''
          VisualArea.style.display = 'none'
          Btn.innerHTML = '<i class="fas fa-stream"></i> 年表表示'
        }
      }

      /**
       * 年表ビジュアル表示処理
       */
      function RenderTimelineVisual() {
        const VisualArea = document.getElementById('TimelineVisualArea')

        if (TimelineList.length === 0) {
          VisualArea.innerHTML = `
                <div style="text-align:center;padding:40px;color:#999;">
                  <i class="fas fa-stream" style="font-size:48px;margin-bottom:15px;"></i>
                  <p>年表データがありません</p>
                </div>
              `
          return
        }

        /** 日付でソート（eventDateの昇順） */
        const SortedList = [...TimelineList].sort((a, b) => {
          const DateA = (a.eventDate || '').replace(/[^0-9]/g, '')
          const DateB = (b.eventDate || '').replace(/[^0-9]/g, '')
          return DateA.localeCompare(DateB)
        })

        /** 年表ビジュアルHTML生成 */
        let Html = '<div class="TimelineVisual">'

        SortedList.forEach((Item, Index) => {
          const IsLeft = Index % 2 === 0
          const PositionClass = IsLeft ? 'TimelineLeft' : 'TimelineRight'
          const EventDateDisplay = FormatDate(Item.eventDate) || '不明'
          const EndDateDisplay = Item.endDate
            ? ` ～ ${FormatDate(Item.endDate)}`
            : ''

          Html += `
                <div class="TimelineItem ${PositionClass}">
                  <div class="TimelineContent">
                    <div class="TimelineDate">${EventDateDisplay}${EndDateDisplay}</div>
                    <div class="TimelineTitle">${EscapeHtml(
                      Item.title || '',
                    )}</div>
                    ${
                      Item.content
                        ? `<div class="TimelineDesc">${EscapeHtml(
                            Item.content,
                          )}</div>`
                        : ''
                    }
                  </div>
                </div>
              `
        })

        Html += '</div>'
        VisualArea.innerHTML = Html
      }

      /**
       * 年表一覧取得処理
       */
      async function LoadTimelineList() {
        /* ---------------------------------------------
         *  1. API通信処理
         * --------------------------------------------- */
        try {
          /* 1. 定義 */
          // 1. 作品ID
          const WorkId = sessionStorage.getItem('WorkId')
          // 2. ユーザーID
          const UserId = sessionStorage.getItem('UserId')

          /* 2. API呼び出し */
          const Response = await CallApi('/GetTimelineList.php', 'POST', {
            // 1. 作品ID
            WorkId: WorkId,
            // 2. ユーザーID
            UserId: UserId,
          })

          /* 3. 取得成功 */
          if (Response.Success) {
            // 1. 取得結果を保持
            TimelineList = Response.Data.TimelineList || []
            // 2. 年表一覧表示
            RenderTimelineTable()
          } else {
            /* 4. 取得失敗 */
            // 1. エラーダイアログ表示
            await ShowErrorDialog(
              Response.Message || '年表一覧の取得に失敗しました',
            )
          }
        } catch (Error) {
          /* ---------------------------------------------
           *  2. 例外処理
           * --------------------------------------------- */
          // 1. エラーダイアログ表示
          await ShowErrorDialog('年表一覧の取得中にエラーが発生しました')
          // 2. デバッグログ
          console.error(Error)
        }
      }

      /**
       * 年表一覧表示処理
       */
      function RenderTimelineTable() {
        /* ---------------------------------------------
         *  1. 定義
         * --------------------------------------------- */
        // 1. 年表一覧表示エリア要素取得
        const TableArea = document.getElementById('TimelineTableArea')
        // 2. 件数表示エリア要素取得
        const RecordCountArea = document.getElementById('RecordCountArea')
        // 3. ページネーション表示エリア要素取得
        const PaginationArea = document.getElementById('PaginationArea')
        // 4. 件数初期化
        RecordCountArea.innerHTML = ''
        // 5. 件数要素を作成して追加
        RecordCountArea.appendChild(CreateRecordCount(TimelineList.length))
        // 6. テーブル要素作成
        const Table = document.createElement('table')
        // 7. クラス設定
        Table.className = 'DataTable'
        // 8. ヘッダー作成
        const Thead = document.createElement('thead')
        // 9. ヘッダー内容定義
        Thead.innerHTML = `<tr><th>タイトル</th><th>発生時期</th><th>終了時期</th><th>内容</th></tr>`
        // 10.ヘッダーをテーブルに追加
        Table.appendChild(Thead)
        // 11.テーブルボディ作成
        const Tbody = document.createElement('tbody')
        // 12.ページング開始インデックスを定義
        const StartIndex = (CurrentPage - 1) * RECORDS_PER_PAGE
        // 13.ページング終了インデックスを定義
        const EndIndex = Math.min(
          StartIndex + RECORDS_PER_PAGE,
          TimelineList.length,
        )
        // 14.ページング用データを取得
        const PageData = TimelineList.slice(StartIndex, EndIndex)

        /* ---------------------------------------------
         *  2. 件数が0件の場合
         * --------------------------------------------- */
        if (PageData.length === 0) {
          // 1. テーブルボディ内容定義
          Tbody.innerHTML =
            '<tr><td colspan="4" style="text-align:center;color:#999;">データがありません</td></tr>'
        } else {
          /* ---------------------------------------------
           *  3. 件数が1件以上の場合
           * --------------------------------------------- */
          PageData.forEach((Item, Index) => {
            /* 1. 行作成 */
            // 1. 行作成
            const Row = document.createElement('tr')
            // 2. カーソル設定
            Row.style.cursor = 'pointer'
            // 3. データ属性設定
            Row.dataset.index = StartIndex + Index

            /* 2. 行内容設定 */
            Row.innerHTML = `<td title="${Item.title}">${TruncateText(
              Item.title,
              20,
            )}</td><td>${FormatDate(Item.eventdate)}</td><td>${
              FormatDate(Item.enddate) || '-'
            }</td><td title="${Item.content || ''}">${
              TruncateText(Item.content, 20) || '-'
            }</td>`

            /* 行ダブルクリックイベント定義 */
            Row.addEventListener('dblclick', () =>
              // 1. 年表選択処理呼び出し
              SelectTimeline(StartIndex + Index),
            )
            /* 3. 行をテーブルボディに追加 */
            Tbody.appendChild(Row)
          })
        }

        /* ---------------------------------------------
         *  4. DOM構築
         * --------------------------------------------- */
        // 1. テーブルボディをテーブルに追加
        Table.appendChild(Tbody)
        // 2. 年表一覧表示エリアを初期化
        TableArea.innerHTML = ''
        // 3. テーブルを年表一覧表示エリアに追加
        TableArea.appendChild(Table)
        // 4. ページネーション表示エリアを初期化
        PaginationArea.innerHTML = ''
        // 5. ページネーション要素を作成して追加
        PaginationArea.appendChild(
          CreatePagination(TimelineList.length, CurrentPage, (Page) => {
            CurrentPage = Page
            RenderTimelineTable()
          }),
        )
      }

      function SelectTimeline(Index) {
        const Item = TimelineList[Index]
        SelectedTimelineId = Item.timeid
        document.getElementById('TimelineTitle').value = Item.title
        document.getElementById('TimelineEventDate').value =
          Item.eventdate || ''
        document.getElementById('TimelineEndDate').value = Item.enddate || ''
        document.getElementById('TimelineContent').value = TruncateText(
          Item.content,
          30,
        )
        document.getElementById('TimelineContentHidden').value =
          Item.content || ''
        const DeleteBtn = document.getElementById('TimelineDeleteButton')
        if (DeleteBtn) DeleteBtn.classList.remove('Hidden')
      }

      function ClearTimelineForm() {
        SelectedTimelineId = null
        document.getElementById('TimelineTitle').value = ''
        document.getElementById('TimelineEventDate').value = ''
        document.getElementById('TimelineEndDate').value = ''
        document.getElementById('TimelineContent').value = ''
        document.getElementById('TimelineContentHidden').value = ''
        const DeleteBtn = document.getElementById('TimelineDeleteButton')
        if (DeleteBtn) DeleteBtn.classList.add('Hidden')
      }

      async function SaveTimeline() {
        const Title = document.getElementById('TimelineTitle').value.trim()
        const EventDate = document
          .getElementById('TimelineEventDate')
          .value.trim()
        if (!Title) {
          await ShowErrorDialog('タイトルを入力してください')
          return
        }
        if (!EventDate) {
          await ShowErrorDialog('発生時期を入力してください')
          return
        }
        try {
          const Response = await CallApi('/SaveTimeline.php', 'POST', {
            TimeId: SelectedTimelineId,
            WorkId: sessionStorage.getItem('WorkId'),
            Title: Title,
            EventDate: EventDate,
            EndDate: document.getElementById('TimelineEndDate').value.trim(),
            Content: document.getElementById('TimelineContentHidden').value,
            UserId: sessionStorage.getItem('UserId'),
          })
          if (Response.Success) {
            await ShowInfoDialog('保存完了', '年表を保存しました')
            ClearTimelineForm()
            await LoadTimelineList()
          } else {
            await ShowErrorDialog(Response.Message || '保存に失敗しました')
          }
        } catch (Error) {
          await ShowErrorDialog('保存中にエラーが発生しました')
        }
      }

      async function DeleteTimeline() {
        if (!SelectedTimelineId) return
        if (!(await ShowConfirmDialog('この年表を削除しますか？'))) return
        try {
          const Response = await CallApi('/DeleteTimeline.php', 'POST', {
            TimeId: SelectedTimelineId,
            UserId: sessionStorage.getItem('UserId'),
          })
          if (Response.Success) {
            await ShowInfoDialog('削除完了', '年表を削除しました')
            ClearTimelineForm()
            await LoadTimelineList()
          } else {
            await ShowErrorDialog(Response.Message || '削除に失敗しました')
          }
        } catch (Error) {
          await ShowErrorDialog('削除中にエラーが発生しました')
        }
      }

      /* ==========================================================================
       * 舞台設定画面 (3.4 StageInfo)
       * ========================================================================== */
      let StageList = []
      let SelectedStageId = null

      async function ShowStageSetting() {
        CurrentPage = 1
        SelectedStageId = null
        const ContentArea = document.getElementById('ContentArea')
        const CanEditFlg = CanEdit()

        ContentArea.innerHTML = `
              ${CreateContentHeader('舞台設定', 'map-marked-alt')}
              <div class="FormRow">
                <div class="Flex1">
                  <div class="ImageBox" id="StageImageBox">
                    <div class="ImageBoxPlaceholder">
                      <i class="fas fa-map-marked-alt"></i>
                      <div>クリックで画像選択</div>
                    </div>
                  </div>
                </div>
              </div>
              <input type="file" id="StageImageInput" accept="image/*" style="display:none;">
              <input type="hidden" id="StageImagePath">
              <div class="FormRow">
                <div class="FormGroup Flex1">
                  <input type="text" class="InputForm" id="StageName" placeholder="舞台名" maxlength="255" ${
                    !CanEditFlg ? 'disabled' : ''
                  }>
                </div>
              </div>
              <div class="FormRow">
                <div class="FormGroup Flex1">
                  <input type="text" class="InputForm" id="StagePopulation" placeholder="人口" maxlength="100" ${
                    !CanEditFlg ? 'disabled' : ''
                  }>
                </div>
                <div class="FormGroup Flex1">
                  <input type="text" class="InputForm" id="StageAreaSize" placeholder="面積" maxlength="100" ${
                    !CanEditFlg ? 'disabled' : ''
                  }>
                </div>
              </div>
              <div class="FormGroup InputWithButton">
                <input type="text" class="InputForm" id="StageDescription" placeholder="説明" disabled>
                <button class="ButtonClass SecondaryButton ButtonSmall" id="StageDescriptionBtn"><i class="fas fa-edit"></i></button>
              </div>
              <input type="hidden" id="StageDescriptionHidden">
              ${
                CanEditFlg
                  ? `
              <div class="ButtonGroup">
                <button class="ButtonClass ClearButton" id="StageClearButton"><i class="fas fa-sync"></i> クリア</button>
                <button class="ButtonClass SaveButton" id="StageSaveButton"><i class="fas fa-save"></i> 保存</button>
                <button class="ButtonClass DeleteButton Hidden" id="StageDeleteButton"><i class="fas fa-trash"></i> 削除</button>
              </div>
              `
                  : ''
              }
              <div id="RecordCountArea" class="MarginTop20"></div>
              <div class="TableContainer" id="StageTableArea"></div>
              <div id="PaginationArea"></div>
            `

        if (CanEditFlg) {
          document
            .getElementById('StageDescriptionBtn')
            .addEventListener('click', async () => {
              const Result = await ShowInputAreaDialog(
                document.getElementById('StageDescriptionHidden').value,
                false,
              )
              if (Result !== null && CanEditFlg) {
                document.getElementById('StageDescriptionHidden').value = Result
                document.getElementById('StageDescription').value =
                  TruncateText(Result, 30)
              }
            })

          document
            .getElementById('StageImageBox')
            .addEventListener('click', async () => {
              const StageImageBox = document.getElementById('StageImageBox')
              const ImgElement = StageImageBox.querySelector('img')

              if (!ImgElement) {
                document.getElementById('StageImageInput').click()
                return
              }

              const Deleted = await ShowImageDialog(ImgElement.src, CanEdit())

              if (Deleted) {
                StageImageBox.innerHTML = `
                    <div class="ImageBoxPlaceholder">
                      <i class="fas fa-map-marked-alt"></i>
                      <div>クリックで画像選択</div>
                    </div>
                  `
                document.getElementById('StageImagePath').value = ''
                document.getElementById('StageImageInput').value = ''
              }
            })

          document
            .getElementById('StageImageInput')
            .addEventListener('change', HandleStageImageChange)
          document
            .getElementById('StageClearButton')
            .addEventListener('click', ClearStageForm)
          document
            .getElementById('StageSaveButton')
            .addEventListener('click', SaveStage)
          document
            .getElementById('StageDeleteButton')
            .addEventListener('click', DeleteStage)
        } else {
          document
            .getElementById('StageDescriptionBtn')
            .addEventListener('click', async () => {
              await ShowInputAreaDialog(
                document.getElementById('StageDescriptionHidden').value,
                true,
              )
            })
        }

        await LoadStageList()
      }

      function HandleStageImageChange(Event) {
        const File = Event.target.files[0]
        if (!File) return

        const Reader = new FileReader()
        Reader.onload = function (Event) {
          const ImageBox = document.getElementById('StageImageBox')
          ImageBox.innerHTML = `<img src="${Event.target.result}" alt="舞台画像">`
        }
        Reader.readAsDataURL(File)
      }

      async function LoadStageList() {
        try {
          const WorkId = sessionStorage.getItem('WorkId')
          const Response = await CallApi(
            `/GetStageList.php?WorkId=${encodeURIComponent(
              WorkId,
            )}&UserId=${encodeURIComponent(sessionStorage.getItem('UserId'))}`,
            'GET',
          )
          if (Response.Success) {
            StageList = Response.Data.StageList || []
            RenderStageTable()
          } else {
            await ShowErrorDialog(
              Response.Message || '舞台一覧の取得に失敗しました',
            )
          }
        } catch (Error) {
          console.error(Error)
          await ShowErrorDialog('舞台一覧の取得中にエラーが発生しました')
        }
      }

      function RenderStageTable() {
        const TotalCount = StageList.length
        document.getElementById(
          'RecordCountArea',
        ).innerHTML = `<span class="RecordCount">${TotalCount} 件</span>`
        const Start = (CurrentPage - 1) * RECORDS_PER_PAGE
        const End = Math.min(Start + RECORDS_PER_PAGE, TotalCount)
        const PageData = StageList.slice(Start, End)
        let TableHtml = `
              <table class="DataTable">
                <thead><tr><th>舞台名</th><th>人口</th><th>面積</th><th>説明</th></tr></thead>
                <tbody>
            `
        if (PageData.length) {
          TableHtml += PageData.map(
            (S) => `
                  <tr data-id="${S.StageId}">
                    <td>${EscapeHtml(S.StageName)}</td>
                    <td>${EscapeHtml(S.Population || '')}</td>
                    <td>${EscapeHtml(S.AreaSize || '')}</td>
                    <td>${EscapeHtml(
                      TruncateText(S.Description || '', 30),
                    )}</td>
                  </tr>
                `,
          ).join('')
        } else {
          TableHtml +=
            '<tr><td colspan="4" class="NoData">データがありません</td></tr>'
        }
        TableHtml += '</tbody></table>'
        document.getElementById('StageTableArea').innerHTML = TableHtml
        document
          .querySelectorAll('#StageTableArea tbody tr[data-id]')
          .forEach((Row) => {
            Row.addEventListener('dblclick', () => SelectStage(Row.dataset.id))
          })
        const PaginationArea = document.getElementById('PaginationArea')
        PaginationArea.innerHTML = ''
        PaginationArea.appendChild(
          CreatePagination(TotalCount, CurrentPage, (Page) => {
            CurrentPage = Page
            RenderStageTable()
          }),
        )
      }

      function SelectStage(StageId) {
        const Item = StageList.find((S) => S.StageId == StageId)
        if (!Item) return
        SelectedStageId = StageId
        document.getElementById('StageName').value = Item.StageName || ''
        document.getElementById('StagePopulation').value = Item.Population || ''
        document.getElementById('StageAreaSize').value = Item.AreaSize || ''
        document.getElementById('StageDescription').value = TruncateText(
          Item.Description || '',
          30,
        )
        document.getElementById('StageDescriptionHidden').value =
          Item.Description || ''
        if (Item.ImgPath) {
          document.getElementById(
            'StageImageBox',
          ).innerHTML = `<img src="${API_BASE_URL}${Item.ImgPath}" alt="舞台画像">`
        }
        const DeleteBtn = document.getElementById('StageDeleteButton')
        if (DeleteBtn) DeleteBtn.classList.remove('Hidden')
      }

      function ClearStageForm() {
        SelectedStageId = null
        document.getElementById('StageName').value = ''
        document.getElementById('StagePopulation').value = ''
        document.getElementById('StageAreaSize').value = ''
        document.getElementById('StageDescription').value = ''
        document.getElementById('StageDescriptionHidden').value = ''
        document.getElementById('StageImageBox').innerHTML =
          '<div class="ImageBoxPlaceholder"><i class="fas fa-map-marked-alt"></i><div>クリックで画像選択</div></div>'
        document.getElementById('StageImageInput').value = ''
        const DeleteBtn = document.getElementById('StageDeleteButton')
        if (DeleteBtn) DeleteBtn.classList.add('Hidden')
      }

      async function SaveStage() {
        const StageName = document.getElementById('StageName').value.trim()
        if (!StageName) {
          await ShowErrorDialog('舞台名を入力してください')
          return
        }
        try {
          ShowSpinner()
          const FormData = new window.FormData()
          if (SelectedStageId) FormData.append('StageId', SelectedStageId)
          FormData.append('WorkId', sessionStorage.getItem('WorkId'))
          FormData.append('StageName', StageName)
          FormData.append(
            'Population',
            document.getElementById('StagePopulation').value,
          )
          FormData.append(
            'AreaSize',
            document.getElementById('StageAreaSize').value,
          )
          FormData.append(
            'Description',
            document.getElementById('StageDescriptionHidden').value,
          )
          FormData.append('UserId', sessionStorage.getItem('UserId'))
          const ImageFile = document.getElementById('StageImageInput').files[0]
          if (ImageFile) FormData.append('Image', ImageFile)
          const Response = await fetch(`${API_BASE_URL}/SaveStage.php`, {
            method: 'POST',
            body: FormData,
          })
          const Result = await Response.json()
          HideSpinner()
          if (Result.Success) {
            await ShowInfoDialog('保存完了', Result.Data.Message)
            ClearStageForm()
            await LoadStageList()
          } else {
            await ShowErrorDialog(Result.Message || '保存に失敗しました')
          }
        } catch (Error) {
          HideSpinner()
          await ShowErrorDialog('保存中にエラーが発生しました')
        }
      }

      async function DeleteStage() {
        if (!SelectedStageId) return
        if (!(await ShowConfirmDialog('この舞台を削除しますか？'))) return
        try {
          const Response = await CallApi('/DeleteStage.php', 'POST', {
            StageId: SelectedStageId,
            WorkId: sessionStorage.getItem('WorkId'),
            UserId: sessionStorage.getItem('UserId'),
          })
          if (Response.Success) {
            await ShowInfoDialog('削除完了', '舞台を削除しました')
            ClearStageForm()
            await LoadStageList()
          } else {
            await ShowErrorDialog(Response.Message || '削除に失敗しました')
          }
        } catch (Error) {
          await ShowErrorDialog('削除中にエラーが発生しました')
        }
      }

      /* ==========================================================================
       * 建物設定画面
       * ========================================================================== */
      let BuildList = []
      let SelectedBuildId = null

      async function ShowBuildingSetting() {
        CurrentPage = 1
        SelectedBuildId = null
        const ContentArea = document.getElementById('ContentArea')
        const CanEditFlg = CanEdit()

        ContentArea.innerHTML = `
              ${CreateContentHeader('建物設定', 'landmark')}
              <div class="FormRow">
                <div class="Flex1">
                  <div class="ImageBox" id="BuildImageBox">
                    <div class="ImageBoxPlaceholder">
                      <i class="fas fa-landmark"></i>
                      <div>クリックで画像選択</div>
                    </div>
                  </div>
                </div>
              </div>
              <input type="file" id="BuildImageInput" accept="image/*" style="display:none;">
              <input type="hidden" id="BuildImagePath">
              <div class="FormRow">
                <div class="FormGroup Flex1">
                  <input type="text" class="InputForm" id="BuildName" placeholder="建物名" maxlength="255" ${
                    !CanEditFlg ? 'disabled' : ''
                  }>
                </div>
              </div>
              <div class="FormRow">
                <div class="FormGroup Flex1 InputWithButton">
                  <input type="text" class="InputForm" id="BuildDate" placeholder="建築日" readonly ${
                    !CanEditFlg ? 'disabled' : ''
                  }>
                  <button class="ButtonClass SecondaryButton ButtonSmall" id="BuildDateBtn"><i class="fas fa-calendar"></i></button>
                </div>
                <div class="FormGroup Flex1">
                  <input type="text" class="InputForm" id="BuildHeight" placeholder="高さ" maxlength="50" ${
                    !CanEditFlg ? 'disabled' : ''
                  }>
                </div>
                <div class="FormGroup Flex1">
                  <input type="text" class="InputForm" id="BuildArea" placeholder="面積" maxlength="50" ${
                    !CanEditFlg ? 'disabled' : ''
                  }>
                </div>
              </div>
              <div class="FormGroup InputWithButton">
                <input type="text" class="InputForm" id="BuildDescription" placeholder="説明" disabled>
                <button class="ButtonClass SecondaryButton ButtonSmall" id="BuildDescriptionBtn"><i class="fas fa-edit"></i></button>
              </div>
              <input type="hidden" id="BuildDescriptionHidden">
              ${
                CanEditFlg
                  ? `
              <div class="ButtonGroup">
                <button class="ButtonClass ClearButton" id="BuildClearButton"><i class="fas fa-sync"></i> クリア</button>
                <button class="ButtonClass SaveButton" id="BuildSaveButton"><i class="fas fa-save"></i> 保存</button>
                <button class="ButtonClass DeleteButton Hidden" id="BuildDeleteButton"><i class="fas fa-trash"></i> 削除</button>
              </div>
              `
                  : ''
              }
              <div id="RecordCountArea" class="MarginTop20"></div>
              <div class="TableContainer" id="BuildTableArea"></div>
              <div id="PaginationArea"></div>
            `

        if (CanEditFlg) {
          document
            .getElementById('BuildDescriptionBtn')
            .addEventListener('click', async () => {
              const Result = await ShowInputAreaDialog(
                document.getElementById('BuildDescriptionHidden').value,
                false,
              )
              if (Result !== null && CanEditFlg) {
                document.getElementById('BuildDescriptionHidden').value = Result
                document.getElementById('BuildDescription').value =
                  TruncateText(Result, 30)
              }
            })

          document
            .getElementById('BuildDateBtn')
            .addEventListener('click', async () => {
              const DatePickerInstance = new DatePicker()
              await DatePickerInstance.openDialog('BuildDate')
            })

          document
            .getElementById('BuildImageBox')
            .addEventListener('click', async () => {
              const BuildImageBox = document.getElementById('BuildImageBox')
              const ImgElement = BuildImageBox.querySelector('img')

              if (!ImgElement) {
                document.getElementById('BuildImageInput').click()
                return
              }

              const Deleted = await ShowImageDialog(ImgElement.src, CanEdit())

              if (Deleted) {
                BuildImageBox.innerHTML = `
                    <div class="ImageBoxPlaceholder">
                      <i class="fas fa-landmark"></i>
                      <div>クリックで画像選択</div>
                    </div>
                  `
                document.getElementById('BuildImagePath').value = ''
                document.getElementById('BuildImageInput').value = ''
              }
            })

          document
            .getElementById('BuildImageInput')
            .addEventListener('change', HandleBuildImageChange)
          document
            .getElementById('BuildClearButton')
            .addEventListener('click', ClearBuildForm)
          document
            .getElementById('BuildSaveButton')
            .addEventListener('click', SaveBuild)
          document
            .getElementById('BuildDeleteButton')
            .addEventListener('click', DeleteBuild)
        } else {
          document
            .getElementById('BuildDescriptionBtn')
            .addEventListener('click', async () => {
              await ShowInputAreaDialog(
                document.getElementById('BuildDescriptionHidden').value,
                true,
              )
            })
          document
            .getElementById('BuildDateBtn')
            .addEventListener('click', async () => {
              const DatePickerInstance = new DatePicker()
              await DatePickerInstance.openDialog('BuildDate')
            })
        }

        await LoadBuildList()
      }

      function HandleBuildImageChange(Event) {
        const File = Event.target.files[0]
        if (!File) return

        const Reader = new FileReader()
        Reader.onload = function (Event) {
          const ImageBox = document.getElementById('BuildImageBox')
          ImageBox.innerHTML = `<img src="${Event.target.result}" alt="建物画像">`
        }
        Reader.readAsDataURL(File)
      }

      async function LoadBuildList() {
        try {
          const WorkId = sessionStorage.getItem('WorkId')
          const Response = await CallApi(
            `/GetBuildList.php?WorkId=${encodeURIComponent(
              WorkId,
            )}&UserId=${encodeURIComponent(sessionStorage.getItem('UserId'))}`,
            'GET',
          )
          if (Response.Success) {
            BuildList = Response.Data.BuildList || []
            RenderBuildTable()
          } else {
            await ShowErrorDialog(
              Response.Message || '建物一覧の取得に失敗しました',
            )
          }
        } catch (Error) {
          console.error(Error)
          await ShowErrorDialog('建物一覧の取得中にエラーが発生しました')
        }
      }

      function RenderBuildTable() {
        const TotalCount = BuildList.length
        document.getElementById(
          'RecordCountArea',
        ).innerHTML = `<span class="RecordCount">${TotalCount} 件</span>`
        const Start = (CurrentPage - 1) * RECORDS_PER_PAGE
        const End = Math.min(Start + RECORDS_PER_PAGE, TotalCount)
        const PageData = BuildList.slice(Start, End)
        let TableHtml = `
              <table class="DataTable">
                <thead><tr><th>建物名</th><th>建築日</th><th>高さ</th><th>面積</th><th>説明</th></tr></thead>
                <tbody>
            `
        if (PageData.length) {
          TableHtml += PageData.map(
            (B) => `
                  <tr data-id="${B.BuildId}">
                    <td>${EscapeHtml(B.BuildName)}</td>
                    <td>${EscapeHtml(
                      FormatDateTimeWithWeekday(B.BuildDate) || '',
                    )}</td>
                    <td>${EscapeHtml(B.Height || '')}</td>
                    <td>${EscapeHtml(B.Area || '')}</td>
                    <td>${EscapeHtml(
                      TruncateText(B.Description || '', 30),
                    )}</td>
                  </tr>
                `,
          ).join('')
        } else {
          TableHtml +=
            '<tr><td colspan="5" class="NoData">データがありません</td></tr>'
        }
        TableHtml += '</tbody></table>'
        document.getElementById('BuildTableArea').innerHTML = TableHtml
        document
          .querySelectorAll('#BuildTableArea tbody tr[data-id]')
          .forEach((Row) => {
            Row.addEventListener('dblclick', () => SelectBuild(Row.dataset.id))
          })
        const PaginationArea = document.getElementById('PaginationArea')
        PaginationArea.innerHTML = ''
        PaginationArea.appendChild(
          CreatePagination(TotalCount, CurrentPage, (Page) => {
            CurrentPage = Page
            RenderBuildTable()
          }),
        )
      }

      function SelectBuild(BuildId) {
        const Item = BuildList.find((B) => B.BuildId == BuildId)
        if (!Item) return
        SelectedBuildId = BuildId
        document.getElementById('BuildName').value = Item.BuildName || ''
        document.getElementById('BuildDate').value = Item.BuildDate || ''
        document.getElementById('BuildHeight').value = Item.Height || ''
        document.getElementById('BuildArea').value = Item.Area || ''
        document.getElementById('BuildDescription').value = TruncateText(
          Item.Description || '',
          30,
        )
        document.getElementById('BuildDescriptionHidden').value =
          Item.Description || ''
        if (Item.ImgPath) {
          document.getElementById(
            'BuildImageBox',
          ).innerHTML = `<img src="${API_BASE_URL}${Item.ImgPath}" alt="建物画像">`
        }
        const DeleteBtn = document.getElementById('BuildDeleteButton')
        if (DeleteBtn) DeleteBtn.classList.remove('Hidden')
      }

      function ClearBuildForm() {
        SelectedBuildId = null
        document.getElementById('BuildName').value = ''
        document.getElementById('BuildDate').value = ''
        document.getElementById('BuildHeight').value = ''
        document.getElementById('BuildArea').value = ''
        document.getElementById('BuildDescription').value = ''
        document.getElementById('BuildDescriptionHidden').value = ''
        document.getElementById('BuildImageBox').innerHTML =
          '<div class="ImageBoxPlaceholder"><i class="fas fa-landmark"></i><div>クリックで画像選択</div></div>'
        document.getElementById('BuildImageInput').value = ''
        const DeleteBtn = document.getElementById('BuildDeleteButton')
        if (DeleteBtn) DeleteBtn.classList.add('Hidden')
      }

      async function SaveBuild() {
        const BuildName = document.getElementById('BuildName').value.trim()
        if (!BuildName) {
          await ShowErrorDialog('建物名を入力してください')
          return
        }
        try {
          ShowSpinner()
          const FormData = new window.FormData()
          if (SelectedBuildId) FormData.append('BuildId', SelectedBuildId)
          FormData.append('WorkId', sessionStorage.getItem('WorkId'))
          FormData.append('BuildName', BuildName)
          FormData.append(
            'BuildDate',
            document.getElementById('BuildDate').value,
          )
          FormData.append(
            'Height',
            document.getElementById('BuildHeight').value,
          )
          FormData.append('Area', document.getElementById('BuildArea').value)
          FormData.append(
            'Description',
            document.getElementById('BuildDescriptionHidden').value,
          )
          FormData.append('UserId', sessionStorage.getItem('UserId'))
          const ImageFile = document.getElementById('BuildImageInput').files[0]
          if (ImageFile) FormData.append('Image', ImageFile)
          const Response = await fetch(`${API_BASE_URL}/SaveBuild.php`, {
            method: 'POST',
            body: FormData,
          })
          const Result = await Response.json()
          HideSpinner()
          if (Result.Success) {
            await ShowInfoDialog('保存完了', Result.Data.Message)
            ClearBuildForm()
            await LoadBuildList()
          } else {
            await ShowErrorDialog(Result.Message || '保存に失敗しました')
          }
        } catch (Error) {
          HideSpinner()
          await ShowErrorDialog('保存中にエラーが発生しました')
        }
      }

      async function DeleteBuild() {
        if (!SelectedBuildId) return
        if (!(await ShowConfirmDialog('この建物を削除しますか？'))) return
        try {
          const Response = await CallApi('/DeleteBuild.php', 'POST', {
            BuildId: SelectedBuildId,
            WorkId: sessionStorage.getItem('WorkId'),
            UserId: sessionStorage.getItem('UserId'),
          })
          if (Response.Success) {
            await ShowInfoDialog('削除完了', '建物を削除しました')
            ClearBuildForm()
            await LoadBuildList()
          } else {
            await ShowErrorDialog(Response.Message || '削除に失敗しました')
          }
        } catch (Error) {
          await ShowErrorDialog('削除中にエラーが発生しました')
        }
      }

      /* ==========================================================================
       * 能力設定画面 (3.9 PowerInfo)
       * ========================================================================== */
      let PowerList = []
      let SelectedPowerId = null

      async function ShowPowerSetting() {
        CurrentPage = 1
        SelectedPowerId = null
        const ContentArea = document.getElementById('ContentArea')
        const CanEditFlg = CanEdit()

        ContentArea.innerHTML = `
              ${CreateContentHeader('能力設定', 'bolt')}
              <div class="FormGroup">
                <input type="text" class="InputForm" id="PowerName" placeholder="能力名" maxlength="150" ${
                  !CanEditFlg ? 'disabled' : ''
                }>
              </div>
              <div class="FormGroup InputWithButton">
                <input type="text" class="InputForm" id="PowerDescription" placeholder="説明" disabled>
                <button class="ButtonClass SecondaryButton ButtonSmall" id="PowerDescriptionBtn"><i class="fas fa-edit"></i></button>
              </div>
              <input type="hidden" id="PowerDescriptionHidden">
              <div class="FormGroup InputWithButton">
                <input type="text" class="InputForm" id="PowerConditions" placeholder="発動条件" disabled>
                <button class="ButtonClass SecondaryButton ButtonSmall" id="PowerConditionsBtn"><i class="fas fa-edit"></i></button>
              </div>
              <input type="hidden" id="PowerConditionsHidden">
              <div class="FormGroup InputWithButton">
                <input type="text" class="InputForm" id="PowerRisk" placeholder="代償・副作用" disabled>
                <button class="ButtonClass SecondaryButton ButtonSmall" id="PowerRiskBtn"><i class="fas fa-edit"></i></button>
              </div>
              <input type="hidden" id="PowerRiskHidden">
              ${
                CanEditFlg
                  ? `
              <div class="ButtonGroup">
                <button class="ButtonClass ClearButton" id="PowerClearButton"><i class="fas fa-sync"></i> クリア</button>
                <button class="ButtonClass SaveButton" id="PowerSaveButton"><i class="fas fa-save"></i> 保存</button>
                <button class="ButtonClass DeleteButton Hidden" id="PowerDeleteButton"><i class="fas fa-trash"></i> 削除</button>
              </div>
              `
                  : ''
              }
              <div id="RecordCountArea" class="MarginTop20"></div>
              <div class="TableContainer" id="PowerTableArea"></div>
              <div id="PaginationArea"></div>
            `

        /** イベント設定 */
        if (CanEditFlg) {
          document
            .getElementById('PowerDescriptionBtn')
            .addEventListener('click', () =>
              ShowInputAreaDialog(
                'PowerDescription',
                'PowerDescriptionHidden',
                CanEditFlg,
              ),
            )
          document
            .getElementById('PowerConditionsBtn')
            .addEventListener('click', () =>
              ShowInputAreaDialog(
                'PowerConditions',
                'PowerConditionsHidden',
                CanEditFlg,
              ),
            )
          document
            .getElementById('PowerRiskBtn')
            .addEventListener('click', () =>
              ShowInputAreaDialog('PowerRisk', 'PowerRiskHidden', CanEditFlg),
            )
          document
            .getElementById('PowerClearButton')
            .addEventListener('click', ClearPowerForm)
          document
            .getElementById('PowerSaveButton')
            .addEventListener('click', SavePower)
          document
            .getElementById('PowerDeleteButton')
            .addEventListener('click', DeletePower)
        } else {
          document
            .getElementById('PowerDescriptionBtn')
            .addEventListener('click', () =>
              ShowInputAreaDialog(
                'PowerDescription',
                'PowerDescriptionHidden',
                false,
              ),
            )
          document
            .getElementById('PowerConditionsBtn')
            .addEventListener('click', () =>
              ShowInputAreaDialog(
                'PowerConditions',
                'PowerConditionsHidden',
                false,
              ),
            )
          document
            .getElementById('PowerRiskBtn')
            .addEventListener('click', () =>
              ShowInputAreaDialog('PowerRisk', 'PowerRiskHidden', false),
            )
        }

        await LoadPowerList()
      }

      async function LoadPowerList() {
        try {
          const WorkId = sessionStorage.getItem('WorkId')
          const Response = await CallApi(
            `/GetPowerList.php?WorkId=${encodeURIComponent(
              WorkId,
            )}&UserId=${encodeURIComponent(sessionStorage.getItem('UserId'))}`,
            'GET',
          )
          if (Response.Success) {
            PowerList = Response.Data.PowerList || []
            RenderPowerTable()
          } else {
            await ShowErrorDialog(
              Response.Message || '能力一覧の取得に失敗しました',
            )
          }
        } catch (Error) {
          console.error(Error)
          await ShowErrorDialog('能力一覧の取得中にエラーが発生しました')
        }
      }

      function RenderPowerTable() {
        const TotalCount = PowerList.length
        document.getElementById(
          'RecordCountArea',
        ).innerHTML = `<span class="RecordCount">${TotalCount} 件</span>`
        const Start = (CurrentPage - 1) * RECORDS_PER_PAGE
        const End = Math.min(Start + RECORDS_PER_PAGE, TotalCount)
        const PageData = PowerList.slice(Start, End)
        let TableHtml = `
              <table class="DataTable">
                <thead><tr><th>能力名</th><th>説明</th><th>発動条件</th><th>代償・副作用</th></tr></thead>
                <tbody>
            `
        if (PageData.length) {
          TableHtml += PageData.map(
            (P) => `
                  <tr data-id="${P.PowerId}">
                    <td>${EscapeHtml(P.PowerName || '')}</td>
                    <td>${TruncateText(
                      EscapeHtml(P.Description || ''),
                      20,
                    )}</td>
                    <td>${TruncateText(EscapeHtml(P.Conditions || ''), 20)}</td>
                    <td>${TruncateText(EscapeHtml(P.Risk || ''), 20)}</td>
                  </tr>
                `,
          ).join('')
        } else {
          TableHtml +=
            '<tr><td colspan="4" class="NoData">データがありません</td></tr>'
        }
        TableHtml += '</tbody></table>'
        document.getElementById('PowerTableArea').innerHTML = TableHtml
        document
          .querySelectorAll('#PowerTableArea tbody tr[data-id]')
          .forEach((Row) => {
            Row.addEventListener('dblclick', () => SelectPower(Row.dataset.id))
          })
        const PaginationArea = document.getElementById('PaginationArea')
        PaginationArea.innerHTML = ''
        PaginationArea.appendChild(
          CreatePagination(TotalCount, CurrentPage, (Page) => {
            CurrentPage = Page
            RenderPowerTable()
          }),
        )
      }

      function SelectPower(PowerId) {
        const Item = PowerList.find((P) => P.PowerId == PowerId)
        if (!Item) return
        SelectedPowerId = PowerId
        document.getElementById('PowerName').value = Item.PowerName || ''
        document.getElementById('PowerDescription').value = TruncateText(
          Item.Description || '',
          30,
        )
        document.getElementById('PowerDescriptionHidden').value =
          Item.Description || ''
        document.getElementById('PowerConditions').value = TruncateText(
          Item.Conditions || '',
          30,
        )
        document.getElementById('PowerConditionsHidden').value =
          Item.Conditions || ''
        document.getElementById('PowerRisk').value = TruncateText(
          Item.Risk || '',
          30,
        )
        document.getElementById('PowerRiskHidden').value = Item.Risk || ''
        const DeleteBtn = document.getElementById('PowerDeleteButton')
        if (DeleteBtn) DeleteBtn.classList.remove('Hidden')
      }

      function ClearPowerForm() {
        SelectedPowerId = null
        document.getElementById('PowerName').value = ''
        document.getElementById('PowerDescription').value = ''
        document.getElementById('PowerDescriptionHidden').value = ''
        document.getElementById('PowerConditions').value = ''
        document.getElementById('PowerConditionsHidden').value = ''
        document.getElementById('PowerRisk').value = ''
        document.getElementById('PowerRiskHidden').value = ''
        const DeleteBtn = document.getElementById('PowerDeleteButton')
        if (DeleteBtn) DeleteBtn.classList.add('Hidden')
      }

      async function SavePower() {
        const PowerName = document.getElementById('PowerName').value.trim()
        if (!PowerName) {
          await ShowErrorDialog('能力名を入力してください')
          return
        }
        try {
          const Response = await CallApi('/SavePower.php', 'POST', {
            PowerId: SelectedPowerId,
            WorkId: sessionStorage.getItem('WorkId'),
            PowerName: PowerName,
            Description: document.getElementById('PowerDescriptionHidden')
              .value,
            Conditions: document.getElementById('PowerConditionsHidden').value,
            Risk: document.getElementById('PowerRiskHidden').value,
            UserId: sessionStorage.getItem('UserId'),
          })
          if (Response.Success) {
            await ShowInfoDialog('保存完了', '能力を保存しました')
            ClearPowerForm()
            await LoadPowerList()
          } else {
            await ShowErrorDialog(Response.Message || '保存に失敗しました')
          }
        } catch (Error) {
          await ShowErrorDialog('保存中にエラーが発生しました')
        }
      }

      async function DeletePower() {
        if (!SelectedPowerId) return
        if (!(await ShowConfirmDialog('この能力を削除しますか？'))) return
        try {
          const Response = await CallApi('/DeletePower.php', 'POST', {
            PowerId: SelectedPowerId,
            WorkId: sessionStorage.getItem('WorkId'),
            UserId: sessionStorage.getItem('UserId'),
          })
          if (Response.Success) {
            await ShowInfoDialog('削除完了', '能力を削除しました')
            ClearPowerForm()
            await LoadPowerList()
          } else {
            await ShowErrorDialog(Response.Message || '削除に失敗しました')
          }
        } catch (Error) {
          await ShowErrorDialog('削除中にエラーが発生しました')
        }
      }

      /* ==========================================================================
       * 武器設定画面 (3.10 WeaponInfo)
       * ========================================================================== */
      let WeaponList = []
      let SelectedWeaponId = null

      async function ShowWeaponSetting() {
        CurrentPage = 1
        SelectedWeaponId = null
        const ContentArea = document.getElementById('ContentArea')
        const CanEditFlg = CanEdit()

        ContentArea.innerHTML = `
              ${CreateContentHeader('武器設定', 'shield-alt')}
              <div class="FormGroup">
                <input type="text" class="InputForm" id="WeaponName" placeholder="武器名" maxlength="150" ${
                  !CanEditFlg ? 'disabled' : ''
                }>
              </div>
              <div class="FormGroup InputWithButton">
                <input type="text" class="InputForm" id="WeaponDescription" placeholder="説明" disabled>
                <button class="ButtonClass SecondaryButton ButtonSmall" id="WeaponDescriptionBtn"><i class="fas fa-edit"></i></button>
              </div>
              <input type="hidden" id="WeaponDescriptionHidden">
              ${
                CanEditFlg
                  ? `
              <div class="FormGroup">
                <div class="ImageUploadArea" id="WeaponImageArea">
                  <div class="ImageBox" id="WeaponImageBox">
                    <span class="ImagePlaceholder"><i class="fas fa-image"></i> 画像を選択</span>
                  </div>
                  <input type="file" id="WeaponImageInput" accept="image/*" style="display:none;">
                </div>
              </div>
              <div class="ButtonGroup">
                <button class="ButtonClass ClearButton" id="WeaponClearButton"><i class="fas fa-sync"></i> クリア</button>
                <button class="ButtonClass SaveButton" id="WeaponSaveButton"><i class="fas fa-save"></i> 保存</button>
                <button class="ButtonClass DeleteButton Hidden" id="WeaponDeleteButton"><i class="fas fa-trash"></i> 削除</button>
              </div>
              `
                  : ''
              }
              <div id="RecordCountArea" class="MarginTop20"></div>
              <div class="TableContainer" id="WeaponTableArea"></div>
              <div id="PaginationArea"></div>
            `

        /** イベント設定 */
        if (CanEditFlg) {
          document
            .getElementById('WeaponDescriptionBtn')
            .addEventListener('click', () =>
              ShowInputAreaDialog(
                'WeaponDescription',
                'WeaponDescriptionHidden',
                CanEditFlg,
              ),
            )
          document
            .getElementById('WeaponImageBox')
            .addEventListener('click', () =>
              document.getElementById('WeaponImageInput').click(),
            )
          document
            .getElementById('WeaponImageInput')
            .addEventListener('change', (E) =>
              PreviewImage(E, 'WeaponImageBox'),
            )
          document
            .getElementById('WeaponClearButton')
            .addEventListener('click', ClearWeaponForm)
          document
            .getElementById('WeaponSaveButton')
            .addEventListener('click', SaveWeapon)
          document
            .getElementById('WeaponDeleteButton')
            .addEventListener('click', DeleteWeapon)
        } else {
          document
            .getElementById('WeaponDescriptionBtn')
            .addEventListener('click', () =>
              ShowInputAreaDialog(
                'WeaponDescription',
                'WeaponDescriptionHidden',
                false,
              ),
            )
        }

        await LoadWeaponList()
      }

      async function LoadWeaponList() {
        try {
          const WorkId = sessionStorage.getItem('WorkId')
          const Response = await CallApi(
            `/GetWeaponList.php?WorkId=${encodeURIComponent(
              WorkId,
            )}&UserId=${encodeURIComponent(sessionStorage.getItem('UserId'))}`,
            'GET',
          )
          if (Response.Success) {
            WeaponList = Response.Data.WeaponList || []
            RenderWeaponTable()
          } else {
            await ShowErrorDialog(
              Response.Message || '武器一覧の取得に失敗しました',
            )
          }
        } catch (Error) {
          console.error(Error)
          await ShowErrorDialog('武器一覧の取得中にエラーが発生しました')
        }
      }

      function RenderWeaponTable() {
        const TotalCount = WeaponList.length
        document.getElementById(
          'RecordCountArea',
        ).innerHTML = `<span class="RecordCount">${TotalCount} 件</span>`
        const Start = (CurrentPage - 1) * RECORDS_PER_PAGE
        const End = Math.min(Start + RECORDS_PER_PAGE, TotalCount)
        const PageData = WeaponList.slice(Start, End)
        let TableHtml = `
              <table class="DataTable">
                <thead><tr><th>武器名</th><th>説明</th><th>画像</th></tr></thead>
                <tbody>
            `
        if (PageData.length) {
          TableHtml += PageData.map(
            (W) => `
                  <tr data-id="${W.WeaponId}">
                    <td>${EscapeHtml(W.WeaponName || '')}</td>
                    <td>${TruncateText(
                      EscapeHtml(W.Description || ''),
                      30,
                    )}</td>
                    <td>${
                      W.ImgPath
                        ? `<img src="${API_BASE_URL}${W.ImgPath}" class="TableThumbnail" alt="武器画像">`
                        : '-'
                    }</td>
                  </tr>
                `,
          ).join('')
        } else {
          TableHtml +=
            '<tr><td colspan="3" class="NoData">データがありません</td></tr>'
        }
        TableHtml += '</tbody></table>'
        document.getElementById('WeaponTableArea').innerHTML = TableHtml
        document
          .querySelectorAll('#WeaponTableArea tbody tr[data-id]')
          .forEach((Row) => {
            Row.addEventListener('dblclick', () => SelectWeapon(Row.dataset.id))
          })
        const PaginationArea = document.getElementById('PaginationArea')
        PaginationArea.innerHTML = ''
        PaginationArea.appendChild(
          CreatePagination(TotalCount, CurrentPage, (Page) => {
            CurrentPage = Page
            RenderWeaponTable()
          }),
        )
      }

      function SelectWeapon(WeaponId) {
        const Item = WeaponList.find((W) => W.WeaponId == WeaponId)
        if (!Item) return
        SelectedWeaponId = WeaponId
        document.getElementById('WeaponName').value = Item.WeaponName || ''
        document.getElementById('WeaponDescription').value = TruncateText(
          Item.Description || '',
          30,
        )
        document.getElementById('WeaponDescriptionHidden').value =
          Item.Description || ''
        const ImageBox = document.getElementById('WeaponImageBox')
        if (ImageBox && Item.ImgPath) {
          ImageBox.innerHTML = `<img src="${API_BASE_URL}${Item.ImgPath}" alt="武器画像">`
        }
        const DeleteBtn = document.getElementById('WeaponDeleteButton')
        if (DeleteBtn) DeleteBtn.classList.remove('Hidden')
      }

      function ClearWeaponForm() {
        SelectedWeaponId = null
        document.getElementById('WeaponName').value = ''
        document.getElementById('WeaponDescription').value = ''
        document.getElementById('WeaponDescriptionHidden').value = ''
        const ImageBox = document.getElementById('WeaponImageBox')
        if (ImageBox) {
          ImageBox.innerHTML =
            '<span class="ImagePlaceholder"><i class="fas fa-image"></i> 画像を選択</span>'
        }
        const ImageInput = document.getElementById('WeaponImageInput')
        if (ImageInput) ImageInput.value = ''
        const DeleteBtn = document.getElementById('WeaponDeleteButton')
        if (DeleteBtn) DeleteBtn.classList.add('Hidden')
      }

      async function SaveWeapon() {
        const WeaponName = document.getElementById('WeaponName').value.trim()
        if (!WeaponName) {
          await ShowErrorDialog('武器名を入力してください')
          return
        }
        try {
          ShowSpinner()
          const FormData = new window.FormData()
          if (SelectedWeaponId) FormData.append('WeaponId', SelectedWeaponId)
          FormData.append('WorkId', sessionStorage.getItem('WorkId'))
          FormData.append('WeaponName', WeaponName)
          FormData.append(
            'Description',
            document.getElementById('WeaponDescriptionHidden').value,
          )
          FormData.append('UserId', sessionStorage.getItem('UserId'))
          const ImageFile = document.getElementById('WeaponImageInput').files[0]
          if (ImageFile) FormData.append('Image', ImageFile)
          const Response = await fetch(`${API_BASE_URL}/SaveWeapon.php`, {
            method: 'POST',
            body: FormData,
          })
          const Result = await Response.json()
          HideSpinner()
          if (Result.Success) {
            await ShowInfoDialog('保存完了', '武器を保存しました')
            ClearWeaponForm()
            await LoadWeaponList()
          } else {
            await ShowErrorDialog(Result.Message || '保存に失敗しました')
          }
        } catch (Error) {
          HideSpinner()
          await ShowErrorDialog('保存中にエラーが発生しました')
        }
      }

      async function DeleteWeapon() {
        if (!SelectedWeaponId) return
        if (!(await ShowConfirmDialog('この武器を削除しますか？'))) return
        try {
          const Response = await CallApi('/DeleteWeapon.php', 'POST', {
            WeaponId: SelectedWeaponId,
            WorkId: sessionStorage.getItem('WorkId'),
            UserId: sessionStorage.getItem('UserId'),
          })
          if (Response.Success) {
            await ShowInfoDialog('削除完了', '武器を削除しました')
            ClearWeaponForm()
            await LoadWeaponList()
          } else {
            await ShowErrorDialog(Response.Message || '削除に失敗しました')
          }
        } catch (Error) {
          await ShowErrorDialog('削除中にエラーが発生しました')
        }
      }

      /* ==========================================================================
       * 技設定画面 (3.11 MoveInfo)
       * ========================================================================== */
      let MoveList = []
      let PowerListForMove = []
      let SelectedMoveId = null

      async function ShowMoveSetting() {
        CurrentPage = 1
        SelectedMoveId = null
        const ContentArea = document.getElementById('ContentArea')
        const CanEditFlg = CanEdit()

        ContentArea.innerHTML = `
              ${CreateContentHeader('技設定', 'fire')}
              <div class="FormRow">
                <div class="FormGroup Flex1">
                  <input type="text" class="InputForm" id="MoveName" placeholder="技名" maxlength="150" ${
                    !CanEditFlg ? 'disabled' : ''
                  }>
                </div>
                <div class="FormGroup Flex1">
                  <select class="SelectForm" id="MovePowerId" ${
                    !CanEditFlg ? 'disabled' : ''
                  }>
                    <option value="">関連能力を選択</option>
                  </select>
                </div>
              </div>
              <div class="FormGroup InputWithButton">
                <input type="text" class="InputForm" id="MoveDescription" placeholder="説明" disabled>
                <button class="ButtonClass SecondaryButton ButtonSmall" id="MoveDescriptionBtn"><i class="fas fa-edit"></i></button>
              </div>
              <input type="hidden" id="MoveDescriptionHidden">
              ${
                CanEditFlg
                  ? `
              <div class="ButtonGroup">
                <button class="ButtonClass ClearButton" id="MoveClearButton"><i class="fas fa-sync"></i> クリア</button>
                <button class="ButtonClass SaveButton" id="MoveSaveButton"><i class="fas fa-save"></i> 保存</button>
                <button class="ButtonClass DeleteButton Hidden" id="MoveDeleteButton"><i class="fas fa-trash"></i> 削除</button>
              </div>
              `
                  : ''
              }
              <div id="RecordCountArea" class="MarginTop20"></div>
              <div class="TableContainer" id="MoveTableArea"></div>
              <div id="PaginationArea"></div>
            `

        if (CanEditFlg) {
          document
            .getElementById('MoveDescriptionBtn')
            .addEventListener('click', async () => {
              const Result = await ShowInputAreaDialog(
                document.getElementById('MoveDescriptionHidden').value,
                false,
              )
              if (Result !== null && CanEditFlg) {
                document.getElementById('MoveDescriptionHidden').value = Result
                document.getElementById('MoveDescription').value = TruncateText(
                  Result,
                  30,
                )
              }
            })

          document
            .getElementById('MoveClearButton')
            .addEventListener('click', ClearMoveForm)
          document
            .getElementById('MoveSaveButton')
            .addEventListener('click', SaveMove)
          document
            .getElementById('MoveDeleteButton')
            .addEventListener('click', DeleteMove)
        } else {
          document
            .getElementById('MoveDescriptionBtn')
            .addEventListener('click', async () => {
              await ShowInputAreaDialog(
                document.getElementById('MoveDescriptionHidden').value,
                true,
              )
            })
        }

        await LoadMoveList()
      }

      async function LoadMoveList() {
        try {
          const WorkId = sessionStorage.getItem('WorkId')
          const Response = await CallApi(
            `/GetMoveList.php?WorkId=${encodeURIComponent(
              WorkId,
            )}&UserId=${encodeURIComponent(sessionStorage.getItem('UserId'))}`,
            'GET',
          )
          if (Response.Success) {
            MoveList = Response.Data.MoveList || []
            PowerListForMove = Response.Data.PowerList || []
            UpdateMovePowerSelect()
            RenderMoveTable()
          } else {
            await ShowErrorDialog(
              Response.Message || '技一覧の取得に失敗しました',
            )
          }
        } catch (Error) {
          console.error(Error)
          await ShowErrorDialog('技一覧の取得中にエラーが発生しました')
        }
      }

      function UpdateMovePowerSelect() {
        const Select = document.getElementById('MovePowerId')
        if (!Select) return
        Select.innerHTML =
          '<option value="">関連能力を選択</option>' +
          PowerListForMove.map(
            (P) => `<option value="${P.PowerId}">${P.PowerName}</option>`,
          ).join('')
      }

      function RenderMoveTable() {
        const TotalCount = MoveList.length
        document.getElementById(
          'RecordCountArea',
        ).innerHTML = `<span class="RecordCount">${TotalCount} 件</span>`
        const Start = (CurrentPage - 1) * RECORDS_PER_PAGE
        const End = Math.min(Start + RECORDS_PER_PAGE, TotalCount)
        const PageData = MoveList.slice(Start, End)
        let TableHtml = `
              <table class="DataTable">
                <thead><tr><th>技名</th><th>関連能力</th><th>説明</th></tr></thead>
                <tbody>
            `
        if (PageData.length) {
          TableHtml += PageData.map(
            (M) => `
                  <tr data-id="${M.MoveId}">
                    <td>${EscapeHtml(M.MoveName)}</td>
                    <td>${EscapeHtml(M.PowerName || '')}</td>
                    <td>${EscapeHtml(
                      TruncateText(M.Description || '', 30),
                    )}</td>
                  </tr>
                `,
          ).join('')
        } else {
          TableHtml +=
            '<tr><td colspan="3" class="NoData">データがありません</td></tr>'
        }
        TableHtml += '</tbody></table>'
        document.getElementById('MoveTableArea').innerHTML = TableHtml
        document
          .querySelectorAll('#MoveTableArea tbody tr[data-id]')
          .forEach((Row) => {
            Row.addEventListener('dblclick', () => SelectMove(Row.dataset.id))
          })
        const PaginationArea = document.getElementById('PaginationArea')
        PaginationArea.innerHTML = ''
        PaginationArea.appendChild(
          CreatePagination(TotalCount, CurrentPage, (Page) => {
            CurrentPage = Page
            RenderMoveTable()
          }),
        )
      }

      function SelectMove(MoveId) {
        const Item = MoveList.find((M) => M.MoveId == MoveId)
        if (!Item) return
        SelectedMoveId = MoveId
        document.getElementById('MoveName').value = Item.MoveName || ''
        document.getElementById('MovePowerId').value = Item.PowerId || ''
        document.getElementById('MoveDescription').value = TruncateText(
          Item.Description || '',
          30,
        )
        document.getElementById('MoveDescriptionHidden').value =
          Item.Description || ''
        const DeleteBtn = document.getElementById('MoveDeleteButton')
        if (DeleteBtn) DeleteBtn.classList.remove('Hidden')
      }

      function ClearMoveForm() {
        SelectedMoveId = null
        document.getElementById('MoveName').value = ''
        document.getElementById('MovePowerId').value = ''
        document.getElementById('MoveDescription').value = ''
        document.getElementById('MoveDescriptionHidden').value = ''
        const DeleteBtn = document.getElementById('MoveDeleteButton')
        if (DeleteBtn) DeleteBtn.classList.add('Hidden')
      }

      async function SaveMove() {
        const MoveName = document.getElementById('MoveName').value.trim()
        if (!MoveName) {
          await ShowErrorDialog('技名を入力してください')
          return
        }
        try {
          ShowSpinner()
          const RequestData = {
            WorkId: sessionStorage.getItem('WorkId'),
            MoveName: MoveName,
            PowerId: document.getElementById('MovePowerId').value,
            Description: document.getElementById('MoveDescriptionHidden').value,
            UserId: sessionStorage.getItem('UserId'),
          }
          if (SelectedMoveId) RequestData.MoveId = SelectedMoveId

          const Response = await CallApi('/SaveMove.php', 'POST', RequestData)
          HideSpinner()
          if (Response.Success) {
            await ShowInfoDialog('保存完了', Response.Data.Message)
            ClearMoveForm()
            await LoadMoveList()
          } else {
            await ShowErrorDialog(Response.Message || '保存に失敗しました')
          }
        } catch (Error) {
          HideSpinner()
          await ShowErrorDialog('保存中にエラーが発生しました')
        }
      }

      async function DeleteMove() {
        if (!SelectedMoveId) return
        if (!(await ShowConfirmDialog('この技を削除しますか？'))) return
        try {
          const Response = await CallApi('/DeleteMove.php', 'POST', {
            MoveId: SelectedMoveId,
            WorkId: sessionStorage.getItem('WorkId'),
            UserId: sessionStorage.getItem('UserId'),
          })
          if (Response.Success) {
            await ShowInfoDialog('削除完了', '技を削除しました')
            ClearMoveForm()
            await LoadMoveList()
          } else {
            await ShowErrorDialog(Response.Message || '削除に失敗しました')
          }
        } catch (Error) {
          await ShowErrorDialog('削除中にエラーが発生しました')
        }
      }

      /* ==========================================================================
       * セリフ設定画面 (4.2 SerifInfo)
       * ========================================================================== */
      let SerifList = []
      let CharaListForSerif = []
      let SelectedSerifId = null

      async function ShowSerifSetting() {
        CurrentPage = 1
        SelectedSerifId = null
        const ContentArea = document.getElementById('ContentArea')
        const CanEditFlg = CanEdit()

        ContentArea.innerHTML = `
              ${CreateContentHeader('セリフ設定', 'comment')}
              <div class="FormRow">
                <div class="FormGroup Flex1">
                  <select class="SelectForm" id="SerifCharaId" ${
                    !CanEditFlg ? 'disabled' : ''
                  }>
                    <option value="">キャラクターを選択</option>
                  </select>
                </div>
                <div class="FormGroup Flex1">
                  <input type="text" class="InputForm" id="SerifSituation" placeholder="場面" maxlength="255" ${
                    !CanEditFlg ? 'disabled' : ''
                  }>
                </div>
              </div>
              <div class="FormGroup InputWithButton">
                <input type="text" class="InputForm" id="SerifContent" placeholder="セリフ内容" disabled>
                <button class="ButtonClass SecondaryButton ButtonSmall" id="SerifContentBtn"><i class="fas fa-edit"></i></button>
              </div>
              <input type="hidden" id="SerifContentHidden">
              ${
                CanEditFlg
                  ? `
              <div class="ButtonGroup">
                <button class="ButtonClass ClearButton" id="SerifClearButton"><i class="fas fa-sync"></i> クリア</button>
                <button class="ButtonClass SaveButton" id="SerifSaveButton"><i class="fas fa-save"></i> 保存</button>
                <button class="ButtonClass DeleteButton Hidden" id="SerifDeleteButton"><i class="fas fa-trash"></i> 削除</button>
              </div>
              `
                  : ''
              }
              <div id="RecordCountArea" class="MarginTop20"></div>
              <div class="TableContainer" id="SerifTableArea"></div>
              <div id="PaginationArea"></div>
            `

        if (CanEditFlg) {
          document
            .getElementById('SerifContentBtn')
            .addEventListener('click', async () => {
              const Result = await ShowInputAreaDialog(
                document.getElementById('SerifContentHidden').value,
                false,
              )
              if (Result !== null && CanEditFlg) {
                document.getElementById('SerifContentHidden').value = Result
                document.getElementById('SerifContent').value = TruncateText(
                  Result,
                  30,
                )
              }
            })

          document
            .getElementById('SerifClearButton')
            .addEventListener('click', ClearSerifForm)
          document
            .getElementById('SerifSaveButton')
            .addEventListener('click', SaveSerif)
          document
            .getElementById('SerifDeleteButton')
            .addEventListener('click', DeleteSerif)
        } else {
          document
            .getElementById('SerifContentBtn')
            .addEventListener('click', async () => {
              await ShowInputAreaDialog(
                document.getElementById('SerifContentHidden').value,
                true,
              )
            })
        }

        await LoadSerifList()
      }

      async function LoadSerifList() {
        try {
          const WorkId = sessionStorage.getItem('WorkId')
          const Response = await CallApi(
            `/GetSerifList.php?WorkId=${encodeURIComponent(
              WorkId,
            )}&UserId=${encodeURIComponent(sessionStorage.getItem('UserId'))}`,
            'GET',
          )
          if (Response.Success) {
            SerifList = Response.Data.SerifList || []
            CharaListForSerif = Response.Data.CharacterList || []
            UpdateSerifCharaSelect()
            RenderSerifTable()
          } else {
            await ShowErrorDialog(
              Response.Message || 'セリフ一覧の取得に失敗しました',
            )
          }
        } catch (Error) {
          console.error(Error)
          await ShowErrorDialog('セリフ一覧の取得中にエラーが発生しました')
        }
      }

      function UpdateSerifCharaSelect() {
        const Select = document.getElementById('SerifCharaId')
        if (!Select) return
        Select.innerHTML =
          '<option value="">キャラクターを選択</option>' +
          CharaListForSerif.map(
            (C) => `<option value="${C.CharaId}">${C.CharaName}</option>`,
          ).join('')
      }

      function RenderSerifTable() {
        const TotalCount = SerifList.length
        document.getElementById(
          'RecordCountArea',
        ).innerHTML = `<span class="RecordCount">${TotalCount} 件</span>`
        const Start = (CurrentPage - 1) * RECORDS_PER_PAGE
        const End = Math.min(Start + RECORDS_PER_PAGE, TotalCount)
        const PageData = SerifList.slice(Start, End)
        let TableHtml = `
              <table class="DataTable">
                <thead><tr><th>キャラクター</th><th>場面</th><th>セリフ内容</th></tr></thead>
                <tbody>
            `
        if (PageData.length) {
          TableHtml += PageData.map(
            (S) => `
                  <tr data-id="${S.SerifId}">
                    <td>${EscapeHtml(S.CharaName || '(未設定)')}</td>
                    <td>${EscapeHtml(S.Situation || '')}</td>
                    <td>${EscapeHtml(TruncateText(S.Content || '', 30))}</td>
                  </tr>
                `,
          ).join('')
        } else {
          TableHtml +=
            '<tr><td colspan="3" class="NoData">データがありません</td></tr>'
        }
        TableHtml += '</tbody></table>'
        document.getElementById('SerifTableArea').innerHTML = TableHtml
        document
          .querySelectorAll('#SerifTableArea tbody tr[data-id]')
          .forEach((Row) => {
            Row.addEventListener('dblclick', () => SelectSerif(Row.dataset.id))
          })
        const PaginationArea = document.getElementById('PaginationArea')
        PaginationArea.innerHTML = ''
        PaginationArea.appendChild(
          CreatePagination(TotalCount, CurrentPage, (Page) => {
            CurrentPage = Page
            RenderSerifTable()
          }),
        )
      }

      function SelectSerif(SerifId) {
        const Item = SerifList.find((S) => S.SerifId == SerifId)
        if (!Item) return
        SelectedSerifId = SerifId
        document.getElementById('SerifCharaId').value = Item.CharaId || ''
        document.getElementById('SerifSituation').value = Item.Situation || ''
        document.getElementById('SerifContent').value = TruncateText(
          Item.Content || '',
          30,
        )
        document.getElementById('SerifContentHidden').value = Item.Content || ''
        const DeleteBtn = document.getElementById('SerifDeleteButton')
        if (DeleteBtn) DeleteBtn.classList.remove('Hidden')
      }

      function ClearSerifForm() {
        SelectedSerifId = null
        document.getElementById('SerifCharaId').value = ''
        document.getElementById('SerifSituation').value = ''
        document.getElementById('SerifContent').value = ''
        document.getElementById('SerifContentHidden').value = ''
        const DeleteBtn = document.getElementById('SerifDeleteButton')
        if (DeleteBtn) DeleteBtn.classList.add('Hidden')
      }

      async function SaveSerif() {
        const Content = document
          .getElementById('SerifContentHidden')
          .value.trim()
        if (!Content) {
          await ShowErrorDialog('セリフ内容を入力してください')
          return
        }
        try {
          ShowSpinner()
          const RequestData = {
            WorkId: sessionStorage.getItem('WorkId'),
            CharaId: document.getElementById('SerifCharaId').value,
            Content: Content,
            Situation: document.getElementById('SerifSituation').value,
            UserId: sessionStorage.getItem('UserId'),
          }
          if (SelectedSerifId) RequestData.SerifId = SelectedSerifId

          const Response = await CallApi('/SaveSerif.php', 'POST', RequestData)
          HideSpinner()
          if (Response.Success) {
            await ShowInfoDialog('保存完了', Response.Data.Message)
            ClearSerifForm()
            await LoadSerifList()
          } else {
            await ShowErrorDialog(Response.Message || '保存に失敗しました')
          }
        } catch (Error) {
          HideSpinner()
          await ShowErrorDialog('保存中にエラーが発生しました')
        }
      }

      async function DeleteSerif() {
        if (!SelectedSerifId) return
        if (!(await ShowConfirmDialog('このセリフを削除しますか？'))) return
        try {
          const Response = await CallApi('/DeleteSerif.php', 'POST', {
            SerifId: SelectedSerifId,
            WorkId: sessionStorage.getItem('WorkId'),
            UserId: sessionStorage.getItem('UserId'),
          })
          if (Response.Success) {
            await ShowInfoDialog('削除完了', 'セリフを削除しました')
            ClearSerifForm()
            await LoadSerifList()
          } else {
            await ShowErrorDialog(Response.Message || '削除に失敗しました')
          }
        } catch (Error) {
          await ShowErrorDialog('削除中にエラーが発生しました')
        }
      }

      /* ==========================================================================
       * 相関図作成画面 (5.1, 5.2 RelationObjectInfo, RelationInfo)
       * ========================================================================== */
      let RelationObjects = []
      let RelationLines = []
      let RelationCharaList = []
      let SelectedRelationObject = null
      let IsDraggingObject = false
      let DragStartX = 0
      let DragStartY = 0
      let IsDrawingLine = false
      let LineStartObjId = null
      let CurrentLineType = 1
      let CurrentRelationType = '好意'
      let CurrentRelationColor = '#e74c3c'
      const RelationTypes = [
        { name: '好意', color: '#e74c3c' },
        { name: '敵意', color: '#2c3e50' },
        { name: '疑心', color: '#9b59b6' },
        { name: '友情', color: '#3498db' },
        { name: '家族', color: '#27ae60' },
        { name: 'ライバル', color: '#f39c12' },
      ]

      async function ShowRelationDiagram() {
        const ContentArea = document.getElementById('ContentArea')
        const CanEditFlg = CanEdit()
        ContentArea.innerHTML = `
              ${CreateContentHeader('相関図作成', 'project-diagram')}
              ${
                CanEditFlg
                  ? `
              <div class="ButtonGroup MarginBottom20">
                <button class="ButtonClass PrimaryButton" id="RelationSaveBtn"><i class="fas fa-save"></i> 保存</button>
                <button class="ButtonClass SecondaryButton" id="RelationAddGroupBtn"><i class="fas fa-object-group"></i> グループ追加</button>
                <select class="SelectForm" id="RelationLineTypeSelect" style="width:auto;">
                  <option value="1">矢印線（感情）</option>
                  <option value="2">直線（関係）</option>
                </select>
              </div>
              <div class="RelationTypeSelector" id="RelationTypeSelector">
                ${RelationTypes.map(
                  (T, I) =>
                    `<div class="RelationTypeOption ${
                      I === 0 ? 'selected' : ''
                    }" data-type="${T.name}" data-color="${
                      T.color
                    }" style="color:${T.color};border-color:${T.color};">${
                      T.name
                    }</div>`,
                ).join('')}
              </div>
              `
                  : ''
              }
              <div class="RelationContainer">
                <div class="RelationSidebar" id="RelationSidebar">
                  <div class="RelationSidebarTitle"><i class="fas fa-users"></i> キャラクター</div>
                  <div id="RelationCharaList"></div>
                </div>
                <div class="RelationCanvas" id="RelationCanvas">
                  <svg class="RelationCanvasSvg" id="RelationSvg"></svg>
                  ${
                    CanEditFlg
                      ? `<div class="TrashZone" id="TrashZone"><i class="fas fa-trash"></i></div>`
                      : ''
                  }
                </div>
              </div>
            `
        await LoadRelationCharaList()
        await LoadRelationData()
        if (CanEditFlg) SetupRelationEvents()
      }

      async function LoadRelationCharaList() {
        try {
          const WorkId = sessionStorage.getItem('WorkId')
          const Response = await CallApi(
            `/GetCharacterList.php?WorkId=${encodeURIComponent(WorkId)}`,
            'GET',
          )
          if (Response.Success) {
            RelationCharaList = Response.Data || []
            RenderRelationCharaList()
          }
        } catch (Error) {
          console.error(Error)
        }
      }

      function RenderRelationCharaList() {
        const Container = document.getElementById('RelationCharaList')
        if (!Container) return
        Container.innerHTML = RelationCharaList.map(
          (C) =>
            `<div class="CharacterListItem" draggable="true" data-charaid="${C.CharaId}" data-charaname="${C.CharaName}">${C.CharaName}</div>`,
        ).join('')
        if (CanEdit()) {
          Container.querySelectorAll('.CharacterListItem').forEach((Item) => {
            Item.addEventListener('dragstart', HandleCharaDragStart)
            Item.addEventListener('dragend', HandleCharaDragEnd)
          })
        }
      }

      function HandleCharaDragStart(E) {
        E.dataTransfer.setData(
          'text/plain',
          JSON.stringify({
            charaId: E.target.dataset.charaid,
            charaName: E.target.dataset.charaname,
          }),
        )
        E.target.classList.add('dragging')
      }

      function HandleCharaDragEnd(E) {
        E.target.classList.remove('dragging')
      }

      async function LoadRelationData() {
        try {
          const WorkId = sessionStorage.getItem('WorkId')
          const [ObjRes, LineRes] = await Promise.all([
            CallApi(
              `/GetRelationObjects.php?WorkId=${encodeURIComponent(WorkId)}`,
              'GET',
            ),
            CallApi(
              `/GetRelationLines.php?WorkId=${encodeURIComponent(WorkId)}`,
              'GET',
            ),
          ])
          RelationObjects = ObjRes.Success ? ObjRes.Data || [] : []
          RelationLines = LineRes.Success ? LineRes.Data || [] : []
          RenderRelationCanvas()
        } catch (Error) {
          console.error(Error)
        }
      }

      function RenderRelationCanvas() {
        const Canvas = document.getElementById('RelationCanvas')
        const Svg = document.getElementById('RelationSvg')
        if (!Canvas || !Svg) return
        Canvas.querySelectorAll('.RelationObject, .RelationGroupBox').forEach(
          (E) => E.remove(),
        )
        Svg.innerHTML = ''
        RelationObjects.forEach((Obj) => {
          if (Obj.ObjType === 2) {
            const GroupBox = document.createElement('div')
            GroupBox.className = 'RelationGroupBox'
            GroupBox.dataset.objid = Obj.ObjId
            GroupBox.style.left = Obj.PosX + 'px'
            GroupBox.style.top = Obj.PosY + 'px'
            GroupBox.style.width = (Obj.Width || 150) + 'px'
            GroupBox.style.height = (Obj.Height || 100) + 'px'
            if (Obj.BgColor) GroupBox.style.borderColor = Obj.BgColor
            if (Obj.Label)
              GroupBox.innerHTML = `<div class="RelationGroupLabel" style="background:${
                Obj.BgColor || '#9b59b6'
              }">${Obj.Label}</div>`
            Canvas.insertBefore(GroupBox, Svg)
          } else {
            const CharaObj = document.createElement('div')
            CharaObj.className = 'RelationObject'
            CharaObj.dataset.objid = Obj.ObjId
            CharaObj.dataset.charaid = Obj.TargetId
            CharaObj.style.left = Obj.PosX + 'px'
            CharaObj.style.top = Obj.PosY + 'px'
            const Chara = RelationCharaList.find(
              (C) => C.CharaId === Obj.TargetId,
            )
            CharaObj.innerHTML = `${
              Chara?.ImgPath ? `<img src="${Chara.ImgPath}" alt="">` : ''
            }<div>${Chara?.CharaName || Obj.Label || '不明'}</div>`
            Canvas.appendChild(CharaObj)
          }
        })
        RelationLines.forEach((Line) => {
          const SourceObj = RelationObjects.find(
            (O) => O.ObjId == Line.SourceObjId,
          )
          const TargetObj = RelationObjects.find(
            (O) => O.ObjId == Line.TargetObjId,
          )
          if (!SourceObj || !TargetObj) return
          const X1 = SourceObj.PosX + 50,
            Y1 = SourceObj.PosY + 40
          const X2 = TargetObj.PosX + 50,
            Y2 = TargetObj.PosY + 40
          if (Line.LineType === 1) {
            const Path = document.createElementNS(
              'http://www.w3.org/2000/svg',
              'path',
            )
            const Dx = X2 - X1,
              Dy = Y2 - Y1,
              Len = Math.sqrt(Dx * Dx + Dy * Dy)
            const UnitX = Dx / Len,
              UnitY = Dy / Len
            const ArrowLen = 10,
              ArrowX = X2 - UnitX * 15,
              ArrowY = Y2 - UnitY * 15
            const LeftX = ArrowX - UnitY * ArrowLen - UnitX * ArrowLen
            const LeftY = ArrowY + UnitX * ArrowLen - UnitY * ArrowLen
            const RightX = ArrowX + UnitY * ArrowLen - UnitX * ArrowLen
            const RightY = ArrowY - UnitX * ArrowLen - UnitY * ArrowLen
            Path.setAttribute(
              'd',
              `M${X1},${Y1} L${X2 - UnitX * 15},${
                Y2 - UnitY * 15
              } M${ArrowX},${ArrowY} L${LeftX},${LeftY} M${ArrowX},${ArrowY} L${RightX},${RightY}`,
            )
            Path.setAttribute('stroke', Line.Color || '#e74c3c')
            Path.setAttribute('stroke-width', '2')
            Path.setAttribute('fill', 'none')
            Path.dataset.relationid = Line.RelationId
            Svg.appendChild(Path)
          } else {
            const LineEl = document.createElementNS(
              'http://www.w3.org/2000/svg',
              'line',
            )
            LineEl.setAttribute('x1', X1)
            LineEl.setAttribute('y1', Y1)
            LineEl.setAttribute('x2', X2)
            LineEl.setAttribute('y2', Y2)
            LineEl.setAttribute('stroke', Line.Color || '#3498db')
            LineEl.setAttribute('stroke-width', '2')
            LineEl.dataset.relationid = Line.RelationId
            Svg.appendChild(LineEl)
          }
          const TextX = (X1 + X2) / 2,
            TextY = (Y1 + Y2) / 2 - 5
          const Text = document.createElementNS(
            'http://www.w3.org/2000/svg',
            'text',
          )
          Text.setAttribute('x', TextX)
          Text.setAttribute('y', TextY)
          Text.setAttribute('fill', Line.Color || '#333')
          Text.setAttribute('font-size', '10')
          Text.setAttribute('text-anchor', 'middle')
          Text.textContent = Line.RelationType || ''
          Svg.appendChild(Text)
        })
        if (CanEdit()) SetupRelationObjectEvents()
      }

      function SetupRelationEvents() {
        const Canvas = document.getElementById('RelationCanvas')
        Canvas.addEventListener('dragover', (E) => E.preventDefault())
        Canvas.addEventListener('drop', HandleCanvasDrop)
        document
          .getElementById('RelationSaveBtn')
          .addEventListener('click', SaveRelationData)
        document
          .getElementById('RelationAddGroupBtn')
          .addEventListener('click', AddRelationGroup)
        document
          .getElementById('RelationLineTypeSelect')
          .addEventListener('change', (E) => {
            CurrentLineType = parseInt(E.target.value)
          })
        document.querySelectorAll('.RelationTypeOption').forEach((Opt) => {
          Opt.addEventListener('click', function () {
            document
              .querySelectorAll('.RelationTypeOption')
              .forEach((O) => O.classList.remove('selected'))
            this.classList.add('selected')
            CurrentRelationType = this.dataset.type
            CurrentRelationColor = this.dataset.color
          })
        })
      }

      function SetupRelationObjectEvents() {
        document.querySelectorAll('.RelationObject').forEach((Obj) => {
          Obj.addEventListener('mousedown', StartDragObject)
          Obj.addEventListener('dblclick', StartDrawLine)
        })
        document.querySelectorAll('.RelationGroupBox').forEach((Obj) => {
          Obj.addEventListener('mousedown', StartDragObject)
        })
      }

      function HandleCanvasDrop(E) {
        E.preventDefault()
        const Data = JSON.parse(E.dataTransfer.getData('text/plain') || '{}')
        if (!Data.charaId) return
        if (RelationObjects.find((O) => O.TargetId === Data.charaId)) {
          ShowErrorDialog('このキャラは既に配置されています')
          return
        }
        const Rect = E.target.closest('.RelationCanvas').getBoundingClientRect()
        const NewObj = {
          ObjId: 'new_' + Date.now(),
          ObjType: 1,
          TargetId: Data.charaId,
          Label: Data.charaName,
          PosX: E.clientX - Rect.left - 40,
          PosY: E.clientY - Rect.top - 30,
        }
        RelationObjects.push(NewObj)
        RenderRelationCanvas()
      }

      function StartDragObject(E) {
        if (E.target.closest('.TrashZone')) return
        SelectedRelationObject = E.target.closest(
          '.RelationObject, .RelationGroupBox',
        )
        if (!SelectedRelationObject) return
        IsDraggingObject = true
        DragStartX = E.clientX - SelectedRelationObject.offsetLeft
        DragStartY = E.clientY - SelectedRelationObject.offsetTop
        document.addEventListener('mousemove', DragObject)
        document.addEventListener('mouseup', EndDragObject)
        document
          .querySelectorAll('.RelationObject')
          .forEach((O) => O.classList.remove('selected'))
        SelectedRelationObject.classList.add('selected')
      }

      function DragObject(E) {
        if (!IsDraggingObject || !SelectedRelationObject) return
        const Canvas = document.getElementById('RelationCanvas')
        const Rect = Canvas.getBoundingClientRect()
        let NewX = E.clientX - DragStartX
        let NewY = E.clientY - DragStartY
        NewX = Math.max(
          0,
          Math.min(NewX, Rect.width - SelectedRelationObject.offsetWidth),
        )
        NewY = Math.max(
          0,
          Math.min(NewY, Rect.height - SelectedRelationObject.offsetHeight),
        )
        SelectedRelationObject.style.left = NewX + 'px'
        SelectedRelationObject.style.top = NewY + 'px'
        const ObjId = SelectedRelationObject.dataset.objid
        const Obj = RelationObjects.find((O) => O.ObjId == ObjId)
        if (Obj) {
          Obj.PosX = NewX
          Obj.PosY = NewY
        }
        RenderRelationLines()
        const TrashZone = document.getElementById('TrashZone')
        if (TrashZone) {
          const TrashRect = TrashZone.getBoundingClientRect()
          if (
            E.clientX >= TrashRect.left &&
            E.clientX <= TrashRect.right &&
            E.clientY >= TrashRect.top &&
            E.clientY <= TrashRect.bottom
          ) {
            TrashZone.classList.add('active')
          } else {
            TrashZone.classList.remove('active')
          }
        }
      }

      function RenderRelationLines() {
        const Svg = document.getElementById('RelationSvg')
        if (!Svg) return
        Svg.innerHTML = ''
        RelationLines.forEach((Line) => {
          const SourceObj = RelationObjects.find(
            (O) => O.ObjId == Line.SourceObjId,
          )
          const TargetObj = RelationObjects.find(
            (O) => O.ObjId == Line.TargetObjId,
          )
          if (!SourceObj || !TargetObj) return
          const X1 = SourceObj.PosX + 50,
            Y1 = SourceObj.PosY + 40
          const X2 = TargetObj.PosX + 50,
            Y2 = TargetObj.PosY + 40
          if (Line.LineType === 1) {
            const Path = document.createElementNS(
              'http://www.w3.org/2000/svg',
              'path',
            )
            const Dx = X2 - X1,
              Dy = Y2 - Y1,
              Len = Math.sqrt(Dx * Dx + Dy * Dy) || 1
            const UnitX = Dx / Len,
              UnitY = Dy / Len
            const ArrowLen = 10,
              ArrowX = X2 - UnitX * 15,
              ArrowY = Y2 - UnitY * 15
            const LeftX = ArrowX - UnitY * ArrowLen - UnitX * ArrowLen
            const LeftY = ArrowY + UnitX * ArrowLen - UnitY * ArrowLen
            const RightX = ArrowX + UnitY * ArrowLen - UnitX * ArrowLen
            const RightY = ArrowY - UnitX * ArrowLen - UnitY * ArrowLen
            Path.setAttribute(
              'd',
              `M${X1},${Y1} L${X2 - UnitX * 15},${
                Y2 - UnitY * 15
              } M${ArrowX},${ArrowY} L${LeftX},${LeftY} M${ArrowX},${ArrowY} L${RightX},${RightY}`,
            )
            Path.setAttribute('stroke', Line.Color || '#e74c3c')
            Path.setAttribute('stroke-width', '2')
            Path.setAttribute('fill', 'none')
            Svg.appendChild(Path)
          } else {
            const LineEl = document.createElementNS(
              'http://www.w3.org/2000/svg',
              'line',
            )
            LineEl.setAttribute('x1', X1)
            LineEl.setAttribute('y1', Y1)
            LineEl.setAttribute('x2', X2)
            LineEl.setAttribute('y2', Y2)
            LineEl.setAttribute('stroke', Line.Color || '#3498db')
            LineEl.setAttribute('stroke-width', '2')
            Svg.appendChild(LineEl)
          }
          const TextX = (X1 + X2) / 2,
            TextY = (Y1 + Y2) / 2 - 5
          const Text = document.createElementNS(
            'http://www.w3.org/2000/svg',
            'text',
          )
          Text.setAttribute('x', TextX)
          Text.setAttribute('y', TextY)
          Text.setAttribute('fill', Line.Color || '#333')
          Text.setAttribute('font-size', '10')
          Text.setAttribute('text-anchor', 'middle')
          Text.textContent = Line.RelationType || ''
          Svg.appendChild(Text)
        })
      }

      function EndDragObject(E) {
        if (!IsDraggingObject) return
        const TrashZone = document.getElementById('TrashZone')
        if (
          TrashZone &&
          TrashZone.classList.contains('active') &&
          SelectedRelationObject
        ) {
          const ObjId = SelectedRelationObject.dataset.objid
          RelationObjects = RelationObjects.filter((O) => O.ObjId != ObjId)
          RelationLines = RelationLines.filter(
            (L) => L.SourceObjId != ObjId && L.TargetObjId != ObjId,
          )
          RenderRelationCanvas()
        }
        IsDraggingObject = false
        SelectedRelationObject = null
        document.removeEventListener('mousemove', DragObject)
        document.removeEventListener('mouseup', EndDragObject)
        if (TrashZone) TrashZone.classList.remove('active')
      }

      function StartDrawLine(E) {
        const Obj = E.target.closest('.RelationObject')
        if (!Obj) return
        if (!IsDrawingLine) {
          IsDrawingLine = true
          LineStartObjId = Obj.dataset.objid
          Obj.classList.add('selected')
          ShowInfoDialog(
            '線の描画',
            '接続先のキャラをダブルクリックしてください',
          )
        } else {
          const EndObjId = Obj.dataset.objid
          if (LineStartObjId !== EndObjId) {
            const NewLine = {
              RelationId: 'new_' + Date.now(),
              SourceObjId: LineStartObjId,
              TargetObjId: EndObjId,
              LineType: CurrentLineType,
              RelationType: CurrentRelationType,
              Color: CurrentRelationColor,
            }
            RelationLines.push(NewLine)
            RenderRelationCanvas()
          }
          IsDrawingLine = false
          LineStartObjId = null
          document
            .querySelectorAll('.RelationObject')
            .forEach((O) => O.classList.remove('selected'))
        }
      }

      /**
       * グループ追加ダイアログを表示する
       * @returns {Promise<void>}
       */
      async function AddRelationGroup() {
        const Result = await ShowGroupDialog()
        if (!Result) return
        const NewGroup = {
          ObjId: 'new_' + Date.now(),
          ObjType: 2,
          Label: Result.Label,
          PosX: 100,
          PosY: 100,
          Width: 200,
          Height: 150,
          BgColor: Result.BgColor || '#9b59b6',
        }
        RelationObjects.push(NewGroup)
        RenderRelationCanvas()
      }

      /**
       * グループ追加・編集ダイアログを表示する
       * @param {Object|null} Group 編集対象のグループ（新規の場合はnull）
       * @returns {Promise<Object|null>} グループ情報またはnull
       */
      function ShowGroupDialog(Group = null) {
        const IsEdit = Group !== null
        return new Promise((Resolve) => {
          const Overlay = document.createElement('div')
          Overlay.className = 'DialogOverlay'
          const Dialog = document.createElement('div')
          Dialog.className = 'DialogContainer DialogSmall'
          Dialog.innerHTML = `
                <div class="DialogTitle">${
                  IsEdit ? 'グループ編集' : 'グループ追加'
                }</div>
                <div class="DialogContent">
                  <div class="FormGroup">
                    <input type="text" class="InputForm" id="GroupLabelInput" placeholder="グループ名" value="${
                      Group?.Label || ''
                    }" maxlength="50">
                  </div>
                  <div class="FormGroup">
                    <label class="FormLabel">背景色</label>
                    <div class="ColorPickerWrapper">
                      <input type="color" class="ColorPicker" id="GroupColorInput" value="${
                        Group?.BgColor || '#9b59b6'
                      }">
                      <input type="text" class="InputForm ColorCodeInput" id="GroupColorCodeInput" placeholder="#9b59b6" value="${
                        Group?.BgColor || '#9b59b6'
                      }" maxlength="7">
                    </div>
                  </div>
                </div>
                <div class="DialogButtonArea">
                  <button class="ButtonClass CloseButton" id="GroupDialogClose"><i class="fas fa-times"></i> 閉じる</button>
                  <button class="ButtonClass SaveButton" id="GroupDialogSave"><i class="fas fa-check"></i> 決定</button>
                </div>
              `
          document.body.appendChild(Overlay)
          Overlay.appendChild(Dialog)

          /** カラーピッカーとテキスト入力の同期 */
          const ColorPicker = Dialog.querySelector('#GroupColorInput')
          const ColorCode = Dialog.querySelector('#GroupColorCodeInput')
          ColorPicker.addEventListener('input', () => {
            ColorCode.value = ColorPicker.value
          })
          ColorCode.addEventListener('input', () => {
            const Val = ColorCode.value
            if (/^#[0-9A-Fa-f]{6}$/.test(Val)) {
              ColorPicker.value = Val
            }
          })

          /** 閉じるボタン */
          Dialog.querySelector('#GroupDialogClose').addEventListener(
            'click',
            () => {
              Overlay.remove()
              Resolve(null)
            },
          )

          /** オーバーレイクリックで閉じる */
          Overlay.addEventListener('click', (E) => {
            if (E.target === Overlay) {
              Overlay.remove()
              Resolve(null)
            }
          })

          /** 決定ボタン */
          Dialog.querySelector('#GroupDialogSave').addEventListener(
            'click',
            async () => {
              const Label =
                Dialog.querySelector('#GroupLabelInput').value.trim()
              const BgColor = ColorCode.value.trim()
              if (!Label) {
                await ShowErrorDialog('グループ名を入力してください')
                return
              }
              if (BgColor && !/^#[0-9A-Fa-f]{6}$/.test(BgColor)) {
                await ShowErrorDialog(
                  'カラーコードの形式が正しくありません（例: #9b59b6）',
                )
                return
              }
              Overlay.remove()
              Resolve({ Label: Label, BgColor: BgColor || '#9b59b6' })
            },
          )

          /** Enterキーで決定 */
          Dialog.querySelector('#GroupLabelInput').addEventListener(
            'keydown',
            (E) => {
              if (E.key === 'Enter') {
                E.preventDefault()
                Dialog.querySelector('#GroupDialogSave').click()
              }
            },
          )

          /** 初期フォーカス */
          Dialog.querySelector('#GroupLabelInput').focus()
        })
      }

      async function SaveRelationData() {
        try {
          const Response = await CallApi('/SaveRelationData.php', 'POST', {
            WorkId: sessionStorage.getItem('WorkId'),
            Objects: RelationObjects,
            Lines: RelationLines,
            UserId: sessionStorage.getItem('UserId'),
          })
          if (Response.Success) {
            await ShowInfoDialog('保存完了', '相関図を保存しました')
            await LoadRelationData()
          } else {
            await ShowErrorDialog(Response.Message || '保存に失敗しました')
          }
        } catch (Error) {
          await ShowErrorDialog('保存中にエラーが発生しました')
        }
      }

      /* ==========================================================================
       * ストーリー作成画面 (6.2 StoryInfo)
       * ========================================================================== */
      let StoryList = []
      let SelectedStoryId = null
      let StoryDragItem = null

      async function ShowStoryCreation() {
        CurrentPage = 1
        SelectedStoryId = null
        const ContentArea = document.getElementById('ContentArea')
        const CanEditFlg = CanEdit()
        ContentArea.innerHTML = `
              ${CreateContentHeader('ストーリー作成', 'book')}
              ${
                CanEditFlg
                  ? `
              <div class="ButtonGroup MarginBottom20">
                <button class="ButtonClass PrimaryButton" id="StoryAddBtn"><i class="fas fa-plus"></i> 行追加</button>
                <button class="ButtonClass SuccessButton" id="StoryExportBtn"><i class="fas fa-file-word"></i> Word出力</button>
              </div>
              `
                  : ''
              }
              <div id="RecordCountArea"></div>
              <div class="StoryList" id="StoryListArea"></div>
              <div id="PaginationArea"></div>
            `
        if (CanEditFlg) {
          document
            .getElementById('StoryAddBtn')
            .addEventListener('click', () => ShowStoryDialog())
          document
            .getElementById('StoryExportBtn')
            .addEventListener('click', ExportStoryToWord)
        }
        await LoadStoryList()
      }

      async function LoadStoryList() {
        try {
          const WorkId = sessionStorage.getItem('WorkId')
          const Response = await CallApi(
            `/GetStoryList.php?WorkId=${encodeURIComponent(WorkId)}`,
            'GET',
          )
          if (Response.Success) {
            StoryList = (Response.Data.StoryList || []).sort(
              (A, B) => A.IndexNum - B.IndexNum,
            )
            RenderStoryList()
          } else {
            await ShowErrorDialog(
              Response.Message || 'ストーリー一覧の取得に失敗しました',
            )
          }
        } catch (Error) {
          console.error(Error)
          await ShowErrorDialog('ストーリー一覧の取得中にエラーが発生しました')
        }
      }

      function RenderStoryList() {
        const ListArea = document.getElementById('StoryListArea')
        const RecordCountArea = document.getElementById('RecordCountArea')
        if (!ListArea) return
        RecordCountArea.innerHTML = ''
        RecordCountArea.appendChild(CreateRecordCount(StoryList.length))
        const CanEditFlg = CanEdit()
        if (StoryList.length === 0) {
          ListArea.innerHTML =
            '<div style="text-align:center;color:#999;padding:50px;">データがありません</div>'
          return
        }
        ListArea.innerHTML = StoryList.map(
          (Item, Index) => `
              <div class="StoryItem" data-storyid="${
                Item.StoryId
              }" data-index="${Index}" ${CanEditFlg ? 'draggable="true"' : ''}>
                <div class="StoryNumber">${Index + 1}</div>
                <div class="StoryContent">
                  <div class="StoryNarrator">${
                    Item.Narrator ? `語り手: ${Item.Narrator}` : 'ナレーション'
                  }</div>
                  <div class="StoryText">${Item.Content || ''}</div>
                </div>
              </div>
            `,
        ).join('')
        if (CanEditFlg) {
          ListArea.querySelectorAll('.StoryItem').forEach((Item) => {
            Item.addEventListener('dblclick', () =>
              ShowStoryDialog(Item.dataset.storyid),
            )
            Item.addEventListener('dragstart', HandleStoryDragStart)
            Item.addEventListener('dragend', HandleStoryDragEnd)
            Item.addEventListener('dragover', HandleStoryDragOver)
            Item.addEventListener('drop', HandleStoryDrop)
          })
        }
      }

      function HandleStoryDragStart(E) {
        StoryDragItem = E.target.closest('.StoryItem')
        E.target.classList.add('dragging')
        E.dataTransfer.effectAllowed = 'move'
      }

      function HandleStoryDragEnd(E) {
        E.target.classList.remove('dragging')
        document
          .querySelectorAll('.StoryItem')
          .forEach((I) => I.classList.remove('drag-over'))
        StoryDragItem = null
      }

      function HandleStoryDragOver(E) {
        E.preventDefault()
        const Item = E.target.closest('.StoryItem')
        if (Item && Item !== StoryDragItem) {
          document
            .querySelectorAll('.StoryItem')
            .forEach((I) => I.classList.remove('drag-over'))
          Item.classList.add('drag-over')
        }
      }

      /**
       * ストーリーの並び替えを処理する
       * @param {DragEvent} E
       * @returns {Promise<void>}
       */
      async function HandleStoryDrop(E) {
        E.preventDefault()
        const DropItem = E.target.closest('.StoryItem')
        if (!DropItem || !StoryDragItem || DropItem === StoryDragItem) return
        const FromIndex = parseInt(StoryDragItem.dataset.index)
        const ToIndex = parseInt(DropItem.dataset.index)
        const MovedItem = StoryList.splice(FromIndex, 1)[0]
        StoryList.splice(ToIndex, 0, MovedItem)
        StoryList.forEach((Item, Index) => {
          Item.IndexNum = Index + 1
        })
        RenderStoryList()
        await SaveStoryOrder()
      }

      /**
       * ストーリーの並び順を保存する
       * @returns {Promise<void>}
       */
      async function SaveStoryOrder() {
        try {
          const Response = await CallApi('/UpdateStoryOrder.php', 'POST', {
            WorkId: sessionStorage.getItem('WorkId'),
            OrderList: StoryList.map((Item) => ({
              StoryId: Item.StoryId,
              IndexNum: Item.IndexNum,
            })),
            UserId: sessionStorage.getItem('UserId'),
          })
          if (!Response.Success)
            await ShowErrorDialog(
              Response.Message || '並び順の保存に失敗しました',
            )
        } catch (Error) {
          console.error(Error)
        }
      }

      async function ShowStoryDialog(StoryId = null) {
        const IsEdit = StoryId !== null
        const Item = IsEdit ? StoryList.find((S) => S.StoryId == StoryId) : null
        return new Promise((Resolve) => {
          const Overlay = document.createElement('div')
          Overlay.className = 'DialogOverlay'
          const Dialog = document.createElement('div')
          Dialog.className = 'DialogContainer DialogMedium'
          Dialog.innerHTML = `
                <div class="DialogTitle">${
                  IsEdit ? 'ストーリー編集' : 'ストーリー追加'
                }</div>
                <div class="DialogContent">
                  <div class="FormGroup">
                    <div class="CheckboxWrapper">
                      <input type="checkbox" id="StoryNarratorToggle" ${
                        Item?.Narrator ? '' : 'checked'
                      }>
                      <label>自由入力</label>
                    </div>
                  </div>
                  <div class="FormGroup" id="StoryNarratorSelectGroup">
                    <select class="SelectForm" id="StoryNarratorSelect">
                      <option value="">語り手を選択</option>
                      ${
                        RelationCharaList.length
                          ? RelationCharaList.map(
                              (C) =>
                                `<option value="${C.CharaName}" ${
                                  Item?.Narrator === C.CharaName
                                    ? 'selected'
                                    : ''
                                }>${C.CharaName}</option>`,
                            ).join('')
                          : CharacterList.map(
                              (C) =>
                                `<option value="${C.CharaName}" ${
                                  Item?.Narrator === C.CharaName
                                    ? 'selected'
                                    : ''
                                }>${C.CharaName}</option>`,
                            ).join('')
                      }
                    </select>
                  </div>
                  <div class="FormGroup Hidden" id="StoryNarratorInputGroup">
                    <input type="text" class="InputForm" id="StoryNarratorInput" placeholder="語り手（空白でナレーション）" value="${
                      Item?.Narrator || ''
                    }">
                  </div>
                  <div class="FormGroup">
                    <textarea class="TextAreaForm" id="StoryContentInput" placeholder="内容" style="min-height:150px;">${
                      Item?.Content || ''
                    }</textarea>
                  </div>
                </div>
                <div class="DialogButtonArea">
                  <button class="ButtonClass CloseButton" id="StoryDialogClose"><i class="fas fa-times"></i> 閉じる</button>
                  ${
                    IsEdit
                      ? `<button class="ButtonClass DeleteButton" id="StoryDialogDelete"><i class="fas fa-trash"></i> 削除</button>`
                      : ''
                  }
                  <button class="ButtonClass SaveButton" id="StoryDialogSave"><i class="fas fa-save"></i> 保存</button>
                </div>
              `
          document.body.appendChild(Overlay)
          Overlay.appendChild(Dialog)
          const Toggle = Dialog.querySelector('#StoryNarratorToggle')
          const SelectGroup = Dialog.querySelector('#StoryNarratorSelectGroup')
          const InputGroup = Dialog.querySelector('#StoryNarratorInputGroup')
          const UpdateToggle = () => {
            if (Toggle.checked) {
              SelectGroup.classList.add('Hidden')
              InputGroup.classList.remove('Hidden')
            } else {
              SelectGroup.classList.remove('Hidden')
              InputGroup.classList.add('Hidden')
            }
          }
          UpdateToggle()
          Toggle.addEventListener('change', UpdateToggle)
          Dialog.querySelector('#StoryDialogClose').addEventListener(
            'click',
            () => {
              Overlay.remove()
              Resolve(null)
            },
          )
          Dialog.querySelector('#StoryDialogSave').addEventListener(
            'click',
            async () => {
              let Narrator = Toggle.checked
                ? Dialog.querySelector('#StoryNarratorInput').value.trim()
                : Dialog.querySelector('#StoryNarratorSelect').value
              let Content =
                Dialog.querySelector('#StoryContentInput').value.trim()
              if (!Content) {
                await ShowErrorDialog('内容を入力してください')
                return
              }
              if (Narrator)
                Content = `「${Content.replace(/^「/, '').replace(/」$/, '')}」`
              try {
                const Response = await CallApi('/SaveStory.php', 'POST', {
                  StoryId: IsEdit ? StoryId : null,
                  WorkId: sessionStorage.getItem('WorkId'),
                  IndexNum: IsEdit ? Item.IndexNum : StoryList.length + 1,
                  Narrator: Narrator,
                  Content: Content,
                  UserId: sessionStorage.getItem('UserId'),
                })
                if (Response.Success) {
                  Overlay.remove()
                  await ShowInfoDialog('保存完了', 'ストーリーを保存しました')
                  await LoadStoryList()
                  Resolve(true)
                } else {
                  await ShowErrorDialog(
                    Response.Message || '保存に失敗しました',
                  )
                }
              } catch (Error) {
                await ShowErrorDialog('保存中にエラーが発生しました')
              }
            },
          )
          if (IsEdit) {
            Dialog.querySelector('#StoryDialogDelete').addEventListener(
              'click',
              async () => {
                if (
                  !(await ShowConfirmDialog('このストーリーを削除しますか？'))
                )
                  return
                try {
                  const Response = await CallApi('/DeleteStory.php', 'POST', {
                    StoryId: StoryId,
                    UserId: sessionStorage.getItem('UserId'),
                    WorkId: sessionStorage.getItem('WorkId'),
                  })
                  if (Response.Success) {
                    Overlay.remove()
                    await ShowInfoDialog('削除完了', 'ストーリーを削除しました')
                    await LoadStoryList()
                    Resolve(true)
                  } else {
                    await ShowErrorDialog(
                      Response.Message || '削除に失敗しました',
                    )
                  }
                } catch (Error) {
                  await ShowErrorDialog('削除中にエラーが発生しました')
                }
              },
            )
          }
        })
      }

      /**
       * ストーリーをWordファイルにエクスポートする
       * @returns {Promise<void>}
       */
      async function ExportStoryToWord() {
        ShowSpinner()
        try {
          const Response = await fetch('/Back/Api/ExportStory.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              WorkId: sessionStorage.getItem('WorkId'),
              UserId: sessionStorage.getItem('UserId'),
            }),
          })

          if (!Response.ok) {
            throw new Error('出力に失敗しました')
          }

          const Blob = await Response.blob()
          const WorkTitle = WorkInfo?.WorkTitle || '作品'
          DownloadFile(Blob, `${WorkTitle}_ストーリー.docx`)

          HideSpinner()

          await ShowInfoDialog('出力完了', 'Wordファイルをダウンロードしました')
        } catch (Error) {
          console.error(Error)
          HideSpinner()
          await ShowErrorDialog('出力中にエラーが発生しました')
        }
      }

      /* ==========================================================================
       * プロット作成画面 (6.3 PlotInfo)
       * ========================================================================== */
      let PlotList = []
      let SelectedPlotId = null
      let PlotDragItem = null
      const PlotStructureLabels = ['起', '承', '転', '結']
      const PlotStructureClasses = ['ki', 'sho', 'ten', 'ketsu']

      async function ShowPlotCreation() {
        CurrentPage = 1
        SelectedPlotId = null
        const ContentArea = document.getElementById('ContentArea')
        const CanEditFlg = CanEdit()
        ContentArea.innerHTML = `
              ${CreateContentHeader('プロット作成', 'sitemap')}
              ${
                CanEditFlg
                  ? `
              <div class="ButtonGroup MarginBottom20">
                <button class="ButtonClass PrimaryButton" id="PlotAddBtn"><i class="fas fa-plus"></i> 行追加</button>
                <button class="ButtonClass SuccessButton" id="PlotExportBtn"><i class="fas fa-file-word"></i> Word出力</button>
              </div>
              `
                  : ''
              }
              <div id="RecordCountArea"></div>
              <div class="StoryList" id="PlotListArea"></div>
              <div id="PaginationArea"></div>
            `
        if (CanEditFlg) {
          document
            .getElementById('PlotAddBtn')
            .addEventListener('click', () => ShowPlotDialog())
          document
            .getElementById('PlotExportBtn')
            .addEventListener('click', ExportPlotToWord)
        }
        await LoadPlotList()
      }

      async function LoadPlotList() {
        try {
          const WorkId = sessionStorage.getItem('WorkId')
          const Response = await CallApi(
            `/GetPlotList.php?WorkId=${encodeURIComponent(WorkId)}`,
            'GET',
          )
          if (Response.Success) {
            PlotList = (Response.Data.PlotList || []).sort(
              (A, B) => A.IndexNum - B.IndexNum,
            )
            RenderPlotList()
          } else {
            await ShowErrorDialog(
              Response.Message || 'プロット一覧の取得に失敗しました',
            )
          }
        } catch (Error) {
          console.error(Error)
          await ShowErrorDialog('プロット一覧の取得中にエラーが発生しました')
        }
      }

      function RenderPlotList() {
        const ListArea = document.getElementById('PlotListArea')
        const RecordCountArea = document.getElementById('RecordCountArea')
        if (!ListArea) return
        RecordCountArea.innerHTML = ''
        RecordCountArea.appendChild(CreateRecordCount(PlotList.length))
        const CanEditFlg = CanEdit()
        if (PlotList.length === 0) {
          ListArea.innerHTML =
            '<div style="text-align:center;color:#999;padding:50px;">データがありません</div>'
          return
        }
        ListArea.innerHTML = PlotList.map(
          (Item, Index) => `
              <div class="StoryItem" data-plotid="${
                Item.PlotId
              }" data-index="${Index}" ${CanEditFlg ? 'draggable="true"' : ''}>
                <div class="StoryNumber">${Index + 1}</div>
                <div class="StoryContent">
                  <span class="PlotBadge ${
                    PlotStructureClasses[Item.StructureType] || ''
                  }">${PlotStructureLabels[Item.StructureType] || '?'}</span>
                  <span class="StoryText">${Item.Content || ''}</span>
                </div>
              </div>
            `,
        ).join('')
        if (CanEditFlg) {
          ListArea.querySelectorAll('.StoryItem').forEach((Item) => {
            Item.addEventListener('dblclick', () =>
              ShowPlotDialog(Item.dataset.plotid),
            )
            Item.addEventListener('dragstart', HandlePlotDragStart)
            Item.addEventListener('dragend', HandlePlotDragEnd)
            Item.addEventListener('dragover', HandlePlotDragOver)
            Item.addEventListener('drop', HandlePlotDrop)
          })
        }
      }

      function HandlePlotDragStart(E) {
        PlotDragItem = E.target.closest('.StoryItem')
        E.target.classList.add('dragging')
        E.dataTransfer.effectAllowed = 'move'
      }

      function HandlePlotDragEnd(E) {
        E.target.classList.remove('dragging')
        document
          .querySelectorAll('.StoryItem')
          .forEach((I) => I.classList.remove('drag-over'))
        PlotDragItem = null
      }

      function HandlePlotDragOver(E) {
        E.preventDefault()
        const Item = E.target.closest('.StoryItem')
        if (Item && Item !== PlotDragItem) {
          document
            .querySelectorAll('.StoryItem')
            .forEach((I) => I.classList.remove('drag-over'))
          Item.classList.add('drag-over')
        }
      }

      async function HandlePlotDrop(E) {
        E.preventDefault()
        const DropItem = E.target.closest('.StoryItem')
        if (!DropItem || !PlotDragItem || DropItem === PlotDragItem) return
        const FromIndex = parseInt(PlotDragItem.dataset.index)
        const ToIndex = parseInt(DropItem.dataset.index)
        const MovedItem = PlotList.splice(FromIndex, 1)[0]
        PlotList.splice(ToIndex, 0, MovedItem)
        PlotList.forEach((Item, Index) => {
          Item.IndexNum = Index + 1
        })
        RenderPlotList()
        await SavePlotOrder()
      }

      async function SavePlotOrder() {
        try {
          const Response = await CallApi('/UpdatePlotOrder.php', 'POST', {
            WorkId: sessionStorage.getItem('WorkId'),
            OrderList: PlotList.map((Item) => ({
              PlotId: Item.PlotId,
              IndexNum: Item.IndexNum,
            })),
            UserId: sessionStorage.getItem('UserId'),
          })
          if (!Response.Success)
            await ShowErrorDialog(
              Response.Message || '並び順の保存に失敗しました',
            )
        } catch (Error) {
          console.error(Error)
        }
      }

      async function ShowPlotDialog(PlotId = null) {
        const IsEdit = PlotId !== null
        const Item = IsEdit ? PlotList.find((P) => P.PlotId == PlotId) : null
        return new Promise((Resolve) => {
          const Overlay = document.createElement('div')
          Overlay.className = 'DialogOverlay'
          const Dialog = document.createElement('div')
          Dialog.className = 'DialogContainer DialogMedium'
          Dialog.innerHTML = `
                <div class="DialogTitle">${
                  IsEdit ? 'プロット編集' : 'プロット追加'
                }</div>
                <div class="DialogContent">
                  <div class="FormGroup">
                    <select class="SelectForm" id="PlotStructureSelect">
                      ${PlotStructureLabels.map(
                        (L, I) =>
                          `<option value="${I}" ${
                            Item?.StructureType == I ? 'selected' : ''
                          }>${L}</option>`,
                      ).join('')}
                    </select>
                  </div>
                  <div class="FormGroup">
                    <textarea class="TextAreaForm" id="PlotContentInput" placeholder="内容" style="min-height:150px;">${
                      Item?.Content || ''
                    }</textarea>
                  </div>
                </div>
                <div class="DialogButtonArea">
                  <button class="ButtonClass CloseButton" id="PlotDialogClose"><i class="fas fa-times"></i> 閉じる</button>
                  ${
                    IsEdit
                      ? `<button class="ButtonClass DeleteButton" id="PlotDialogDelete"><i class="fas fa-trash"></i> 削除</button>`
                      : ''
                  }
                  <button class="ButtonClass SaveButton" id="PlotDialogSave"><i class="fas fa-save"></i> 保存</button>
                </div>
              `
          document.body.appendChild(Overlay)
          Overlay.appendChild(Dialog)
          Dialog.querySelector('#PlotDialogClose').addEventListener(
            'click',
            () => {
              Overlay.remove()
              Resolve(null)
            },
          )
          Dialog.querySelector('#PlotDialogSave').addEventListener(
            'click',
            async () => {
              const StructureType = parseInt(
                Dialog.querySelector('#PlotStructureSelect').value,
              )
              const Content =
                Dialog.querySelector('#PlotContentInput').value.trim()
              if (!Content) {
                await ShowErrorDialog('内容を入力してください')
                return
              }
              if (!IsEdit && !ValidatePlotOrder(StructureType)) {
                await ShowErrorDialog('起承転結の順序で登録してください')
                return
              }
              try {
                const Response = await CallApi('/SavePlot.php', 'POST', {
                  PlotId: IsEdit ? PlotId : null,
                  WorkId: sessionStorage.getItem('WorkId'),
                  IndexNum: IsEdit ? Item.IndexNum : PlotList.length + 1,
                  StructureType: StructureType,
                  Content: Content,
                  UserId: sessionStorage.getItem('UserId'),
                })
                if (Response.Success) {
                  Overlay.remove()
                  await ShowInfoDialog('保存完了', 'プロットを保存しました')
                  await LoadPlotList()
                  Resolve(true)
                } else {
                  await ShowErrorDialog(
                    Response.Message || '保存に失敗しました',
                  )
                }
              } catch (Error) {
                await ShowErrorDialog('保存中にエラーが発生しました')
              }
            },
          )
          if (IsEdit) {
            Dialog.querySelector('#PlotDialogDelete').addEventListener(
              'click',
              async () => {
                if (!(await ShowConfirmDialog('このプロットを削除しますか？')))
                  return
                try {
                  const Response = await CallApi('/DeletePlot.php', 'POST', {
                    PlotId: PlotId,
                    UserId: sessionStorage.getItem('UserId'),
                  })
                  if (Response.Success) {
                    Overlay.remove()
                    await ShowInfoDialog('削除完了', 'プロットを削除しました')
                    await LoadPlotList()
                    Resolve(true)
                  } else {
                    await ShowErrorDialog(
                      Response.Message || '削除に失敗しました',
                    )
                  }
                } catch (Error) {
                  await ShowErrorDialog('削除中にエラーが発生しました')
                }
              },
            )
          }
        })
      }

      function ValidatePlotOrder(NewStructureType) {
        if (PlotList.length === 0) return NewStructureType === 0
        const LastStructureType = PlotList[PlotList.length - 1].StructureType
        return NewStructureType >= LastStructureType
      }

      async function ExportPlotToWord() {
        try {
          ShowSpinner()
          const Response = await fetch(`${API_BASE_URL}/ExportPlot.php`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              WorkId: sessionStorage.getItem('WorkId'),
              UserId: sessionStorage.getItem('UserId'),
            }),
          })
          if (!Response.ok) throw new Error('出力に失敗しました')
          const Blob = await Response.blob()
          const WorkTitle = WorkInfo?.WorkTitle || '作品'
          DownloadFile(Blob, `${WorkTitle}_プロット.docx`)
          HideSpinner()
          await ShowInfoDialog('出力完了', 'Wordファイルをダウンロードしました')
        } catch (Error) {
          HideSpinner()
          await ShowErrorDialog('出力中にエラーが発生しました')
        }
      }

      /* ==========================================================================
       * 伏線メモ画面 (6.4 ClueInfo)
       * ========================================================================== */
      let ClueList = []
      let SelectedClueId = null

      async function ShowClueMemo() {
        CurrentPage = 1
        SelectedClueId = null
        const ContentArea = document.getElementById('ContentArea')
        const CanEditFlg = CanEdit()

        ContentArea.innerHTML = `
              ${CreateContentHeader('伏線メモ', 'puzzle-piece')}
              <div class="FormRow">
                <div class="FormGroup Flex1">
                  <input type="text" class="InputForm" id="ClueTitle" placeholder="タイトル" maxlength="255" ${
                    !CanEditFlg ? 'disabled' : ''
                  }>
                </div>
              </div>
              <div class="FormGroup InputWithButton">
                <input type="text" class="InputForm" id="ClueContent" placeholder="伏線内容" disabled>
                <button class="ButtonClass SecondaryButton ButtonSmall" id="ClueContentBtn"><i class="fas fa-edit"></i></button>
              </div>
              <input type="hidden" id="ClueContentHidden">
              <div class="FormGroup InputWithButton">
                <input type="text" class="InputForm" id="ClueRecoveryStatus" placeholder="回収状況・備考" disabled>
                <button class="ButtonClass SecondaryButton ButtonSmall" id="ClueRecoveryStatusBtn"><i class="fas fa-edit"></i></button>
              </div>
              <input type="hidden" id="ClueRecoveryStatusHidden">
              ${
                CanEditFlg
                  ? `
              <div class="ButtonGroup">
                <button class="ButtonClass ClearButton" id="ClueClearButton"><i class="fas fa-sync"></i> クリア</button>
                <button class="ButtonClass SaveButton" id="ClueSaveButton"><i class="fas fa-save"></i> 保存</button>
                <button class="ButtonClass DeleteButton Hidden" id="ClueDeleteButton"><i class="fas fa-trash"></i> 削除</button>
              </div>
              `
                  : ''
              }
              <div id="RecordCountArea" class="MarginTop20"></div>
              <div class="TableContainer" id="ClueTableArea"></div>
              <div id="PaginationArea"></div>
            `

        if (CanEditFlg) {
          document
            .getElementById('ClueContentBtn')
            .addEventListener('click', async () => {
              const Result = await ShowInputAreaDialog(
                document.getElementById('ClueContentHidden').value,
                false,
              )
              if (Result !== null && CanEditFlg) {
                document.getElementById('ClueContentHidden').value = Result
                document.getElementById('ClueContent').value = TruncateText(
                  Result,
                  30,
                )
              }
            })

          document
            .getElementById('ClueRecoveryStatusBtn')
            .addEventListener('click', async () => {
              const Result = await ShowInputAreaDialog(
                document.getElementById('ClueRecoveryStatusHidden').value,
                false,
              )
              if (Result !== null && CanEditFlg) {
                document.getElementById('ClueRecoveryStatusHidden').value =
                  Result
                document.getElementById('ClueRecoveryStatus').value =
                  TruncateText(Result, 30)
              }
            })

          document
            .getElementById('ClueClearButton')
            .addEventListener('click', ClearClueForm)
          document
            .getElementById('ClueSaveButton')
            .addEventListener('click', SaveClue)
          document
            .getElementById('ClueDeleteButton')
            .addEventListener('click', DeleteClue)
        } else {
          document
            .getElementById('ClueContentBtn')
            .addEventListener('click', async () => {
              await ShowInputAreaDialog(
                document.getElementById('ClueContentHidden').value,
                true,
              )
            })
          document
            .getElementById('ClueRecoveryStatusBtn')
            .addEventListener('click', async () => {
              await ShowInputAreaDialog(
                document.getElementById('ClueRecoveryStatusHidden').value,
                true,
              )
            })
        }

        await LoadClueList()
      }

      async function LoadClueList() {
        try {
          const WorkId = sessionStorage.getItem('WorkId')
          const Response = await CallApi(
            `/GetClueList.php?WorkId=${encodeURIComponent(
              WorkId,
            )}&UserId=${encodeURIComponent(sessionStorage.getItem('UserId'))}`,
            'GET',
          )
          if (Response.Success) {
            ClueList = Response.Data.ClueList || []
            RenderClueTable()
          } else {
            await ShowErrorDialog(
              Response.Message || '伏線メモ一覧の取得に失敗しました',
            )
          }
        } catch (Error) {
          console.error(Error)
          await ShowErrorDialog('伏線メモ一覧の取得中にエラーが発生しました')
        }
      }

      function RenderClueTable() {
        const TotalCount = ClueList.length
        document.getElementById(
          'RecordCountArea',
        ).innerHTML = `<span class="RecordCount">${TotalCount} 件</span>`
        const Start = (CurrentPage - 1) * RECORDS_PER_PAGE
        const End = Math.min(Start + RECORDS_PER_PAGE, TotalCount)
        const PageData = ClueList.slice(Start, End)
        let TableHtml = `
              <table class="DataTable">
                <thead><tr><th>タイトル</th><th>伏線内容</th><th>回収状況</th></tr></thead>
                <tbody>
            `
        if (PageData.length) {
          TableHtml += PageData.map(
            (C) => `
                  <tr data-id="${C.ClueId}">
                    <td>${EscapeHtml(C.Title)}</td>
                    <td>${EscapeHtml(TruncateText(C.Content || '', 30))}</td>
                    <td>${EscapeHtml(
                      TruncateText(C.RecoveryStatus || '', 30),
                    )}</td>
                  </tr>
                `,
          ).join('')
        } else {
          TableHtml +=
            '<tr><td colspan="3" class="NoData">データがありません</td></tr>'
        }
        TableHtml += '</tbody></table>'
        document.getElementById('ClueTableArea').innerHTML = TableHtml
        document
          .querySelectorAll('#ClueTableArea tbody tr[data-id]')
          .forEach((Row) => {
            Row.addEventListener('dblclick', () => SelectClue(Row.dataset.id))
          })
        const PaginationArea = document.getElementById('PaginationArea')
        PaginationArea.innerHTML = ''
        PaginationArea.appendChild(
          CreatePagination(TotalCount, CurrentPage, (Page) => {
            CurrentPage = Page
            RenderClueTable()
          }),
        )
      }

      function SelectClue(ClueId) {
        const Item = ClueList.find((C) => C.ClueId == ClueId)
        if (!Item) return
        SelectedClueId = ClueId
        document.getElementById('ClueTitle').value = Item.Title || ''
        document.getElementById('ClueContent').value = TruncateText(
          Item.Content || '',
          30,
        )
        document.getElementById('ClueContentHidden').value = Item.Content || ''
        document.getElementById('ClueRecoveryStatus').value = TruncateText(
          Item.RecoveryStatus || '',
          30,
        )
        document.getElementById('ClueRecoveryStatusHidden').value =
          Item.RecoveryStatus || ''
        const DeleteBtn = document.getElementById('ClueDeleteButton')
        if (DeleteBtn) DeleteBtn.classList.remove('Hidden')
      }

      function ClearClueForm() {
        SelectedClueId = null
        document.getElementById('ClueTitle').value = ''
        document.getElementById('ClueContent').value = ''
        document.getElementById('ClueContentHidden').value = ''
        document.getElementById('ClueRecoveryStatus').value = ''
        document.getElementById('ClueRecoveryStatusHidden').value = ''
        const DeleteBtn = document.getElementById('ClueDeleteButton')
        if (DeleteBtn) DeleteBtn.classList.add('Hidden')
      }

      async function SaveClue() {
        const Title = document.getElementById('ClueTitle').value.trim()
        if (!Title) {
          await ShowErrorDialog('タイトルを入力してください')
          return
        }
        try {
          ShowSpinner()
          const RequestData = {
            WorkId: sessionStorage.getItem('WorkId'),
            Title: Title,
            Content: document.getElementById('ClueContentHidden').value,
            RecoveryStatus: document.getElementById('ClueRecoveryStatusHidden')
              .value,
            UserId: sessionStorage.getItem('UserId'),
          }
          if (SelectedClueId) RequestData.ClueId = SelectedClueId

          const Response = await CallApi('/SaveClue.php', 'POST', RequestData)
          HideSpinner()
          if (Response.Success) {
            await ShowInfoDialog('保存完了', Response.Data.Message)
            ClearClueForm()
            await LoadClueList()
          } else {
            await ShowErrorDialog(Response.Message || '保存に失敗しました')
          }
        } catch (Error) {
          HideSpinner()
          await ShowErrorDialog('保存中にエラーが発生しました')
        }
      }

      async function DeleteClue() {
        if (!SelectedClueId) return
        if (!(await ShowConfirmDialog('この伏線メモを削除しますか？'))) return
        try {
          const Response = await CallApi('/DeleteClue.php', 'POST', {
            ClueId: SelectedClueId,
            WorkId: sessionStorage.getItem('WorkId'),
            UserId: sessionStorage.getItem('UserId'),
          })
          if (Response.Success) {
            await ShowInfoDialog('削除完了', '伏線メモを削除しました')
            ClearClueForm()
            await LoadClueList()
          } else {
            await ShowErrorDialog(Response.Message || '削除に失敗しました')
          }
        } catch (Error) {
          await ShowErrorDialog('削除中にエラーが発生しました')
        }
      }

      /* ==========================================================================
       * 作品レビュー (7.3 ReviewInfo)
       * ========================================================================== */
      async function ShowWorkReview() {
        CurrentPage = 1
        SelectedReviewId = null
        const ContentArea = document.getElementById('ContentArea')
        const CanEditFlg = CanEditReview()
        ContentArea.innerHTML = `
            ${CreateContentHeader('作品レビュー', 'star')}
            <div class="FormGroup"><input type="text" class="InputForm" id="ReviewerName" placeholder="レビュアー名" maxlength="150" ${
              !CanEditFlg ? 'disabled' : ''
            }></div>
            <div class="FormGroup"><select class="SelectForm" id="ReviewEvaluation" ${
              !CanEditFlg ? 'disabled' : ''
            }>${PullDownList('Review')}</select></div>
            <div class="FormGroup InputWithButton"><input type="text" class="InputForm" id="ReviewContent" placeholder="レビュー内容" disabled><button class="ButtonClass SecondaryButton ButtonSmall" id="ReviewContentBtn"><i class="fas fa-edit"></i></button></div>
            <input type="hidden" id="ReviewContentHidden">
            ${
              CanEditFlg
                ? `<div class="ButtonGroup"><button class="ButtonClass ClearButton" id="ReviewClearButton"><i class="fas fa-sync"></i> クリア</button><button class="ButtonClass SaveButton" id="ReviewSaveButton"><i class="fas fa-save"></i> 保存</button><button class="ButtonClass DeleteButton Hidden" id="ReviewDeleteButton"><i class="fas fa-trash"></i> 削除</button></div>`
                : ''
            }
            <div id="RecordCountArea" class="MarginTop20"></div><div class="TableContainer" id="ReviewTableArea"></div><div id="PaginationArea"></div>
          `
        if (CanEditFlg) {
          document
            .getElementById('ReviewClearButton')
            .addEventListener('click', ClearReviewForm)
          document
            .getElementById('ReviewSaveButton')
            .addEventListener('click', SaveReview)
          document
            .getElementById('ReviewDeleteButton')
            .addEventListener('click', DeleteReview)
        }
        document
          .getElementById('ReviewContentBtn')
          .addEventListener('click', async () => {
            const Result = await ShowInputAreaDialog(
              document.getElementById('ReviewContentHidden').value,
              !CanEditFlg,
            )
            if (Result !== null && CanEditFlg) {
              document.getElementById('ReviewContentHidden').value = Result
              document.getElementById('ReviewContent').value = TruncateText(
                Result,
                30,
              )
            }
          })
        await LoadReviewList()
      }

      async function LoadReviewList() {
        try {
          const Response = await CallApi('/GetReviewList.php', 'POST', {
            WorkId: sessionStorage.getItem('WorkId'),
            UserId: sessionStorage.getItem('UserId'),
          })

          if (Response.Success) {
            ReviewList = Response.Data.ReviewList || []
            RenderReviewTable()
          } else {
            await ShowErrorDialog(
              Response.Message || 'レビュー一覧の取得に失敗しました',
            )
          }
        } catch (Error) {
          console.error(Error)
          await ShowErrorDialog('レビュー一覧の取得中にエラーが発生しました')
        }
      }

      function RenderReviewTable() {
        const TableArea = document.getElementById('ReviewTableArea')
        const RecordCountArea = document.getElementById('RecordCountArea')
        const PaginationArea = document.getElementById('PaginationArea')
        RecordCountArea.innerHTML = ''
        RecordCountArea.appendChild(CreateRecordCount(ReviewList.length))
        const Table = document.createElement('table')
        Table.className = 'DataTable'
        const Thead = document.createElement('thead')
        Thead.innerHTML = `<tr><th>レビュアー</th><th>評価</th><th>内容</th><th>登録日</th></tr>`
        Table.appendChild(Thead)
        const Tbody = document.createElement('tbody')
        const StartIndex = (CurrentPage - 1) * RECORDS_PER_PAGE
        const EndIndex = Math.min(
          StartIndex + RECORDS_PER_PAGE,
          ReviewList.length,
        )
        const PageData = ReviewList.slice(StartIndex, EndIndex)
        if (PageData.length === 0) {
          Tbody.innerHTML =
            '<tr><td colspan="4" style="text-align:center;color:#999;">データがありません</td></tr>'
        } else {
          PageData.forEach((Item, Index) => {
            const Row = document.createElement('tr')
            Row.style.cursor = 'pointer'
            Row.innerHTML = `<td>${
              Item.ReviewerName || '-'
            }</td><td>${GetKeyInfo('Review', Item.Evaluation)}</td><td title="${
              Item.ReviewContent || ''
            }">${TruncateText(
              Item.ReviewContent,
              25,
            )}</td><td>${FormatTimestamp(Item.RegistDate)}</td>`
            Row.addEventListener('dblclick', () =>
              SelectReview(StartIndex + Index),
            )
            Tbody.appendChild(Row)
          })
        }
        Table.appendChild(Tbody)
        TableArea.innerHTML = ''
        TableArea.appendChild(Table)
        PaginationArea.innerHTML = ''
        PaginationArea.appendChild(
          CreatePagination(ReviewList.length, CurrentPage, (Page) => {
            CurrentPage = Page
            RenderReviewTable()
          }),
        )
      }

      function SelectReview(Index) {
        const Item = ReviewList[Index]
        SelectedReviewId = Item.ReviewId
        document.getElementById('ReviewerName').value = Item.ReviewerName || ''
        document.getElementById('ReviewEvaluation').value = Item.Evaluation
        document.getElementById('ReviewContent').value = TruncateText(
          Item.ReviewContent,
          30,
        )
        document.getElementById('ReviewContentHidden').value =
          Item.ReviewContent || ''
        const DeleteBtn = document.getElementById('ReviewDeleteButton')
        if (DeleteBtn) DeleteBtn.classList.remove('Hidden')
      }

      function ClearReviewForm() {
        SelectedReviewId = null
        document.getElementById('ReviewerName').value = ''
        document.getElementById('ReviewEvaluation').value = '0'
        document.getElementById('ReviewContent').value = ''
        document.getElementById('ReviewContentHidden').value = ''
        const DeleteBtn = document.getElementById('ReviewDeleteButton')
        if (DeleteBtn) DeleteBtn.classList.add('Hidden')
      }

      async function SaveReview() {
        const ReviewContent = document
          .getElementById('ReviewContentHidden')
          .value.trim()
        const Evaluation = document.getElementById('ReviewEvaluation').value
        if (!ReviewContent) {
          await ShowErrorDialog('レビュー内容を入力してください')
          return
        }
        if (Evaluation === '0') {
          await ShowErrorDialog('評価を選択してください')
          return
        }
        try {
          const Response = await CallApi('/SaveReview.php', 'POST', {
            ReviewId: SelectedReviewId,
            WorkId: sessionStorage.getItem('WorkId'),
            ReviewerName: document.getElementById('ReviewerName').value.trim(),
            ReviewContent: ReviewContent,
            Evaluation: parseInt(Evaluation),
            UserId: sessionStorage.getItem('UserId'),
          })
          if (Response.Success) {
            await ShowInfoDialog('保存完了', 'レビューを保存しました')
            ClearReviewForm()
            await LoadReviewList()
          } else {
            await ShowErrorDialog(Response.Message || '保存に失敗しました')
          }
        } catch (Error) {
          await ShowErrorDialog('保存中にエラーが発生しました')
        }
      }

      async function DeleteReview() {
        if (!SelectedReviewId) return
        if (!(await ShowConfirmDialog('このレビューを削除しますか？'))) return
        try {
          const Response = await CallApi('/DeleteReview.php', 'POST', {
            ReviewId: SelectedReviewId,
            UserId: sessionStorage.getItem('UserId'),
          })
          if (Response.Success) {
            await ShowInfoDialog('削除完了', 'レビューを削除しました')
            ClearReviewForm()
            await LoadReviewList()
          } else {
            await ShowErrorDialog(Response.Message || '削除に失敗しました')
          }
        } catch (Error) {
          await ShowErrorDialog('削除中にエラーが発生しました')
        }
      }

      /* ==========================================================================
       * 作品作成用メモ画面 (7.2 WorkMemoInfo)
       * ※全ユーザが登録可能。更新・削除は自身の投稿のみ可能。
       * ========================================================================== */
      let WorkMemoList = []
      let SelectedWorkMemoId = null
      let SelectedWorkMemoOwner = null

      async function ShowWorkMemo() {
        CurrentPage = 1
        SelectedWorkMemoId = null
        SelectedWorkMemoOwner = null
        const ContentArea = document.getElementById('ContentArea')
        const CurrentUserId = sessionStorage.getItem('UserId')

        ContentArea.innerHTML = `
              ${CreateContentHeader('作品作成用メモ', 'sticky-note')}
              <div class="FormRow">
                <div class="FormGroup Flex1">
                  <input type="text" class="InputForm" id="WorkMemoTitle" placeholder="タイトル" maxlength="255">
                </div>
              </div>
              <div class="FormGroup InputWithButton">
                <input type="text" class="InputForm" id="WorkMemoContent" placeholder="内容" disabled>
                <button class="ButtonClass SecondaryButton ButtonSmall" id="WorkMemoContentBtn"><i class="fas fa-edit"></i></button>
              </div>
              <input type="hidden" id="WorkMemoContentHidden">
              <div class="ButtonGroup">
                <button class="ButtonClass ClearButton" id="WorkMemoClearButton"><i class="fas fa-sync"></i> クリア</button>
                <button class="ButtonClass SaveButton" id="WorkMemoSaveButton"><i class="fas fa-save"></i> 保存</button>
                <button class="ButtonClass DeleteButton Hidden" id="WorkMemoDeleteButton"><i class="fas fa-trash"></i> 削除</button>
              </div>
              <div id="RecordCountArea" class="MarginTop20"></div>
              <div class="TableContainer" id="WorkMemoTableArea"></div>
              <div id="PaginationArea"></div>
            `

        document
          .getElementById('WorkMemoContentBtn')
          .addEventListener('click', async () => {
            const Result = await ShowInputAreaDialog(
              document.getElementById('WorkMemoContentHidden').value,
              false,
            )
            if (Result !== null) {
              document.getElementById('WorkMemoContentHidden').value = Result
              document.getElementById('WorkMemoContent').value = TruncateText(
                Result,
                30,
              )
            }
          })

        document
          .getElementById('WorkMemoClearButton')
          .addEventListener('click', ClearWorkMemoForm)
        document
          .getElementById('WorkMemoSaveButton')
          .addEventListener('click', SaveWorkMemo)
        document
          .getElementById('WorkMemoDeleteButton')
          .addEventListener('click', DeleteWorkMemo)

        await LoadWorkMemoList()
      }

      async function LoadWorkMemoList() {
        try {
          const WorkId = sessionStorage.getItem('WorkId')
          const Response = await CallApi(
            `/GetWorkMemoList.php?WorkId=${encodeURIComponent(
              WorkId,
            )}&UserId=${encodeURIComponent(sessionStorage.getItem('UserId'))}`,
            'GET',
          )
          if (Response.Success) {
            WorkMemoList = Response.Data.MemoList || []
            RenderWorkMemoTable()
          } else {
            await ShowErrorDialog(
              Response.Message || 'メモ一覧の取得に失敗しました',
            )
          }
        } catch (Error) {
          console.error(Error)
          await ShowErrorDialog('メモ一覧の取得中にエラーが発生しました')
        }
      }

      function RenderWorkMemoTable() {
        const TotalCount = WorkMemoList.length
        const CurrentUserId = sessionStorage.getItem('UserId')
        document.getElementById(
          'RecordCountArea',
        ).innerHTML = `<span class="RecordCount">${TotalCount} 件</span>`
        const Start = (CurrentPage - 1) * RECORDS_PER_PAGE
        const End = Math.min(Start + RECORDS_PER_PAGE, TotalCount)
        const PageData = WorkMemoList.slice(Start, End)
        let TableHtml = `
              <table class="DataTable">
                <thead><tr><th>タイトル</th><th>内容</th><th>投稿者</th><th>投稿日</th></tr></thead>
                <tbody>
            `
        if (PageData.length) {
          TableHtml += PageData.map(
            (M) => `
                  <tr data-id="${M.MemoId}" data-owner="${
              M.RegistUser
            }" class="${M.RegistUser === CurrentUserId ? 'OwnRow' : ''}">
                    <td>${EscapeHtml(M.Title)}</td>
                    <td>${EscapeHtml(TruncateText(M.Content || '', 30))}</td>
                    <td>${EscapeHtml(M.RegistUser || '')}</td>
                    <td>${FormatDateTimeWithWeekday(M.RegistDate)}</td>
                  </tr>
                `,
          ).join('')
        } else {
          TableHtml +=
            '<tr><td colspan="4" class="NoData">データがありません</td></tr>'
        }
        TableHtml += '</tbody></table>'
        document.getElementById('WorkMemoTableArea').innerHTML = TableHtml
        document
          .querySelectorAll('#WorkMemoTableArea tbody tr[data-id]')
          .forEach((Row) => {
            Row.addEventListener('dblclick', () =>
              SelectWorkMemo(Row.dataset.id, Row.dataset.owner),
            )
          })
        const PaginationArea = document.getElementById('PaginationArea')
        PaginationArea.innerHTML = ''
        PaginationArea.appendChild(
          CreatePagination(TotalCount, CurrentPage, (Page) => {
            CurrentPage = Page
            RenderWorkMemoTable()
          }),
        )
      }

      function SelectWorkMemo(MemoId, Owner) {
        const Item = WorkMemoList.find((M) => M.MemoId == MemoId)
        if (!Item) return
        const CurrentUserId = sessionStorage.getItem('UserId')

        SelectedWorkMemoId = MemoId
        SelectedWorkMemoOwner = Owner
        document.getElementById('WorkMemoTitle').value = Item.Title || ''
        document.getElementById('WorkMemoContent').value = TruncateText(
          Item.Content || '',
          30,
        )
        document.getElementById('WorkMemoContentHidden').value =
          Item.Content || ''

        /** 自身の投稿の場合のみ編集・削除可能 */
        const TitleInput = document.getElementById('WorkMemoTitle')
        const DeleteBtn = document.getElementById('WorkMemoDeleteButton')

        if (Owner === CurrentUserId) {
          TitleInput.disabled = false
          if (DeleteBtn) DeleteBtn.classList.remove('Hidden')
        } else {
          TitleInput.disabled = true
          if (DeleteBtn) DeleteBtn.classList.add('Hidden')
        }
      }

      function ClearWorkMemoForm() {
        SelectedWorkMemoId = null
        SelectedWorkMemoOwner = null
        document.getElementById('WorkMemoTitle').value = ''
        document.getElementById('WorkMemoTitle').disabled = false
        document.getElementById('WorkMemoContent').value = ''
        document.getElementById('WorkMemoContentHidden').value = ''
        const DeleteBtn = document.getElementById('WorkMemoDeleteButton')
        if (DeleteBtn) DeleteBtn.classList.add('Hidden')
      }

      async function SaveWorkMemo() {
        const Title = document.getElementById('WorkMemoTitle').value.trim()
        if (!Title) {
          await ShowErrorDialog('タイトルを入力してください')
          return
        }

        const CurrentUserId = sessionStorage.getItem('UserId')
        /** 更新の場合、自身の投稿かどうかをチェック */
        if (SelectedWorkMemoId && SelectedWorkMemoOwner !== CurrentUserId) {
          await ShowErrorDialog('他のユーザが投稿したメモは更新できません')
          return
        }

        try {
          ShowSpinner()
          const RequestData = {
            WorkId: sessionStorage.getItem('WorkId'),
            Title: Title,
            Content: document.getElementById('WorkMemoContentHidden').value,
            UserId: CurrentUserId,
          }
          if (SelectedWorkMemoId) RequestData.MemoId = SelectedWorkMemoId

          const Response = await CallApi(
            '/SaveWorkMemo.php',
            'POST',
            RequestData,
          )
          HideSpinner()
          if (Response.Success) {
            await ShowInfoDialog('保存完了', Response.Data.Message)
            ClearWorkMemoForm()
            await LoadWorkMemoList()
          } else {
            await ShowErrorDialog(Response.Message || '保存に失敗しました')
          }
        } catch (Error) {
          HideSpinner()
          await ShowErrorDialog('保存中にエラーが発生しました')
        }
      }

      async function DeleteWorkMemo() {
        if (!SelectedWorkMemoId) return

        const CurrentUserId = sessionStorage.getItem('UserId')
        /** 自身の投稿かどうかをチェック */
        if (SelectedWorkMemoOwner !== CurrentUserId) {
          await ShowErrorDialog('他のユーザが投稿したメモは削除できません')
          return
        }

        if (!(await ShowConfirmDialog('このメモを削除しますか？'))) return
        try {
          const Response = await CallApi('/DeleteWorkMemo.php', 'POST', {
            MemoId: SelectedWorkMemoId,
            WorkId: sessionStorage.getItem('WorkId'),
            UserId: CurrentUserId,
          })
          if (Response.Success) {
            await ShowInfoDialog('削除完了', 'メモを削除しました')
            ClearWorkMemoForm()
            await LoadWorkMemoList()
          } else {
            await ShowErrorDialog(Response.Message || '削除に失敗しました')
          }
        } catch (Error) {
          await ShowErrorDialog('削除中にエラーが発生しました')
        }
      }

      /* ==========================================================================
       * スケジュール
       * ========================================================================== */
      let CalendarYear = new Date().getFullYear()
      let CalendarMonth = new Date().getMonth()
      const ScheduleColors = [
        '#3498db',
        '#e74c3c',
        '#2ecc71',
        '#9b59b6',
        '#f39c12',
        '#1abc9c',
        '#e91e63',
        '#00bcd4',
      ]

      async function ShowSchedule() {
        SelectedScheduleId = null
        const ContentArea = document.getElementById('ContentArea')
        ContentArea.innerHTML = `
            ${CreateContentHeader('スケジュール', 'tasks')}
            <div class="CalendarContainer">
              <div class="CalendarHeader">
                <button class="CalendarNavButton" id="CalendarPrev"><i class="fas fa-chevron-left"></i></button>
                <h3 id="CalendarTitle"></h3>
                <button class="CalendarNavButton" id="CalendarNext"><i class="fas fa-chevron-right"></i></button>
              </div>
              <div class="CalendarGrid" id="CalendarGrid"></div>
            </div>
            <div id="RecordCountArea" class="MarginTop20"></div>
          `
        document
          .getElementById('CalendarPrev')
          .addEventListener('click', () => {
            CalendarMonth--
            if (CalendarMonth < 0) {
              CalendarMonth = 11
              CalendarYear--
            }
            RenderCalendar()
          })
        document
          .getElementById('CalendarNext')
          .addEventListener('click', () => {
            CalendarMonth++
            if (CalendarMonth > 11) {
              CalendarMonth = 0
              CalendarYear++
            }
            RenderCalendar()
          })
        await LoadScheduleList()
      }

      async function LoadScheduleList() {
        try {
          const Response = await CallApi('/GetScheduleList.php', 'POST', {
            WorkId: sessionStorage.getItem('WorkId'),
            UserId: sessionStorage.getItem('UserId'),
          })
          if (Response.Success) {
            ScheduleList = Response.Data.ScheduleList || []
            RenderCalendar()
          } else {
            await ShowErrorDialog(
              Response.Message || 'スケジュール一覧の取得に失敗しました',
            )
          }
        } catch (Error) {
          console.error(Error)
          await ShowErrorDialog(
            'スケジュール一覧の取得中にエラーが発生しました',
          )
        }
      }

      function RenderCalendar() {
        const Grid = document.getElementById('CalendarGrid')
        const Title = document.getElementById('CalendarTitle')
        const RecordCountArea = document.getElementById('RecordCountArea')
        if (!Grid) return
        Title.textContent = `${CalendarYear}年${CalendarMonth + 1}月`
        RecordCountArea.innerHTML = ''
        RecordCountArea.appendChild(CreateRecordCount(ScheduleList.length))
        Grid.innerHTML = ''
        const DayNames = ['日', '月', '火', '水', '木', '金', '土']
        DayNames.forEach((Name, Index) => {
          const DayHeader = document.createElement('div')
          DayHeader.className = 'CalendarDayHeader'
          if (Index === 0) DayHeader.classList.add('Sunday')
          if (Index === 6) DayHeader.classList.add('Saturday')
          DayHeader.textContent = Name
          Grid.appendChild(DayHeader)
        })
        const FirstDay = new Date(CalendarYear, CalendarMonth, 1)
        const LastDay = new Date(CalendarYear, CalendarMonth + 1, 0)
        const StartDayOfWeek = FirstDay.getDay()
        const DaysInMonth = LastDay.getDate()
        const Today = new Date()
        const TodayStr = `${Today.getFullYear()}-${String(
          Today.getMonth() + 1,
        ).padStart(2, '0')}-${String(Today.getDate()).padStart(2, '0')}`
        const PrevMonthLastDay = new Date(
          CalendarYear,
          CalendarMonth,
          0,
        ).getDate()
        for (let I = StartDayOfWeek - 1; I >= 0; I--) {
          Grid.appendChild(
            CreateDayCell(PrevMonthLastDay - I, true, StartDayOfWeek - 1 - I),
          )
        }
        for (let Day = 1; Day <= DaysInMonth; Day++) {
          const DateStr = `${CalendarYear}-${String(CalendarMonth + 1).padStart(
            2,
            '0',
          )}-${String(Day).padStart(2, '0')}`
          const DayOfWeek = new Date(CalendarYear, CalendarMonth, Day).getDay()
          Grid.appendChild(
            CreateDayCell(Day, false, DayOfWeek, DateStr, DateStr === TodayStr),
          )
        }
        const TotalCells = StartDayOfWeek + DaysInMonth
        const RemainingCells = (7 - (TotalCells % 7)) % 7
        for (let I = 1; I <= RemainingCells; I++) {
          Grid.appendChild(CreateDayCell(I, true, (TotalCells + I - 1) % 7))
        }
      }

      function CreateDayCell(
        Day,
        IsOtherMonth,
        DayOfWeek,
        DateStr = null,
        IsToday = false,
      ) {
        const DayCell = document.createElement('div')
        DayCell.className = 'CalendarDay'
        if (IsOtherMonth) DayCell.classList.add('OtherMonth')
        if (IsToday) DayCell.classList.add('Today')
        if (DayOfWeek === 0) DayCell.classList.add('Sunday')
        if (DayOfWeek === 6) DayCell.classList.add('Saturday')
        const DayNumber = document.createElement('div')
        DayNumber.className = 'CalendarDayNumber'
        DayNumber.textContent = Day
        DayCell.appendChild(DayNumber)
        if (DateStr && !IsOtherMonth) {
          const DayEvents = GetEventsForDate(DateStr)
          DayEvents.slice(0, 2).forEach((Event) => {
            const EventEl = document.createElement('div')
            EventEl.className = 'CalendarEvent'
            EventEl.style.backgroundColor = Event.color || '#3498db'
            EventEl.textContent = Event.title
            EventEl.title = Event.title
            EventEl.addEventListener('click', (E) => {
              E.stopPropagation()
              OpenScheduleModal(Event)
            })
            DayCell.appendChild(EventEl)
          })
          if (DayEvents.length > 2) {
            const MoreEl = document.createElement('div')
            MoreEl.className = 'CalendarMoreEvents'
            MoreEl.textContent = `+${DayEvents.length - 2}件`
            DayCell.appendChild(MoreEl)
          }
          if (CanEdit()) {
            DayCell.addEventListener('click', () =>
              OpenScheduleModal(null, DateStr),
            )
          }
        }
        return DayCell
      }

      function GetEventsForDate(DateStr) {
        return ScheduleList.filter((Item) => {
          const Start = Item.startdate || ''
          const End = Item.enddate || Start
          return Start && DateStr >= Start && DateStr <= (End || Start)
        })
      }

      function OpenScheduleModal(Event = null, DefaultDate = null) {
        const CanEditFlg = CanEdit()
        const IsNew = Event === null
        const Modal = document.createElement('div')
        Modal.className = 'ScheduleModal'
        Modal.innerHTML = `
            <div class="ScheduleModalContent">
              <div class="ScheduleModalHeader"><h3>${
                IsNew ? 'スケジュール追加' : 'スケジュール編集'
              }</h3><button class="ScheduleModalClose" id="ScheduleModalClose">&times;</button></div>
              <div class="FormGroup"><input type="text" class="InputForm" id="ModalScheduleTitle" placeholder="タイトル" maxlength="255" value="${
                Event?.title || ''
              }" ${!CanEditFlg ? 'disabled' : ''}></div>
              <div class="FormGroup InputWithButton"><input type="text" class="InputForm" id="ModalScheduleStartDate" placeholder="開始日" value="${
                Event?.startdate || DefaultDate || ''
              }" readonly ${!CanEditFlg ? 'disabled' : ''}>${
          CanEditFlg
            ? `<button class="ButtonClass SecondaryButton ButtonSmall" id="ModalStartDateBtn"><i class="fas fa-calendar"></i></button>`
            : ''
        }</div>
              <div class="FormGroup InputWithButton"><input type="text" class="InputForm" id="ModalScheduleEndDate" placeholder="終了日" value="${
                Event?.enddate || ''
              }" readonly ${!CanEditFlg ? 'disabled' : ''}>${
          CanEditFlg
            ? `<button class="ButtonClass SecondaryButton ButtonSmall" id="ModalEndDateBtn"><i class="fas fa-calendar"></i></button>`
            : ''
        }</div>
              ${
                CanEditFlg
                  ? `<label style="font-size:12px;color:#666;margin-bottom:5px;display:block;">カラー</label><div class="ScheduleColorPicker" id="ColorPicker">${ScheduleColors.map(
                      (C) =>
                        `<div class="ColorOption ${
                          (Event?.color || ScheduleColors[0]) === C
                            ? 'Selected'
                            : ''
                        }" data-color="${C}" style="background-color:${C};"></div>`,
                    ).join('')}</div>`
                  : ''
              }
              <div class="FormGroup InputWithButton"><input type="text" class="InputForm" id="ModalScheduleDescription" placeholder="説明" value="${
                TruncateText(Event?.description, 30) || ''
              }" disabled><button class="ButtonClass SecondaryButton ButtonSmall" id="ModalDescriptionBtn"><i class="fas fa-edit"></i></button></div>
              <input type="hidden" id="ModalScheduleDescriptionHidden" value="${
                Event?.description || ''
              }">
              <input type="hidden" id="ModalScheduleColor" value="${
                Event?.color || ScheduleColors[0]
              }">
              <input type="hidden" id="ModalScheduleId" value="${
                Event?.scheduleid || ''
              }">
              ${
                CanEditFlg
                  ? `<div class="ButtonGroup" style="margin-top:20px;"><button class="ButtonClass SaveButton" id="ModalSaveBtn"><i class="fas fa-save"></i> 保存</button>${
                      !IsNew
                        ? `<button class="ButtonClass DeleteButton" id="ModalDeleteBtn"><i class="fas fa-trash"></i> 削除</button>`
                        : ''
                    }</div>`
                  : ''
              }
            </div>`
        document.body.appendChild(Modal)
        const CloseModal = () => Modal.remove()
        Modal.querySelector('#ScheduleModalClose').addEventListener(
          'click',
          CloseModal,
        )
        Modal.addEventListener('click', (E) => {
          if (E.target === Modal) CloseModal()
        })
        if (CanEditFlg) {
          const DatePickerInstance = new DatePicker()
          Modal.querySelector('#ModalStartDateBtn').addEventListener(
            'click',
            () => DatePickerInstance.OpenDialog('ModalScheduleStartDate'),
          )
          Modal.querySelector('#ModalEndDateBtn').addEventListener(
            'click',
            () => DatePickerInstance.OpenDialog('ModalScheduleEndDate'),
          )
          Modal.querySelectorAll('.ColorOption').forEach((Opt) => {
            Opt.addEventListener('click', () => {
              Modal.querySelectorAll('.ColorOption').forEach((O) =>
                O.classList.remove('Selected'),
              )
              Opt.classList.add('Selected')
              Modal.querySelector('#ModalScheduleColor').value =
                Opt.dataset.color
            })
          })
          Modal.querySelector('#ModalSaveBtn').addEventListener(
            'click',
            async () => {
              const Title = Modal.querySelector(
                '#ModalScheduleTitle',
              ).value.trim()
              if (!Title) {
                await ShowErrorDialog('タイトルを入力してください')
                return
              }
              try {
                const Response = await CallApi('/SaveSchedule.php', 'POST', {
                  ScheduleId:
                    Modal.querySelector('#ModalScheduleId').value || null,
                  WorkId: sessionStorage.getItem('WorkId'),
                  Title: Title,
                  StartDate: Modal.querySelector(
                    '#ModalScheduleStartDate',
                  ).value.trim(),
                  EndDate: Modal.querySelector(
                    '#ModalScheduleEndDate',
                  ).value.trim(),
                  Color: Modal.querySelector('#ModalScheduleColor').value,
                  Description: Modal.querySelector(
                    '#ModalScheduleDescriptionHidden',
                  ).value,
                  UserId: sessionStorage.getItem('UserId'),
                })
                if (Response.Success) {
                  CloseModal()
                  await ShowInfoDialog('保存完了', 'スケジュールを保存しました')
                  await LoadScheduleList()
                } else {
                  await ShowErrorDialog(
                    Response.Message || '保存に失敗しました',
                  )
                }
              } catch (Error) {
                await ShowErrorDialog('保存中にエラーが発生しました')
              }
            },
          )
          if (!IsNew) {
            Modal.querySelector('#ModalDeleteBtn').addEventListener(
              'click',
              async () => {
                if (
                  !(await ShowConfirmDialog('このスケジュールを削除しますか？'))
                )
                  return
                try {
                  const Response = await CallApi(
                    '/DeleteSchedule.php',
                    'POST',
                    {
                      ScheduleId: Modal.querySelector('#ModalScheduleId').value,
                      WorkId: sessionStorage.getItem('WorkId'),
                      UserId: sessionStorage.getItem('UserId'),
                    },
                  )
                  if (Response.Success) {
                    CloseModal()
                    await ShowInfoDialog(
                      '削除完了',
                      'スケジュールを削除しました',
                    )
                    await LoadScheduleList()
                  } else {
                    await ShowErrorDialog(
                      Response.Message || '削除に失敗しました',
                    )
                  }
                } catch (Error) {
                  await ShowErrorDialog('削除中にエラーが発生しました')
                }
              },
            )
          }
        }
        Modal.querySelector('#ModalDescriptionBtn').addEventListener(
          'click',
          async () => {
            const Result = await ShowInputAreaDialog(
              Modal.querySelector('#ModalScheduleDescriptionHidden').value,
              !CanEditFlg,
            )
            if (Result !== null && CanEditFlg) {
              Modal.querySelector('#ModalScheduleDescriptionHidden').value =
                Result
              Modal.querySelector('#ModalScheduleDescription').value =
                TruncateText(Result, 30)
            }
          },
        )
      }

      /* ==========================================================================
       * 作品作成参加者一覧画面 (2.2 CreaterList)
       * ========================================================================== */
      let ParticipantList = []

      async function ShowParticipants() {
        CurrentPage = 1
        const ContentArea = document.getElementById('ContentArea')
        const CanEditFlg = CanEdit()

        ContentArea.innerHTML = `
              ${CreateContentHeader('参加者一覧', 'user-friends')}
              <div id="RecordCountArea" class="MarginTop20"></div>
              <div class="TableContainer" id="ParticipantTableArea"></div>
              <div id="PaginationArea"></div>
            `

        await LoadParticipantList()
      }

      async function LoadParticipantList() {
        try {
          const WorkId = sessionStorage.getItem('WorkId')
          const Response = await CallApi(
            `/GetParticipantList.php?WorkId=${encodeURIComponent(
              WorkId,
            )}&UserId=${encodeURIComponent(sessionStorage.getItem('UserId'))}`,
            'GET',
          )
          if (Response.Success) {
            ParticipantList = Response.Data.ParticipantList || []
            RenderParticipantTable()
          } else {
            await ShowErrorDialog(
              Response.Message || '参加者一覧の取得に失敗しました',
            )
          }
        } catch (Error) {
          console.error(Error)
          await ShowErrorDialog('参加者一覧の取得中にエラーが発生しました')
        }
      }

      /**
       * 参加者一覧表示処理
       **/
      function RenderParticipantTable() {
        const CanEditFlg = CanEdit()
        console.log('CanEditFlg', CanEditFlg)
        const TotalCount = ParticipantList.length
        document.getElementById(
          'RecordCountArea',
        ).innerHTML = `<span class="RecordCount">${TotalCount} 件</span>`
        const Start = (CurrentPage - 1) * RECORDS_PER_PAGE
        const End = Math.min(Start + RECORDS_PER_PAGE, TotalCount)
        const PageData = ParticipantList.slice(Start, End)
        let TableHtml = `
              <table class="DataTable">
                <thead><tr>
                  <th>ユーザーID</th>
                  <th>利用者区分</th>
                  <th>参加日</th>
                  ${CanEditFlg ? '<th>アクセス権限</th>' : ''}
                </tr></thead>
                <tbody>
            `
        if (PageData.length) {
          TableHtml += PageData.map((P) => {
            console.log('P', P)
            const RoleLabel = P.IsCreator ? '作成者' : 'アシスタント'
            const LockBtnLabel = P.UserLockFlg ? 'アクセス許可' : 'アクセス禁止'
            const LockBtnClass = P.UserLockFlg
              ? 'SuccessButton'
              : 'DangerButton'
            return `
                  <tr data-userid="${EscapeHtml(P.UserId)}">
                    <td>${EscapeHtml(P.UserId || '')}</td>
                    <td>${RoleLabel}</td>
                    <td>${FormatTimestamp(P.RegistDate)}</td>
                    ${
                      CanEditFlg && !P.IsCreator
                        ? `<td>
                            <button
                              class="ButtonClass ${LockBtnClass} ButtonSmall ParticipantLockBtn"
                              data-userid="${EscapeHtml(P.UserId)}"
                              data-locked="${P.UserLockFlg ? 'true' : 'false'}">
                              <i class="fas fa-${
                                P.UserLockFlg ? 'lock' : 'unlock'
                              }"></i>
                              ${LockBtnLabel}
                            </button>
                          </td>`
                        : CanEditFlg
                        ? '<td></td>'
                        : ''
                    }
                  </tr>
                `
          }).join('')
        } else {
          TableHtml += `<tr><td colspan="${
            CanEditFlg ? '4' : '3'
          }" class="NoData">データがありません</td></tr>`
        }
        TableHtml += '</tbody></table>'
        document.getElementById('ParticipantTableArea').innerHTML = TableHtml

        /** アクセス権限ボタンのイベント設定 */
        if (CanEditFlg) {
          document.querySelectorAll('.ParticipantLockBtn').forEach((Btn) => {
            Btn.addEventListener('click', (E) => {
              const TargetUserId = E.currentTarget.dataset.userid
              const IsLocked = E.currentTarget.dataset.locked === 'true'
              ChangeParticipantLock(TargetUserId, IsLocked)
            })
          })
        }

        const PaginationArea = document.getElementById('PaginationArea')
        PaginationArea.innerHTML = ''
        PaginationArea.appendChild(
          CreatePagination(TotalCount, CurrentPage, (Page) => {
            CurrentPage = Page
            RenderParticipantTable()
          }),
        )
      }

      /**
       * ユーザーのプロジェクト参加を制御
       * */
      async function ChangeParticipantLock(TargetUserId, CurrentLockStatus) {
        /* ---------------------------------------------
         *  1. Enterキー押下時の処理
         * --------------------------------------------- */
        // 1. ロック制御状態を取得
        const NewLockStatus = !CurrentLockStatus
        // 2. 状態に応じたメッセージを設定
        const Message = NewLockStatus
          ? 'このユーザーのアクセスを禁止しますか？'
          : 'このユーザーのアクセスを許可しますか？'

        /* ---------------------------------------------
         *  2. いいえが選択された場合
         * --------------------------------------------- */
        if (!(await ShowConfirmDialog(Message))) {
          // 1. 処理終了
          return
        }

        /* ---------------------------------------------
         *  3. API通信
         * --------------------------------------------- */
        try {
          /* 1. API呼び出し */
          const Response = await CallApi('/UpdateParticipant.php', 'POST', {
            // 1. ID
            TargetUserId: TargetUserId,
            // 2. 作品ID
            WorkId: sessionStorage.getItem('WorkId'),
            // 3. ユーザーID
            UserId: sessionStorage.getItem('UserId'),
          })

          /* 2. 処理成功時 */
          if (Response.Success) {
            // 1. 状態に応じてメッセージ設定
            const InfoMessage = NewLockStatus
              ? 'アクセスを禁止しました'
              : 'アクセスを許可しました'
            // 2. インフォダイアログ表示
            await ShowInfoDialog('更新完了', InfoMessage)
            // 3.参加者一覧表示
            await LoadParticipantList()
          } else {
            /* 3. 処理失敗時 */
            // 1. エラーダイアログ表示
            await ShowErrorDialog(Response.Message || '更新に失敗しました')
          }
        } catch (Error) {
          /* ---------------------------------------------
           *  4. 例外処理
           * --------------------------------------------- */
          // 1. エラーダイアログ表示
          await ShowErrorDialog('更新中にエラーが発生しました')
        }
      }
    </script>
  </body>
</html>

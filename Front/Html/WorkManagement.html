<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>作品管理 | 作品管理システム</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="../Css/Common.css" />
    <style>
      /**
     * 作品管理画面固有スタイル
     */
      .WorkTitle {
        font-size: 18px;
        color: #2c3e50;
        margin-bottom: 20px;
        padding: 10px 15px;
        background-color: #ecf0f1;
        border-radius: 6px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .WorkTitle i {
        color: #3498db;
      }

      .SidebarSubMenu {
        padding-left: 20px;
        font-size: 13px;
      }

      .SidebarSubMenu .SidebarItem {
        padding: 10px 15px;
      }

      .SidebarDivider {
        height: 1px;
        background-color: #34495e;
        margin: 10px 15px;
      }

      .FormRow {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
        flex-wrap: wrap;
      }

      .FormRow .FormGroup {
        flex: 1;
        min-width: 200px;
        margin-bottom: 0;
      }

      .FormLabel {
        display: block;
        font-size: 12px;
        color: #666;
        margin-bottom: 5px;
      }

      /* 相関図スタイル */
      .RelationContainer {
        display: flex;
        gap: 20px;
        height: calc(100vh - 200px);
        min-height: 500px;
      }

      .RelationSidebar {
        width: 200px;
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        overflow-y: auto;
      }

      .RelationSidebarTitle {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 10px;
        color: #2c3e50;
      }

      .CharacterListItem {
        padding: 8px 12px;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-bottom: 8px;
        cursor: grab;
        font-size: 12px;
        transition: all 0.2s ease;
      }

      .CharacterListItem:hover {
        background: #e3f2fd;
        border-color: #3498db;
      }

      .CharacterListItem.dragging {
        opacity: 0.5;
      }

      .RelationCanvas {
        flex: 1;
        background: #fff;
        border: 2px solid #ddd;
        border-radius: 8px;
        position: relative;
        overflow: hidden;
      }

      .RelationCanvasSvg {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
      }

      .RelationCanvasSvg line,
      .RelationCanvasSvg path {
        pointer-events: stroke;
        cursor: pointer;
      }

      .RelationObject {
        position: absolute;
        background: #fff;
        border: 2px solid #3498db;
        border-radius: 8px;
        padding: 10px;
        cursor: move;
        min-width: 80px;
        text-align: center;
        font-size: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        z-index: 10;
      }

      .RelationObject.selected {
        border-color: #e74c3c;
        box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.2);
      }

      .RelationObject img {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        object-fit: cover;
        margin-bottom: 5px;
      }

      .RelationGroupBox {
        position: absolute;
        border: 2px dashed #9b59b6;
        border-radius: 12px;
        padding: 10px;
        background: rgba(155, 89, 182, 0.05);
        z-index: 1;
      }

      .RelationGroupLabel {
        position: absolute;
        top: -12px;
        left: 10px;
        background: #9b59b6;
        color: #fff;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 11px;
      }

      .TrashZone {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 60px;
        height: 60px;
        background: #f8f9fa;
        border: 2px dashed #e74c3c;
        border-radius: 8px;
        display: flex;
        justify-content: center;
        align-items: center;
        color: #e74c3c;
        font-size: 24px;
        transition: all 0.2s ease;
        z-index: 100;
      }

      .TrashZone.active {
        background: #fee;
        border-style: solid;
        transform: scale(1.1);
      }

      /* ストーリー・プロット用スタイル */
      .StoryList {
        margin-top: 20px;
      }

      .StoryItem {
        display: flex;
        align-items: flex-start;
        padding: 15px;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        margin-bottom: 10px;
        cursor: grab;
        transition: all 0.2s ease;
      }

      .StoryItem:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .StoryItem.dragging {
        opacity: 0.5;
        transform: rotate(2deg);
      }

      .StoryItem.drag-over {
        border-color: #3498db;
        background: #e3f2fd;
      }

      .StoryNumber {
        width: 30px;
        height: 30px;
        background: #3498db;
        color: #fff;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: 600;
        font-size: 12px;
        margin-right: 15px;
        flex-shrink: 0;
      }

      .StoryContent {
        flex: 1;
      }

      .StoryNarrator {
        font-size: 12px;
        color: #666;
        margin-bottom: 5px;
      }

      .StoryText {
        font-size: 14px;
        line-height: 1.6;
      }

      .PlotBadge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        margin-right: 10px;
      }

      .PlotBadge.ki {
        background: #e3f2fd;
        color: #1976d2;
      }

      .PlotBadge.sho {
        background: #e8f5e9;
        color: #388e3c;
      }

      .PlotBadge.ten {
        background: #fff3e0;
        color: #f57c00;
      }

      .PlotBadge.ketsu {
        background: #fce4ec;
        color: #c2185b;
      }

      /* 関係性タイプ選択 */
      .RelationTypeSelector {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 15px;
      }

      .RelationTypeOption {
        padding: 8px 16px;
        border: 2px solid #ddd;
        border-radius: 20px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s ease;
      }

      .RelationTypeOption:hover {
        border-color: #3498db;
      }

      .RelationTypeOption.selected {
        border-color: currentColor;
        background: currentColor;
        color: #fff;
      }

      /* カレンダーUI */
      .CalendarContainer {
        margin-top: 20px;
      }

      .CalendarHeader {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding: 10px;
        background-color: #3498db;
        border-radius: 8px;
        color: #fff;
      }

      .CalendarHeader h3 {
        margin: 0;
        font-size: 18px;
      }

      .CalendarNavButton {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: #fff;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 16px;
        transition: background 0.2s;
      }

      .CalendarNavButton:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .CalendarGrid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 2px;
        background-color: #ddd;
        border-radius: 8px;
        overflow: hidden;
      }

      .CalendarDayHeader {
        background-color: #34495e;
        color: #fff;
        text-align: center;
        padding: 10px 5px;
        font-size: 12px;
        font-weight: bold;
      }

      .CalendarDayHeader.Sunday {
        color: #ff6b6b;
      }
      .CalendarDayHeader.Saturday {
        color: #74b9ff;
      }

      .CalendarDay {
        background-color: #fff;
        min-height: 80px;
        padding: 5px;
        cursor: pointer;
        transition: background 0.2s;
        position: relative;
      }

      .CalendarDay:hover {
        background-color: #ecf0f1;
      }

      .CalendarDay.OtherMonth {
        background-color: #f8f9fa;
        color: #aaa;
      }

      .CalendarDay.Today {
        background-color: #fff9c4;
      }

      .CalendarDayNumber {
        font-size: 12px;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .CalendarDay.Sunday .CalendarDayNumber {
        color: #e74c3c;
      }
      .CalendarDay.Saturday .CalendarDayNumber {
        color: #3498db;
      }

      .CalendarEvent {
        font-size: 10px;
        padding: 2px 4px;
        margin-bottom: 2px;
        border-radius: 3px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        cursor: pointer;
        color: #fff;
        background-color: #3498db;
      }

      .CalendarEvent:hover {
        opacity: 0.8;
      }

      .CalendarMoreEvents {
        font-size: 10px;
        color: #666;
        text-align: center;
        margin-top: 2px;
      }

      /* スケジュール詳細モーダル */
      .ScheduleModal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }

      .ScheduleModalContent {
        background: #fff;
        padding: 25px;
        border-radius: 12px;
        width: 90%;
        max-width: 450px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      }

      .ScheduleModalHeader {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .ScheduleModalHeader h3 {
        margin: 0;
        font-size: 18px;
        color: #2c3e50;
      }

      .ScheduleModalClose {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #999;
      }

      .ScheduleModalClose:hover {
        color: #333;
      }

      .ScheduleColorPicker {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-bottom: 15px;
      }

      .ColorOption {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        cursor: pointer;
        border: 3px solid transparent;
        transition: transform 0.2s, border-color 0.2s;
      }

      .ColorOption:hover {
        transform: scale(1.1);
      }

      .ColorOption.Selected {
        border-color: #2c3e50;
      }

      @media screen and (max-width: 768px) {
        .CalendarDay {
          min-height: 60px;
          padding: 3px;
        }
        .CalendarDayNumber {
          font-size: 10px;
        }
        .CalendarEvent {
          font-size: 8px;
          padding: 1px 2px;
        }
      }
    </style>
  </head>
  <body>
    <!-- メニュートグルボタン（モバイル用） -->
    <button class="MenuToggle" id="MenuToggle">
      <i class="fas fa-bars"></i>
    </button>

    <!-- サイドバーオーバーレイ（モバイル用） -->
    <div class="SidebarOverlay" id="SidebarOverlay"></div>

    <div class="PageContainer">
      <!-- サイドバー -->
      <nav class="Sidebar" id="Sidebar">
        <div class="SidebarHeader">
          <h1><i class="fas fa-book-open"></i> 作品管理</h1>
        </div>
        <div class="SidebarMenu">
          <!-- メイン機能 -->
          <button class="SidebarItem" id="MenuBackToMain">
            <i class="fas fa-arrow-left"></i> メインへ戻る
          </button>

          <div class="SidebarDivider"></div>

          <!-- 作品設定 -->
          <button class="SidebarItem Active" id="MenuWorkInfo">
            <i class="fas fa-info-circle"></i> 作品共通情報
          </button>
          <button class="SidebarItem" id="MenuCharacter">
            <i class="fas fa-user"></i> キャラ設定
          </button>
          <button class="SidebarItem" id="MenuOrganization">
            <i class="fas fa-building"></i> 組織設定
          </button>
          <button class="SidebarItem" id="MenuTeam">
            <i class="fas fa-users"></i> チーム設定
          </button>
          <button class="SidebarItem" id="MenuRace">
            <i class="fas fa-dna"></i> 種族設定
          </button>
          <button class="SidebarItem" id="MenuClass">
            <i class="fas fa-medal"></i> 階級設定
          </button>

          <div class="SidebarDivider"></div>

          <!-- 世界観設定 -->
          <button class="SidebarItem" id="MenuCalendar">
            <i class="fas fa-calendar-alt"></i> 元号設定
          </button>
          <button class="SidebarItem" id="MenuTimeline">
            <i class="fas fa-stream"></i> 年表設定
          </button>
          <button class="SidebarItem" id="MenuStage">
            <i class="fas fa-map-marked-alt"></i> 舞台設定
          </button>
          <button class="SidebarItem" id="MenuBuilding">
            <i class="fas fa-landmark"></i> 建物設定
          </button>

          <div class="SidebarDivider"></div>

          <!-- 能力・装備 -->
          <button class="SidebarItem" id="MenuPower">
            <i class="fas fa-bolt"></i> 能力設定
          </button>
          <button class="SidebarItem" id="MenuWeapon">
            <i class="fas fa-shield-alt"></i> 武器設定
          </button>
          <button class="SidebarItem" id="MenuMove">
            <i class="fas fa-fire"></i> 技設定
          </button>

          <div class="SidebarDivider"></div>

          <!-- ストーリー・その他 -->
          <button class="SidebarItem" id="MenuSerif">
            <i class="fas fa-comment"></i> セリフ設定
          </button>
          <button class="SidebarItem" id="MenuRelation">
            <i class="fas fa-project-diagram"></i> 相関図作成
          </button>
          <button class="SidebarItem" id="MenuStory">
            <i class="fas fa-book"></i> ストーリー作成
          </button>
          <button class="SidebarItem" id="MenuPlot">
            <i class="fas fa-sitemap"></i> プロット作成
          </button>
          <button class="SidebarItem" id="MenuClue">
            <i class="fas fa-puzzle-piece"></i> 伏線メモ
          </button>

          <div class="SidebarDivider"></div>

          <!-- 管理 -->
          <button class="SidebarItem" id="MenuReview">
            <i class="fas fa-star"></i> 作品レビュー
          </button>
          <button class="SidebarItem" id="MenuMemo">
            <i class="fas fa-sticky-note"></i> 作品作成用メモ
          </button>
          <button class="SidebarItem" id="MenuSchedule">
            <i class="fas fa-tasks"></i> スケジュール
          </button>
          <button class="SidebarItem" id="MenuParticipants">
            <i class="fas fa-user-friends"></i> 参加者一覧
          </button>
          <button class="SidebarItem" id="MenuHistory">
            <i class="fas fa-history"></i> 更新履歴
          </button>
        </div>
        <div class="SidebarFooter">
          <button class="SidebarItem" id="MenuLogout">
            <i class="fas fa-sign-out-alt"></i> ログアウト
          </button>
        </div>
      </nav>

      <!-- メインコンテンツ -->
      <main class="MainContentWrapper">
        <div class="ContentArea" id="ContentArea">
          <!-- 動的にコンテンツが挿入される -->
        </div>
      </main>
    </div>

    <script src="../Js/Common.js"></script>
    <script src="../Js/Dialog.js"></script>
    <script>
      // ページネーション用の1ページあたり件数（デフォルト値）
      const PAGE_SIZE = 15
      /**
       * WorkManagement.js
       * 作品管理画面の処理
       */

      /** グローバル変数 */
      let WorkInfo = null
      let IsCreator = false
      let IsAdmin = false
      let IsAssistant = false
      let CurrentPage = 1
      let TimelineList = []
      let ScheduleList = []
      let ReviewList = []
      let SelectedTimelineId = null
      let SelectedScheduleId = null
      let SelectedReviewId = null

      /**
       * ページ読み込み時の初期化処理
       */
      document.addEventListener('DOMContentLoaded', function () {
        InitializeWorkManagementPage()
      })

      /**
       * 作品管理画面の初期化
       */
      async function InitializeWorkManagementPage() {
        /** セッションチェック */
        const UserId = sessionStorage.getItem('UserId')
        const WorkId = sessionStorage.getItem('WorkId')

        if (!UserId || !WorkId) {
          window.location.href = '/index.html'
          return
        }

        IsAdmin = sessionStorage.getItem('AuthFlg') === 'true'

        /** メニューイベント設定 */
        SetupMenuEvents()

        /** モバイルメニュートグル */
        SetupMobileMenu()

        /** セッション監視開始 */
        StartSessionMonitor()

        /** 作品情報取得 */
        await LoadWorkInfo()

        /** 利用者区分チェック */
        await CheckUserPermission()

        /** 初期表示：作品共通情報 */
        ShowWorkCommonInfo()
      }

      /**
       * 作品情報を読み込み
       */
      async function LoadWorkInfo() {
        try {
          const WorkId = sessionStorage.getItem('WorkId')
          const Response = await CallApi(
            `/GetWorkInfo.php?WorkId=${encodeURIComponent(WorkId)}`,
            'GET',
          )

          if (Response.Success) {
            WorkInfo = Response.Data
          } else {
            await ShowErrorDialog(
              Response.Message || '作品情報の取得に失敗しました',
            )
            window.location.href = 'Main.html'
          }
        } catch (Error) {
          await ShowErrorDialog('作品情報の取得中にエラーが発生しました')
          window.location.href = 'Main.html'
        }
      }

      /**
       * 利用者区分チェック
       */
      async function CheckUserPermission() {
        try {
          const UserId = sessionStorage.getItem('UserId')
          const WorkId = sessionStorage.getItem('WorkId')
          const Response = await CallApi(
            `/GetUserPermission.php?WorkId=${encodeURIComponent(
              WorkId,
            )}&UserId=${encodeURIComponent(UserId)}`,
            'GET',
          )

          if (Response.Success) {
            IsCreator = Response.IsCreator
            IsAssistant = !Response.IsCreator
          }
        } catch (Error) {
          console.error('権限チェックエラー:', Error)
        }
      }

      /**
       * 編集権限があるかチェック（作成者または管理者）
       * @returns {boolean} 編集権限があるかどうか
       */
      function CanEdit() {
        return IsCreator || IsAdmin
      }

      /**
       * レビュー編集権限があるかチェック（アシスタントまたは管理者）
       * @returns {boolean} レビュー編集権限があるかどうか
       */
      function CanEditReview() {
        return IsAssistant || IsAdmin
      }

      /**
       * メニューイベントの設定
       */
      function SetupMenuEvents() {
        /** メインへ戻る */
        document
          .getElementById('MenuBackToMain')
          .addEventListener('click', function () {
            window.location.href = 'Main.html'
          })

        /** 各メニュー項目 */
        document
          .getElementById('MenuWorkInfo')
          .addEventListener('click', function () {
            SetActiveMenu(this)
            ShowWorkCommonInfo()
          })

        document
          .getElementById('MenuCharacter')
          .addEventListener('click', function () {
            SetActiveMenu(this)
            ShowCharacterSetting()
          })

        document
          .getElementById('MenuOrganization')
          .addEventListener('click', function () {
            SetActiveMenu(this)
            ShowOrganizationSetting()
          })

        document
          .getElementById('MenuTeam')
          .addEventListener('click', function () {
            SetActiveMenu(this)
            ShowTeamSetting()
          })

        document
          .getElementById('MenuRace')
          .addEventListener('click', function () {
            SetActiveMenu(this)
            ShowRaceSetting()
          })

        document
          .getElementById('MenuClass')
          .addEventListener('click', function () {
            SetActiveMenu(this)
            ShowClassSetting()
          })

        document
          .getElementById('MenuCalendar')
          .addEventListener('click', function () {
            SetActiveMenu(this)
            ShowCalendarSetting()
          })

        document
          .getElementById('MenuTimeline')
          .addEventListener('click', function () {
            SetActiveMenu(this)
            ShowTimelineSetting()
          })

        document
          .getElementById('MenuStage')
          .addEventListener('click', function () {
            SetActiveMenu(this)
            ShowStageSetting()
          })

        document
          .getElementById('MenuBuilding')
          .addEventListener('click', function () {
            SetActiveMenu(this)
            ShowBuildingSetting()
          })

        document
          .getElementById('MenuPower')
          .addEventListener('click', function () {
            SetActiveMenu(this)
            ShowPowerSetting()
          })

        document
          .getElementById('MenuWeapon')
          .addEventListener('click', function () {
            SetActiveMenu(this)
            ShowWeaponSetting()
          })

        document
          .getElementById('MenuMove')
          .addEventListener('click', function () {
            SetActiveMenu(this)
            ShowMoveSetting()
          })

        document
          .getElementById('MenuSerif')
          .addEventListener('click', function () {
            SetActiveMenu(this)
            ShowSerifSetting()
          })

        document
          .getElementById('MenuRelation')
          .addEventListener('click', function () {
            SetActiveMenu(this)
            ShowRelationDiagram()
          })

        document
          .getElementById('MenuStory')
          .addEventListener('click', function () {
            SetActiveMenu(this)
            ShowStoryCreation()
          })

        document
          .getElementById('MenuPlot')
          .addEventListener('click', function () {
            SetActiveMenu(this)
            ShowPlotCreation()
          })

        document
          .getElementById('MenuClue')
          .addEventListener('click', function () {
            SetActiveMenu(this)
            ShowClueMemo()
          })

        document
          .getElementById('MenuReview')
          .addEventListener('click', function () {
            SetActiveMenu(this)
            ShowWorkReview()
          })

        document
          .getElementById('MenuMemo')
          .addEventListener('click', function () {
            SetActiveMenu(this)
            ShowWorkMemo()
          })

        document
          .getElementById('MenuSchedule')
          .addEventListener('click', function () {
            SetActiveMenu(this)
            ShowSchedule()
          })

        document
          .getElementById('MenuParticipants')
          .addEventListener('click', function () {
            SetActiveMenu(this)
            ShowParticipants()
          })

        document
          .getElementById('MenuHistory')
          .addEventListener('click', function () {
            SetActiveMenu(this)
            ShowUpdateHistory()
          })

        document
          .getElementById('MenuLogout')
          .addEventListener('click', HandleLogout)
      }

      /**
       * モバイルメニューの設定
       */
      function SetupMobileMenu() {
        const Toggle = document.getElementById('MenuToggle')
        const Sidebar = document.getElementById('Sidebar')
        const Overlay = document.getElementById('SidebarOverlay')

        Toggle.addEventListener('click', function () {
          Sidebar.classList.toggle('Open')
          Overlay.classList.toggle('Open')
        })

        Overlay.addEventListener('click', function () {
          Sidebar.classList.remove('Open')
          Overlay.classList.remove('Open')
        })
      }

      /**
       * アクティブメニューの設定
       * @param {HTMLElement} Element アクティブにする要素
       */
      function SetActiveMenu(Element) {
        document.querySelectorAll('.SidebarItem').forEach((Item) => {
          Item.classList.remove('Active')
        })
        Element.classList.add('Active')

        document.getElementById('Sidebar').classList.remove('Open')
        document.getElementById('SidebarOverlay').classList.remove('Open')
      }

      /**
       * ログアウト処理
       */
      async function HandleLogout() {
        const Confirmed = await ShowConfirmDialog('ログアウトしますか？')
        if (Confirmed) {
          sessionStorage.clear()
          window.location.href = '/index.html'
        }
      }

      /**
       * コンテンツヘッダーを生成
       * @param {string} Title タイトル
       * @param {string} Icon アイコン
       * @returns {string} HTML文字列
       */
      function CreateContentHeader(Title, Icon) {
        const WorkTitle = WorkInfo ? WorkInfo.WorkTitle : ''
        return `
        <div class="WorkTitle">
          <i class="fas fa-book"></i>
          <span>${TruncateText(WorkTitle, 30)}</span>
        </div>
        <div class="ContentHeader">
          <h2 class="ContentTitle"><i class="fas fa-${Icon}"></i> ${Title}</h2>
        </div>
      `
      }

      /* ==========================================================================
       * 作品共通情報
       * ========================================================================== */
      /**
       * 作品共通情報画面を表示
       */
      function ShowWorkCommonInfo() {
        const ContentArea = document.getElementById('ContentArea')
        const CanEditFlg = CanEdit()

        ContentArea.innerHTML = `
        ${CreateContentHeader('作品共通情報', 'info-circle')}
        <div class="FormGroup">
          <input type="text" class="InputForm" id="WorkTitle" placeholder="作品名" value="${
            WorkInfo?.WorkTitle || ''
          }" ${!CanEditFlg ? 'disabled' : ''}>
        </div>
        <div class="FormGroup">
          <select class="SelectForm" id="Genre" ${
            !CanEditFlg ? 'disabled' : ''
          }>
            ${PullDownList('Genre')}
          </select>
        </div>
        ${
          CanEditFlg
            ? `
        <div class="ButtonGroup">
          <button class="ButtonClass SaveButton" id="SaveWorkInfoButton">
            <i class="fas fa-save"></i> 保存
          </button>
        </div>
        `
            : ''
        }
      `

        if (WorkInfo) {
          document.getElementById('Genre').value = WorkInfo.Genre
        }

        if (CanEditFlg) {
          document
            .getElementById('SaveWorkInfoButton')
            .addEventListener('click', SaveWorkInfo)
        }
      }

      /**
       * 作品情報を保存
       */
      async function SaveWorkInfo() {
        const WorkTitle = document.getElementById('WorkTitle').value.trim()
        const Genre = document.getElementById('Genre').value

        if (!WorkTitle) {
          await ShowErrorDialog('作品名を入力してください')
          return
        }

        try {
          const UserId = sessionStorage.getItem('UserId')
          const WorkId = sessionStorage.getItem('WorkId')
          const Response = await CallApi('/UpdateWorkInfo.php', 'POST', {
            WorkId: WorkId,
            WorkTitle: WorkTitle,
            Genre: parseInt(Genre),
            UserId: UserId,
          })

          if (Response.Success) {
            await ShowInfoDialog('保存完了', '作品情報を保存しました')
            await LoadWorkInfo()
            ShowWorkCommonInfo()
          } else {
            await ShowErrorDialog(Response.Message || '保存に失敗しました')
          }
        } catch (Error) {
          await ShowErrorDialog('保存中にエラーが発生しました')
        }
      }

      /* ==========================================================================
       * キャラ設定画面 (4.1 CharacterInfo)
       * ========================================================================== */
      let CharacterList = []
      let SelectedCharacterId = null
      let CharacterOrganizationList = []
      let CharacterTeamList = []
      let CharacterRaceList = []
      let CharacterClassList = []

      async function ShowCharacterSetting() {
        CurrentPage = 1
        SelectedCharacterId = null
        const ContentArea = document.getElementById('ContentArea')
        const CanEditFlg = CanEdit()

        ContentArea.innerHTML = `
          ${CreateContentHeader('キャラ設定', 'user')}
          <div class="TabContainer">
            <div class="TabHeader">
              <button class="TabButton Active" data-tab="basic">基本情報</button>
              <button class="TabButton" data-tab="affiliation">所属情報</button>
              <button class="TabButton" data-tab="detail">詳細情報</button>
              <button class="TabButton" data-tab="image">画像</button>
            </div>

            <!-- 基本情報タブ -->
            <div class="TabContent Active" id="TabBasic">
              <div class="FormRow">
                <div class="FormGroup">
                  <input type="text" class="InputForm" id="CharaName" placeholder="キャラ名" maxlength="255" ${
                    !CanEditFlg ? 'disabled' : ''
                  }>
                </div>
                <div class="FormGroup">
                  <select class="SelectForm" id="CharaGender" ${
                    !CanEditFlg ? 'disabled' : ''
                  }>${PullDownList('Gender')}</select>
                </div>
              </div>
              <div class="FormRow">
                <div class="FormGroup InputWithButton">
                  <input type="text" class="InputForm" id="CharaBirthDate" placeholder="生年月日" readonly ${
                    !CanEditFlg ? 'disabled' : ''
                  }>
                  ${
                    CanEditFlg
                      ? `<button class="ButtonClass SecondaryButton ButtonSmall" id="CharaBirthDateBtn"><i class="fas fa-calendar"></i></button>`
                      : ''
                  }
                </div>
                <div class="FormGroup">
                  <input type="text" class="InputForm" id="CharaAge" placeholder="年齢" maxlength="50" ${
                    !CanEditFlg ? 'disabled' : ''
                  }>
                </div>
              </div>
              <div class="FormRow">
                <div class="FormGroup">
                  <input type="text" class="InputForm" id="CharaHeight" placeholder="身長" maxlength="50" ${
                    !CanEditFlg ? 'disabled' : ''
                  }>
                </div>
                <div class="FormGroup">
                  <input type="text" class="InputForm" id="CharaWeight" placeholder="体重" maxlength="50" ${
                    !CanEditFlg ? 'disabled' : ''
                  }>
                </div>
                <div class="FormGroup">
                  <input type="text" class="InputForm" id="CharaBloodType" placeholder="血液型" maxlength="10" ${
                    !CanEditFlg ? 'disabled' : ''
                  }>
                </div>
              </div>
              <div class="FormRow">
                <div class="FormGroup">
                  <input type="text" class="InputForm" id="CharaFirstPerson" placeholder="一人称" maxlength="50" ${
                    !CanEditFlg ? 'disabled' : ''
                  }>
                </div>
                <div class="FormGroup">
                  <input type="text" class="InputForm" id="CharaSecondPerson" placeholder="二人称" maxlength="50" ${
                    !CanEditFlg ? 'disabled' : ''
                  }>
                </div>
              </div>
              <div class="FormGroup InputWithButton">
                <input type="text" class="InputForm" id="CharaRoleInfo" placeholder="役割" disabled>
                <button class="ButtonClass SecondaryButton ButtonSmall" id="CharaRoleInfoBtn"><i class="fas fa-edit"></i></button>
              </div>
              <input type="hidden" id="CharaRoleInfoHidden">
            </div>

            <!-- 所属情報タブ -->
            <div class="TabContent" id="TabAffiliation">
              <div class="FormRow">
                <div class="FormGroup">
                  <select class="SelectForm" id="CharaRace" ${
                    !CanEditFlg ? 'disabled' : ''
                  }>
                    <option value="">種族を選択</option>
                  </select>
                </div>
                <div class="FormGroup">
                  <select class="SelectForm" id="CharaOrganization" ${
                    !CanEditFlg ? 'disabled' : ''
                  }>
                    <option value="">組織を選択</option>
                  </select>
                </div>
              </div>
              <div class="FormRow">
                <div class="FormGroup">
                  <select class="SelectForm" id="CharaTeam" ${
                    !CanEditFlg ? 'disabled' : ''
                  }>
                    <option value="">チームを選択</option>
                  </select>
                </div>
                <div class="FormGroup">
                  <select class="SelectForm" id="CharaClass" ${
                    !CanEditFlg ? 'disabled' : ''
                  }>
                    <option value="">階級を選択</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- 詳細情報タブ -->
            <div class="TabContent" id="TabDetail">
              <div class="FormGroup InputWithButton">
                <input type="text" class="InputForm" id="CharaPersonality" placeholder="性格" disabled>
                <button class="ButtonClass SecondaryButton ButtonSmall" id="CharaPersonalityBtn"><i class="fas fa-edit"></i></button>
              </div>
              <input type="hidden" id="CharaPersonalityHidden">
              <div class="FormGroup InputWithButton">
                <input type="text" class="InputForm" id="CharaBiography" placeholder="生い立ち・経歴" disabled>
                <button class="ButtonClass SecondaryButton ButtonSmall" id="CharaBiographyBtn"><i class="fas fa-edit"></i></button>
              </div>
              <input type="hidden" id="CharaBiographyHidden">
            </div>

            <!-- 画像タブ -->
            <div class="TabContent" id="TabImage">
              <div class="ImageBox" id="CharaImageBox">
                <div class="ImageBoxPlaceholder">
                  <i class="fas fa-user"></i>
                  <div>クリックで画像選択</div>
                </div>
              </div>
              <input type="file" id="CharaImageInput" accept="image/*" style="display:none;">
              <input type="hidden" id="CharaImagePath">
            </div>
          </div>

          ${
            CanEditFlg
              ? `
          <div class="ButtonGroup">
            <button class="ButtonClass ClearButton" id="CharaClearButton"><i class="fas fa-sync"></i> クリア</button>
            <button class="ButtonClass SaveButton" id="CharaSaveButton"><i class="fas fa-save"></i> 保存</button>
            <button class="ButtonClass DeleteButton Hidden" id="CharaDeleteButton"><i class="fas fa-trash"></i> 削除</button>
          </div>
          `
              : ''
          }
          <div id="RecordCountArea" class="MarginTop20"></div>
          <div class="TableContainer" id="CharacterTableArea"></div>
          <div id="PaginationArea"></div>
        `

        SetupCharacterTabEvents()
        await LoadCharacterMasterData()
        SetupCharacterFormEvents(CanEditFlg)
        await LoadCharacterList()
      }

      function SetupCharacterTabEvents() {
        document.querySelectorAll('.TabButton').forEach((Btn) => {
          Btn.addEventListener('click', function () {
            document
              .querySelectorAll('.TabButton')
              .forEach((B) => B.classList.remove('Active'))
            document
              .querySelectorAll('.TabContent')
              .forEach((C) => C.classList.remove('Active'))
            this.classList.add('Active')
            const TabId = this.dataset.tab
            const TabMap = {
              basic: 'TabBasic',
              affiliation: 'TabAffiliation',
              detail: 'TabDetail',
              image: 'TabImage',
            }
            document.getElementById(TabMap[TabId]).classList.add('Active')
          })
        })
      }

      async function LoadCharacterMasterData() {
        try {
          const WorkId = sessionStorage.getItem('WorkId')
          const [OrgRes, TeamRes, RaceRes, ClassRes] = await Promise.all([
            CallApi(
              `/GetOrganizationList.php?WorkId=${encodeURIComponent(WorkId)}`,
              'GET',
            ),
            CallApi(
              `/GetTeamList.php?WorkId=${encodeURIComponent(WorkId)}`,
              'GET',
            ),
            CallApi(
              `/GetRaceList.php?WorkId=${encodeURIComponent(WorkId)}`,
              'GET',
            ),
            CallApi(
              `/GetClassList.php?WorkId=${encodeURIComponent(WorkId)}`,
              'GET',
            ),
          ])
          CharacterOrganizationList = OrgRes.Success ? OrgRes.Data || [] : []
          CharacterTeamList = TeamRes.Success ? TeamRes.Data || [] : []
          CharacterRaceList = RaceRes.Success ? RaceRes.Data || [] : []
          CharacterClassList = ClassRes.Success ? ClassRes.Data || [] : []
          PopulateCharacterSelects()
        } catch (Error) {
          console.error('マスタデータ取得エラー:', Error)
        }
      }

      function PopulateCharacterSelects() {
        const OrgSelect = document.getElementById('CharaOrganization')
        const TeamSelect = document.getElementById('CharaTeam')
        const RaceSelect = document.getElementById('CharaRace')
        const ClassSelect = document.getElementById('CharaClass')
        OrgSelect.innerHTML =
          '<option value="">組織を選択</option>' +
          CharacterOrganizationList.map(
            (I) => `<option value="${I.OrgId}">${I.OrgName}</option>`,
          ).join('')
        TeamSelect.innerHTML =
          '<option value="">チームを選択</option>' +
          CharacterTeamList.map(
            (I) => `<option value="${I.TeamId}">${I.TeamName}</option>`,
          ).join('')
        RaceSelect.innerHTML =
          '<option value="">種族を選択</option>' +
          CharacterRaceList.map(
            (I) => `<option value="${I.RaceId}">${I.RaceName}</option>`,
          ).join('')
        ClassSelect.innerHTML =
          '<option value="">階級を選択</option>' +
          CharacterClassList.map(
            (I) => `<option value="${I.ClassId}">${I.ClassName}</option>`,
          ).join('')
      }

      function SetupCharacterFormEvents(CanEditFlg) {
        if (CanEditFlg) {
          const DatePickerInstance = new DatePicker()
          document
            .getElementById('CharaBirthDateBtn')
            ?.addEventListener('click', () =>
              DatePickerInstance.OpenDialog('CharaBirthDate'),
            )
          document
            .getElementById('CharaClearButton')
            .addEventListener('click', ClearCharacterForm)
          document
            .getElementById('CharaSaveButton')
            .addEventListener('click', SaveCharacter)
          document
            .getElementById('CharaDeleteButton')
            .addEventListener('click', DeleteCharacter)
          document
            .getElementById('CharaImageBox')
            .addEventListener('click', () =>
              document.getElementById('CharaImageInput').click(),
            )
          document
            .getElementById('CharaImageInput')
            .addEventListener('change', HandleCharacterImageChange)
        }
        document
          .getElementById('CharaRoleInfoBtn')
          .addEventListener('click', async () => {
            const Result = await ShowInputAreaDialog(
              document.getElementById('CharaRoleInfoHidden').value,
              !CanEditFlg,
            )
            if (Result !== null && CanEditFlg) {
              document.getElementById('CharaRoleInfoHidden').value = Result
              document.getElementById('CharaRoleInfo').value = TruncateText(
                Result,
                30,
              )
            }
          })
        document
          .getElementById('CharaPersonalityBtn')
          .addEventListener('click', async () => {
            const Result = await ShowInputAreaDialog(
              document.getElementById('CharaPersonalityHidden').value,
              !CanEditFlg,
            )
            if (Result !== null && CanEditFlg) {
              document.getElementById('CharaPersonalityHidden').value = Result
              document.getElementById('CharaPersonality').value = TruncateText(
                Result,
                30,
              )
            }
          })
        document
          .getElementById('CharaBiographyBtn')
          .addEventListener('click', async () => {
            const Result = await ShowInputAreaDialog(
              document.getElementById('CharaBiographyHidden').value,
              !CanEditFlg,
            )
            if (Result !== null && CanEditFlg) {
              document.getElementById('CharaBiographyHidden').value = Result
              document.getElementById('CharaBiography').value = TruncateText(
                Result,
                30,
              )
            }
          })
      }

      function HandleCharacterImageChange(E) {
        const File = E.target.files[0]
        if (!File) return
        const Reader = new FileReader()
        Reader.onload = function (Ev) {
          const ImageBox = document.getElementById('CharaImageBox')
          ImageBox.innerHTML = `<img src="${Ev.target.result}" alt="キャラ画像">`
          ImageBox.addEventListener('click', async () => {
            const Deleted = await ShowImageDialog(Ev.target.result, CanEdit())
            if (Deleted) {
              ImageBox.innerHTML = `<div class="ImageBoxPlaceholder"><i class="fas fa-user"></i><div>クリックで画像選択</div></div>`
              document.getElementById('CharaImagePath').value = ''
              document.getElementById('CharaImageInput').value = ''
            }
          })
        }
        Reader.readAsDataURL(File)
      }

      async function LoadCharacterList() {
        try {
          const WorkId = sessionStorage.getItem('WorkId')
          const Response = await CallApi(
            `/GetCharacterList.php?WorkId=${encodeURIComponent(WorkId)}`,
            'GET',
          )
          if (Response.Success) {
            CharacterList = Response.Data || []
            RenderCharacterTable()
          } else {
            await ShowErrorDialog(
              Response.Message || 'キャラ一覧の取得に失敗しました',
            )
          }
        } catch (Error) {
          console.error(Error)
          await ShowErrorDialog('キャラ一覧の取得中にエラーが発生しました')
        }
      }

      function RenderCharacterTable() {
        const TableArea = document.getElementById('CharacterTableArea')
        const RecordCountArea = document.getElementById('RecordCountArea')
        const PaginationArea = document.getElementById('PaginationArea')
        RecordCountArea.innerHTML = ''
        RecordCountArea.appendChild(CreateRecordCount(CharacterList.length))
        const Table = document.createElement('table')
        Table.className = 'DataTable'
        const Thead = document.createElement('thead')
        Thead.innerHTML = `<tr><th>キャラ名</th><th>性別</th><th>年齢</th><th>種族</th><th>組織</th><th>登録日</th></tr>`
        Table.appendChild(Thead)
        const Tbody = document.createElement('tbody')
        const StartIndex = (CurrentPage - 1) * RECORDS_PER_PAGE
        const EndIndex = Math.min(
          StartIndex + RECORDS_PER_PAGE,
          CharacterList.length,
        )
        const PageData = CharacterList.slice(StartIndex, EndIndex)
        if (PageData.length === 0) {
          Tbody.innerHTML =
            '<tr><td colspan="6" style="text-align:center;color:#999;">データがありません</td></tr>'
        } else {
          PageData.forEach((Item, Idx) => {
            const Row = document.createElement('tr')
            Row.style.cursor = 'pointer'
            Row.innerHTML = `<td title="${Item.CharaName}">${TruncateText(
              Item.CharaName,
              15,
            )}</td><td>${GetKeyInfo('Gender', Item.Gender)}</td><td>${
              Item.Age || '-'
            }</td><td>${Item.RaceName || '-'}</td><td>${
              Item.OrgName || '-'
            }</td><td>${FormatTimestamp(Item.RegistDate)}</td>`
            Row.addEventListener('dblclick', () =>
              SelectCharacter(StartIndex + Idx),
            )
            Tbody.appendChild(Row)
          })
        }
        Table.appendChild(Tbody)
        TableArea.innerHTML = ''
        TableArea.appendChild(Table)
        PaginationArea.innerHTML = ''
        PaginationArea.appendChild(
          CreatePagination(CharacterList.length, CurrentPage, (Page) => {
            CurrentPage = Page
            RenderCharacterTable()
          }),
        )
      }

      function SelectCharacter(Index) {
        const Item = CharacterList[Index]
        SelectedCharacterId = Item.CharaId
        document.getElementById('CharaName').value = Item.CharaName || ''
        document.getElementById('CharaGender').value = Item.Gender || 0
        document.getElementById('CharaBirthDate').value = Item.BirthDate || ''
        document.getElementById('CharaAge').value = Item.Age || ''
        document.getElementById('CharaHeight').value = Item.Height || ''
        document.getElementById('CharaWeight').value = Item.Weight || ''
        document.getElementById('CharaBloodType').value = Item.BloodType || ''
        document.getElementById('CharaFirstPerson').value =
          Item.FirstPerson || ''
        document.getElementById('CharaSecondPerson').value =
          Item.SecondPerson || ''
        document.getElementById('CharaRoleInfo').value = TruncateText(
          Item.RoleInfo,
          30,
        )
        document.getElementById('CharaRoleInfoHidden').value =
          Item.RoleInfo || ''
        document.getElementById('CharaRace').value = Item.RaceId || ''
        document.getElementById('CharaOrganization').value = Item.OrgId || ''
        document.getElementById('CharaTeam').value = Item.TeamId || ''
        document.getElementById('CharaClass').value = Item.ClassId || ''
        document.getElementById('CharaPersonality').value = TruncateText(
          Item.Personality,
          30,
        )
        document.getElementById('CharaPersonalityHidden').value =
          Item.Personality || ''
        document.getElementById('CharaBiography').value = TruncateText(
          Item.Biography,
          30,
        )
        document.getElementById('CharaBiographyHidden').value =
          Item.Biography || ''
        if (Item.ImgPath) {
          const ImageBox = document.getElementById('CharaImageBox')
          ImageBox.innerHTML = `<img src="${Item.ImgPath}" alt="キャラ画像">`
          document.getElementById('CharaImagePath').value = Item.ImgPath
        }
        const DeleteBtn = document.getElementById('CharaDeleteButton')
        if (DeleteBtn) DeleteBtn.classList.remove('Hidden')
      }

      function ClearCharacterForm() {
        SelectedCharacterId = null
        document.getElementById('CharaName').value = ''
        document.getElementById('CharaGender').value = 0
        document.getElementById('CharaBirthDate').value = ''
        document.getElementById('CharaAge').value = ''
        document.getElementById('CharaHeight').value = ''
        document.getElementById('CharaWeight').value = ''
        document.getElementById('CharaBloodType').value = ''
        document.getElementById('CharaFirstPerson').value = ''
        document.getElementById('CharaSecondPerson').value = ''
        document.getElementById('CharaRoleInfo').value = ''
        document.getElementById('CharaRoleInfoHidden').value = ''
        document.getElementById('CharaRace').value = ''
        document.getElementById('CharaOrganization').value = ''
        document.getElementById('CharaTeam').value = ''
        document.getElementById('CharaClass').value = ''
        document.getElementById('CharaPersonality').value = ''
        document.getElementById('CharaPersonalityHidden').value = ''
        document.getElementById('CharaBiography').value = ''
        document.getElementById('CharaBiographyHidden').value = ''
        document.getElementById(
          'CharaImageBox',
        ).innerHTML = `<div class="ImageBoxPlaceholder"><i class="fas fa-user"></i><div>クリックで画像選択</div></div>`
        document.getElementById('CharaImagePath').value = ''
        document.getElementById('CharaImageInput').value = ''
        const DeleteBtn = document.getElementById('CharaDeleteButton')
        if (DeleteBtn) DeleteBtn.classList.add('Hidden')
      }

      async function SaveCharacter() {
        const CharaName = document.getElementById('CharaName').value.trim()
        if (!CharaName) {
          await ShowErrorDialog('キャラ名を入力してください')
          return
        }
        try {
          const FormData = new window.FormData()
          FormData.append('CharaId', SelectedCharacterId || '')
          FormData.append('WorkId', sessionStorage.getItem('WorkId'))
          FormData.append('CharaName', CharaName)
          FormData.append(
            'Gender',
            document.getElementById('CharaGender').value,
          )
          FormData.append(
            'BirthDate',
            document.getElementById('CharaBirthDate').value,
          )
          FormData.append('Age', document.getElementById('CharaAge').value)
          FormData.append(
            'Height',
            document.getElementById('CharaHeight').value,
          )
          FormData.append(
            'Weight',
            document.getElementById('CharaWeight').value,
          )
          FormData.append(
            'BloodType',
            document.getElementById('CharaBloodType').value,
          )
          FormData.append(
            'FirstPerson',
            document.getElementById('CharaFirstPerson').value,
          )
          FormData.append(
            'SecondPerson',
            document.getElementById('CharaSecondPerson').value,
          )
          FormData.append(
            'RoleInfo',
            document.getElementById('CharaRoleInfoHidden').value,
          )
          FormData.append('RaceId', document.getElementById('CharaRace').value)
          FormData.append(
            'OrgId',
            document.getElementById('CharaOrganization').value,
          )
          FormData.append('TeamId', document.getElementById('CharaTeam').value)
          FormData.append(
            'ClassId',
            document.getElementById('CharaClass').value,
          )
          FormData.append(
            'Personality',
            document.getElementById('CharaPersonalityHidden').value,
          )
          FormData.append(
            'Biography',
            document.getElementById('CharaBiographyHidden').value,
          )
          FormData.append('UserId', sessionStorage.getItem('UserId'))
          const ImageInput = document.getElementById('CharaImageInput')
          if (ImageInput.files[0]) FormData.append('Image', ImageInput.files[0])
          ShowSpinner()
          const Response = await fetch(`${API_BASE_URL}/SaveCharacter.php`, {
            method: 'POST',
            body: FormData,
          })
          const Result = await Response.json()
          HideSpinner()
          if (Result.Success) {
            await ShowInfoDialog('保存完了', 'キャラ情報を保存しました')
            ClearCharacterForm()
            await LoadCharacterList()
          } else {
            await ShowErrorDialog(Result.Message || '保存に失敗しました')
          }
        } catch (Error) {
          HideSpinner()
          await ShowErrorDialog('保存中にエラーが発生しました')
        }
      }

      async function DeleteCharacter() {
        if (!SelectedCharacterId) return
        if (!(await ShowConfirmDialog('このキャラを削除しますか？'))) return
        try {
          const Response = await CallApi('/DeleteCharacter.php', 'POST', {
            CharaId: SelectedCharacterId,
            UserId: sessionStorage.getItem('UserId'),
          })
          if (Response.Success) {
            await ShowInfoDialog('削除完了', 'キャラを削除しました')
            ClearCharacterForm()
            await LoadCharacterList()
          } else {
            await ShowErrorDialog(Response.Message || '削除に失敗しました')
          }
        } catch (Error) {
          await ShowErrorDialog('削除中にエラーが発生しました')
        }
      }

      /* ==========================================================================
       * 組織設定画面 (3.5 OrganizationInfo)
       * ========================================================================== */
      let OrganizationList = []
      let BuildListForOrg = []
      let SelectedOrgId = null

      async function ShowOrganizationSetting() {
        CurrentPage = 1
        SelectedOrgId = null
        const ContentArea = document.getElementById('ContentArea')
        const CanEditFlg = CanEdit()

        ContentArea.innerHTML = `
          ${CreateContentHeader('組織設定', 'building')}
          <div class="FormRow">
            <div class="FormGroup Flex1">
              <input type="text" class="InputForm" id="OrgName" placeholder="組織名" maxlength="255" ${
                !CanEditFlg ? 'disabled' : ''
              }>
            </div>
            <div class="FormGroup Flex1">
              <select class="SelectForm" id="OrgBaseBuild" ${
                !CanEditFlg ? 'disabled' : ''
              }>
                <option value="">拠点建物を選択</option>
              </select>
            </div>
          </div>
          <div class="FormRow">
            <div class="FormGroup Flex1 InputWithButton">
              <input type="text" class="InputForm" id="OrgFoundedDate" placeholder="設立日" readonly ${
                !CanEditFlg ? 'disabled' : ''
              }>
              ${
                CanEditFlg
                  ? `<button class="ButtonClass SecondaryButton ButtonSmall" id="OrgFoundedDateBtn"><i class="fas fa-calendar"></i></button>`
                  : ''
              }
            </div>
            <div class="FormGroup Flex1">
              <input type="text" class="InputForm" id="OrgPeopleNum" placeholder="人数" maxlength="50" ${
                !CanEditFlg ? 'disabled' : ''
              }>
            </div>
          </div>
          <div class="FormGroup InputWithButton">
            <input type="text" class="InputForm" id="OrgPurpose" placeholder="目的" disabled>
            <button class="ButtonClass SecondaryButton ButtonSmall" id="OrgPurposeBtn"><i class="fas fa-edit"></i></button>
          </div>
          <input type="hidden" id="OrgPurposeHidden">
          <div class="FormGroup InputWithButton">
            <input type="text" class="InputForm" id="OrgActivity" placeholder="活動内容" disabled>
            <button class="ButtonClass SecondaryButton ButtonSmall" id="OrgActivityBtn"><i class="fas fa-edit"></i></button>
          </div>
          <input type="hidden" id="OrgActivityHidden">
          ${
            CanEditFlg
              ? `
          <div class="FormGroup">
            <div class="ImageUploadArea" id="OrgImageArea">
              <div class="ImageBox" id="OrgImageBox">
                <span class="ImagePlaceholder"><i class="fas fa-image"></i> 画像を選択</span>
              </div>
              <input type="file" id="OrgImageInput" accept="image/*" style="display:none;">
            </div>
          </div>
          <div class="ButtonGroup">
            <button class="ButtonClass ClearButton" id="OrgClearButton"><i class="fas fa-sync"></i> クリア</button>
            <button class="ButtonClass SaveButton" id="OrgSaveButton"><i class="fas fa-save"></i> 保存</button>
            <button class="ButtonClass DeleteButton Hidden" id="OrgDeleteButton"><i class="fas fa-trash"></i> 削除</button>
          </div>
          `
              : ''
          }
          <div id="RecordCountArea" class="MarginTop20"></div>
          <div class="TableContainer" id="OrgTableArea"></div>
          <div id="PaginationArea"></div>
        `

        if (CanEditFlg) {
          document
            .getElementById('OrgFoundedDateBtn')
            .addEventListener('click', async () => {
              const Picker = new DatePicker()
              await Picker.openDialog('OrgFoundedDate')
            })
          document
            .getElementById('OrgPurposeBtn')
            .addEventListener('click', () =>
              ShowInputAreaDialog('OrgPurpose', 'OrgPurposeHidden', CanEditFlg),
            )
          document
            .getElementById('OrgActivityBtn')
            .addEventListener('click', () =>
              ShowInputAreaDialog(
                'OrgActivity',
                'OrgActivityHidden',
                CanEditFlg,
              ),
            )
          document
            .getElementById('OrgImageBox')
            .addEventListener('click', () =>
              document.getElementById('OrgImageInput').click(),
            )
          document
            .getElementById('OrgImageInput')
            .addEventListener('change', (E) => PreviewImage(E, 'OrgImageBox'))
          document
            .getElementById('OrgClearButton')
            .addEventListener('click', ClearOrgForm)
          document
            .getElementById('OrgSaveButton')
            .addEventListener('click', SaveOrganization)
          document
            .getElementById('OrgDeleteButton')
            .addEventListener('click', DeleteOrganization)
        } else {
          document
            .getElementById('OrgPurposeBtn')
            .addEventListener('click', () =>
              ShowInputAreaDialog('OrgPurpose', 'OrgPurposeHidden', false),
            )
          document
            .getElementById('OrgActivityBtn')
            .addEventListener('click', () =>
              ShowInputAreaDialog('OrgActivity', 'OrgActivityHidden', false),
            )
        }

        await LoadOrganizationList()
      }

      async function LoadOrganizationList() {
        try {
          const WorkId = sessionStorage.getItem('WorkId')
          const Response = await CallApi(
            `/GetOrganizationList.php?WorkId=${encodeURIComponent(
              WorkId,
            )}&UserId=${encodeURIComponent(sessionStorage.getItem('UserId'))}`,
            'GET',
          )
          if (Response.Success) {
            OrganizationList = Response.Data.OrganizationList || []
            BuildListForOrg = Response.Data.BuildList || []
            UpdateBuildSelect()
            RenderOrganizationTable()
          } else {
            await ShowErrorDialog(
              Response.Message || '組織一覧の取得に失敗しました',
            )
          }
        } catch (Error) {
          console.error(Error)
          await ShowErrorDialog('組織一覧の取得中にエラーが発生しました')
        }
      }

      function UpdateBuildSelect() {
        const Select = document.getElementById('OrgBaseBuild')
        if (!Select) return
        Select.innerHTML =
          '<option value="">拠点建物を選択</option>' +
          BuildListForOrg.map(
            (B) => `<option value="${B.BuildId}">${B.BuildName}</option>`,
          ).join('')
      }

      function RenderOrganizationTable() {
        const TotalCount = OrganizationList.length
        document.getElementById(
          'RecordCountArea',
        ).innerHTML = `<span class="RecordCount">${TotalCount} 件</span>`
        const Start = (CurrentPage - 1) * RECORDS_PER_PAGE
        const End = Math.min(Start + RECORDS_PER_PAGE, TotalCount)
        const PageData = OrganizationList.slice(Start, End)
        let TableHtml = `
          <table class="DataTable">
            <thead><tr><th>組織名</th><th>拠点</th><th>人数</th><th>設立日</th></tr></thead>
            <tbody>
        `
        if (PageData.length) {
          TableHtml += PageData.map(
            (O) => `
              <tr data-id="${O.OrgId}">
                <td>${EscapeHtml(O.OrgName)}</td>
                <td>${EscapeHtml(O.BuildName || '')}</td>
                <td>${EscapeHtml(O.PeopleNum || '')}</td>
                <td>${FormatDisplayDate(O.FoundedDate)}</td>
              </tr>
            `,
          ).join('')
        } else {
          TableHtml +=
            '<tr><td colspan="4" class="NoData">データがありません</td></tr>'
        }
        TableHtml += '</tbody></table>'
        document.getElementById('OrgTableArea').innerHTML = TableHtml
        document
          .querySelectorAll('#OrgTableArea tbody tr[data-id]')
          .forEach((Row) => {
            Row.addEventListener('dblclick', () =>
              SelectOrganization(Row.dataset.id),
            )
          })
        const PaginationArea = document.getElementById('PaginationArea')
        PaginationArea.innerHTML = ''
        PaginationArea.appendChild(
          CreatePagination(TotalCount, CurrentPage, (Page) => {
            CurrentPage = Page
            RenderOrganizationTable()
          }),
        )
      }

      function SelectOrganization(OrgId) {
        const Item = OrganizationList.find((O) => O.OrgId == OrgId)
        if (!Item) return
        SelectedOrgId = OrgId
        document.getElementById('OrgName').value = Item.OrgName || ''
        document.getElementById('OrgBaseBuild').value = Item.BaseBuildId || ''
        document.getElementById('OrgFoundedDate').value = Item.FoundedDate || ''
        document.getElementById('OrgPeopleNum').value = Item.PeopleNum || ''
        document.getElementById('OrgPurpose').value = TruncateText(
          Item.Purpose || '',
          30,
        )
        document.getElementById('OrgPurposeHidden').value = Item.Purpose || ''
        document.getElementById('OrgActivity').value = TruncateText(
          Item.Activity || '',
          30,
        )
        document.getElementById('OrgActivityHidden').value = Item.Activity || ''
        if (Item.ImgPath) {
          document.getElementById(
            'OrgImageBox',
          ).innerHTML = `<img src="${API_BASE_URL}${Item.ImgPath}" alt="組織画像">`
        }
        const DeleteBtn = document.getElementById('OrgDeleteButton')
        if (DeleteBtn) DeleteBtn.classList.remove('Hidden')
      }

      function ClearOrgForm() {
        SelectedOrgId = null
        document.getElementById('OrgName').value = ''
        document.getElementById('OrgBaseBuild').value = ''
        document.getElementById('OrgFoundedDate').value = ''
        document.getElementById('OrgPeopleNum').value = ''
        document.getElementById('OrgPurpose').value = ''
        document.getElementById('OrgPurposeHidden').value = ''
        document.getElementById('OrgActivity').value = ''
        document.getElementById('OrgActivityHidden').value = ''
        document.getElementById('OrgImageBox').innerHTML =
          '<span class="ImagePlaceholder"><i class="fas fa-image"></i> 画像を選択</span>'
        document.getElementById('OrgImageInput').value = ''
        const DeleteBtn = document.getElementById('OrgDeleteButton')
        if (DeleteBtn) DeleteBtn.classList.add('Hidden')
      }

      async function SaveOrganization() {
        const OrgName = document.getElementById('OrgName').value.trim()
        if (!OrgName) {
          await ShowErrorDialog('組織名を入力してください')
          return
        }
        try {
          ShowSpinner()
          const FormData = new window.FormData()
          if (SelectedOrgId) FormData.append('OrgId', SelectedOrgId)
          FormData.append('WorkId', sessionStorage.getItem('WorkId'))
          FormData.append('OrgName', OrgName)
          FormData.append(
            'FoundedDate',
            document.getElementById('OrgFoundedDate').value,
          )
          FormData.append(
            'PeopleNum',
            document.getElementById('OrgPeopleNum').value,
          )
          FormData.append(
            'Purpose',
            document.getElementById('OrgPurposeHidden').value,
          )
          FormData.append(
            'Activity',
            document.getElementById('OrgActivityHidden').value,
          )
          FormData.append(
            'BaseBuildId',
            document.getElementById('OrgBaseBuild').value,
          )
          FormData.append('UserId', sessionStorage.getItem('UserId'))
          const ImageFile = document.getElementById('OrgImageInput').files[0]
          if (ImageFile) FormData.append('Image', ImageFile)
          const Response = await fetch(`${API_BASE_URL}/SaveOrganization.php`, {
            method: 'POST',
            body: FormData,
          })
          const Result = await Response.json()
          HideSpinner()
          if (Result.Success) {
            await ShowInfoDialog('保存完了', Result.Data.Message)
            ClearOrgForm()
            await LoadOrganizationList()
          } else {
            await ShowErrorDialog(Result.Message || '保存に失敗しました')
          }
        } catch (Error) {
          HideSpinner()
          await ShowErrorDialog('保存中にエラーが発生しました')
        }
      }

      async function DeleteOrganization() {
        if (!SelectedOrgId) return
        if (!(await ShowConfirmDialog('この組織を削除しますか？'))) return
        try {
          const Response = await CallApi('/DeleteOrganization.php', 'POST', {
            OrgId: SelectedOrgId,
            WorkId: sessionStorage.getItem('WorkId'),
            UserId: sessionStorage.getItem('UserId'),
          })
          if (Response.Success) {
            await ShowInfoDialog('削除完了', '組織を削除しました')
            ClearOrgForm()
            await LoadOrganizationList()
          } else {
            await ShowErrorDialog(Response.Message || '削除に失敗しました')
          }
        } catch (Error) {
          await ShowErrorDialog('削除中にエラーが発生しました')
        }
      }

      /* ==========================================================================
       * チーム設定画面 (3.7 TeamInfo)
       * ========================================================================== */
      let TeamList = []
      let OrgListForTeam = []
      let SelectedTeamId = null

      async function ShowTeamSetting() {
        CurrentPage = 1
        SelectedTeamId = null
        const ContentArea = document.getElementById('ContentArea')
        const CanEditFlg = CanEdit()

        ContentArea.innerHTML = `
          ${CreateContentHeader('チーム設定', 'users')}
          <div class="FormRow">
            <div class="FormGroup Flex1">
              <input type="text" class="InputForm" id="TeamName" placeholder="チーム名" maxlength="150" ${
                !CanEditFlg ? 'disabled' : ''
              }>
            </div>
            <div class="FormGroup Flex1">
              <select class="SelectForm" id="TeamOrgId" ${
                !CanEditFlg ? 'disabled' : ''
              }>
                <option value="">所属組織を選択</option>
              </select>
            </div>
          </div>
          <div class="FormGroup InputWithButton">
            <input type="text" class="InputForm" id="TeamDescription" placeholder="説明" disabled>
            <button class="ButtonClass SecondaryButton ButtonSmall" id="TeamDescriptionBtn"><i class="fas fa-edit"></i></button>
          </div>
          <input type="hidden" id="TeamDescriptionHidden">
          ${
            CanEditFlg
              ? `
          <div class="FormGroup">
            <div class="ImageUploadArea" id="TeamImageArea">
              <div class="ImageBox" id="TeamImageBox">
                <span class="ImagePlaceholder"><i class="fas fa-image"></i> 画像を選択</span>
              </div>
              <input type="file" id="TeamImageInput" accept="image/*" style="display:none;">
            </div>
          </div>
          <div class="ButtonGroup">
            <button class="ButtonClass ClearButton" id="TeamClearButton"><i class="fas fa-sync"></i> クリア</button>
            <button class="ButtonClass SaveButton" id="TeamSaveButton"><i class="fas fa-save"></i> 保存</button>
            <button class="ButtonClass DeleteButton Hidden" id="TeamDeleteButton"><i class="fas fa-trash"></i> 削除</button>
          </div>
          `
              : ''
          }
          <div id="RecordCountArea" class="MarginTop20"></div>
          <div class="TableContainer" id="TeamTableArea"></div>
          <div id="PaginationArea"></div>
        `

        if (CanEditFlg) {
          document
            .getElementById('TeamDescriptionBtn')
            .addEventListener('click', () =>
              ShowInputAreaDialog(
                'TeamDescription',
                'TeamDescriptionHidden',
                CanEditFlg,
              ),
            )
          document
            .getElementById('TeamImageBox')
            .addEventListener('click', () =>
              document.getElementById('TeamImageInput').click(),
            )
          document
            .getElementById('TeamImageInput')
            .addEventListener('change', (E) => PreviewImage(E, 'TeamImageBox'))
          document
            .getElementById('TeamClearButton')
            .addEventListener('click', ClearTeamForm)
          document
            .getElementById('TeamSaveButton')
            .addEventListener('click', SaveTeam)
          document
            .getElementById('TeamDeleteButton')
            .addEventListener('click', DeleteTeam)
        } else {
          document
            .getElementById('TeamDescriptionBtn')
            .addEventListener('click', () =>
              ShowInputAreaDialog(
                'TeamDescription',
                'TeamDescriptionHidden',
                false,
              ),
            )
        }

        await LoadTeamList()
      }

      async function LoadTeamList() {
        try {
          const WorkId = sessionStorage.getItem('WorkId')
          const Response = await CallApi(
            `/GetTeamList.php?WorkId=${encodeURIComponent(
              WorkId,
            )}&UserId=${encodeURIComponent(sessionStorage.getItem('UserId'))}`,
            'GET',
          )
          if (Response.Success) {
            TeamList = Response.Data.TeamList || []
            OrgListForTeam = Response.Data.OrganizationList || []
            UpdateTeamOrgSelect()
            RenderTeamTable()
          } else {
            await ShowErrorDialog(
              Response.Message || 'チーム一覧の取得に失敗しました',
            )
          }
        } catch (Error) {
          console.error(Error)
          await ShowErrorDialog('チーム一覧の取得中にエラーが発生しました')
        }
      }

      function UpdateTeamOrgSelect() {
        const Select = document.getElementById('TeamOrgId')
        if (!Select) return
        Select.innerHTML =
          '<option value="">所属組織を選択</option>' +
          OrgListForTeam.map(
            (O) => `<option value="${O.OrgId}">${O.OrgName}</option>`,
          ).join('')
      }

      function RenderTeamTable() {
        const TotalCount = TeamList.length
        document.getElementById(
          'RecordCountArea',
        ).innerHTML = `<span class="RecordCount">${TotalCount} 件</span>`
        const Start = (CurrentPage - 1) * RECORDS_PER_PAGE
        const End = Math.min(Start + RECORDS_PER_PAGE, TotalCount)
        const PageData = TeamList.slice(Start, End)
        let TableHtml = `
          <table class="DataTable">
            <thead><tr><th>チーム名</th><th>所属組織</th><th>説明</th></tr></thead>
            <tbody>
        `
        if (PageData.length) {
          TableHtml += PageData.map(
            (T) => `
              <tr data-id="${T.TeamId}">
                <td>${EscapeHtml(T.TeamName)}</td>
                <td>${EscapeHtml(T.OrgName || '')}</td>
                <td>${EscapeHtml(TruncateText(T.Description || '', 30))}</td>
              </tr>
            `,
          ).join('')
        } else {
          TableHtml +=
            '<tr><td colspan="3" class="NoData">データがありません</td></tr>'
        }
        TableHtml += '</tbody></table>'
        document.getElementById('TeamTableArea').innerHTML = TableHtml
        document
          .querySelectorAll('#TeamTableArea tbody tr[data-id]')
          .forEach((Row) => {
            Row.addEventListener('dblclick', () => SelectTeam(Row.dataset.id))
          })
        const PaginationArea = document.getElementById('PaginationArea')
        PaginationArea.innerHTML = ''
        PaginationArea.appendChild(
          CreatePagination(TotalCount, CurrentPage, (Page) => {
            CurrentPage = Page
            RenderTeamTable()
          }),
        )
      }

      function SelectTeam(TeamId) {
        const Item = TeamList.find((T) => T.TeamId == TeamId)
        if (!Item) return
        SelectedTeamId = TeamId
        document.getElementById('TeamName').value = Item.TeamName || ''
        document.getElementById('TeamOrgId').value = Item.OrgId || ''
        document.getElementById('TeamDescription').value = TruncateText(
          Item.Description || '',
          30,
        )
        document.getElementById('TeamDescriptionHidden').value =
          Item.Description || ''
        if (Item.ImgPath) {
          document.getElementById(
            'TeamImageBox',
          ).innerHTML = `<img src="${API_BASE_URL}${Item.ImgPath}" alt="チーム画像">`
        }
        const DeleteBtn = document.getElementById('TeamDeleteButton')
        if (DeleteBtn) DeleteBtn.classList.remove('Hidden')
      }

      function ClearTeamForm() {
        SelectedTeamId = null
        document.getElementById('TeamName').value = ''
        document.getElementById('TeamOrgId').value = ''
        document.getElementById('TeamDescription').value = ''
        document.getElementById('TeamDescriptionHidden').value = ''
        document.getElementById('TeamImageBox').innerHTML =
          '<span class="ImagePlaceholder"><i class="fas fa-image"></i> 画像を選択</span>'
        document.getElementById('TeamImageInput').value = ''
        const DeleteBtn = document.getElementById('TeamDeleteButton')
        if (DeleteBtn) DeleteBtn.classList.add('Hidden')
      }

      async function SaveTeam() {
        const TeamName = document.getElementById('TeamName').value.trim()
        if (!TeamName) {
          await ShowErrorDialog('チーム名を入力してください')
          return
        }
        try {
          ShowSpinner()
          const FormData = new window.FormData()
          if (SelectedTeamId) FormData.append('TeamId', SelectedTeamId)
          FormData.append('WorkId', sessionStorage.getItem('WorkId'))
          FormData.append('TeamName', TeamName)
          FormData.append('OrgId', document.getElementById('TeamOrgId').value)
          FormData.append(
            'Description',
            document.getElementById('TeamDescriptionHidden').value,
          )
          FormData.append('UserId', sessionStorage.getItem('UserId'))
          const ImageFile = document.getElementById('TeamImageInput').files[0]
          if (ImageFile) FormData.append('Image', ImageFile)
          const Response = await fetch(`${API_BASE_URL}/SaveTeam.php`, {
            method: 'POST',
            body: FormData,
          })
          const Result = await Response.json()
          HideSpinner()
          if (Result.Success) {
            await ShowInfoDialog('保存完了', Result.Data.Message)
            ClearTeamForm()
            await LoadTeamList()
          } else {
            await ShowErrorDialog(Result.Message || '保存に失敗しました')
          }
        } catch (Error) {
          HideSpinner()
          await ShowErrorDialog('保存中にエラーが発生しました')
        }
      }

      async function DeleteTeam() {
        if (!SelectedTeamId) return
        if (!(await ShowConfirmDialog('このチームを削除しますか？'))) return
        try {
          const Response = await CallApi('/DeleteTeam.php', 'POST', {
            TeamId: SelectedTeamId,
            WorkId: sessionStorage.getItem('WorkId'),
            UserId: sessionStorage.getItem('UserId'),
          })
          if (Response.Success) {
            await ShowInfoDialog('削除完了', 'チームを削除しました')
            ClearTeamForm()
            await LoadTeamList()
          } else {
            await ShowErrorDialog(Response.Message || '削除に失敗しました')
          }
        } catch (Error) {
          await ShowErrorDialog('削除中にエラーが発生しました')
        }
      }

      function ShowRaceSetting() {
        ShowPlaceholder('種族設定', 'dna')
      }

      /* ==========================================================================
       * 階級設定画面 (3.6 ClassInfo)
       * ========================================================================== */
      let ClassList = []
      let OrgListForClass = []
      let SelectedClassId = null

      async function ShowClassSetting() {
        CurrentPage = 1
        SelectedClassId = null
        const ContentArea = document.getElementById('ContentArea')
        const CanEditFlg = CanEdit()

        ContentArea.innerHTML = `
          ${CreateContentHeader('階級設定', 'medal')}
          <div class="FormRow">
            <div class="FormGroup Flex1">
              <input type="text" class="InputForm" id="ClassName" placeholder="階級名" maxlength="150" ${
                !CanEditFlg ? 'disabled' : ''
              }>
            </div>
            <div class="FormGroup Flex1">
              <select class="SelectForm" id="ClassOrgId" ${
                !CanEditFlg ? 'disabled' : ''
              }>
                <option value="">組織を選択（共通階級の場合は未選択）</option>
              </select>
            </div>
          </div>
          <div class="FormRow">
            <div class="FormGroup Flex1">
              <input type="number" class="InputForm" id="ClassRankOrder" placeholder="序列（数字が小さいほど上位）" min="0" ${
                !CanEditFlg ? 'disabled' : ''
              }>
            </div>
          </div>
          <div class="FormGroup InputWithButton">
            <input type="text" class="InputForm" id="ClassDescription" placeholder="説明" disabled>
            <button class="ButtonClass SecondaryButton ButtonSmall" id="ClassDescriptionBtn"><i class="fas fa-edit"></i></button>
          </div>
          <input type="hidden" id="ClassDescriptionHidden">
          ${
            CanEditFlg
              ? `
          <div class="ButtonGroup">
            <button class="ButtonClass ClearButton" id="ClassClearButton"><i class="fas fa-sync"></i> クリア</button>
            <button class="ButtonClass SaveButton" id="ClassSaveButton"><i class="fas fa-save"></i> 保存</button>
            <button class="ButtonClass DeleteButton Hidden" id="ClassDeleteButton"><i class="fas fa-trash"></i> 削除</button>
          </div>
          `
              : ''
          }
          <div id="RecordCountArea" class="MarginTop20"></div>
          <div class="TableContainer" id="ClassTableArea"></div>
          <div id="PaginationArea"></div>
        `

        if (CanEditFlg) {
          document
            .getElementById('ClassDescriptionBtn')
            .addEventListener('click', () =>
              ShowInputAreaDialog(
                'ClassDescription',
                'ClassDescriptionHidden',
                CanEditFlg,
              ),
            )
          document
            .getElementById('ClassClearButton')
            .addEventListener('click', ClearClassForm)
          document
            .getElementById('ClassSaveButton')
            .addEventListener('click', SaveClass)
          document
            .getElementById('ClassDeleteButton')
            .addEventListener('click', DeleteClass)
        } else {
          document
            .getElementById('ClassDescriptionBtn')
            .addEventListener('click', () =>
              ShowInputAreaDialog(
                'ClassDescription',
                'ClassDescriptionHidden',
                false,
              ),
            )
        }

        await LoadClassList()
      }

      async function LoadClassList() {
        try {
          const WorkId = sessionStorage.getItem('WorkId')
          const Response = await CallApi(
            `/GetClassList.php?WorkId=${encodeURIComponent(
              WorkId,
            )}&UserId=${encodeURIComponent(sessionStorage.getItem('UserId'))}`,
            'GET',
          )
          if (Response.Success) {
            ClassList = Response.Data.ClassList || []
            OrgListForClass = Response.Data.OrganizationList || []
            UpdateClassOrgSelect()
            RenderClassTable()
          } else {
            await ShowErrorDialog(
              Response.Message || '階級一覧の取得に失敗しました',
            )
          }
        } catch (Error) {
          console.error(Error)
          await ShowErrorDialog('階級一覧の取得中にエラーが発生しました')
        }
      }

      function UpdateClassOrgSelect() {
        const Select = document.getElementById('ClassOrgId')
        if (!Select) return
        Select.innerHTML =
          '<option value="">組織を選択（共通階級の場合は未選択）</option>' +
          OrgListForClass.map(
            (O) => `<option value="${O.OrgId}">${O.OrgName}</option>`,
          ).join('')
      }

      function RenderClassTable() {
        const TotalCount = ClassList.length
        document.getElementById(
          'RecordCountArea',
        ).innerHTML = `<span class="RecordCount">${TotalCount} 件</span>`
        const Start = (CurrentPage - 1) * RECORDS_PER_PAGE
        const End = Math.min(Start + RECORDS_PER_PAGE, TotalCount)
        const PageData = ClassList.slice(Start, End)
        let TableHtml = `
          <table class="DataTable">
            <thead><tr><th>階級名</th><th>所属組織</th><th>序列</th><th>説明</th></tr></thead>
            <tbody>
        `
        if (PageData.length) {
          TableHtml += PageData.map(
            (C) => `
              <tr data-id="${C.ClassId}">
                <td>${EscapeHtml(C.ClassName)}</td>
                <td>${EscapeHtml(C.OrgName || '共通')}</td>
                <td>${C.RankOrder !== null ? C.RankOrder : ''}</td>
                <td>${EscapeHtml(TruncateText(C.Description || '', 30))}</td>
              </tr>
            `,
          ).join('')
        } else {
          TableHtml +=
            '<tr><td colspan="4" class="NoData">データがありません</td></tr>'
        }
        TableHtml += '</tbody></table>'
        document.getElementById('ClassTableArea').innerHTML = TableHtml
        document
          .querySelectorAll('#ClassTableArea tbody tr[data-id]')
          .forEach((Row) => {
            Row.addEventListener('dblclick', () => SelectClass(Row.dataset.id))
          })
        const PaginationArea = document.getElementById('PaginationArea')
        PaginationArea.innerHTML = ''
        PaginationArea.appendChild(
          CreatePagination(TotalCount, CurrentPage, (Page) => {
            CurrentPage = Page
            RenderClassTable()
          }),
        )
      }

      function SelectClass(ClassId) {
        const Item = ClassList.find((C) => C.ClassId == ClassId)
        if (!Item) return
        SelectedClassId = ClassId
        document.getElementById('ClassName').value = Item.ClassName || ''
        document.getElementById('ClassOrgId').value = Item.OrgId || ''
        document.getElementById('ClassRankOrder').value =
          Item.RankOrder !== null ? Item.RankOrder : ''
        document.getElementById('ClassDescription').value = TruncateText(
          Item.Description || '',
          30,
        )
        document.getElementById('ClassDescriptionHidden').value =
          Item.Description || ''
        const DeleteBtn = document.getElementById('ClassDeleteButton')
        if (DeleteBtn) DeleteBtn.classList.remove('Hidden')
      }

      function ClearClassForm() {
        SelectedClassId = null
        document.getElementById('ClassName').value = ''
        document.getElementById('ClassOrgId').value = ''
        document.getElementById('ClassRankOrder').value = ''
        document.getElementById('ClassDescription').value = ''
        document.getElementById('ClassDescriptionHidden').value = ''
        const DeleteBtn = document.getElementById('ClassDeleteButton')
        if (DeleteBtn) DeleteBtn.classList.add('Hidden')
      }

      async function SaveClass() {
        const ClassName = document.getElementById('ClassName').value.trim()
        if (!ClassName) {
          await ShowErrorDialog('階級名を入力してください')
          return
        }
        try {
          const RankOrderVal = document.getElementById('ClassRankOrder').value
          const Response = await CallApi('/SaveClass.php', 'POST', {
            ClassId: SelectedClassId,
            WorkId: sessionStorage.getItem('WorkId'),
            OrgId: document.getElementById('ClassOrgId').value || null,
            ClassName: ClassName,
            RankOrder: RankOrderVal !== '' ? parseInt(RankOrderVal) : null,
            Description: document.getElementById('ClassDescriptionHidden')
              .value,
            UserId: sessionStorage.getItem('UserId'),
          })
          if (Response.Success) {
            await ShowInfoDialog('保存完了', Response.Data.Message)
            ClearClassForm()
            await LoadClassList()
          } else {
            await ShowErrorDialog(Response.Message || '保存に失敗しました')
          }
        } catch (Error) {
          await ShowErrorDialog('保存中にエラーが発生しました')
        }
      }

      async function DeleteClass() {
        if (!SelectedClassId) return
        if (!(await ShowConfirmDialog('この階級を削除しますか？'))) return
        try {
          const Response = await CallApi('/DeleteClass.php', 'POST', {
            ClassId: SelectedClassId,
            WorkId: sessionStorage.getItem('WorkId'),
            UserId: sessionStorage.getItem('UserId'),
          })
          if (Response.Success) {
            await ShowInfoDialog('削除完了', '階級を削除しました')
            ClearClassForm()
            await LoadClassList()
          } else {
            await ShowErrorDialog(Response.Message || '削除に失敗しました')
          }
        } catch (Error) {
          await ShowErrorDialog('削除中にエラーが発生しました')
        }
      }

      function ShowCalendarSetting() {
        ShowPlaceholder('元号設定', 'calendar-alt')
      }

      /* ==========================================================================
       * 更新履歴一覧画面 (2.3 UpdateHistory)
       * ========================================================================== */
      let UpdateHistoryList = []

      async function ShowUpdateHistory() {
        CurrentPage = 1
        const ContentArea = document.getElementById('ContentArea')

        ContentArea.innerHTML = `
          ${CreateContentHeader('更新履歴', 'history')}
          <div id="RecordCountArea" class="MarginTop20"></div>
          <div class="TableContainer" id="HistoryTableArea"></div>
          <div id="PaginationArea"></div>
        `

        await LoadUpdateHistoryList()
      }

      async function LoadUpdateHistoryList() {
        try {
          const WorkId = sessionStorage.getItem('WorkId')
          const Response = await CallApi(
            `/GetUpdateHistoryList.php?WorkId=${encodeURIComponent(
              WorkId,
            )}&UserId=${encodeURIComponent(sessionStorage.getItem('UserId'))}`,
            'GET',
          )
          if (Response.Success) {
            UpdateHistoryList = Response.Data.HistoryList || []
            RenderUpdateHistoryTable()
          } else {
            await ShowErrorDialog(
              Response.Message || '更新履歴の取得に失敗しました',
            )
          }
        } catch (Error) {
          console.error(Error)
          await ShowErrorDialog('更新履歴の取得中にエラーが発生しました')
        }
      }

      function RenderUpdateHistoryTable() {
        const TotalCount = UpdateHistoryList.length
        document.getElementById(
          'RecordCountArea',
        ).innerHTML = `<span class="RecordCount">${TotalCount} 件</span>`
        const Start = (CurrentPage - 1) * RECORDS_PER_PAGE
        const End = Math.min(Start + RECORDS_PER_PAGE, TotalCount)
        const PageData = UpdateHistoryList.slice(Start, End)
        let TableHtml = `
          <table class="DataTable">
            <thead><tr><th>更新日時</th><th>機能名</th><th>操作</th><th>更新者</th></tr></thead>
            <tbody>
        `
        if (PageData.length) {
          TableHtml += PageData.map(
            (H) => `
              <tr>
                <td>${FormatDisplayDateTime(H.RegistDate)}</td>
                <td>${EscapeHtml(H.FunctionName || '')}</td>
                <td>${EscapeHtml(H.Operation || '')}</td>
                <td>${EscapeHtml(H.RegistUser || '')}</td>
              </tr>
            `,
          ).join('')
        } else {
          TableHtml +=
            '<tr><td colspan="4" class="NoData">データがありません</td></tr>'
        }
        TableHtml += '</tbody></table>'
        document.getElementById('HistoryTableArea').innerHTML = TableHtml
        const PaginationArea = document.getElementById('PaginationArea')
        PaginationArea.innerHTML = ''
        PaginationArea.appendChild(
          CreatePagination(TotalCount, CurrentPage, (Page) => {
            CurrentPage = Page
            RenderUpdateHistoryTable()
          }),
        )
      }

      /**
       * 日時をフォーマットして表示用に変換
       * @param {string} DateStr 日時文字列
       * @returns {string} フォーマット済み日時
       */
      function FormatDisplayDateTime(DateStr) {
        if (!DateStr) return ''
        const D = new Date(DateStr)
        if (isNaN(D.getTime())) return DateStr
        const Y = D.getFullYear()
        const M = String(D.getMonth() + 1).padStart(2, '0')
        const Day = String(D.getDate()).padStart(2, '0')
        const H = String(D.getHours()).padStart(2, '0')
        const Min = String(D.getMinutes()).padStart(2, '0')
        return `${Y}年${M}月${Day}日 ${H}:${Min}`
      }

      /* ==========================================================================
       * 年表設定 (6.1 TimelineInfo)
       * ========================================================================== */
      async function ShowTimelineSetting() {
        CurrentPage = 1
        SelectedTimelineId = null
        const ContentArea = document.getElementById('ContentArea')
        const CanEditFlg = CanEdit()

        ContentArea.innerHTML = `
        ${CreateContentHeader('年表設定', 'stream')}
        <div class="FormGroup">
          <input type="text" class="InputForm" id="TimelineTitle" placeholder="出来事タイトル" maxlength="255" ${
            !CanEditFlg ? 'disabled' : ''
          }>
        </div>
        <div class="FormGroup InputWithButton">
          <input type="text" class="InputForm" id="TimelineEventDate" placeholder="発生時期" readonly ${
            !CanEditFlg ? 'disabled' : ''
          }>
          ${
            CanEditFlg
              ? `<button class="ButtonClass SecondaryButton ButtonSmall" id="TimelineEventDateBtn"><i class="fas fa-calendar"></i></button>`
              : ''
          }
        </div>
        <div class="FormGroup InputWithButton">
          <input type="text" class="InputForm" id="TimelineEndDate" placeholder="終了時期（任意）" readonly ${
            !CanEditFlg ? 'disabled' : ''
          }>
          ${
            CanEditFlg
              ? `<button class="ButtonClass SecondaryButton ButtonSmall" id="TimelineEndDateBtn"><i class="fas fa-calendar"></i></button>`
              : ''
          }
        </div>
        <div class="FormGroup InputWithButton">
          <input type="text" class="InputForm" id="TimelineContent" placeholder="内容" disabled>
          <button class="ButtonClass SecondaryButton ButtonSmall" id="TimelineContentBtn"><i class="fas fa-edit"></i></button>
        </div>
        <input type="hidden" id="TimelineContentHidden">
        ${
          CanEditFlg
            ? `
        <div class="ButtonGroup">
          <button class="ButtonClass ClearButton" id="TimelineClearButton"><i class="fas fa-sync"></i> クリア</button>
          <button class="ButtonClass SaveButton" id="TimelineSaveButton"><i class="fas fa-save"></i> 保存</button>
          <button class="ButtonClass DeleteButton Hidden" id="TimelineDeleteButton"><i class="fas fa-trash"></i> 削除</button>
        </div>
        `
            : ''
        }
        <div id="RecordCountArea" class="MarginTop20"></div>
        <div class="TableContainer" id="TimelineTableArea"></div>
        <div id="PaginationArea"></div>
      `

        if (CanEditFlg) {
          const DatePickerInstance = new DatePicker()
          document
            .getElementById('TimelineEventDateBtn')
            .addEventListener('click', () =>
              DatePickerInstance.OpenDialog('TimelineEventDate'),
            )
          document
            .getElementById('TimelineEndDateBtn')
            .addEventListener('click', () =>
              DatePickerInstance.OpenDialog('TimelineEndDate'),
            )
          document
            .getElementById('TimelineClearButton')
            .addEventListener('click', ClearTimelineForm)
          document
            .getElementById('TimelineSaveButton')
            .addEventListener('click', SaveTimeline)
          document
            .getElementById('TimelineDeleteButton')
            .addEventListener('click', DeleteTimeline)
        }
        document
          .getElementById('TimelineContentBtn')
          .addEventListener('click', async () => {
            const Result = await ShowInputAreaDialog(
              document.getElementById('TimelineContentHidden').value,
              !CanEditFlg,
            )
            if (Result !== null && CanEditFlg) {
              document.getElementById('TimelineContentHidden').value = Result
              document.getElementById('TimelineContent').value = TruncateText(
                Result,
                30,
              )
            }
          })
        await LoadTimelineList()
      }

      async function LoadTimelineList() {
        try {
          const WorkId = sessionStorage.getItem('WorkId')
          const Response = await CallApi(
            `/GetTimelineList.php?WorkId=${encodeURIComponent(WorkId)}`,
            'GET',
          )
          if (Response.Success) {
            TimelineList = Response.Data || []
            RenderTimelineTable()
          } else {
            await ShowErrorDialog(
              Response.Message || '年表一覧の取得に失敗しました',
            )
          }
        } catch (Error) {
          console.error(Error)
          await ShowErrorDialog('年表一覧の取得中にエラーが発生しました')
        }
      }
      function RenderTimelineTable() {
        const TableArea = document.getElementById('TimelineTableArea')
        const RecordCountArea = document.getElementById('RecordCountArea')
        const PaginationArea = document.getElementById('PaginationArea')
        RecordCountArea.innerHTML = ''
        RecordCountArea.appendChild(CreateRecordCount(TimelineList.length))
        const Table = document.createElement('table')
        Table.className = 'DataTable'
        const Thead = document.createElement('thead')
        Thead.innerHTML = `<tr><th>タイトル</th><th>発生時期</th><th>終了時期</th><th>内容</th></tr>`
        Table.appendChild(Thead)
        const Tbody = document.createElement('tbody')
        const StartIndex = (CurrentPage - 1) * RECORDS_PER_PAGE
        const EndIndex = Math.min(
          StartIndex + RECORDS_PER_PAGE,
          TimelineList.length,
        )
        const PageData = TimelineList.slice(StartIndex, EndIndex)
        if (PageData.length === 0) {
          Tbody.innerHTML =
            '<tr><td colspan="4" style="text-align:center;color:#999;">データがありません</td></tr>'
        } else {
          PageData.forEach((Item, Idx) => {
            const Row = document.createElement('tr')
            Row.style.cursor = 'pointer'
            Row.dataset.index = StartIndex + Idx
            Row.innerHTML = `<td title="${Item.Title}">${TruncateText(
              Item.Title,
              20,
            )}</td><td>${FormatDate(Item.EventDate)}</td><td>${
              FormatDate(Item.EndDate) || '-'
            }</td><td title="${Item.Content || ''}">${
              TruncateText(Item.Content, 20) || '-'
            }</td>`
            Row.addEventListener('dblclick', () =>
              SelectTimeline(StartIndex + Idx),
            )
            Tbody.appendChild(Row)
          })
        }
        Table.appendChild(Tbody)
        TableArea.innerHTML = ''
        TableArea.appendChild(Table)
        PaginationArea.innerHTML = ''
        PaginationArea.appendChild(
          CreatePagination(TimelineList.length, CurrentPage, (Page) => {
            CurrentPage = Page
            RenderTimelineTable()
          }),
        )
      }

      function SelectTimeline(Index) {
        const Item = TimelineList[Index]
        SelectedTimelineId = Item.TimeId
        document.getElementById('TimelineTitle').value = Item.Title
        document.getElementById('TimelineEventDate').value =
          Item.EventDate || ''
        document.getElementById('TimelineEndDate').value = Item.EndDate || ''
        document.getElementById('TimelineContent').value = TruncateText(
          Item.Content,
          30,
        )
        document.getElementById('TimelineContentHidden').value =
          Item.Content || ''
        const DeleteBtn = document.getElementById('TimelineDeleteButton')
        if (DeleteBtn) DeleteBtn.classList.remove('Hidden')
      }

      function ClearTimelineForm() {
        SelectedTimelineId = null
        document.getElementById('TimelineTitle').value = ''
        document.getElementById('TimelineEventDate').value = ''
        document.getElementById('TimelineEndDate').value = ''
        document.getElementById('TimelineContent').value = ''
        document.getElementById('TimelineContentHidden').value = ''
        const DeleteBtn = document.getElementById('TimelineDeleteButton')
        if (DeleteBtn) DeleteBtn.classList.add('Hidden')
      }

      async function SaveTimeline() {
        const Title = document.getElementById('TimelineTitle').value.trim()
        const EventDate = document
          .getElementById('TimelineEventDate')
          .value.trim()
        if (!Title) {
          await ShowErrorDialog('タイトルを入力してください')
          return
        }
        if (!EventDate) {
          await ShowErrorDialog('発生時期を入力してください')
          return
        }
        try {
          const Response = await CallApi('/SaveTimeline.php', 'POST', {
            TimeId: SelectedTimelineId,
            WorkId: sessionStorage.getItem('WorkId'),
            Title: Title,
            EventDate: EventDate,
            EndDate: document.getElementById('TimelineEndDate').value.trim(),
            Content: document.getElementById('TimelineContentHidden').value,
            UserId: sessionStorage.getItem('UserId'),
          })
          if (Response.Success) {
            await ShowInfoDialog('保存完了', '年表を保存しました')
            ClearTimelineForm()
            await LoadTimelineList()
          } else {
            await ShowErrorDialog(Response.Message || '保存に失敗しました')
          }
        } catch (Error) {
          await ShowErrorDialog('保存中にエラーが発生しました')
        }
      }

      async function DeleteTimeline() {
        if (!SelectedTimelineId) return
        if (!(await ShowConfirmDialog('この年表を削除しますか？'))) return
        try {
          const Response = await CallApi('/DeleteTimeline.php', 'POST', {
            TimeId: SelectedTimelineId,
            UserId: sessionStorage.getItem('UserId'),
          })
          if (Response.Success) {
            await ShowInfoDialog('削除完了', '年表を削除しました')
            ClearTimelineForm()
            await LoadTimelineList()
          } else {
            await ShowErrorDialog(Response.Message || '削除に失敗しました')
          }
        } catch (Error) {
          await ShowErrorDialog('削除中にエラーが発生しました')
        }
      }

      function ShowStageSetting() {
        ShowPlaceholder('舞台設定', 'map-marked-alt')
      }

      function ShowBuildingSetting() {
        ShowPlaceholder('建物設定', 'landmark')
      }

      function ShowPowerSetting() {
        ShowPlaceholder('能力設定', 'bolt')
      }

      function ShowWeaponSetting() {
        ShowPlaceholder('武器設定', 'shield-alt')
      }

      function ShowMoveSetting() {
        ShowPlaceholder('技設定', 'fire')
      }

      function ShowSerifSetting() {
        ShowPlaceholder('セリフ設定', 'comment')
      }

      /* ==========================================================================
       * 相関図作成画面 (5.1, 5.2 RelationObjectInfo, RelationInfo)
       * ========================================================================== */
      let RelationObjects = []
      let RelationLines = []
      let RelationCharaList = []
      let SelectedRelationObject = null
      let IsDraggingObject = false
      let DragStartX = 0
      let DragStartY = 0
      let IsDrawingLine = false
      let LineStartObjId = null
      let CurrentLineType = 1
      let CurrentRelationType = '好意'
      let CurrentRelationColor = '#e74c3c'
      const RelationTypes = [
        { name: '好意', color: '#e74c3c' },
        { name: '敵意', color: '#2c3e50' },
        { name: '疑心', color: '#9b59b6' },
        { name: '友情', color: '#3498db' },
        { name: '家族', color: '#27ae60' },
        { name: 'ライバル', color: '#f39c12' },
      ]

      async function ShowRelationDiagram() {
        const ContentArea = document.getElementById('ContentArea')
        const CanEditFlg = CanEdit()
        ContentArea.innerHTML = `
          ${CreateContentHeader('相関図作成', 'project-diagram')}
          ${
            CanEditFlg
              ? `
          <div class="ButtonGroup MarginBottom20">
            <button class="ButtonClass PrimaryButton" id="RelationSaveBtn"><i class="fas fa-save"></i> 保存</button>
            <button class="ButtonClass SecondaryButton" id="RelationAddGroupBtn"><i class="fas fa-object-group"></i> グループ追加</button>
            <select class="SelectForm" id="RelationLineTypeSelect" style="width:auto;">
              <option value="1">矢印線（感情）</option>
              <option value="2">直線（関係）</option>
            </select>
          </div>
          <div class="RelationTypeSelector" id="RelationTypeSelector">
            ${RelationTypes.map(
              (T, I) =>
                `<div class="RelationTypeOption ${
                  I === 0 ? 'selected' : ''
                }" data-type="${T.name}" data-color="${T.color}" style="color:${
                  T.color
                };border-color:${T.color};">${T.name}</div>`,
            ).join('')}
          </div>
          `
              : ''
          }
          <div class="RelationContainer">
            <div class="RelationSidebar" id="RelationSidebar">
              <div class="RelationSidebarTitle"><i class="fas fa-users"></i> キャラクター</div>
              <div id="RelationCharaList"></div>
            </div>
            <div class="RelationCanvas" id="RelationCanvas">
              <svg class="RelationCanvasSvg" id="RelationSvg"></svg>
              ${
                CanEditFlg
                  ? `<div class="TrashZone" id="TrashZone"><i class="fas fa-trash"></i></div>`
                  : ''
              }
            </div>
          </div>
        `
        await LoadRelationCharaList()
        await LoadRelationData()
        if (CanEditFlg) SetupRelationEvents()
      }

      async function LoadRelationCharaList() {
        try {
          const WorkId = sessionStorage.getItem('WorkId')
          const Response = await CallApi(
            `/GetCharacterList.php?WorkId=${encodeURIComponent(WorkId)}`,
            'GET',
          )
          if (Response.Success) {
            RelationCharaList = Response.Data || []
            RenderRelationCharaList()
          }
        } catch (Error) {
          console.error(Error)
        }
      }

      function RenderRelationCharaList() {
        const Container = document.getElementById('RelationCharaList')
        if (!Container) return
        Container.innerHTML = RelationCharaList.map(
          (C) =>
            `<div class="CharacterListItem" draggable="true" data-charaid="${C.CharaId}" data-charaname="${C.CharaName}">${C.CharaName}</div>`,
        ).join('')
        if (CanEdit()) {
          Container.querySelectorAll('.CharacterListItem').forEach((Item) => {
            Item.addEventListener('dragstart', HandleCharaDragStart)
            Item.addEventListener('dragend', HandleCharaDragEnd)
          })
        }
      }

      function HandleCharaDragStart(E) {
        E.dataTransfer.setData(
          'text/plain',
          JSON.stringify({
            charaId: E.target.dataset.charaid,
            charaName: E.target.dataset.charaname,
          }),
        )
        E.target.classList.add('dragging')
      }

      function HandleCharaDragEnd(E) {
        E.target.classList.remove('dragging')
      }

      async function LoadRelationData() {
        try {
          const WorkId = sessionStorage.getItem('WorkId')
          const [ObjRes, LineRes] = await Promise.all([
            CallApi(
              `/GetRelationObjects.php?WorkId=${encodeURIComponent(WorkId)}`,
              'GET',
            ),
            CallApi(
              `/GetRelationLines.php?WorkId=${encodeURIComponent(WorkId)}`,
              'GET',
            ),
          ])
          RelationObjects = ObjRes.Success ? ObjRes.Data || [] : []
          RelationLines = LineRes.Success ? LineRes.Data || [] : []
          RenderRelationCanvas()
        } catch (Error) {
          console.error(Error)
        }
      }

      function RenderRelationCanvas() {
        const Canvas = document.getElementById('RelationCanvas')
        const Svg = document.getElementById('RelationSvg')
        if (!Canvas || !Svg) return
        Canvas.querySelectorAll('.RelationObject, .RelationGroupBox').forEach(
          (E) => E.remove(),
        )
        Svg.innerHTML = ''
        RelationObjects.forEach((Obj) => {
          if (Obj.ObjType === 2) {
            const GroupBox = document.createElement('div')
            GroupBox.className = 'RelationGroupBox'
            GroupBox.dataset.objid = Obj.ObjId
            GroupBox.style.left = Obj.PosX + 'px'
            GroupBox.style.top = Obj.PosY + 'px'
            GroupBox.style.width = (Obj.Width || 150) + 'px'
            GroupBox.style.height = (Obj.Height || 100) + 'px'
            if (Obj.BgColor) GroupBox.style.borderColor = Obj.BgColor
            if (Obj.Label)
              GroupBox.innerHTML = `<div class="RelationGroupLabel" style="background:${
                Obj.BgColor || '#9b59b6'
              }">${Obj.Label}</div>`
            Canvas.insertBefore(GroupBox, Svg)
          } else {
            const CharaObj = document.createElement('div')
            CharaObj.className = 'RelationObject'
            CharaObj.dataset.objid = Obj.ObjId
            CharaObj.dataset.charaid = Obj.TargetId
            CharaObj.style.left = Obj.PosX + 'px'
            CharaObj.style.top = Obj.PosY + 'px'
            const Chara = RelationCharaList.find(
              (C) => C.CharaId === Obj.TargetId,
            )
            CharaObj.innerHTML = `${
              Chara?.ImgPath ? `<img src="${Chara.ImgPath}" alt="">` : ''
            }<div>${Chara?.CharaName || Obj.Label || '不明'}</div>`
            Canvas.appendChild(CharaObj)
          }
        })
        RelationLines.forEach((Line) => {
          const SourceObj = RelationObjects.find(
            (O) => O.ObjId == Line.SourceObjId,
          )
          const TargetObj = RelationObjects.find(
            (O) => O.ObjId == Line.TargetObjId,
          )
          if (!SourceObj || !TargetObj) return
          const X1 = SourceObj.PosX + 50,
            Y1 = SourceObj.PosY + 40
          const X2 = TargetObj.PosX + 50,
            Y2 = TargetObj.PosY + 40
          if (Line.LineType === 1) {
            const Path = document.createElementNS(
              'http://www.w3.org/2000/svg',
              'path',
            )
            const Dx = X2 - X1,
              Dy = Y2 - Y1,
              Len = Math.sqrt(Dx * Dx + Dy * Dy)
            const UnitX = Dx / Len,
              UnitY = Dy / Len
            const ArrowLen = 10,
              ArrowX = X2 - UnitX * 15,
              ArrowY = Y2 - UnitY * 15
            const LeftX = ArrowX - UnitY * ArrowLen - UnitX * ArrowLen
            const LeftY = ArrowY + UnitX * ArrowLen - UnitY * ArrowLen
            const RightX = ArrowX + UnitY * ArrowLen - UnitX * ArrowLen
            const RightY = ArrowY - UnitX * ArrowLen - UnitY * ArrowLen
            Path.setAttribute(
              'd',
              `M${X1},${Y1} L${X2 - UnitX * 15},${
                Y2 - UnitY * 15
              } M${ArrowX},${ArrowY} L${LeftX},${LeftY} M${ArrowX},${ArrowY} L${RightX},${RightY}`,
            )
            Path.setAttribute('stroke', Line.Color || '#e74c3c')
            Path.setAttribute('stroke-width', '2')
            Path.setAttribute('fill', 'none')
            Path.dataset.relationid = Line.RelationId
            Svg.appendChild(Path)
          } else {
            const LineEl = document.createElementNS(
              'http://www.w3.org/2000/svg',
              'line',
            )
            LineEl.setAttribute('x1', X1)
            LineEl.setAttribute('y1', Y1)
            LineEl.setAttribute('x2', X2)
            LineEl.setAttribute('y2', Y2)
            LineEl.setAttribute('stroke', Line.Color || '#3498db')
            LineEl.setAttribute('stroke-width', '2')
            LineEl.dataset.relationid = Line.RelationId
            Svg.appendChild(LineEl)
          }
          const TextX = (X1 + X2) / 2,
            TextY = (Y1 + Y2) / 2 - 5
          const Text = document.createElementNS(
            'http://www.w3.org/2000/svg',
            'text',
          )
          Text.setAttribute('x', TextX)
          Text.setAttribute('y', TextY)
          Text.setAttribute('fill', Line.Color || '#333')
          Text.setAttribute('font-size', '10')
          Text.setAttribute('text-anchor', 'middle')
          Text.textContent = Line.RelationType || ''
          Svg.appendChild(Text)
        })
        if (CanEdit()) SetupRelationObjectEvents()
      }

      function SetupRelationEvents() {
        const Canvas = document.getElementById('RelationCanvas')
        Canvas.addEventListener('dragover', (E) => E.preventDefault())
        Canvas.addEventListener('drop', HandleCanvasDrop)
        document
          .getElementById('RelationSaveBtn')
          .addEventListener('click', SaveRelationData)
        document
          .getElementById('RelationAddGroupBtn')
          .addEventListener('click', AddRelationGroup)
        document
          .getElementById('RelationLineTypeSelect')
          .addEventListener('change', (E) => {
            CurrentLineType = parseInt(E.target.value)
          })
        document.querySelectorAll('.RelationTypeOption').forEach((Opt) => {
          Opt.addEventListener('click', function () {
            document
              .querySelectorAll('.RelationTypeOption')
              .forEach((O) => O.classList.remove('selected'))
            this.classList.add('selected')
            CurrentRelationType = this.dataset.type
            CurrentRelationColor = this.dataset.color
          })
        })
      }

      function SetupRelationObjectEvents() {
        document.querySelectorAll('.RelationObject').forEach((Obj) => {
          Obj.addEventListener('mousedown', StartDragObject)
          Obj.addEventListener('dblclick', StartDrawLine)
        })
        document.querySelectorAll('.RelationGroupBox').forEach((Obj) => {
          Obj.addEventListener('mousedown', StartDragObject)
        })
      }

      function HandleCanvasDrop(E) {
        E.preventDefault()
        const Data = JSON.parse(E.dataTransfer.getData('text/plain') || '{}')
        if (!Data.charaId) return
        if (RelationObjects.find((O) => O.TargetId === Data.charaId)) {
          ShowErrorDialog('このキャラは既に配置されています')
          return
        }
        const Rect = E.target.closest('.RelationCanvas').getBoundingClientRect()
        const NewObj = {
          ObjId: 'new_' + Date.now(),
          ObjType: 1,
          TargetId: Data.charaId,
          Label: Data.charaName,
          PosX: E.clientX - Rect.left - 40,
          PosY: E.clientY - Rect.top - 30,
        }
        RelationObjects.push(NewObj)
        RenderRelationCanvas()
      }

      function StartDragObject(E) {
        if (E.target.closest('.TrashZone')) return
        SelectedRelationObject = E.target.closest(
          '.RelationObject, .RelationGroupBox',
        )
        if (!SelectedRelationObject) return
        IsDraggingObject = true
        DragStartX = E.clientX - SelectedRelationObject.offsetLeft
        DragStartY = E.clientY - SelectedRelationObject.offsetTop
        document.addEventListener('mousemove', DragObject)
        document.addEventListener('mouseup', EndDragObject)
        document
          .querySelectorAll('.RelationObject')
          .forEach((O) => O.classList.remove('selected'))
        SelectedRelationObject.classList.add('selected')
      }

      function DragObject(E) {
        if (!IsDraggingObject || !SelectedRelationObject) return
        const Canvas = document.getElementById('RelationCanvas')
        const Rect = Canvas.getBoundingClientRect()
        let NewX = E.clientX - DragStartX
        let NewY = E.clientY - DragStartY
        NewX = Math.max(
          0,
          Math.min(NewX, Rect.width - SelectedRelationObject.offsetWidth),
        )
        NewY = Math.max(
          0,
          Math.min(NewY, Rect.height - SelectedRelationObject.offsetHeight),
        )
        SelectedRelationObject.style.left = NewX + 'px'
        SelectedRelationObject.style.top = NewY + 'px'
        const ObjId = SelectedRelationObject.dataset.objid
        const Obj = RelationObjects.find((O) => O.ObjId == ObjId)
        if (Obj) {
          Obj.PosX = NewX
          Obj.PosY = NewY
        }
        RenderRelationLines()
        const TrashZone = document.getElementById('TrashZone')
        if (TrashZone) {
          const TrashRect = TrashZone.getBoundingClientRect()
          if (
            E.clientX >= TrashRect.left &&
            E.clientX <= TrashRect.right &&
            E.clientY >= TrashRect.top &&
            E.clientY <= TrashRect.bottom
          ) {
            TrashZone.classList.add('active')
          } else {
            TrashZone.classList.remove('active')
          }
        }
      }

      function RenderRelationLines() {
        const Svg = document.getElementById('RelationSvg')
        if (!Svg) return
        Svg.innerHTML = ''
        RelationLines.forEach((Line) => {
          const SourceObj = RelationObjects.find(
            (O) => O.ObjId == Line.SourceObjId,
          )
          const TargetObj = RelationObjects.find(
            (O) => O.ObjId == Line.TargetObjId,
          )
          if (!SourceObj || !TargetObj) return
          const X1 = SourceObj.PosX + 50,
            Y1 = SourceObj.PosY + 40
          const X2 = TargetObj.PosX + 50,
            Y2 = TargetObj.PosY + 40
          if (Line.LineType === 1) {
            const Path = document.createElementNS(
              'http://www.w3.org/2000/svg',
              'path',
            )
            const Dx = X2 - X1,
              Dy = Y2 - Y1,
              Len = Math.sqrt(Dx * Dx + Dy * Dy) || 1
            const UnitX = Dx / Len,
              UnitY = Dy / Len
            const ArrowLen = 10,
              ArrowX = X2 - UnitX * 15,
              ArrowY = Y2 - UnitY * 15
            const LeftX = ArrowX - UnitY * ArrowLen - UnitX * ArrowLen
            const LeftY = ArrowY + UnitX * ArrowLen - UnitY * ArrowLen
            const RightX = ArrowX + UnitY * ArrowLen - UnitX * ArrowLen
            const RightY = ArrowY - UnitX * ArrowLen - UnitY * ArrowLen
            Path.setAttribute(
              'd',
              `M${X1},${Y1} L${X2 - UnitX * 15},${
                Y2 - UnitY * 15
              } M${ArrowX},${ArrowY} L${LeftX},${LeftY} M${ArrowX},${ArrowY} L${RightX},${RightY}`,
            )
            Path.setAttribute('stroke', Line.Color || '#e74c3c')
            Path.setAttribute('stroke-width', '2')
            Path.setAttribute('fill', 'none')
            Svg.appendChild(Path)
          } else {
            const LineEl = document.createElementNS(
              'http://www.w3.org/2000/svg',
              'line',
            )
            LineEl.setAttribute('x1', X1)
            LineEl.setAttribute('y1', Y1)
            LineEl.setAttribute('x2', X2)
            LineEl.setAttribute('y2', Y2)
            LineEl.setAttribute('stroke', Line.Color || '#3498db')
            LineEl.setAttribute('stroke-width', '2')
            Svg.appendChild(LineEl)
          }
          const TextX = (X1 + X2) / 2,
            TextY = (Y1 + Y2) / 2 - 5
          const Text = document.createElementNS(
            'http://www.w3.org/2000/svg',
            'text',
          )
          Text.setAttribute('x', TextX)
          Text.setAttribute('y', TextY)
          Text.setAttribute('fill', Line.Color || '#333')
          Text.setAttribute('font-size', '10')
          Text.setAttribute('text-anchor', 'middle')
          Text.textContent = Line.RelationType || ''
          Svg.appendChild(Text)
        })
      }

      function EndDragObject(E) {
        if (!IsDraggingObject) return
        const TrashZone = document.getElementById('TrashZone')
        if (
          TrashZone &&
          TrashZone.classList.contains('active') &&
          SelectedRelationObject
        ) {
          const ObjId = SelectedRelationObject.dataset.objid
          RelationObjects = RelationObjects.filter((O) => O.ObjId != ObjId)
          RelationLines = RelationLines.filter(
            (L) => L.SourceObjId != ObjId && L.TargetObjId != ObjId,
          )
          RenderRelationCanvas()
        }
        IsDraggingObject = false
        SelectedRelationObject = null
        document.removeEventListener('mousemove', DragObject)
        document.removeEventListener('mouseup', EndDragObject)
        if (TrashZone) TrashZone.classList.remove('active')
      }

      function StartDrawLine(E) {
        const Obj = E.target.closest('.RelationObject')
        if (!Obj) return
        if (!IsDrawingLine) {
          IsDrawingLine = true
          LineStartObjId = Obj.dataset.objid
          Obj.classList.add('selected')
          ShowInfoDialog(
            '線の描画',
            '接続先のキャラをダブルクリックしてください',
          )
        } else {
          const EndObjId = Obj.dataset.objid
          if (LineStartObjId !== EndObjId) {
            const NewLine = {
              RelationId: 'new_' + Date.now(),
              SourceObjId: LineStartObjId,
              TargetObjId: EndObjId,
              LineType: CurrentLineType,
              RelationType: CurrentRelationType,
              Color: CurrentRelationColor,
            }
            RelationLines.push(NewLine)
            RenderRelationCanvas()
          }
          IsDrawingLine = false
          LineStartObjId = null
          document
            .querySelectorAll('.RelationObject')
            .forEach((O) => O.classList.remove('selected'))
        }
      }

      /**
       * グループ追加ダイアログを表示する
       * @returns {Promise<void>}
       */
      async function AddRelationGroup() {
        const Result = await ShowGroupDialog()
        if (!Result) return
        const NewGroup = {
          ObjId: 'new_' + Date.now(),
          ObjType: 2,
          Label: Result.Label,
          PosX: 100,
          PosY: 100,
          Width: 200,
          Height: 150,
          BgColor: Result.BgColor || '#9b59b6',
        }
        RelationObjects.push(NewGroup)
        RenderRelationCanvas()
      }

      /**
       * グループ追加・編集ダイアログを表示する
       * @param {Object|null} Group 編集対象のグループ（新規の場合はnull）
       * @returns {Promise<Object|null>} グループ情報またはnull
       */
      function ShowGroupDialog(Group = null) {
        const IsEdit = Group !== null
        return new Promise((Resolve) => {
          const Overlay = document.createElement('div')
          Overlay.className = 'DialogOverlay'
          const Dialog = document.createElement('div')
          Dialog.className = 'DialogContainer DialogSmall'
          Dialog.innerHTML = `
            <div class="DialogTitle">${
              IsEdit ? 'グループ編集' : 'グループ追加'
            }</div>
            <div class="DialogContent">
              <div class="FormGroup">
                <input type="text" class="InputForm" id="GroupLabelInput" placeholder="グループ名" value="${
                  Group?.Label || ''
                }" maxlength="50">
              </div>
              <div class="FormGroup">
                <label class="FormLabel">背景色</label>
                <div class="ColorPickerWrapper">
                  <input type="color" class="ColorPicker" id="GroupColorInput" value="${
                    Group?.BgColor || '#9b59b6'
                  }">
                  <input type="text" class="InputForm ColorCodeInput" id="GroupColorCodeInput" placeholder="#9b59b6" value="${
                    Group?.BgColor || '#9b59b6'
                  }" maxlength="7">
                </div>
              </div>
            </div>
            <div class="DialogButtonArea">
              <button class="ButtonClass CloseButton" id="GroupDialogClose"><i class="fas fa-times"></i> 閉じる</button>
              <button class="ButtonClass SaveButton" id="GroupDialogSave"><i class="fas fa-check"></i> 決定</button>
            </div>
          `
          document.body.appendChild(Overlay)
          Overlay.appendChild(Dialog)

          /** カラーピッカーとテキスト入力の同期 */
          const ColorPicker = Dialog.querySelector('#GroupColorInput')
          const ColorCode = Dialog.querySelector('#GroupColorCodeInput')
          ColorPicker.addEventListener('input', () => {
            ColorCode.value = ColorPicker.value
          })
          ColorCode.addEventListener('input', () => {
            const Val = ColorCode.value
            if (/^#[0-9A-Fa-f]{6}$/.test(Val)) {
              ColorPicker.value = Val
            }
          })

          /** 閉じるボタン */
          Dialog.querySelector('#GroupDialogClose').addEventListener(
            'click',
            () => {
              Overlay.remove()
              Resolve(null)
            },
          )

          /** オーバーレイクリックで閉じる */
          Overlay.addEventListener('click', (E) => {
            if (E.target === Overlay) {
              Overlay.remove()
              Resolve(null)
            }
          })

          /** 決定ボタン */
          Dialog.querySelector('#GroupDialogSave').addEventListener(
            'click',
            async () => {
              const Label =
                Dialog.querySelector('#GroupLabelInput').value.trim()
              const BgColor = ColorCode.value.trim()
              if (!Label) {
                await ShowErrorDialog('グループ名を入力してください')
                return
              }
              if (BgColor && !/^#[0-9A-Fa-f]{6}$/.test(BgColor)) {
                await ShowErrorDialog(
                  'カラーコードの形式が正しくありません（例: #9b59b6）',
                )
                return
              }
              Overlay.remove()
              Resolve({ Label: Label, BgColor: BgColor || '#9b59b6' })
            },
          )

          /** Enterキーで決定 */
          Dialog.querySelector('#GroupLabelInput').addEventListener(
            'keydown',
            (E) => {
              if (E.key === 'Enter') {
                E.preventDefault()
                Dialog.querySelector('#GroupDialogSave').click()
              }
            },
          )

          /** 初期フォーカス */
          Dialog.querySelector('#GroupLabelInput').focus()
        })
      }

      async function SaveRelationData() {
        try {
          const Response = await CallApi('/SaveRelationData.php', 'POST', {
            WorkId: sessionStorage.getItem('WorkId'),
            Objects: RelationObjects,
            Lines: RelationLines,
            UserId: sessionStorage.getItem('UserId'),
          })
          if (Response.Success) {
            await ShowInfoDialog('保存完了', '相関図を保存しました')
            await LoadRelationData()
          } else {
            await ShowErrorDialog(Response.Message || '保存に失敗しました')
          }
        } catch (Error) {
          await ShowErrorDialog('保存中にエラーが発生しました')
        }
      }

      /* ==========================================================================
       * ストーリー作成画面 (6.2 StoryInfo)
       * ========================================================================== */
      let StoryList = []
      let SelectedStoryId = null
      let StoryDragItem = null

      async function ShowStoryCreation() {
        CurrentPage = 1
        SelectedStoryId = null
        const ContentArea = document.getElementById('ContentArea')
        const CanEditFlg = CanEdit()
        ContentArea.innerHTML = `
          ${CreateContentHeader('ストーリー作成', 'book')}
          ${
            CanEditFlg
              ? `
          <div class="ButtonGroup MarginBottom20">
            <button class="ButtonClass PrimaryButton" id="StoryAddBtn"><i class="fas fa-plus"></i> 行追加</button>
            <button class="ButtonClass SuccessButton" id="StoryExportBtn"><i class="fas fa-file-word"></i> Word出力</button>
          </div>
          `
              : ''
          }
          <div id="RecordCountArea"></div>
          <div class="StoryList" id="StoryListArea"></div>
          <div id="PaginationArea"></div>
        `
        if (CanEditFlg) {
          document
            .getElementById('StoryAddBtn')
            .addEventListener('click', () => ShowStoryDialog())
          document
            .getElementById('StoryExportBtn')
            .addEventListener('click', ExportStoryToWord)
        }
        await LoadStoryList()
      }

      async function LoadStoryList() {
        try {
          const WorkId = sessionStorage.getItem('WorkId')
          const Response = await CallApi(
            `/GetStoryList.php?WorkId=${encodeURIComponent(WorkId)}`,
            'GET',
          )
          if (Response.Success) {
            StoryList = (Response.Data.StoryList || []).sort(
              (A, B) => A.IndexNum - B.IndexNum,
            )
            RenderStoryList()
          } else {
            await ShowErrorDialog(
              Response.Message || 'ストーリー一覧の取得に失敗しました',
            )
          }
        } catch (Error) {
          console.error(Error)
          await ShowErrorDialog('ストーリー一覧の取得中にエラーが発生しました')
        }
      }

      function RenderStoryList() {
        const ListArea = document.getElementById('StoryListArea')
        const RecordCountArea = document.getElementById('RecordCountArea')
        if (!ListArea) return
        RecordCountArea.innerHTML = ''
        RecordCountArea.appendChild(CreateRecordCount(StoryList.length))
        const CanEditFlg = CanEdit()
        if (StoryList.length === 0) {
          ListArea.innerHTML =
            '<div style="text-align:center;color:#999;padding:50px;">データがありません</div>'
          return
        }
        ListArea.innerHTML = StoryList.map(
          (Item, Idx) => `
          <div class="StoryItem" data-storyid="${
            Item.StoryId
          }" data-index="${Idx}" ${CanEditFlg ? 'draggable="true"' : ''}>
            <div class="StoryNumber">${Idx + 1}</div>
            <div class="StoryContent">
              <div class="StoryNarrator">${
                Item.Narrator ? `語り手: ${Item.Narrator}` : 'ナレーション'
              }</div>
              <div class="StoryText">${Item.Content || ''}</div>
            </div>
          </div>
        `,
        ).join('')
        if (CanEditFlg) {
          ListArea.querySelectorAll('.StoryItem').forEach((Item) => {
            Item.addEventListener('dblclick', () =>
              ShowStoryDialog(Item.dataset.storyid),
            )
            Item.addEventListener('dragstart', HandleStoryDragStart)
            Item.addEventListener('dragend', HandleStoryDragEnd)
            Item.addEventListener('dragover', HandleStoryDragOver)
            Item.addEventListener('drop', HandleStoryDrop)
          })
        }
      }

      function HandleStoryDragStart(E) {
        StoryDragItem = E.target.closest('.StoryItem')
        E.target.classList.add('dragging')
        E.dataTransfer.effectAllowed = 'move'
      }

      function HandleStoryDragEnd(E) {
        E.target.classList.remove('dragging')
        document
          .querySelectorAll('.StoryItem')
          .forEach((I) => I.classList.remove('drag-over'))
        StoryDragItem = null
      }

      function HandleStoryDragOver(E) {
        E.preventDefault()
        const Item = E.target.closest('.StoryItem')
        if (Item && Item !== StoryDragItem) {
          document
            .querySelectorAll('.StoryItem')
            .forEach((I) => I.classList.remove('drag-over'))
          Item.classList.add('drag-over')
        }
      }

      /**
       * ストーリーの並び替えを処理する
       * @param {DragEvent} E
       * @returns {Promise<void>}
       */
      async function HandleStoryDrop(E) {
        E.preventDefault()
        const DropItem = E.target.closest('.StoryItem')
        if (!DropItem || !StoryDragItem || DropItem === StoryDragItem) return
        const FromIndex = parseInt(StoryDragItem.dataset.index)
        const ToIndex = parseInt(DropItem.dataset.index)
        const MovedItem = StoryList.splice(FromIndex, 1)[0]
        StoryList.splice(ToIndex, 0, MovedItem)
        StoryList.forEach((Item, Idx) => {
          Item.IndexNum = Idx + 1
        })
        RenderStoryList()
        await SaveStoryOrder()
      }

      /**
       * ストーリーの並び順を保存する
       * @returns {Promise<void>}
       */
      async function SaveStoryOrder() {
        try {
          const Response = await CallApi('/UpdateStoryOrder.php', 'POST', {
            WorkId: sessionStorage.getItem('WorkId'),
            OrderList: StoryList.map((Item) => ({
              StoryId: Item.StoryId,
              IndexNum: Item.IndexNum,
            })),
            UserId: sessionStorage.getItem('UserId'),
          })
          if (!Response.Success)
            await ShowErrorDialog(
              Response.Message || '並び順の保存に失敗しました',
            )
        } catch (Error) {
          console.error(Error)
        }
      }

      async function ShowStoryDialog(StoryId = null) {
        const IsEdit = StoryId !== null
        const Item = IsEdit ? StoryList.find((S) => S.StoryId == StoryId) : null
        return new Promise((Resolve) => {
          const Overlay = document.createElement('div')
          Overlay.className = 'DialogOverlay'
          const Dialog = document.createElement('div')
          Dialog.className = 'DialogContainer DialogMedium'
          Dialog.innerHTML = `
            <div class="DialogTitle">${
              IsEdit ? 'ストーリー編集' : 'ストーリー追加'
            }</div>
            <div class="DialogContent">
              <div class="FormGroup">
                <div class="CheckboxWrapper">
                  <input type="checkbox" id="StoryNarratorToggle" ${
                    Item?.Narrator ? '' : 'checked'
                  }>
                  <label>自由入力</label>
                </div>
              </div>
              <div class="FormGroup" id="StoryNarratorSelectGroup">
                <select class="SelectForm" id="StoryNarratorSelect">
                  <option value="">語り手を選択</option>
                  ${
                    RelationCharaList.length
                      ? RelationCharaList.map(
                          (C) =>
                            `<option value="${C.CharaName}" ${
                              Item?.Narrator === C.CharaName ? 'selected' : ''
                            }>${C.CharaName}</option>`,
                        ).join('')
                      : CharacterList.map(
                          (C) =>
                            `<option value="${C.CharaName}" ${
                              Item?.Narrator === C.CharaName ? 'selected' : ''
                            }>${C.CharaName}</option>`,
                        ).join('')
                  }
                </select>
              </div>
              <div class="FormGroup Hidden" id="StoryNarratorInputGroup">
                <input type="text" class="InputForm" id="StoryNarratorInput" placeholder="語り手（空白でナレーション）" value="${
                  Item?.Narrator || ''
                }">
              </div>
              <div class="FormGroup">
                <textarea class="TextAreaForm" id="StoryContentInput" placeholder="内容" style="min-height:150px;">${
                  Item?.Content || ''
                }</textarea>
              </div>
            </div>
            <div class="DialogButtonArea">
              <button class="ButtonClass CloseButton" id="StoryDialogClose"><i class="fas fa-times"></i> 閉じる</button>
              ${
                IsEdit
                  ? `<button class="ButtonClass DeleteButton" id="StoryDialogDelete"><i class="fas fa-trash"></i> 削除</button>`
                  : ''
              }
              <button class="ButtonClass SaveButton" id="StoryDialogSave"><i class="fas fa-save"></i> 保存</button>
            </div>
          `
          document.body.appendChild(Overlay)
          Overlay.appendChild(Dialog)
          const Toggle = Dialog.querySelector('#StoryNarratorToggle')
          const SelectGroup = Dialog.querySelector('#StoryNarratorSelectGroup')
          const InputGroup = Dialog.querySelector('#StoryNarratorInputGroup')
          const UpdateToggle = () => {
            if (Toggle.checked) {
              SelectGroup.classList.add('Hidden')
              InputGroup.classList.remove('Hidden')
            } else {
              SelectGroup.classList.remove('Hidden')
              InputGroup.classList.add('Hidden')
            }
          }
          UpdateToggle()
          Toggle.addEventListener('change', UpdateToggle)
          Dialog.querySelector('#StoryDialogClose').addEventListener(
            'click',
            () => {
              Overlay.remove()
              Resolve(null)
            },
          )
          Dialog.querySelector('#StoryDialogSave').addEventListener(
            'click',
            async () => {
              let Narrator = Toggle.checked
                ? Dialog.querySelector('#StoryNarratorInput').value.trim()
                : Dialog.querySelector('#StoryNarratorSelect').value
              let Content =
                Dialog.querySelector('#StoryContentInput').value.trim()
              if (!Content) {
                await ShowErrorDialog('内容を入力してください')
                return
              }
              if (Narrator)
                Content = `「${Content.replace(/^「/, '').replace(/」$/, '')}」`
              try {
                const Response = await CallApi('/SaveStory.php', 'POST', {
                  StoryId: IsEdit ? StoryId : null,
                  WorkId: sessionStorage.getItem('WorkId'),
                  IndexNum: IsEdit ? Item.IndexNum : StoryList.length + 1,
                  Narrator: Narrator,
                  Content: Content,
                  UserId: sessionStorage.getItem('UserId'),
                })
                if (Response.Success) {
                  Overlay.remove()
                  await ShowInfoDialog('保存完了', 'ストーリーを保存しました')
                  await LoadStoryList()
                  Resolve(true)
                } else {
                  await ShowErrorDialog(
                    Response.Message || '保存に失敗しました',
                  )
                }
              } catch (Error) {
                await ShowErrorDialog('保存中にエラーが発生しました')
              }
            },
          )
          if (IsEdit) {
            Dialog.querySelector('#StoryDialogDelete').addEventListener(
              'click',
              async () => {
                if (
                  !(await ShowConfirmDialog('このストーリーを削除しますか？'))
                )
                  return
                try {
                  const Response = await CallApi('/DeleteStory.php', 'POST', {
                    StoryId: StoryId,
                    UserId: sessionStorage.getItem('UserId'),
                    WorkId: sessionStorage.getItem('WorkId'),
                  })
                  if (Response.Success) {
                    Overlay.remove()
                    await ShowInfoDialog('削除完了', 'ストーリーを削除しました')
                    await LoadStoryList()
                    Resolve(true)
                  } else {
                    await ShowErrorDialog(
                      Response.Message || '削除に失敗しました',
                    )
                  }
                } catch (Error) {
                  await ShowErrorDialog('削除中にエラーが発生しました')
                }
              },
            )
          }
        })
      }

      /**
       * ストーリーをWordファイルにエクスポートする
       * @returns {Promise<void>}
       */
      async function ExportStoryToWord() {
        try {
          ShowSpinner()
          const Response = await CallApi('/ExportStory.php', 'POST', {
            WorkId: sessionStorage.getItem('WorkId'),
            UserId: sessionStorage.getItem('UserId'),
          })
          if (!Response.ok) throw new Error('出力に失敗しました')
          const Blob = await Response.blob()
          const WorkTitle = WorkInfo?.WorkTitle || '作品'
          DownloadFile(Blob, `${WorkTitle}_ストーリー.docx`)
          HideSpinner()
          await ShowInfoDialog('出力完了', 'Wordファイルをダウンロードしました')
        } catch (Error) {
          HideSpinner()
          await ShowErrorDialog('出力中にエラーが発生しました')
        }
      }

      /* ==========================================================================
       * プロット作成画面 (6.3 PlotInfo)
       * ========================================================================== */
      let PlotList = []
      let SelectedPlotId = null
      let PlotDragItem = null
      const PlotStructureLabels = ['起', '承', '転', '結']
      const PlotStructureClasses = ['ki', 'sho', 'ten', 'ketsu']

      async function ShowPlotCreation() {
        CurrentPage = 1
        SelectedPlotId = null
        const ContentArea = document.getElementById('ContentArea')
        const CanEditFlg = CanEdit()
        ContentArea.innerHTML = `
          ${CreateContentHeader('プロット作成', 'sitemap')}
          ${
            CanEditFlg
              ? `
          <div class="ButtonGroup MarginBottom20">
            <button class="ButtonClass PrimaryButton" id="PlotAddBtn"><i class="fas fa-plus"></i> 行追加</button>
            <button class="ButtonClass SuccessButton" id="PlotExportBtn"><i class="fas fa-file-word"></i> Word出力</button>
          </div>
          `
              : ''
          }
          <div id="RecordCountArea"></div>
          <div class="StoryList" id="PlotListArea"></div>
          <div id="PaginationArea"></div>
        `
        if (CanEditFlg) {
          document
            .getElementById('PlotAddBtn')
            .addEventListener('click', () => ShowPlotDialog())
          document
            .getElementById('PlotExportBtn')
            .addEventListener('click', ExportPlotToWord)
        }
        await LoadPlotList()
      }

      async function LoadPlotList() {
        try {
          const WorkId = sessionStorage.getItem('WorkId')
          const Response = await CallApi(
            `/GetPlotList.php?WorkId=${encodeURIComponent(WorkId)}`,
            'GET',
          )
          if (Response.Success) {
            PlotList = (Response.Data.PlotList || []).sort(
              (A, B) => A.IndexNum - B.IndexNum,
            )
            RenderPlotList()
          } else {
            await ShowErrorDialog(
              Response.Message || 'プロット一覧の取得に失敗しました',
            )
          }
        } catch (Error) {
          console.error(Error)
          await ShowErrorDialog('プロット一覧の取得中にエラーが発生しました')
        }
      }

      function RenderPlotList() {
        const ListArea = document.getElementById('PlotListArea')
        const RecordCountArea = document.getElementById('RecordCountArea')
        if (!ListArea) return
        RecordCountArea.innerHTML = ''
        RecordCountArea.appendChild(CreateRecordCount(PlotList.length))
        const CanEditFlg = CanEdit()
        if (PlotList.length === 0) {
          ListArea.innerHTML =
            '<div style="text-align:center;color:#999;padding:50px;">データがありません</div>'
          return
        }
        ListArea.innerHTML = PlotList.map(
          (Item, Idx) => `
          <div class="StoryItem" data-plotid="${
            Item.PlotId
          }" data-index="${Idx}" ${CanEditFlg ? 'draggable="true"' : ''}>
            <div class="StoryNumber">${Idx + 1}</div>
            <div class="StoryContent">
              <span class="PlotBadge ${
                PlotStructureClasses[Item.StructureType] || ''
              }">${PlotStructureLabels[Item.StructureType] || '?'}</span>
              <span class="StoryText">${Item.Content || ''}</span>
            </div>
          </div>
        `,
        ).join('')
        if (CanEditFlg) {
          ListArea.querySelectorAll('.StoryItem').forEach((Item) => {
            Item.addEventListener('dblclick', () =>
              ShowPlotDialog(Item.dataset.plotid),
            )
            Item.addEventListener('dragstart', HandlePlotDragStart)
            Item.addEventListener('dragend', HandlePlotDragEnd)
            Item.addEventListener('dragover', HandlePlotDragOver)
            Item.addEventListener('drop', HandlePlotDrop)
          })
        }
      }

      function HandlePlotDragStart(E) {
        PlotDragItem = E.target.closest('.StoryItem')
        E.target.classList.add('dragging')
        E.dataTransfer.effectAllowed = 'move'
      }

      function HandlePlotDragEnd(E) {
        E.target.classList.remove('dragging')
        document
          .querySelectorAll('.StoryItem')
          .forEach((I) => I.classList.remove('drag-over'))
        PlotDragItem = null
      }

      function HandlePlotDragOver(E) {
        E.preventDefault()
        const Item = E.target.closest('.StoryItem')
        if (Item && Item !== PlotDragItem) {
          document
            .querySelectorAll('.StoryItem')
            .forEach((I) => I.classList.remove('drag-over'))
          Item.classList.add('drag-over')
        }
      }

      async function HandlePlotDrop(E) {
        E.preventDefault()
        const DropItem = E.target.closest('.StoryItem')
        if (!DropItem || !PlotDragItem || DropItem === PlotDragItem) return
        const FromIndex = parseInt(PlotDragItem.dataset.index)
        const ToIndex = parseInt(DropItem.dataset.index)
        const MovedItem = PlotList.splice(FromIndex, 1)[0]
        PlotList.splice(ToIndex, 0, MovedItem)
        PlotList.forEach((Item, Idx) => {
          Item.IndexNum = Idx + 1
        })
        RenderPlotList()
        await SavePlotOrder()
      }

      async function SavePlotOrder() {
        try {
          const Response = await CallApi('/UpdatePlotOrder.php', 'POST', {
            WorkId: sessionStorage.getItem('WorkId'),
            OrderList: PlotList.map((Item) => ({
              PlotId: Item.PlotId,
              IndexNum: Item.IndexNum,
            })),
            UserId: sessionStorage.getItem('UserId'),
          })
          if (!Response.Success)
            await ShowErrorDialog(
              Response.Message || '並び順の保存に失敗しました',
            )
        } catch (Error) {
          console.error(Error)
        }
      }

      async function ShowPlotDialog(PlotId = null) {
        const IsEdit = PlotId !== null
        const Item = IsEdit ? PlotList.find((P) => P.PlotId == PlotId) : null
        return new Promise((Resolve) => {
          const Overlay = document.createElement('div')
          Overlay.className = 'DialogOverlay'
          const Dialog = document.createElement('div')
          Dialog.className = 'DialogContainer DialogMedium'
          Dialog.innerHTML = `
            <div class="DialogTitle">${
              IsEdit ? 'プロット編集' : 'プロット追加'
            }</div>
            <div class="DialogContent">
              <div class="FormGroup">
                <select class="SelectForm" id="PlotStructureSelect">
                  ${PlotStructureLabels.map(
                    (L, I) =>
                      `<option value="${I}" ${
                        Item?.StructureType == I ? 'selected' : ''
                      }>${L}</option>`,
                  ).join('')}
                </select>
              </div>
              <div class="FormGroup">
                <textarea class="TextAreaForm" id="PlotContentInput" placeholder="内容" style="min-height:150px;">${
                  Item?.Content || ''
                }</textarea>
              </div>
            </div>
            <div class="DialogButtonArea">
              <button class="ButtonClass CloseButton" id="PlotDialogClose"><i class="fas fa-times"></i> 閉じる</button>
              ${
                IsEdit
                  ? `<button class="ButtonClass DeleteButton" id="PlotDialogDelete"><i class="fas fa-trash"></i> 削除</button>`
                  : ''
              }
              <button class="ButtonClass SaveButton" id="PlotDialogSave"><i class="fas fa-save"></i> 保存</button>
            </div>
          `
          document.body.appendChild(Overlay)
          Overlay.appendChild(Dialog)
          Dialog.querySelector('#PlotDialogClose').addEventListener(
            'click',
            () => {
              Overlay.remove()
              Resolve(null)
            },
          )
          Dialog.querySelector('#PlotDialogSave').addEventListener(
            'click',
            async () => {
              const StructureType = parseInt(
                Dialog.querySelector('#PlotStructureSelect').value,
              )
              const Content =
                Dialog.querySelector('#PlotContentInput').value.trim()
              if (!Content) {
                await ShowErrorDialog('内容を入力してください')
                return
              }
              if (!IsEdit && !ValidatePlotOrder(StructureType)) {
                await ShowErrorDialog('起承転結の順序で登録してください')
                return
              }
              try {
                const Response = await CallApi('/SavePlot.php', 'POST', {
                  PlotId: IsEdit ? PlotId : null,
                  WorkId: sessionStorage.getItem('WorkId'),
                  IndexNum: IsEdit ? Item.IndexNum : PlotList.length + 1,
                  StructureType: StructureType,
                  Content: Content,
                  UserId: sessionStorage.getItem('UserId'),
                })
                if (Response.Success) {
                  Overlay.remove()
                  await ShowInfoDialog('保存完了', 'プロットを保存しました')
                  await LoadPlotList()
                  Resolve(true)
                } else {
                  await ShowErrorDialog(
                    Response.Message || '保存に失敗しました',
                  )
                }
              } catch (Error) {
                await ShowErrorDialog('保存中にエラーが発生しました')
              }
            },
          )
          if (IsEdit) {
            Dialog.querySelector('#PlotDialogDelete').addEventListener(
              'click',
              async () => {
                if (!(await ShowConfirmDialog('このプロットを削除しますか？')))
                  return
                try {
                  const Response = await CallApi('/DeletePlot.php', 'POST', {
                    PlotId: PlotId,
                    UserId: sessionStorage.getItem('UserId'),
                  })
                  if (Response.Success) {
                    Overlay.remove()
                    await ShowInfoDialog('削除完了', 'プロットを削除しました')
                    await LoadPlotList()
                    Resolve(true)
                  } else {
                    await ShowErrorDialog(
                      Response.Message || '削除に失敗しました',
                    )
                  }
                } catch (Error) {
                  await ShowErrorDialog('削除中にエラーが発生しました')
                }
              },
            )
          }
        })
      }

      function ValidatePlotOrder(NewStructureType) {
        if (PlotList.length === 0) return NewStructureType === 0
        const LastStructureType = PlotList[PlotList.length - 1].StructureType
        return NewStructureType >= LastStructureType
      }

      async function ExportPlotToWord() {
        try {
          ShowSpinner()
          const Response = await fetch(`${API_BASE_URL}/ExportPlot.php`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              WorkId: sessionStorage.getItem('WorkId'),
              UserId: sessionStorage.getItem('UserId'),
            }),
          })
          if (!Response.ok) throw new Error('出力に失敗しました')
          const Blob = await Response.blob()
          const WorkTitle = WorkInfo?.WorkTitle || '作品'
          DownloadFile(Blob, `${WorkTitle}_プロット.docx`)
          HideSpinner()
          await ShowInfoDialog('出力完了', 'Wordファイルをダウンロードしました')
        } catch (Error) {
          HideSpinner()
          await ShowErrorDialog('出力中にエラーが発生しました')
        }
      }

      function ShowClueMemo() {
        ShowPlaceholder('伏線メモ', 'puzzle-piece')
      }

      /* ==========================================================================
       * 作品レビュー (7.3 ReviewInfo)
       * ========================================================================== */
      async function ShowWorkReview() {
        CurrentPage = 1
        SelectedReviewId = null
        const ContentArea = document.getElementById('ContentArea')
        const CanEditFlg = CanEditReview()
        ContentArea.innerHTML = `
        ${CreateContentHeader('作品レビュー', 'star')}
        <div class="FormGroup"><input type="text" class="InputForm" id="ReviewerName" placeholder="レビュアー名" maxlength="150" ${
          !CanEditFlg ? 'disabled' : ''
        }></div>
        <div class="FormGroup"><select class="SelectForm" id="ReviewEvaluation" ${
          !CanEditFlg ? 'disabled' : ''
        }>${PullDownList('Review')}</select></div>
        <div class="FormGroup InputWithButton"><input type="text" class="InputForm" id="ReviewContent" placeholder="レビュー内容" disabled><button class="ButtonClass SecondaryButton ButtonSmall" id="ReviewContentBtn"><i class="fas fa-edit"></i></button></div>
        <input type="hidden" id="ReviewContentHidden">
        ${
          CanEditFlg
            ? `<div class="ButtonGroup"><button class="ButtonClass ClearButton" id="ReviewClearButton"><i class="fas fa-sync"></i> クリア</button><button class="ButtonClass SaveButton" id="ReviewSaveButton"><i class="fas fa-save"></i> 保存</button><button class="ButtonClass DeleteButton Hidden" id="ReviewDeleteButton"><i class="fas fa-trash"></i> 削除</button></div>`
            : ''
        }
        <div id="RecordCountArea" class="MarginTop20"></div><div class="TableContainer" id="ReviewTableArea"></div><div id="PaginationArea"></div>
      `
        if (CanEditFlg) {
          document
            .getElementById('ReviewClearButton')
            .addEventListener('click', ClearReviewForm)
          document
            .getElementById('ReviewSaveButton')
            .addEventListener('click', SaveReview)
          document
            .getElementById('ReviewDeleteButton')
            .addEventListener('click', DeleteReview)
        }
        document
          .getElementById('ReviewContentBtn')
          .addEventListener('click', async () => {
            const Result = await ShowInputAreaDialog(
              document.getElementById('ReviewContentHidden').value,
              !CanEditFlg,
            )
            if (Result !== null && CanEditFlg) {
              document.getElementById('ReviewContentHidden').value = Result
              document.getElementById('ReviewContent').value = TruncateText(
                Result,
                30,
              )
            }
          })
        await LoadReviewList()
      }

      async function LoadReviewList() {
        try {
          const Response = await CallApi('/GetReviewList.php', 'POST', {
            WorkId: sessionStorage.getItem('WorkId'),
            UserId: sessionStorage.getItem('UserId'),
          })

          if (Response.Success) {
            ReviewList = Response.Data.ReviewList || []
            RenderReviewTable()
          } else {
            await ShowErrorDialog(
              Response.Message || 'レビュー一覧の取得に失敗しました',
            )
          }
        } catch (Error) {
          console.error(Error)
          await ShowErrorDialog('レビュー一覧の取得中にエラーが発生しました')
        }
      }

      function RenderReviewTable() {
        const TableArea = document.getElementById('ReviewTableArea')
        const RecordCountArea = document.getElementById('RecordCountArea')
        const PaginationArea = document.getElementById('PaginationArea')
        RecordCountArea.innerHTML = ''
        RecordCountArea.appendChild(CreateRecordCount(ReviewList.length))
        const Table = document.createElement('table')
        Table.className = 'DataTable'
        const Thead = document.createElement('thead')
        Thead.innerHTML = `<tr><th>レビュアー</th><th>評価</th><th>内容</th><th>登録日</th></tr>`
        Table.appendChild(Thead)
        const Tbody = document.createElement('tbody')
        const StartIndex = (CurrentPage - 1) * RECORDS_PER_PAGE
        const EndIndex = Math.min(
          StartIndex + RECORDS_PER_PAGE,
          ReviewList.length,
        )
        const PageData = ReviewList.slice(StartIndex, EndIndex)
        if (PageData.length === 0) {
          Tbody.innerHTML =
            '<tr><td colspan="4" style="text-align:center;color:#999;">データがありません</td></tr>'
        } else {
          PageData.forEach((Item, Idx) => {
            const Row = document.createElement('tr')
            Row.style.cursor = 'pointer'
            Row.innerHTML = `<td>${
              Item.ReviewerName || '-'
            }</td><td>${GetKeyInfo('Review', Item.Evaluation)}</td><td title="${
              Item.ReviewContent || ''
            }">${TruncateText(
              Item.ReviewContent,
              25,
            )}</td><td>${FormatTimestamp(Item.RegistDate)}</td>`
            Row.addEventListener('dblclick', () =>
              SelectReview(StartIndex + Idx),
            )
            Tbody.appendChild(Row)
          })
        }
        Table.appendChild(Tbody)
        TableArea.innerHTML = ''
        TableArea.appendChild(Table)
        PaginationArea.innerHTML = ''
        PaginationArea.appendChild(
          CreatePagination(ReviewList.length, CurrentPage, (Page) => {
            CurrentPage = Page
            RenderReviewTable()
          }),
        )
      }

      function SelectReview(Index) {
        const Item = ReviewList[Index]
        SelectedReviewId = Item.ReviewId
        document.getElementById('ReviewerName').value = Item.ReviewerName || ''
        document.getElementById('ReviewEvaluation').value = Item.Evaluation
        document.getElementById('ReviewContent').value = TruncateText(
          Item.ReviewContent,
          30,
        )
        document.getElementById('ReviewContentHidden').value =
          Item.ReviewContent || ''
        const DeleteBtn = document.getElementById('ReviewDeleteButton')
        if (DeleteBtn) DeleteBtn.classList.remove('Hidden')
      }

      function ClearReviewForm() {
        SelectedReviewId = null
        document.getElementById('ReviewerName').value = ''
        document.getElementById('ReviewEvaluation').value = '0'
        document.getElementById('ReviewContent').value = ''
        document.getElementById('ReviewContentHidden').value = ''
        const DeleteBtn = document.getElementById('ReviewDeleteButton')
        if (DeleteBtn) DeleteBtn.classList.add('Hidden')
      }

      async function SaveReview() {
        const ReviewContent = document
          .getElementById('ReviewContentHidden')
          .value.trim()
        const Evaluation = document.getElementById('ReviewEvaluation').value
        if (!ReviewContent) {
          await ShowErrorDialog('レビュー内容を入力してください')
          return
        }
        if (Evaluation === '0') {
          await ShowErrorDialog('評価を選択してください')
          return
        }
        try {
          const Response = await CallApi('/SaveReview.php', 'POST', {
            ReviewId: SelectedReviewId,
            WorkId: sessionStorage.getItem('WorkId'),
            ReviewerName: document.getElementById('ReviewerName').value.trim(),
            ReviewContent: ReviewContent,
            Evaluation: parseInt(Evaluation),
            UserId: sessionStorage.getItem('UserId'),
          })
          if (Response.Success) {
            await ShowInfoDialog('保存完了', 'レビューを保存しました')
            ClearReviewForm()
            await LoadReviewList()
          } else {
            await ShowErrorDialog(Response.Message || '保存に失敗しました')
          }
        } catch (Error) {
          await ShowErrorDialog('保存中にエラーが発生しました')
        }
      }

      async function DeleteReview() {
        if (!SelectedReviewId) return
        if (!(await ShowConfirmDialog('このレビューを削除しますか？'))) return
        try {
          const Response = await CallApi('/DeleteReview.php', 'POST', {
            ReviewId: SelectedReviewId,
            UserId: sessionStorage.getItem('UserId'),
          })
          if (Response.Success) {
            await ShowInfoDialog('削除完了', 'レビューを削除しました')
            ClearReviewForm()
            await LoadReviewList()
          } else {
            await ShowErrorDialog(Response.Message || '削除に失敗しました')
          }
        } catch (Error) {
          await ShowErrorDialog('削除中にエラーが発生しました')
        }
      }

      function ShowWorkMemo() {
        ShowPlaceholder('作品作成用メモ', 'sticky-note')
      }

      /* ==========================================================================
       * スケジュール
       * ========================================================================== */
      let CalendarYear = new Date().getFullYear()
      let CalendarMonth = new Date().getMonth()
      const ScheduleColors = [
        '#3498db',
        '#e74c3c',
        '#2ecc71',
        '#9b59b6',
        '#f39c12',
        '#1abc9c',
        '#e91e63',
        '#00bcd4',
      ]

      async function ShowSchedule() {
        SelectedScheduleId = null
        const ContentArea = document.getElementById('ContentArea')
        ContentArea.innerHTML = `
        ${CreateContentHeader('スケジュール', 'tasks')}
        <div class="CalendarContainer">
          <div class="CalendarHeader">
            <button class="CalendarNavButton" id="CalendarPrev"><i class="fas fa-chevron-left"></i></button>
            <h3 id="CalendarTitle"></h3>
            <button class="CalendarNavButton" id="CalendarNext"><i class="fas fa-chevron-right"></i></button>
          </div>
          <div class="CalendarGrid" id="CalendarGrid"></div>
        </div>
        <div id="RecordCountArea" class="MarginTop20"></div>
      `
        document
          .getElementById('CalendarPrev')
          .addEventListener('click', () => {
            CalendarMonth--
            if (CalendarMonth < 0) {
              CalendarMonth = 11
              CalendarYear--
            }
            RenderCalendar()
          })
        document
          .getElementById('CalendarNext')
          .addEventListener('click', () => {
            CalendarMonth++
            if (CalendarMonth > 11) {
              CalendarMonth = 0
              CalendarYear++
            }
            RenderCalendar()
          })
        await LoadScheduleList()
      }

      async function LoadScheduleList() {
        try {
          const Response = await CallApi('/GetScheduleList.php', 'POST', {
            WorkId: sessionStorage.getItem('WorkId'),
            UserId: sessionStorage.getItem('UserId'),
          })
          if (Response.Success) {
            ScheduleList = Response.Data.ScheduleList || []
            RenderCalendar()
          } else {
            await ShowErrorDialog(
              Response.Message || 'スケジュール一覧の取得に失敗しました',
            )
          }
        } catch (Error) {
          console.error(Error)
          await ShowErrorDialog(
            'スケジュール一覧の取得中にエラーが発生しました',
          )
        }
      }

      function RenderCalendar() {
        const Grid = document.getElementById('CalendarGrid')
        const Title = document.getElementById('CalendarTitle')
        const RecordCountArea = document.getElementById('RecordCountArea')
        if (!Grid) return
        Title.textContent = `${CalendarYear}年${CalendarMonth + 1}月`
        RecordCountArea.innerHTML = ''
        RecordCountArea.appendChild(CreateRecordCount(ScheduleList.length))
        Grid.innerHTML = ''
        const DayNames = ['日', '月', '火', '水', '木', '金', '土']
        DayNames.forEach((Name, Idx) => {
          const DayHeader = document.createElement('div')
          DayHeader.className = 'CalendarDayHeader'
          if (Idx === 0) DayHeader.classList.add('Sunday')
          if (Idx === 6) DayHeader.classList.add('Saturday')
          DayHeader.textContent = Name
          Grid.appendChild(DayHeader)
        })
        const FirstDay = new Date(CalendarYear, CalendarMonth, 1)
        const LastDay = new Date(CalendarYear, CalendarMonth + 1, 0)
        const StartDayOfWeek = FirstDay.getDay()
        const DaysInMonth = LastDay.getDate()
        const Today = new Date()
        const TodayStr = `${Today.getFullYear()}-${String(
          Today.getMonth() + 1,
        ).padStart(2, '0')}-${String(Today.getDate()).padStart(2, '0')}`
        const PrevMonthLastDay = new Date(
          CalendarYear,
          CalendarMonth,
          0,
        ).getDate()
        for (let I = StartDayOfWeek - 1; I >= 0; I--) {
          Grid.appendChild(
            CreateDayCell(PrevMonthLastDay - I, true, StartDayOfWeek - 1 - I),
          )
        }
        for (let Day = 1; Day <= DaysInMonth; Day++) {
          const DateStr = `${CalendarYear}-${String(CalendarMonth + 1).padStart(
            2,
            '0',
          )}-${String(Day).padStart(2, '0')}`
          const DayOfWeek = new Date(CalendarYear, CalendarMonth, Day).getDay()
          Grid.appendChild(
            CreateDayCell(Day, false, DayOfWeek, DateStr, DateStr === TodayStr),
          )
        }
        const TotalCells = StartDayOfWeek + DaysInMonth
        const RemainingCells = (7 - (TotalCells % 7)) % 7
        for (let I = 1; I <= RemainingCells; I++) {
          Grid.appendChild(CreateDayCell(I, true, (TotalCells + I - 1) % 7))
        }
      }

      function CreateDayCell(
        Day,
        IsOtherMonth,
        DayOfWeek,
        DateStr = null,
        IsToday = false,
      ) {
        const DayCell = document.createElement('div')
        DayCell.className = 'CalendarDay'
        if (IsOtherMonth) DayCell.classList.add('OtherMonth')
        if (IsToday) DayCell.classList.add('Today')
        if (DayOfWeek === 0) DayCell.classList.add('Sunday')
        if (DayOfWeek === 6) DayCell.classList.add('Saturday')
        const DayNumber = document.createElement('div')
        DayNumber.className = 'CalendarDayNumber'
        DayNumber.textContent = Day
        DayCell.appendChild(DayNumber)
        if (DateStr && !IsOtherMonth) {
          const DayEvents = GetEventsForDate(DateStr)
          DayEvents.slice(0, 2).forEach((Event) => {
            const EventEl = document.createElement('div')
            EventEl.className = 'CalendarEvent'
            EventEl.style.backgroundColor = Event.color || '#3498db'
            EventEl.textContent = Event.title
            EventEl.title = Event.title
            EventEl.addEventListener('click', (E) => {
              E.stopPropagation()
              OpenScheduleModal(Event)
            })
            DayCell.appendChild(EventEl)
          })
          if (DayEvents.length > 2) {
            const MoreEl = document.createElement('div')
            MoreEl.className = 'CalendarMoreEvents'
            MoreEl.textContent = `+${DayEvents.length - 2}件`
            DayCell.appendChild(MoreEl)
          }
          if (CanEdit()) {
            DayCell.addEventListener('click', () =>
              OpenScheduleModal(null, DateStr),
            )
          }
        }
        return DayCell
      }

      function GetEventsForDate(DateStr) {
        return ScheduleList.filter((Item) => {
          const Start = Item.startdate || ''
          const End = Item.enddate || Start
          return Start && DateStr >= Start && DateStr <= (End || Start)
        })
      }

      function OpenScheduleModal(Event = null, DefaultDate = null) {
        const CanEditFlg = CanEdit()
        const IsNew = Event === null
        const Modal = document.createElement('div')
        Modal.className = 'ScheduleModal'
        Modal.innerHTML = `
        <div class="ScheduleModalContent">
          <div class="ScheduleModalHeader"><h3>${
            IsNew ? 'スケジュール追加' : 'スケジュール編集'
          }</h3><button class="ScheduleModalClose" id="ScheduleModalClose">&times;</button></div>
          <div class="FormGroup"><input type="text" class="InputForm" id="ModalScheduleTitle" placeholder="タイトル" maxlength="255" value="${
            Event?.title || ''
          }" ${!CanEditFlg ? 'disabled' : ''}></div>
          <div class="FormGroup InputWithButton"><input type="text" class="InputForm" id="ModalScheduleStartDate" placeholder="開始日" value="${
            Event?.startdate || DefaultDate || ''
          }" readonly ${!CanEditFlg ? 'disabled' : ''}>${
          CanEditFlg
            ? `<button class="ButtonClass SecondaryButton ButtonSmall" id="ModalStartDateBtn"><i class="fas fa-calendar"></i></button>`
            : ''
        }</div>
          <div class="FormGroup InputWithButton"><input type="text" class="InputForm" id="ModalScheduleEndDate" placeholder="終了日" value="${
            Event?.enddate || ''
          }" readonly ${!CanEditFlg ? 'disabled' : ''}>${
          CanEditFlg
            ? `<button class="ButtonClass SecondaryButton ButtonSmall" id="ModalEndDateBtn"><i class="fas fa-calendar"></i></button>`
            : ''
        }</div>
          ${
            CanEditFlg
              ? `<label style="font-size:12px;color:#666;margin-bottom:5px;display:block;">カラー</label><div class="ScheduleColorPicker" id="ColorPicker">${ScheduleColors.map(
                  (C) =>
                    `<div class="ColorOption ${
                      (Event?.color || ScheduleColors[0]) === C
                        ? 'Selected'
                        : ''
                    }" data-color="${C}" style="background-color:${C};"></div>`,
                ).join('')}</div>`
              : ''
          }
          <div class="FormGroup InputWithButton"><input type="text" class="InputForm" id="ModalScheduleDescription" placeholder="説明" value="${
            TruncateText(Event?.description, 30) || ''
          }" disabled><button class="ButtonClass SecondaryButton ButtonSmall" id="ModalDescriptionBtn"><i class="fas fa-edit"></i></button></div>
          <input type="hidden" id="ModalScheduleDescriptionHidden" value="${
            Event?.description || ''
          }">
          <input type="hidden" id="ModalScheduleColor" value="${
            Event?.color || ScheduleColors[0]
          }">
          <input type="hidden" id="ModalScheduleId" value="${
            Event?.scheduleid || ''
          }">
          ${
            CanEditFlg
              ? `<div class="ButtonGroup" style="margin-top:20px;"><button class="ButtonClass SaveButton" id="ModalSaveBtn"><i class="fas fa-save"></i> 保存</button>${
                  !IsNew
                    ? `<button class="ButtonClass DeleteButton" id="ModalDeleteBtn"><i class="fas fa-trash"></i> 削除</button>`
                    : ''
                }</div>`
              : ''
          }
        </div>`
        document.body.appendChild(Modal)
        const CloseModal = () => Modal.remove()
        Modal.querySelector('#ScheduleModalClose').addEventListener(
          'click',
          CloseModal,
        )
        Modal.addEventListener('click', (E) => {
          if (E.target === Modal) CloseModal()
        })
        if (CanEditFlg) {
          const DatePickerInstance = new DatePicker()
          Modal.querySelector('#ModalStartDateBtn').addEventListener(
            'click',
            () => DatePickerInstance.OpenDialog('ModalScheduleStartDate'),
          )
          Modal.querySelector('#ModalEndDateBtn').addEventListener(
            'click',
            () => DatePickerInstance.OpenDialog('ModalScheduleEndDate'),
          )
          Modal.querySelectorAll('.ColorOption').forEach((Opt) => {
            Opt.addEventListener('click', () => {
              Modal.querySelectorAll('.ColorOption').forEach((O) =>
                O.classList.remove('Selected'),
              )
              Opt.classList.add('Selected')
              Modal.querySelector('#ModalScheduleColor').value =
                Opt.dataset.color
            })
          })
          Modal.querySelector('#ModalSaveBtn').addEventListener(
            'click',
            async () => {
              const Title = Modal.querySelector(
                '#ModalScheduleTitle',
              ).value.trim()
              if (!Title) {
                await ShowErrorDialog('タイトルを入力してください')
                return
              }
              try {
                const Response = await CallApi('/SaveSchedule.php', 'POST', {
                  ScheduleId:
                    Modal.querySelector('#ModalScheduleId').value || null,
                  WorkId: sessionStorage.getItem('WorkId'),
                  Title: Title,
                  StartDate: Modal.querySelector(
                    '#ModalScheduleStartDate',
                  ).value.trim(),
                  EndDate: Modal.querySelector(
                    '#ModalScheduleEndDate',
                  ).value.trim(),
                  Color: Modal.querySelector('#ModalScheduleColor').value,
                  Description: Modal.querySelector(
                    '#ModalScheduleDescriptionHidden',
                  ).value,
                  UserId: sessionStorage.getItem('UserId'),
                })
                if (Response.Success) {
                  CloseModal()
                  await ShowInfoDialog('保存完了', 'スケジュールを保存しました')
                  await LoadScheduleList()
                } else {
                  await ShowErrorDialog(
                    Response.Message || '保存に失敗しました',
                  )
                }
              } catch (Error) {
                await ShowErrorDialog('保存中にエラーが発生しました')
              }
            },
          )
          if (!IsNew) {
            Modal.querySelector('#ModalDeleteBtn').addEventListener(
              'click',
              async () => {
                if (
                  !(await ShowConfirmDialog('このスケジュールを削除しますか？'))
                )
                  return
                try {
                  const Response = await CallApi(
                    '/DeleteSchedule.php',
                    'POST',
                    {
                      ScheduleId: Modal.querySelector('#ModalScheduleId').value,
                      WorkId: sessionStorage.getItem('WorkId'),
                      UserId: sessionStorage.getItem('UserId'),
                    },
                  )
                  if (Response.Success) {
                    CloseModal()
                    await ShowInfoDialog(
                      '削除完了',
                      'スケジュールを削除しました',
                    )
                    await LoadScheduleList()
                  } else {
                    await ShowErrorDialog(
                      Response.Message || '削除に失敗しました',
                    )
                  }
                } catch (Error) {
                  await ShowErrorDialog('削除中にエラーが発生しました')
                }
              },
            )
          }
        }
        Modal.querySelector('#ModalDescriptionBtn').addEventListener(
          'click',
          async () => {
            const Result = await ShowInputAreaDialog(
              Modal.querySelector('#ModalScheduleDescriptionHidden').value,
              !CanEditFlg,
            )
            if (Result !== null && CanEditFlg) {
              Modal.querySelector('#ModalScheduleDescriptionHidden').value =
                Result
              Modal.querySelector('#ModalScheduleDescription').value =
                TruncateText(Result, 30)
            }
          },
        )
      }

      function ShowParticipants() {
        ShowPlaceholder('参加者一覧', 'user-friends')
      }

      /**
       * プレースホルダー画面を表示
       * @param {string} Title タイトル
       * @param {string} Icon アイコン
       */
      function ShowPlaceholder(Title, Icon) {
        const ContentArea = document.getElementById('ContentArea')
        ContentArea.innerHTML = `
        ${CreateContentHeader(Title, Icon)}
        <div style="text-align: center; padding: 50px; color: #999;">
          <i class="fas fa-${Icon}" style="font-size: 60px; margin-bottom: 20px;"></i>
          <p>この機能は準備中です</p>
        </div>
      `
      }
    </script>
  </body>
</html>
